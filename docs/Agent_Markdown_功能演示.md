# Agent Markdown 解析器功能演示

本文档展示了升级后的Agent聊天界面支持的完整Markdown功能。

---

## ✨ 升级内容

### 1. 标题支持（6级标题）
```markdown
# 一级标题
## 二级标题
### 三级标题
#### 四级标题
##### 五级标题
###### 六级标题
```

### 2. 列表支持

**无序列表：**
```markdown
- 项目一
- 项目二
- 项目三
```

**有序列表：**
```markdown
1. 第一项
2. 第二项
3. 第三项
```

### 3. 文本格式

- **粗体文本**：`**文本**` 或 `__文本__`
- *斜体文本*：`*文本*` 或 `_文本_`
- ***粗斜体***：`***文本***` 或 `___文本___`
- ~~删除线~~：`~~文本~~`
- `行内代码`：`` `代码` ``

### 4. 代码块
```python
def hello_world():
    print("Hello, World!")
    return True
```

### 5. 引用块
```markdown
> 这是一段引用文本
> 可以包含多行
```

### 6. 链接和图片
```markdown
[链接文本](https://example.com)
![图片描述](image-url.jpg)
```

### 7. 分隔线
```markdown
---
或
***
```

---

## 🎨 样式特性

### 主题适配
- ✅ 浅色主题完整支持
- ✅ 深色主题完整适配
- ✅ 用户消息和AI消息样式差异化

### 美化元素
- 标题带下划线分隔
- 列表项使用彩色标记
- 引用块左侧彩色边框
- 代码块深色背景
- 链接悬停效果
- 图片圆角显示

---

## 🔧 技术实现

### 核心改进
1. **HTML安全转义**：防止XSS攻击
2. **代码块优先处理**：避免被其他规则干扰
3. **正则表达式优化**：准确匹配各种Markdown语法
4. **段落智能处理**：自动识别段落边界
5. **连续元素合并**：合并连续的列表、引用等

### 文件修改
- `core/static/js/agent-chat.js` - formatContent() 函数重写（998-1100行）
- `core/static/css/agent-chat.css` - 新增Markdown元素样式（364-545行）

---

## 📝 使用示例

在Agent聊天中，AI回复可以使用完整的Markdown格式：

### 示例1：任务清单
```markdown
# 今日待办事项

## 工作任务
1. 完成项目报告
2. 参加团队会议
3. 代码review

## 个人事项
- 健身
- 阅读
- 学习新技术
```

### 示例2：代码说明
```markdown
## Python函数示例

这是一个简单的函数：

```python
def calculate_sum(a, b):
    """计算两个数的和"""
    return a + b
```

**使用方式：**
```python
result = calculate_sum(5, 3)
print(result)  # 输出: 8
```
```

### 示例3：引用与强调
```markdown
> **重要提示**：请确保在执行操作前备份数据。

这个功能支持：
- *实时更新*
- **自动保存**
- ~~手动刷新~~（已废弃）
```

---

## 🎯 测试建议

在Agent聊天中输入以下提示词进行测试：

1. "请用Markdown格式给我一个学习计划"
2. "帮我写一个Python代码示例，用Markdown格式化"
3. "用列表形式总结今天的任务"

---

## 📊 支持的Markdown语法清单

| 语法 | 支持 | 效果 |
|------|------|------|
| # 标题 | ✅ | 6级标题 |
| 列表 | ✅ | 有序/无序 |
| **粗体** | ✅ | 加粗 |
| *斜体* | ✅ | 倾斜 |
| ~~删除线~~ | ✅ | 划线 |
| `代码` | ✅ | 行内代码 |
| ```代码块``` | ✅ | 多行代码 |
| > 引用 | ✅ | 引用块 |
| [链接](url) | ✅ | 超链接 |
| ![图片](url) | ✅ | 图片 |
| --- | ✅ | 分隔线 |
| 表格 | ✅ | Markdown表格 |
| [^1] 脚注 | ✅ | 脚注引用 |
| $公式$ | ✅ | 行内公式 |
| $$公式$$ | ✅ | 块级公式 |

---

## 🆕 新增功能详解

### 1. 表格支持

**语法：**
```markdown
| 列1 | 列2 | 列3 |
|-----|-----|-----|
| 数据1 | 数据2 | 数据3 |
| 数据4 | 数据5 | 数据6 |
```

**效果：**
- ✅ 自动表头样式（蓝色背景）
- ✅ 斑马纹行（偶数行浅色）
- ✅ 悬停高亮效果
- ✅ 响应式宽度
- ✅ 深色主题适配

**示例：**
```markdown
| 任务名称 | 优先级 | 状态 |
|---------|--------|------|
| 完成报告 | 高 | 进行中 |
| 代码审查 | 中 | 待办 |
| 文档更新 | 低 | 已完成 |
```

---

### 2. 脚注支持

**语法：**
```markdown
这是一段文字[^1]，需要补充说明[^2]。

[^1]: 这是第一个脚注的内容。
[^2]: 这是第二个脚注的内容。
```

**效果：**
- ✅ 上标引用链接
- ✅ 点击跳转到脚注
- ✅ 返回链接（↩）
- ✅ 底部自动汇总
- ✅ 深色主题适配

**使用场景：**
- 学术引用
- 补充说明
- 参考资料

---

### 3. 数学公式支持

**行内公式语法：**
```markdown
爱因斯坦质能方程：$E = mc^2$
```

**块级公式语法：**
```markdown
$$
\int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi}
$$
```

**技术实现：**
- ✅ 使用 MathJax 3.x 渲染
- ✅ 支持 LaTeX 语法
- ✅ 自动渲染
- ✅ 响应式显示
- ✅ 深色主题适配

**常用公式示例：**

1. **分式：** `$\frac{a}{b}$`
2. **根号：** `$\sqrt{x}$` 或 `$\sqrt[3]{x}$`
3. **上下标：** `$x^2$` 或 `$x_i$`
4. **求和：** `$\sum_{i=1}^{n} x_i$`
5. **积分：** `$\int_0^1 f(x)dx$`
6. **极限：** `$\lim_{x \to \infty} f(x)$`
7. **矩阵：**
```markdown
$$
\begin{bmatrix}
a & b \\
c & d
\end{bmatrix}
$$
```

**使用场景：**
- 数学教学
- 科学计算
- 物理公式
- 统计分析

---

## 🎨 完整测试示例

### 示例4：数据分析报告

```markdown
# 数据分析报告

## 数据概览

| 指标 | 数值 | 增长率 |
|------|------|--------|
| 用户数 | 10,000 | +15% |
| 活跃率 | 68% | +5% |
| 留存率 | 85% | +8% |

## 统计分析

用户增长符合指数模型[^1]，预测公式为：

$$
N(t) = N_0 \cdot e^{rt}
$$

其中增长率 $r = 0.15$，初始用户数 $N_0 = 8,695$。

## 结论

数据表明[^2]：
1. 用户增长稳定
2. 活跃度提升显著
3. 留存率超出预期

[^1]: 基于最近3个月的数据拟合
[^2]: 置信区间95%
```

### 示例5：物理公式说明

```markdown
# 经典力学公式

## 牛顿第二定律

力与加速度的关系：$F = ma$

## 动能公式

物体的动能计算公式为：

$$
E_k = \frac{1}{2}mv^2
$$

其中：
- $m$ 表示质量（单位：kg）
- $v$ 表示速度（单位：m/s）
- $E_k$ 表示动能（单位：J）
```

---

## 📦 更新内容汇总

### JavaScript 更新
- **文件**：`core/static/js/agent-chat.js`
- **函数**：`formatContent()` (997-1155行)
- **新增**：
  - 表格解析（正则匹配 `| col |` 格式）
  - 脚注提取和引用
  - 数学公式标记（`$...$` 和 `$$...$$`）
  - MathJax 自动渲染触发
  - HTML 转义辅助函数

### CSS 更新
- **文件**：`core/static/css/agent-chat.css`
- **新增样式**：
  - `.markdown-table` - 表格样式
  - `.footnote-ref` - 脚注引用
  - `.footnotes` - 脚注列表
  - `.math-block` - 块级数学公式
  - `.math-inline` - 行内数学公式
  - 深色主题适配

### HTML 更新
- **文件**：`core/templates/home.html`
- **新增**：
  - MathJax 3.x CDN 引入
  - MathJax 配置脚本
  - LaTeX 语法支持配置

---

升级完成！🎉

## 🎯 测试方法

在Agent聊天中测试新功能：

### 测试表格：
```
"请创建一个任务进度表格，包含任务名称、负责人、进度和截止日期"
```

### 测试脚注：
```
"解释什么是人工智能，并添加相关引用脚注"
```

### 测试数学公式：
```
"用数学公式解释正态分布"
"给我展示二次方程求根公式"
```

### 综合测试：
```
"创建一个数据分析报告，包含表格、统计公式和脚注说明"
```

---

## 🔧 技术细节

### MathJax 配置
- **版本**：MathJax 3.x
- **渲染引擎**：tex-mml-chtml
- **支持语法**：LaTeX、MathML
- **渲染方式**：异步渲染，不阻塞页面
- **触发时机**：消息添加后100ms自动渲染

### 表格解析
- **正则表达式**：匹配 `| col |` 格式
- **表头识别**：自动检测分隔行 `|---|`
- **HTML生成**：完整的 `<table><thead><tbody>` 结构
- **样式类名**：`.markdown-table`

### 脚注系统
- **引用格式**：`[^标识]`
- **定义格式**：`[^标识]: 内容`
- **跳转链接**：双向跳转支持
- **位置**：自动添加到消息底部

---

## ⚡ 性能优化

1. **异步渲染**：MathJax 异步加载和渲染
2. **按需触发**：仅在消息添加时触发渲染
3. **缓存优化**：MathJax 自动缓存渲染结果
4. **延迟执行**：100ms 延迟避免重复渲染

---

## 🛡️ 安全性

1. **HTML转义**：所有内容先转义，防止XSS
2. **公式隔离**：数学公式在独立容器中渲染
3. **链接安全**：外部链接添加安全属性
4. **脚本过滤**：MathJax 配置忽略脚本标签

---

## 📚 参考资源

- [MathJax 官方文档](https://docs.mathjax.org/)
- [LaTeX 数学符号](https://www.latex-project.org/)
- [Markdown 表格语法](https://www.markdownguide.org/extended-syntax/#tables)
- [GitHub Flavored Markdown](https://github.github.com/gfm/)

---

现在Agent聊天界面支持完整的Markdown格式，包括表格、脚注和数学公式！🎉✨
