# 邮件验证功能配置说明

## 概述

本项目支持真实的邮件验证功能，包括：
1. **注册验证**：新用户注册时需要验证邮箱
2. **找回密码**：通过邮箱验证码重置密码

邮件服务通过独立的配置文件管理，支持可选配置（未配置时提供测试模式）。

## 配置文件

### 文件位置
- 配置文件：`config/email.json`（已加入.gitignore，不会被提交到Git）
- 示例文件：`config/email.example.json`（可以提交到Git作为参考）

### 配置格式

```json
{
  "enabled": true,
  "smtp_host": "smtpdm.aliyun.com",
  "smtp_port": 465,
  "smtp_use_ssl": true,
  "smtp_user": "verify@unischedulersuper.online",
  "smtp_password": "您的SMTP密码",
  "from_email": "verify@unischedulersuper.online",
  "from_name": "UniSchedulerSuper"
}
```

### 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `enabled` | boolean | 是 | 是否启用邮件发送。设为`false`则使用测试模式 |
| `smtp_host` | string | 是 | SMTP服务器地址（如：smtp.qq.com, smtp.163.com等） |
| `smtp_port` | integer | 是 | SMTP端口（SSL通常为465，TLS通常为587） |
| `smtp_use_ssl` | boolean | 是 | 是否使用SSL连接（true使用SSL，false使用TLS） |
| `smtp_user` | string | 是 | SMTP用户名（通常是完整的邮箱地址） |
| `smtp_password` | string | 是 | SMTP密码或授权码 |
| `from_email` | string | 是 | 发件人邮箱地址 |
| `from_name` | string | 否 | 发件人名称，默认"时间管理大师" |

## 常见邮件服务配置示例

### 阿里云邮件推送（推荐用于生产环境）

```json
{
  "enabled": true,
  "smtp_host": "smtpdm.aliyun.com",
  "smtp_port": 465,
  "smtp_use_ssl": true,
  "smtp_user": "verify@yourdomain.com",
  "smtp_password": "您的SMTP密码",
  "from_email": "verify@yourdomain.com",
  "from_name": "您的网站名称"
}
```

**注意**：
- 需要在阿里云控制台创建邮件推送服务
- 需要配置发信域名并完成域名验证
- SMTP密码在阿里云控制台获取

### QQ邮箱

```json
{
  "enabled": true,
  "smtp_host": "smtp.qq.com",
  "smtp_port": 465,
  "smtp_use_ssl": true,
  "smtp_user": "your_qq@qq.com",
  "smtp_password": "授权码（非QQ密码）",
  "from_email": "your_qq@qq.com",
  "from_name": "网站名称"
}
```

**获取QQ邮箱授权码**：
1. 登录QQ邮箱网页版
2. 设置 → 账户 → POP3/IMAP/SMTP服务
3. 开启服务并生成授权码

### 163邮箱

```json
{
  "enabled": true,
  "smtp_host": "smtp.163.com",
  "smtp_port": 465,
  "smtp_use_ssl": true,
  "smtp_user": "your_email@163.com",
  "smtp_password": "授权码（非登录密码）",
  "from_email": "your_email@163.com",
  "from_name": "网站名称"
}
```

### Gmail（国外服务器）

```json
{
  "enabled": true,
  "smtp_host": "smtp.gmail.com",
  "smtp_port": 587,
  "smtp_use_ssl": false,
  "smtp_user": "your_email@gmail.com",
  "smtp_password": "应用专用密码",
  "from_email": "your_email@gmail.com",
  "from_name": "Your Site"
}
```

## 使用场景

### 场景1：生产环境（启用邮件发送）

```json
{
  "enabled": true,
  "smtp_host": "smtpdm.aliyun.com",
  "smtp_port": 465,
  "smtp_use_ssl": true,
  "smtp_user": "verify@unischedulersuper.online",
  "smtp_password": "your_smtp_password",
  "from_email": "verify@unischedulersuper.online",
  "from_name": "UniSchedulerSuper"
}
```

**行为**：
- 用户注册时发送验证码到邮箱
- 找回密码时发送验证码到邮箱
- API响应不包含验证码（验证码仅通过邮件发送）

### 场景2：开发测试（测试模式）

```json
{
  "enabled": false
}
```

或者直接删除 `config/email.json` 文件。

**行为**：
- 不发送真实邮件
- API响应中包含生成的验证码（方便测试）
- 验证码记录仍然保存到数据库
- 验证码验证功能正常工作

## API接口说明

### 1. 请求注册验证码

**接口**：`POST /api/email/request-verification/`

**请求体**：
```json
{
  "email": "user@example.com",
  "purpose": "register"
}
```

**成功响应**（邮件功能启用）：
```json
{
  "message": "验证码已发送到您的邮箱，请注意查收",
  "email": "user@example.com",
  "expires_in": "15分钟"
}
```

**成功响应**（测试模式）：
```json
{
  "message": "验证码已生成（邮件功能未启用，仅供测试）",
  "email": "user@example.com",
  "code": "123456",
  "expires_in": "15分钟"
}
```

### 2. 验证邮箱验证码

**接口**：`POST /api/email/verify-code/`

**请求体**：
```json
{
  "email": "user@example.com",
  "code": "123456",
  "purpose": "register"
}
```

**成功响应**：
```json
{
  "message": "验证成功",
  "email": "user@example.com"
}
```

### 3. 请求密码重置验证码

**接口**：`POST /api/password-reset/request/`

**请求体**：
```json
{
  "email": "user@example.com"
}
```

**成功响应**（邮件功能启用）：
```json
{
  "message": "验证码已发送到您的邮箱，请注意查收",
  "email": "user@example.com",
  "expires_in": "15分钟"
}
```

## 初始配置步骤

### 方法1：使用阿里云邮件推送（推荐）

1. **注册阿里云账号并开通邮件推送服务**
   - 访问 https://www.aliyun.com/product/directmail
   - 开通服务并完成实名认证

2. **配置发信域名**
   - 在阿里云控制台添加你的域名
   - 按照提示完成域名验证（添加TXT记录到DNS）
   - 配置SPF、DKIM等记录

3. **创建发信地址**
   - 创建发信地址，如：verify@yourdomain.com
   - 获取SMTP密码

4. **配置本项目**
   ```bash
   cp config/email.example.json config/email.json
   ```
   
   编辑 `config/email.json`：
   ```json
   {
     "enabled": true,
     "smtp_host": "smtpdm.aliyun.com",
     "smtp_port": 465,
     "smtp_use_ssl": true,
     "smtp_user": "verify@yourdomain.com",
     "smtp_password": "从阿里云获取的SMTP密码",
     "from_email": "verify@yourdomain.com",
     "from_name": "您的网站名称"
   }
   ```

5. **生成数据库迁移并运行**
   ```bash
   python manage.py makemigrations
   python manage.py migrate
   ```

6. **重启Django服务**

### 方法2：使用QQ邮箱（适合开发测试）

1. **获取QQ邮箱授权码**
   - 登录QQ邮箱网页版
   - 设置 → 账户 → 开启POP3/SMTP服务
   - 生成授权码并保存

2. **配置项目**
   ```bash
   cp config/email.example.json config/email.json
   ```
   
   编辑配置文件并填入授权码

3. **生成迁移并重启**

## 邮件模板

系统会发送美观的HTML邮件，包含：
- 渐变色标题栏
- 大号验证码显示（易于识别）
- 注意事项说明
- 响应式设计（支持移动设备）

**注册验证码邮件示例**：
```
欢迎注册时间管理大师

感谢您注册我们的服务！

请使用以下验证码完成注册：

┌─────────┐
│ 123456 │
└─────────┘

注意事项：
• 验证码有效期为 15分钟
• 请勿将验证码泄露给他人
• 如果这不是您本人的操作，请忽略此邮件
```

## 数据库模型

### EmailVerificationCode（邮箱验证码）

用于注册等场景的邮箱验证。

| 字段 | 类型 | 说明 |
|------|------|------|
| email | EmailField | 待验证的邮箱 |
| code | CharField(6) | 6位数字验证码 |
| purpose | CharField(20) | 用途（register, change_email等） |
| created_at | DateTimeField | 创建时间 |
| expires_at | DateTimeField | 过期时间（15分钟后） |
| is_used | BooleanField | 是否已使用 |

### PasswordResetCode（密码重置验证码）

用于密码重置的验证码。

| 字段 | 类型 | 说明 |
|------|------|------|
| user | ForeignKey(User) | 关联用户 |
| code | CharField(6) | 6位数字验证码 |
| created_at | DateTimeField | 创建时间 |
| expires_at | DateTimeField | 过期时间（15分钟后） |
| is_used | BooleanField | 是否已使用 |

## 安全性说明

1. **验证码安全**
   - 6位数字随机生成
   - 15分钟有效期
   - 使用后自动标记为已使用
   - 每个邮箱可以多次请求（新验证码覆盖旧验证码）

2. **邮箱验证**
   - 注册时检查邮箱是否已被注册
   - 找回密码时不泄露邮箱是否存在（安全考虑）
   - 验证码通过加密连接发送

3. **配置文件安全**
   - email.json已加入.gitignore
   - SMTP密码不会被提交到版本控制
   - 支持环境变量配置（可扩展）

## 故障排查

### 问题1：邮件发送失败

**可能原因**：
- SMTP配置错误
- SMTP密码不正确
- 邮件服务未开启SMTP功能
- 防火墙阻止连接

**解决方法**：
1. 检查日志：`logs/application.log`
2. 验证SMTP配置是否正确
3. 确认SMTP服务已开启
4. 测试SMTP连接：使用 `telnet smtp_host smtp_port`

### 问题2：收不到验证码邮件

**可能原因**：
- 邮件被归类为垃圾邮件
- 邮箱地址错误
- 邮件服务延迟

**解决方法**：
1. 检查垃圾邮件文件夹
2. 将发件人地址加入白名单
3. 查看服务器日志确认邮件已发送

### 问题3：验证码总是无效

**可能原因**：
- 服务器时间不准确
- 验证码已过期（15分钟）
- 验证码已被使用

**解决方法**：
1. 检查服务器时间：`date`
2. 重新请求验证码
3. 检查数据库中的验证码记录

## 测试邮件发送

可以使用Python直接测试邮件配置：

```python
from config.email_manager import test_email_config

success, message = test_email_config()
print(f"测试结果: {message}")
```

或者通过Django shell：

```bash
python manage.py shell

>>> from config.email_manager import send_verification_code_email
>>> success, msg = send_verification_code_email("your_email@example.com", "123456", "register")
>>> print(f"发送{'成功' if success else '失败'}: {msg}")
```

## 更新记录

- **2026-02-03**: 初始版本
  - 实现邮件验证码发送功能
  - 支持注册验证和找回密码
  - 添加测试模式（邮件功能未启用时）
  - 创建EmailVerificationCode和PasswordResetCode模型
  - 提供精美的HTML邮件模板
