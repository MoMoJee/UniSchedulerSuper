# 提醒日历集成功能文档

## 功能概述
将提醒（Reminder）数据集成到日历视图中，使用户可以在日历界面直接查看和管理提醒，提供完整的提醒操作功能。

## 实施日期
- **开发日期**: 2025年10月31日
- **版本号**: v20251031-004
- **最后更新**: 2025年10月31日 - 修复模态框显示和布局优化

## 核心功能

### 1. 提醒在日历中的显示
- **数据来源**: 从 `/api/reminders/` API 获取提醒数据
- **过滤条件**: 只显示状态为 `active` 和 `snoozed_*` 的提醒（排除已完成和已忽略）
- **时间范围**: 
  - 开始时间：`trigger_time` 或 `snooze_until`（如果被延后）
  - 结束时间：开始时间 + 30分钟
- **时间显示**: 
  - 只显示开始时间（如 "14:30"）
  - 不显示结束时间（因为结束时间仅用于占位，无实际意义）
  - 使用自定义 `eventContent` 渲染
- **视觉特征**:
  - 🔔 图标前缀
  - 半透明背景（opacity: 0.75）
  - 虚线边框（dashed border）
  - 斜体标题
  - 根据优先级显示不同颜色

### 2. 优先级颜色方案
```javascript
'urgent': 'rgba(220, 53, 69, 0.6)',    // 红色半透明 🔥
'high':   'rgba(255, 193, 7, 0.6)',    // 黄色半透明 ❗
'normal': 'rgba(0, 123, 255, 0.6)',    // 蓝色半透明 🔔
'low':    'rgba(108, 117, 125, 0.6)',  // 灰色半透明 🔕
'debug':  'rgba(111, 66, 193, 0.6)'    // 紫色半透明 🐛
```

### 3. 交互限制
#### 禁用的操作
- **拖拽（eventDrop）**: 禁止移动提醒，会显示警告并回退操作
- **调整大小（eventResize）**: 禁止调整提醒时长，会显示警告并回退操作

#### 原因
提醒的时间由提醒系统管理，应通过提醒编辑界面修改，而不是通过日历拖拽。

### 4. 点击提醒的交互

#### 触发流程
1. 用户点击日历中的提醒事件
2. 检测到 `extendedProps.isReminder === true`
3. 调用 `handleReminderClick()` 而非普通事件的 `handleEventEdit()`

#### 提醒详情模态框
显示完整的提醒信息和操作按钮：

**信息展示**:
- 优先级图标 + 标题
- 提醒时间（含星期）
- 内容描述
- 重复规则（如果有）

**操作按钮**:

1. **✓ 完成** - 标记提醒为已完成
   - 按钮样式：绿色（已完成）/ 绿色轮廓（未完成）
   - 调用：`toggleReminderStatus(reminderId, 'completed')`
   - 效果：提醒从日历中消失，左下角列表也会更新

2. **✕ 忽略** - 标记提醒为已忽略
   - 按钮样式：灰色（已忽略）/ 灰色轮廓（未忽略）
   - 调用：`toggleReminderStatus(reminderId, 'dismissed')`
   - 效果：提醒从日历中消失

3. **延后** - 延后提醒时间
   - 下拉菜单选项：
     - 15分钟后
     - 1小时后
     - 一天后
     - 自定义
   - 如果已延后，显示延后状态和"取消延后"按钮
   - 调用：`snoozeReminderFromCalendar(reminderId, duration)`

4. **✏ 编辑** - 打开提醒编辑模态框
   - 调用：`editReminderFromCalendar(reminderId)`
   - 会关闭当前详情框，打开完整的编辑提醒模态框

5. **🗑 删除** - 删除提醒
   - 需要确认操作
   - 调用：`deleteReminderFromCalendar(reminderId)`

## 技术实现

### 修改的文件

#### 1. staticfiles/js/event-manager.js（及源文件 core/static/js/event-manager.js）

**新增方法**:
- `getReminderColor(priority)` - 获取提醒颜色
- `handleReminderClick(eventInfo)` - 处理提醒点击
- `formatReminderTime(date)` - 格式化提醒时间
- `getPriorityIcon(priority)` - 获取优先级图标
- `getSnoozeText(snoozeType, snoozeUntil)` - 获取延后文本
- `toggleReminderStatus(reminderId, targetStatus)` - 切换提醒状态
- `snoozeReminderFromCalendar(reminderId, duration)` - 延后提醒
- `cancelReminderSnooze(reminderId)` - 取消延后
- `customSnoozeReminder(reminderId)` - 自定义延后
- `editReminderFromCalendar(reminderId)` - 编辑提醒
- `deleteReminderFromCalendar(reminderId)` - 删除提醒
- `getCSRFToken()` - 获取CSRF令牌

**修改的方法**:
- `fetchEvents(start, end)` - 合并提醒数据到日历事件（30分钟时长）
- `eventClick` 回调 - 添加提醒检测逻辑（两处：初始化和setOption）
- `eventDrop` 回调 - 添加提醒拖拽禁用逻辑
- `eventResize` 回调 - 添加提醒调整禁用逻辑

**新增配置**:
- `eventContent` - 自定义提醒的时间显示格式（只显示开始时间）

#### 2. core/templates/home_new.html

**新增模态框**:
```html
<div class="modal" id="reminderDetailModal">
    <!-- 提醒详情和操作界面 -->
</div>
```

**版本号更新**:
- CSS: `v=20251031-002`
- JS: `v=20251031-002`

#### 3. staticfiles/css/home-styles.css（及源文件 core/static/css/home-styles.css）

**新增样式**:
```css
/* 日历中的提醒事件样式 */
.fc-event.reminder-event {
    opacity: 0.75;
    border-style: dashed !important;
    border-width: 2px !important;
}

.fc-event.reminder-event:hover {
    opacity: 0.9;
    cursor: pointer;
}

.fc-event.reminder-event .fc-event-title {
    font-style: italic;
}

/* 提醒详情卡片样式 */
.reminder-detail-card { /* ... */ }
```

### 数据流程

```
1. 页面加载
   ↓
2. FullCalendar 调用 fetchEvents()
   ↓
3. 并行请求:
   - /get_calendar/events/ (日程)
   - /api/reminders/ (提醒)
   ↓
4. 转换提醒为日历事件格式
   - id: "reminder_${reminder.id}"
   - title: "🔔 ${title}"
   - start/end: 15分钟时间段
   - extendedProps.isReminder: true
   - classNames: ['reminder-event']
   ↓
5. 合并并返回所有事件
   ↓
6. FullCalendar 渲染
```

### 用户操作流程

```
用户点击日历中的提醒
   ↓
eventClick 回调检测 isReminder
   ↓
调用 handleReminderClick()
   ↓
显示 reminderDetailModal
   ↓
用户选择操作:
   ├─ 完成 → toggleReminderStatus('completed')
   ├─ 忽略 → toggleReminderStatus('dismissed')
   ├─ 延后 → snoozeReminderFromCalendar()
   ├─ 编辑 → editReminderFromCalendar()
   └─ 删除 → deleteReminderFromCalendar()
   ↓
调用后端API更新数据
   ↓
成功后:
   - 关闭模态框
   - 刷新日历 (calendar.refetchEvents())
   - 刷新左下角提醒列表 (reminderManager.loadReminders())
```

## API 调用

### 使用的后端接口
1. `GET /api/reminders/` - 获取提醒列表
2. `POST /api/reminders/update-status/` - 更新提醒状态
3. `POST /api/reminders/delete/` - 删除提醒
4. 通过 `reminderManager` 调用的延后接口

### CSRF保护
所有POST请求都包含 `X-CSRFToken` 头，从 `window.CSRF_TOKEN` 获取。

## 与现有功能的集成

### 与左下角提醒列表的同步
- 当用户在日历中操作提醒时，会同时刷新左下角的提醒列表
- 使用 `window.reminderManager.loadReminders()` 和 `applyFilters()`
- 保证两处数据一致性

### 与 ReminderManager 的协作
- 延后功能直接调用 `reminderManager.snoozeReminder()`
- 自定义延后调用 `reminderManager.customSnooze()`
- 取消延后调用 `reminderManager.cancelSnooze()`
- 避免代码重复，复用已有逻辑

### 与 ModalManager 的协作
- 编辑提醒调用 `modalManager.openEditReminderModal()`
- 关闭模态框调用 `modalManager.closeAllModals()`
- 复用现有模态框组件

## 用户体验优化

### 视觉区分
- **半透明**: 与日程区分开，不会遮挡过多信息
- **虚线边框**: 明确表示这是提醒而非日程
- **斜体**: 进一步强化视觉差异
- **图标**: 🔔 前缀一眼就能识别

### 交互保护
- **拖拽禁用**: 防止用户误操作，提供明确提示
- **确认删除**: 删除前需要确认，避免误删

### 即时反馈
- 所有操作完成后立即刷新日历和列表
- 操作失败时显示错误提示
- 模态框自动关闭，流程顺畅

## 兼容性说明

### 浏览器兼容性
- 使用现代JavaScript（async/await, fetch, arrow functions）
- 需要支持ES6+的浏览器
- CSS使用标准属性，兼容性良好

### 向后兼容
- 不影响现有日程功能
- 提醒系统独立运行
- 可以单独禁用（只需修改 fetchEvents 不加载提醒数据）

## 故障排查

### 常见问题

**Q: 提醒不显示在日历中？**
A: 检查：
1. `/api/reminders/` 是否正常返回数据
2. 提醒状态是否为 `active` 或 `snoozed_*`
3. 浏览器控制台是否有错误
4. 缓存是否更新（硬刷新 Ctrl+F5）

**Q: 点击提醒没有反应？**
A: 检查：
1. `reminderDetailModal` 是否存在于DOM中
2. 控制台是否有JavaScript错误
3. `extendedProps.isReminder` 是否正确设置

**Q: 操作后日历没有刷新？**
A: 检查：
1. API调用是否成功（查看Network面板）
2. `calendar.refetchEvents()` 是否被调用
3. 是否有错误导致代码中断

## 未来改进建议

### 功能增强
1. **批量操作**: 支持一次性标记多个提醒为完成
2. **快捷操作**: 右键菜单快速访问常用操作
3. **通知集成**: 浏览器通知API集成
4. **智能延后**: 根据用户习惯推荐延后时间

### 性能优化
1. **数据缓存**: 缓存提醒数据，减少API调用
2. **增量更新**: 只更新变化的事件，而非全部刷新
3. **懒加载**: 只加载可视范围内的提醒

### UI/UX改进
1. **移动端适配**: 优化小屏幕体验
2. **键盘快捷键**: 支持键盘操作
3. **拖拽创建**: 从日历拖拽创建新提醒
4. **颜色自定义**: 允许用户自定义提醒颜色

## 测试清单

### 功能测试
- [ ] 提醒正确显示在日历中
- [ ] 点击提醒打开详情模态框
- [ ] 完成按钮正常工作
- [ ] 忽略按钮正常工作
- [ ] 延后功能（15分钟、1小时、1天）正常工作
- [ ] 自定义延后正常工作
- [ ] 取消延后正常工作
- [ ] 编辑按钮打开编辑模态框
- [ ] 删除功能正常工作
- [ ] 拖拽被正确禁用并提示
- [ ] 调整大小被正确禁用并提示

### 集成测试
- [ ] 日历操作与左下角列表同步
- [ ] 左下角操作与日历同步
- [ ] 重复提醒正确显示
- [ ] 延后后的提醒时间正确更新
- [ ] 状态变化后日历正确刷新

### 样式测试
- [ ] 提醒显示为半透明
- [ ] 虚线边框正确显示
- [ ] 优先级颜色正确
- [ ] 悬停效果正常
- [ ] 模态框样式正常

## 版本历史

### v20251031-004 (2025-10-31)
- 🐛 修复：点击提醒后模态框未正确显示的问题
  - 添加 `show` 类保持模态框状态
  - 禁用日历交互防止误触发
- ⚡ 优化：提醒时间和标题布局
  - 改为单行显示（时间 + 空格 + 标题）
  - 解决换行导致内容被遮挡的问题

### v20251031-003 (2025-10-31)
- 🐛 修复：点击提醒时错误地打开日程编辑框的问题
  - 在 `setOption('eventClick')` 中也添加了提醒检测逻辑
- ⚡ 优化：提醒时长从15分钟改为30分钟
  - 解决纵向空间不足导致内容显示不全的问题
- ✨ 新增：自定义提醒的时间显示格式
  - 使用 `eventContent` 只显示开始时间（如 "14:30"）
  - 不显示结束时间，因为结束时间无实际意义

### v20251031-002 (2025-10-31)
- ✅ 初始版本发布
- ✅ 完整的提醒日历集成功能
- ✅ 所有核心功能实现
- ✅ 完整的文档编写

---

**开发者**: GitHub Copilot  
**项目**: UniSchedulerSuper  
**文档版本**: 1.0
