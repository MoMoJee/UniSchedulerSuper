# 重复日程截止时间(DDL)功能完整修复文档

## 修复日期
2025-10-14

## 问题描述

### 1. 前端UI控制问题
- **症状**：创建/编辑重复日程时，截止时间可以选择任意日期，不符合"只能设置当天时间点"的需求
- **期望行为**：重复日程的ddl只能选择时间（时分），日期必须锁定为end当天

### 2. 参数传递问题
- **症状**：创建和编辑重复日程时，ddl参数未正确传递到后端
- **表现**：编辑重复日程后ddl丢失或不更新

## 修复方案

### 一、前端UI严格控制

#### 1. 动态切换控件类型 (`updateDdlInputType`)

**位置**：`core/static/js/modal-manager.js` line ~405

**功能**：
- 检测"重复日程"复选框状态
- **重复日程模式**：`<input type="time">` - 只能选时分
- **非重复日程模式**：`<input type="datetime-local">` - 可选日期+时间

**代码**：
```javascript
updateDdlInputType(mode, rruleStr) {
    let isRecurring = false;
    if (mode === 'create') {
        isRecurring = document.getElementById('newEventIsRecurring')?.checked;
    } else {
        if (rruleStr && rruleStr.trim() !== '') {
            isRecurring = true;
        } else {
            isRecurring = document.getElementById('eventRepeat')?.checked;
        }
    }
    const ddlInput = document.getElementById(mode === 'create' ? 'creatEventDdl' : 'eventDdl');
    if (!ddlInput) return;
    
    if (isRecurring) {
        ddlInput.type = 'time';  // 只选时间
        if (ddlInput.value) {
            const t = ddlInput.value.split('T')[1] || ddlInput.value;
            ddlInput.value = t.length > 5 ? t.substring(0, 5) : t;
        }
    } else {
        ddlInput.type = 'datetime-local';  // 完整日期时间
    }
}
```

#### 2. 同步ddl日期与end日期 (`syncDdlWithEnd`)

**位置**：`core/static/js/modal-manager.js` line ~435

**功能**：
- 当end时间变化时，自动更新ddl的日期部分
- 保留用户设置的时间部分

**代码**：
```javascript
syncDdlWithEnd(mode) {
    const endInput = document.getElementById(mode === 'create' ? 'newEventEnd' : 'eventEnd');
    const ddlInput = document.getElementById(mode === 'create' ? 'creatEventDdl' : 'eventDdl');
    if (!endInput || !ddlInput) return;
    
    const endValue = endInput.value;
    if (!endValue) return;
    
    let ddlTime = '23:59';
    if (ddlInput.value) {
        const t = ddlInput.value.split('T')[1] || ddlInput.value;
        ddlTime = t.length > 5 ? t.substring(0, 5) : t;
    }
    
    if (ddlInput.type === 'time') {
        ddlInput.value = ddlTime;
    } else {
        const endDate = endValue.split('T')[0];
        ddlInput.value = `${endDate}T${ddlTime}`;
    }
}
```

#### 3. 事件监听绑定

**位置**：`core/static/js/modal-manager.js` `setupEventListeners()` 方法

**新增监听**：
```javascript
// 重复日程复选框监听（创建模态框）
const newEventIsRecurring = document.getElementById('newEventIsRecurring');
if (newEventIsRecurring) {
    newEventIsRecurring.addEventListener('change', () => {
        this.updateDdlInputType('create');
    });
}

// End时间变化监听（创建模态框）
const newEventEnd = document.getElementById('newEventEnd');
if (newEventEnd) {
    newEventEnd.addEventListener('change', () => {
        if (document.getElementById('newEventIsRecurring')?.checked) {
            this.syncDdlWithEnd('create');
        }
    });
}

// End时间变化监听（编辑模态框）
const eventEnd = document.getElementById('eventEnd');
if (eventEnd) {
    eventEnd.addEventListener('change', () => {
        if (document.getElementById('eventRepeat')?.checked) {
            this.syncDdlWithEnd('edit');
        }
    });
}
```

#### 4. 编辑模态框初始化调用

**位置**：`openEditEventModal()` 和 `handleRecurringCheckboxChange()`

```javascript
// openEditEventModal中初始化
this.updateDdlInputType('edit', event.extendedProps.rrule);

// handleRecurringCheckboxChange中响应变化
this.updateDdlInputType('edit');
```

### 二、数据拼接与传递

#### 1. 表单数据收集 (`getEventFormData`)

**位置**：`core/static/js/modal-manager.js` line ~2220

**修正逻辑**：
```javascript
// 如果是重复日程，强制ddl日期与end日期一致，只保留时间部分
if ((data.rrule && data.rrule.trim() !== '') || document.getElementById(mode === 'create' ? 'newEventIsRecurring' : 'eventRepeat')?.checked) {
    if (data.ddl) {
        // 只保留时间部分
        let ddlTime = data.ddl;
        if (ddlTime.includes('T')) ddlTime = ddlTime.split('T')[1];
        if (ddlTime.length > 5) ddlTime = ddlTime.substring(0, 5);
        const endDate = data.end.split('T')[0];
        data.ddl = `${endDate}T${ddlTime}`;  // 拼接end日期 + 时间
    }
}
```

**工作流程**：
1. 用户选择重复日程，ddl控件变为type="time"，只能输入"HH:MM"
2. 用户修改end日期，ddl的日期自动跟随
3. 提交时，`getEventFormData`自动拼接：`${end日期}T${ddl时间}`
4. 参数传递到后端时格式正确：`"2025-10-14T18:30"`

### 三、语法错误修复

#### 问题
```
Uncaught SyntaxError: Unexpected token '{' (at modal-manager.js:317:40)
```

#### 原因
`updateDdlInputType` 方法定义时缺少 `this.` 前缀，导致不是类方法而是独立函数，语法错误。

#### 修复
- 将 `updateDdlInputType(mode, rruleStr) {` 改为类方法格式
- 确保在类定义内正确位置（`openEditEventModal` 之后）

## 验证测试

### 测试场景1：创建重复日程
1. 打开创建日程模态框
2. 勾选"重复事件"
3. **预期**：截止时间控件变为时间选择器（只有时分）
4. 选择end时间为"2025-10-15 14:00"
5. 选择ddl时间为"18:30"
6. **预期提交数据**：`ddl: "2025-10-15T18:30"`

### 测试场景2：编辑重复日程
1. 打开已有重复日程的编辑模态框
2. **预期**：截止时间控件自动变为时间选择器
3. 显示原有时间部分（如"18:30"）
4. 修改end日期为"2025-10-20 10:00"
5. **预期**：ddl自动更新为"2025-10-20"当天
6. 保存后ddl参数正确传递

### 测试场景3：切换重复/非重复模式
1. 创建日程，勾选"重复事件"
2. **预期**：ddl变为time类型
3. 取消勾选"重复事件"
4. **预期**：ddl恢复为datetime-local类型
5. 再次勾选"重复事件"
6. **预期**：ddl再次变为time类型

### 测试场景4：拖拽超过截止时间
1. 创建一个重复日程，ddl设为"18:00"
2. 拖拽事件使end时间超过当天18:00
3. **预期**：弹出提示并自动弹回原位置

## 技术要点

### 1. 控件类型动态切换
- `<input type="datetime-local">` → `<input type="time">`
- 保留时间值，丢弃日期部分

### 2. 数据格式统一
- **前端输入**：`type="time"` → "HH:MM"
- **前端处理**：拼接end日期 → "YYYY-MM-DDTHH:MM"
- **后端接收**：`data.get('ddl')` → "YYYY-MM-DDTHH:MM"

### 3. 事件联动
- 复选框change → 切换控件类型
- end时间change → 同步ddl日期
- 打开模态框 → 初始化控件类型

## 后续验证

### 前端部分 ✅
- [x] UI控件类型动态切换
- [x] 事件监听正确绑定
- [x] 数据拼接逻辑正确
- [x] 语法错误修复

### 后端部分（待验证）
- [ ] `create_event_impl` 正确接收并保存ddl
- [ ] `bulk_edit_events_impl` 正确接收并保存ddl
- [ ] 重复日程生成实例时，ddl日期正确调整

## 相关文件

- `core/static/js/modal-manager.js` - 前端主要修改
- `core/templates/home_new.html` - HTML控件定义
- `core/views_events.py` - 后端处理（待验证）

## 总结

本次修复完整实现了"重复日程截止时间只能设置时间点，日期锁定为end当天"的需求：

1. **UI严格控制**：通过动态切换控件类型，从根本上限制用户只能选时间
2. **自动同步**：end时间变化时，ddl日期自动跟随
3. **数据保障**：提交时自动拼接正确格式，确保参数传递无误
4. **用户体验**：切换流畅，提示清晰，符合直觉

修复后，用户无法在重复日程中设置错误的截止日期，系统自动保证ddl日期始终等于end日期，只有时间部分可调。
