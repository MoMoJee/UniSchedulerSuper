# 日历主题适配修复总结

## 问题描述
用户报告了3个日历显示问题：
1. 月视图无法用鼠标滚轮上下滚动
2. "第N周"显示没有根据主题变换颜色
3. 各个视图中"今天"的加深背景显示消失了

## 修复方案

### 1. CSS修改 (core/static/css/home-styles.css)

#### 问题1: 月视图滚动支持
```css
/* 月视图滚动支持 */
.fc-dayGridMonth-view .fc-scroller,
.fc-daygrid-body .fc-scroller,
.fc-dayGridMonth-view .fc-view-harness {
    overflow-y: auto !important;
    overflow-x: hidden !important;
}
```

#### 问题2: "第N周"主题适配
```css
/* 月视图周数 */
.fc .fc-daygrid-week-number {
    background: var(--bg-tertiary) !important;
    color: var(--text-secondary) !important;
}

.fc .fc-daygrid-week-number a {
    color: var(--text-secondary) !important;
}
```

#### 问题3: "今天"背景高亮
```css
.fc-day-today {
    background-color: var(--fc-today-bg) !important;
}

/* 确保今天的背景色在所有视图中都生效 */
.fc .fc-day-today,
.fc-daygrid-day.fc-day-today,
.fc-timegrid-col.fc-day-today {
    background-color: var(--fc-today-bg) !important;
}

/* 今天的日期数字也加上轻微的强调 */
.fc .fc-day-today .fc-daygrid-day-number {
    font-weight: 600 !important;
}

/* 列表视图中今天的行 */
.fc .fc-list-day.fc-day-today,
.fc .fc-list-day.fc-day-today .fc-list-day-cushion {
    background-color: var(--fc-today-bg) !important;
    font-weight: 600 !important;
}
```

#### 额外修复: CSS变量错误
```css
/* 修复前（有错误） */
.fc .fc-button-active,
.fc .fc-button-primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark, var(--primary))) !important;
}

/* 修复后 */
.fc .fc-button-active,
.fc .fc-button-primary {
    background: var(--button-bg) !important;
    color: var(--button-text) !important;
    border-color: var(--primary) !important;
}
```

### 2. HTML模板修改 (core/templates/home_new.html)

更新静态文件版本号以清除浏览器缓存：
```html
<!-- 修改前 -->
<link rel="stylesheet" href="{% static 'css/home-styles.css' %}?v=20251103-001">
<script src="{% static 'js/event-manager.js' %}?v=20251031-004"></script>

<!-- 修改后 -->
<link rel="stylesheet" href="{% static 'css/home-styles.css' %}?v=20251104-002">
<script src="{% static 'js/event-manager.js' %}?v=20251104-002"></script>
```

### 3. JavaScript配置 (core/static/js/event-manager.js)

之前已经正确配置了按钮文字和星期名称：
```javascript
// 自定义按钮文字
buttonText: {
    today: '今天',
    month: '月',
    week: '周',
    day: '日',
    list: '列表'
},

// 自定义星期名称
dayHeaderContent: (args) => {
    const dayNames = ['日', '一', '二', '三', '四', '五', '六'];
    return dayNames[args.date.getDay()];
},
```

## 部署步骤

1. **修改源文件**
   - 修改 `core/static/css/home-styles.css`
   - 修改 `core/templates/home_new.html`

2. **收集静态文件**
   ```bash
   D:/PROJECTS/UniSchedulerSuper/.venv/Scripts/python.exe manage.py collectstatic --noinput
   ```

3. **清除浏览器缓存**
   - 方法1: 硬刷新 (Ctrl + F5 或 Ctrl + Shift + R)
   - 方法2: 清除浏览器缓存
   - 方法3: 使用无痕模式测试

## 验证清单

### CSS验证
- [ ] 月视图可以用鼠标滚轮滚动
- [ ] "第N周"显示颜色跟随主题变化
- [ ] "今天"在月视图有背景高亮
- [ ] "今天"在周视图有背景高亮
- [ ] "今天"在列表视图有背景高亮
- [ ] "今天"的日期数字加粗显示
- [ ] 无CSS错误（--primary-dark已修复）

### JavaScript验证
- [ ] 按钮显示中文（列表、月、周、日、今天）
- [ ] 星期显示为"一二三四五六日"而非"周一周二..."
- [ ] 无控制台JavaScript错误

### 浏览器调试
打开浏览器开发者工具（F12）：
1. **Network标签页**
   - 查看 `home-styles.css?v=20251104-002` 是否加载
   - 查看 `event-manager.js?v=20251104-002` 是否加载
   - 确认状态码为 200（不是 304）

2. **Console标签页**
   - 检查是否有JavaScript错误
   - 检查FullCalendar的配置是否正确

3. **Elements标签页**
   - 检查日历元素的computed styles
   - 验证CSS变量是否正确应用

## 注意事项

1. **DEBUG模式**
   - 当前 `settings.py` 中 `DEBUG = True`
   - Django会直接从 `core/static/` 加载文件
   - 但浏览器缓存仍可能导致旧文件被使用

2. **版本号机制**
   - HTML中使用 `?v=20251104-002` 参数
   - 每次修改CSS/JS后需要更新版本号
   - 这会强制浏览器重新下载文件

3. **静态文件收集**
   - 生产环境需要运行 `collectstatic`
   - 开发环境(DEBUG=True)可直接使用源文件
   - 建议每次修改后都运行一次确保一致性

## 相关文件清单

### 已修改文件
- `core/static/css/home-styles.css` - CSS样式修复
- `core/templates/home_new.html` - 版本号更新
- `staticfiles/css/home-styles.css` - 自动收集的副本

### 相关但未修改文件
- `core/static/js/event-manager.js` - 已包含正确配置
- `staticfiles/js/event-manager.js` - 自动收集的副本

## 问题排查

如果修改仍未生效，请按以下步骤排查：

1. **确认文件已修改**
   ```bash
   # 检查CSS文件修改时间
   Get-Item "d:\PROJECTS\UniSchedulerSuper\core\static\css\home-styles.css" | Select-Object LastWriteTime
   ```

2. **确认静态文件已收集**
   ```bash
   # 比较源文件和静态文件
   $hash1 = Get-FileHash "d:\PROJECTS\UniSchedulerSuper\core\static\css\home-styles.css" -Algorithm MD5
   $hash2 = Get-FileHash "d:\PROJECTS\UniSchedulerSuper\staticfiles\css\home-styles.css" -Algorithm MD5
   if ($hash1.Hash -eq $hash2.Hash) { "文件一致" } else { "文件不一致" }
   ```

3. **确认浏览器加载新文件**
   - F12打开开发者工具
   - Network标签页
   - 刷新页面
   - 查找 `home-styles.css?v=20251104-002`
   - 确认请求头中无 `from disk cache` 或 `from memory cache`

4. **重启Django服务器**
   - 虽然DEBUG模式下不需要，但有时重启可以解决问题
   - Ctrl+C 停止服务器
   - 重新运行 `python manage.py runserver`

## 最终效果

修复完成后，日历应该具有以下特性：
- ✅ 所有视图都支持主题适配
- ✅ 月视图支持鼠标滚轮滚动
- ✅ "第N周"颜色跟随主题变化
- ✅ "今天"在所有视图中都有明显的背景高亮
- ✅ 按钮文字全部中文化
- ✅ 星期名称简洁显示
- ✅ 无CSS或JavaScript错误
