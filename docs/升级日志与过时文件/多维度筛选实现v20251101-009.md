# 多维度筛选实现 v20251101-009

## 修复日期
2025年11月1日

## 问题描述

用户报告了两个关键问题：

### 问题1：筛选器变更不刷新日历
在左侧提醒框中改变筛选器后，日历框没有立即刷新显示。

**根因**：`applyFilters()` 已经调用了 `calendar.refetchEvents()`，但可能存在时序问题。

### 问题2：只有状态筛选生效
左侧提醒框有四个筛选器：
- ✅ **状态**（活跃/已完成/已忽略/已延后/全部）- 已生效
- ❌ **优先级**（紧急/高/普通/低/全部）- 未生效
- ❌ **类型**（单次/重复/已分离/全部）- 未生效
- ⏭️ **时间范围**（今天/本周/本月等）- 用户要求不应用到日历

**用户需求**：
- 时间筛选：❌ 不应用到日历（只在左下角列表生效）
- 优先级筛选：✅ 应用到日历
- 类型筛选：✅ 应用到日历
- 状态筛选：✅ 应用到日历

## 根本原因分析

### 原因1：fetchEvents 只读取了状态筛选器

**错误代码** (`event-manager.js`):
```javascript
// ❌ 只读取了状态筛选器
const statusFilter = document.getElementById('reminderStatusFilter')?.value || 'active';

const filteredReminders = reminders.filter(reminder => {
    // 只有状态筛选
    if (statusFilter && statusFilter !== 'all') {
        if (statusFilter === 'snoozed') {
            if (!reminder.status.startsWith('snoozed_')) return false;
        } else {
            if (reminder.status !== statusFilter) return false;
        }
    }
    return true;  // ❌ 没有检查优先级和类型
});
```

### 原因2：优先级筛选器选项值错误

**HTML筛选器** (`home_new.html`):
```html
<!-- ❌ 错误的优先级值 -->
<select id="reminderPriorityFilter">
    <option value="critical">紧急</option>
    <option value="high">高优先级</option>
    <option value="medium">中优先级</option>
    <option value="low">低优先级</option>
</select>
```

**实际数据使用的值** (来自新建/编辑提醒表单):
```html
<!-- ✅ 正确的优先级值 -->
<select id="newReminderPriority">
    <option value="urgent">紧急</option>
    <option value="high">高</option>
    <option value="normal">普通</option>
    <option value="low">低</option>
</select>
```

**问题**：
- 筛选器使用 `critical/high/medium/low`
- 实际数据使用 `urgent/high/normal/low`
- 即使读取了优先级筛选器，也无法匹配到数据

### 原因3：applyFilters 确实调用了刷新

**验证** (`reminder-manager.js`):
```javascript
applyFilters(providedFilters = null) {
    // ... 读取筛选器值 ...
    
    this.renderReminders(filters);
    
    // ✅ 已经调用了日历刷新
    if (window.eventManager && window.eventManager.calendar) {
        console.log('刷新日历视图中的提醒');
        window.eventManager.calendar.refetchEvents();
    }
}
```

**结论**：问题1实际上已经修复（v20251101-008），但问题2导致看起来像没刷新。

## 解决方案

### 修复1：在 fetchEvents 中读取所有筛选器

**修改文件**: `staticfiles/js/event-manager.js` 和 `core/static/js/event-manager.js`

```javascript
// ✅ 读取所有需要的筛选器
const statusFilter = document.getElementById('reminderStatusFilter')?.value || 'active';
const priorityFilter = document.getElementById('reminderPriorityFilter')?.value || 'all';
const typeFilter = document.getElementById('reminderTypeFilter')?.value || 'all';

console.log('日历fetchEvents - 筛选器设置:', {
    status: statusFilter,
    priority: priorityFilter,
    type: typeFilter
});

// ✅ 应用所有筛选条件
const filteredReminders = reminders.filter(reminder => {
    // 状态筛选
    if (statusFilter && statusFilter !== 'all') {
        if (statusFilter === 'snoozed') {
            if (!reminder.status.startsWith('snoozed_')) return false;
        } else {
            if (reminder.status !== statusFilter) return false;
        }
    }
    
    // ✅ 优先级筛选
    if (priorityFilter && priorityFilter !== 'all') {
        if (reminder.priority !== priorityFilter) return false;
    }
    
    // ✅ 类型筛选（单次/重复）
    if (typeFilter && typeFilter !== 'all') {
        const hasRRule = reminder.rrule && reminder.rrule.includes('FREQ=');
        if (typeFilter === 'recurring' && !hasRRule) return false;
        if (typeFilter === 'single' && hasRRule) return false;
        if (typeFilter === 'detached' && !reminder.is_detached) return false;
    }
    
    return true;
});
```

### 修复2：修正优先级筛选器的选项值

**修改文件**: `core/templates/home_new.html`

```html
<!-- ✅ 修正后的优先级筛选器 -->
<select id="reminderPriorityFilter" class="form-select form-select-sm">
    <option value="all">全部优先级</option>
    <option value="urgent">紧急</option>
    <option value="high">高</option>
    <option value="normal">普通</option>
    <option value="low">低</option>
</select>
```

**对比**：
| Before | After | 说明 |
|--------|-------|------|
| `critical` | `urgent` | ✅ 与数据一致 |
| `high` | `high` | ✅ 保持不变 |
| `medium` | `normal` | ✅ 与数据一致 |
| `low` | `low` | ✅ 保持不变 |

## 修改的文件

### 1. staticfiles/js/event-manager.js
- 在 `fetchEvents()` 中添加优先级和类型筛选器读取
- 实现三维度筛选逻辑（状态 + 优先级 + 类型）
- 添加调试日志输出所有筛选器值

### 2. core/static/js/event-manager.js
- 同步上述修改

### 3. core/templates/home_new.html
- 修正 `reminderPriorityFilter` 的选项值
- 版本号更新为 v20251101-009

## 技术细节

### 筛选器应用范围

| 筛选器 | 左下角列表 | 日历视图 | 说明 |
|--------|-----------|---------|------|
| 时间范围 | ✅ | ❌ | 日历本身有时间轴，不需要额外筛选 |
| 状态 | ✅ | ✅ | 完全同步 |
| 优先级 | ✅ | ✅ | 完全同步（v009新增） |
| 类型 | ✅ | ✅ | 完全同步（v009新增） |

### 筛选逻辑详解

#### 状态筛选
```javascript
if (statusFilter !== 'all') {
    if (statusFilter === 'snoozed') {
        // 匹配所有延后状态：snoozed_15m, snoozed_1h, snoozed_1d, snoozed_custom
        if (!reminder.status.startsWith('snoozed_')) return false;
    } else {
        // 精确匹配：active, completed, dismissed
        if (reminder.status !== statusFilter) return false;
    }
}
```

#### 优先级筛选
```javascript
if (priorityFilter !== 'all') {
    // 精确匹配：urgent, high, normal, low
    if (reminder.priority !== priorityFilter) return false;
}
```

#### 类型筛选
```javascript
if (typeFilter !== 'all') {
    const hasRRule = reminder.rrule && reminder.rrule.includes('FREQ=');
    
    if (typeFilter === 'recurring') {
        // 重复提醒：有有效的RRule
        if (!hasRRule) return false;
    } else if (typeFilter === 'single') {
        // 单次提醒：没有RRule
        if (hasRRule) return false;
    } else if (typeFilter === 'detached') {
        // 已分离提醒：从重复系列中分离出来的单个实例
        if (!reminder.is_detached) return false;
    }
}
```

### 筛选器变更流程

```
用户改变任一筛选器
  ↓
change事件触发
  ↓
reminderManager.applyFilters()
  ↓
├─ 读取所有筛选器值（时间/状态/优先级/类型）
├─ settingsManager保存设置
├─ renderReminders(filters) - 刷新左下角列表（应用所有4个筛选器）
  └─ calendar.refetchEvents() - 触发日历刷新
        ↓
      fetchEvents()
        ↓
      读取筛选器（状态/优先级/类型，不含时间）
        ↓
      过滤reminders数据
        ↓
      转换为日历事件格式
        ↓
      显示在日历中
```

## 测试验证

### 测试场景1：优先级筛选
1. 创建多个不同优先级的提醒（紧急/高/普通/低）
2. 在左下角筛选器选择"优先级" → "紧急"
3. ✅ **日历只显示红色边框的紧急提醒**
4. 改为"全部优先级"
5. ✅ **日历显示所有提醒**

### 测试场景2：类型筛选
1. 创建单次提醒和重复提醒
2. 在左下角筛选器选择"类型" → "重复提醒"
3. ✅ **日历只显示重复提醒**
4. 改为"单次提醒"
5. ✅ **日历只显示单次提醒**
6. 改为"全部类型"
7. ✅ **日历显示所有提醒**

### 测试场景3：组合筛选
1. 设置状态="活跃"，优先级="紧急"，类型="重复提醒"
2. ✅ **日历只显示：活跃状态 + 紧急优先级 + 重复类型的提醒**
3. 改变任一筛选器
4. ✅ **日历立即刷新显示新结果**

### 测试场景4：筛选器UI同步
1. 设置优先级="高"
2. 刷新浏览器
3. ✅ **筛选器显示"高"**
4. ✅ **日历显示匹配"高"优先级的提醒**

### 测试场景5：时间筛选不影响日历
1. 设置时间范围="今天"
2. ✅ **左下角列表只显示今天的提醒**
3. ✅ **日历仍显示所有时间的提醒**（因为日历有自己的时间轴）
4. 设置状态="已完成"
5. ✅ **左下角列表显示今天的已完成提醒**
6. ✅ **日历显示所有已完成提醒**（不限时间）

## 调试日志

添加了详细的调试日志：

```javascript
console.log('日历fetchEvents - 筛选器设置:', {
    status: statusFilter,
    priority: priorityFilter,
    type: typeFilter
});
```

**输出示例**：
```
日历fetchEvents - 筛选器设置: {
  status: "active",
  priority: "urgent",
  type: "recurring"
}
```

## 相关版本历史
- v20251031-002: 初始提醒日历集成
- v20251031-003~006: 功能完善和颜色方案
- v20251031-007: 强化刷新机制
- v20251101-008: 修复筛选器默认值 + 延后刷新
- **v20251101-009**: **实现多维度筛选（状态+优先级+类型）+ 修复优先级选项值**

## 核心改进总结

### Before (v20251101-008)
- ✅ 状态筛选生效
- ❌ 优先级筛选不生效（选项值错误）
- ❌ 类型筛选不生效（未读取）
- ⚠️ 时间筛选应用到日历（不符合需求）

### After (v20251101-009)
- ✅ 状态筛选生效
- ✅ 优先级筛选生效（修正选项值 + 实现逻辑）
- ✅ 类型筛选生效（实现逻辑）
- ✅ 时间筛选不应用到日历（符合需求）
- ✅ 筛选器变更立即刷新日历
- ✅ 调试日志完善

## 优先级值映射表

为了避免将来混淆，这里记录所有相关的优先级值：

| 位置 | 字段名 | 值 | 说明 |
|------|--------|-----|------|
| 提醒数据 | `priority` | `urgent` `high` `normal` `low` | ✅ 标准值 |
| 新建表单 | `newReminderPriority` | `urgent` `high` `normal` `low` | ✅ 与数据一致 |
| 编辑表单 | `reminderPriority` | `urgent` `high` `normal` `low` | ✅ 与数据一致 |
| 筛选器（旧） | `reminderPriorityFilter` | `critical` `high` `medium` `low` | ❌ 错误 |
| 筛选器（新） | `reminderPriorityFilter` | `urgent` `high` `normal` `low` | ✅ 已修正 |

## 注意事项

### 关于时间筛选
时间筛选器（今天/本周/本月/季度/年）**仅在左下角提醒列表生效**，不会应用到日历视图。这是合理的设计，因为：
- 日历本身就有时间轴导航
- 用户可以通过日历的前进/后退按钮查看不同时间段
- 强制时间筛选会限制日历的导航功能

### 关于已分离提醒
"已分离"类型指的是从重复提醒系列中分离出来的单个实例。这种提醒：
- 原本属于某个重复系列
- 用户选择"仅此提醒"进行编辑后
- 从系列中分离，成为独立的单次提醒
- 标记为 `is_detached: true`

### 关于筛选器持久化
所有筛选器设置通过 `settingsManager` 保存到后端，刷新后会恢复上次的选择。这包括：
- 时间范围
- 状态
- 优先级
- 类型

## 性能考虑

当前实现在每次筛选器变更时都会：
1. 重新获取所有提醒数据（`/api/reminders/`）
2. 在前端过滤
3. 渲染到日历

**优化空间**：
- 可以在后端API支持筛选参数
- 减少数据传输量
- 但当前数据量不大，暂无必要优化
