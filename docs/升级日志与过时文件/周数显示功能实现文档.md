# å‘¨æ•°æ˜¾ç¤ºåŠŸèƒ½å®ç°æ–‡æ¡£

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

**ç‰ˆæœ¬**: v20251102-005  
**æ—¥æœŸ**: 2025-11-02  
**åŠŸèƒ½**: åœ¨æ—¥å†æ ‡é¢˜æ—æ˜¾ç¤º"ç¬¬Nå‘¨"å¾½ç« 

## âœ¨ åŠŸèƒ½æè¿°

åœ¨æ—¥å†å·¥å…·æ æ ‡é¢˜çš„å³ä¾§åŠ¨æ€æ˜¾ç¤ºå½“å‰è§†å›¾æ‰€åœ¨çš„å‘¨æ•°,ä¾‹å¦‚"ç¬¬ 36 å‘¨"ã€‚å‘¨æ•°æ ¹æ®ç”¨æˆ·è®¾ç½®çš„å­¦æœŸ/å¹´åº¦èµ·å§‹æ—¥æœŸè®¡ç®—ã€‚

### æ˜¾ç¤ºæ•ˆæœ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2025å¹´11æœˆ2æ—¥ â€“ 8æ—¥  [ç¬¬ 36 å‘¨]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç‰¹æ€§

- âœ… **åŠ¨æ€è®¡ç®—**: æ ¹æ®ç”¨æˆ·è®¾ç½®çš„èµ·å§‹æ—¥æœŸè‡ªåŠ¨è®¡ç®—å‘¨æ•°
- âœ… **è‡ªåŠ¨æ›´æ–°**: åˆ‡æ¢æ—¥æœŸæˆ–è§†å›¾æ—¶è‡ªåŠ¨æ›´æ–°æ˜¾ç¤º
- âœ… **ç”¨æˆ·å¯é…ç½®**: æ”¯æŒåœ¨è®¾ç½®ä¸­è‡ªå®šä¹‰å­¦æœŸèµ·å§‹æ—¥æœŸ
- âœ… **å‰ç«¯å®ç°**: å…¨éƒ¨é€»è¾‘åœ¨å‰ç«¯JavaScriptä¸­,æ— éœ€åç«¯è®¡ç®—
- âœ… **å®æ—¶å“åº”**: è§†å›¾å˜åŒ–ç«‹å³æ›´æ–°,æ— å»¶è¿Ÿ

## ğŸ¯ å®ç°ç»†èŠ‚

### 1. å‘¨æ•°è®¡ç®—é€»è¾‘ (JavaScript)

#### æ ¸å¿ƒç®—æ³•
```javascript
function calculateWeekNumber(date = new Date()) {
    // ä»ç”¨æˆ·è®¾ç½®ä¸­è·å–å‘¨æ•°èµ·å§‹æ—¥æœŸ
    const settings = window.userSettings || {};
    const weekNumberStart = settings.week_number_start || { month: 2, day: 24 };
    
    // åˆ›å»ºèµ·å§‹æ—¥æœŸï¼ˆå½“å¹´çš„æŒ‡å®šæœˆæ—¥ï¼‰
    const currentYear = date.getFullYear();
    const startDate = new Date(currentYear, weekNumberStart.month - 1, weekNumberStart.day);
    
    // å¦‚æœå½“å‰æ—¥æœŸæ—©äºèµ·å§‹æ—¥æœŸï¼Œä½¿ç”¨å»å¹´çš„èµ·å§‹æ—¥æœŸ
    if (date < startDate) {
        startDate.setFullYear(currentYear - 1);
    }
    
    // è®¡ç®—å¤©æ•°å·®
    const diffTime = date - startDate;
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    
    // è®¡ç®—å‘¨æ•°ï¼ˆä»ç¬¬1å‘¨å¼€å§‹ï¼‰
    const weekNumber = Math.floor(diffDays / 7) + 1;
    
    return weekNumber;
}
```

#### è®¡ç®—è§„åˆ™

1. **èµ·å§‹æ—¥æœŸ**: ä»ç”¨æˆ·è®¾ç½®çš„ `week_number_start` è·å–(é»˜è®¤: 2æœˆ24æ—¥)
2. **è·¨å¹´å¤„ç†**: å¦‚æœå½“å‰æ—¥æœŸæ—©äºä»Šå¹´çš„èµ·å§‹æ—¥æœŸ,ä½¿ç”¨å»å¹´çš„èµ·å§‹æ—¥æœŸ
3. **å‘¨æ•°å…¬å¼**: `å‘¨æ•° = floor((å½“å‰æ—¥æœŸ - èµ·å§‹æ—¥æœŸ) / 7) + 1`
4. **ä»1å¼€å§‹**: èµ·å§‹æ—¥æœŸæ‰€åœ¨å‘¨ä¸ºç¬¬1å‘¨

### 2. åŠ¨æ€æ˜¾ç¤ºå®ç°

#### åˆ›å»ºå¾½ç« å…ƒç´ 
```javascript
function updateWeekNumberDisplay() {
    // è·å–æ—¥å†å®ä¾‹
    const calendarInstance = window.eventManager?.calendar;
    if (!calendarInstance) return;
    
    // è·å–å½“å‰è§†å›¾çš„æ—¥æœŸ
    const currentDate = calendarInstance.getDate();
    const weekNumber = calculateWeekNumber(currentDate);
    
    // æŸ¥æ‰¾æˆ–åˆ›å»ºå‘¨æ•°æ˜¾ç¤ºå…ƒç´ 
    let weekBadge = document.getElementById('weekNumberBadge');
    const toolbarTitle = document.querySelector('.fc-toolbar-title');
    
    if (!weekBadge) {
        // åˆ›å»ºå‘¨æ•°å¾½ç« å…ƒç´ 
        weekBadge = document.createElement('span');
        weekBadge.id = 'weekNumberBadge';
        weekBadge.className = 'badge bg-primary ms-3';
        weekBadge.style.fontSize = '0.9rem';
        weekBadge.style.verticalAlign = 'middle';
        
        // æ’å…¥åˆ°æ ‡é¢˜åé¢
        toolbarTitle.appendChild(weekBadge);
    }
    
    // æ›´æ–°å‘¨æ•°æ–‡æœ¬
    weekBadge.textContent = `ç¬¬ ${weekNumber} å‘¨`;
}
```

#### æ ·å¼è¯´æ˜
- **Bootstrapå¾½ç« **: ä½¿ç”¨ `badge bg-primary` ç±»
- **å·¦è¾¹è·**: `ms-3` (margin-start: 1rem)
- **å­—ä½“å¤§å°**: 0.9rem (ç•¥å°äºæ ‡é¢˜)
- **å‚ç›´å¯¹é½**: middle (ä¸æ ‡é¢˜æ–‡å­—å¯¹é½)

### 3. äº‹ä»¶ç›‘å¬ä¸è‡ªåŠ¨æ›´æ–°

#### åˆå§‹åŒ–å‡½æ•°
```javascript
function initWeekNumberDisplay() {
    // ç­‰å¾…æ—¥å†åˆå§‹åŒ–å®Œæˆ
    const checkCalendar = setInterval(() => {
        if (window.eventManager?.calendar) {
            clearInterval(checkCalendar);
            
            // é¦–æ¬¡æ˜¾ç¤ºå‘¨æ•°
            setTimeout(() => {
                updateWeekNumberDisplay();
            }, 500);
            
            // ç›‘å¬æ—¥å†è§†å›¾å˜åŒ–
            const calendarInstance = window.eventManager.calendar;
            
            // ä½¿ç”¨FullCalendarçš„datesSetäº‹ä»¶ç›‘å¬æ—¥æœŸå˜åŒ–
            calendarInstance.on('datesSet', function(info) {
                console.log('æ—¥å†è§†å›¾å·²å˜åŒ–ï¼Œæ›´æ–°å‘¨æ•°');
                updateWeekNumberDisplay();
            });
            
            console.log('âœ… å‘¨æ•°æ˜¾ç¤ºåŠŸèƒ½å·²åˆå§‹åŒ–');
        }
    }, 100);
    
    // 30ç§’ååœæ­¢æ£€æŸ¥ï¼ˆé˜²æ­¢æ— é™å¾ªç¯ï¼‰
    setTimeout(() => {
        clearInterval(checkCalendar);
    }, 30000);
}
```

#### è§¦å‘æ›´æ–°çš„åœºæ™¯
- âœ… é¡µé¢åŠ è½½å®Œæˆ
- âœ… åˆ‡æ¢æ—¥å†è§†å›¾(æœˆ/å‘¨/æ—¥)
- âœ… ç‚¹å‡»å‰è¿›/åé€€æŒ‰é’®
- âœ… ç‚¹å‡»"ä»Šå¤©"æŒ‰é’®
- âœ… é€‰æ‹©æ—¥æœŸè·³è½¬

### 4. é¡µé¢åˆå§‹åŒ–é›†æˆ

åœ¨ `DOMContentLoaded` äº‹ä»¶ä¸­è°ƒç”¨:

```javascript
document.addEventListener('DOMContentLoaded', function() {
    // ... å…¶ä»–åˆå§‹åŒ–ä»£ç 
    
    // åˆå§‹åŒ–å‘¨æ•°æ˜¾ç¤ºåŠŸèƒ½
    initWeekNumberDisplay();
    
    console.log('UniSchedulerSuper ç³»ç»Ÿå·²åˆå§‹åŒ–å®Œæˆ');
});
```

### 5. åç«¯ä»£ç æ¸…ç† (views.py)

#### ç§»é™¤çš„ä»£ç 
```python
# å·²åˆ é™¤ - å‘¨æ•°è®¡ç®—å·²è¿ç§»åˆ°å‰ç«¯
week_number_start = user_preference["week_number_start"]
start_date = datetime.date(datetime.date.today().year, week_number_start["month"], week_number_start["day"])
delta = datetime.date.today() - start_date
week_number = delta.days // 7 + 1

context = {
    "currentWeek": week_number,  # å·²åˆ é™¤
    # ...
}
```

#### æ·»åŠ çš„æ³¨é‡Š
```python
# å‘¨æ•°è®¡ç®—å·²è¿ç§»åˆ°å‰ç«¯JavaScript - 2025-11-02
# å‰ç«¯ä¼šæ ¹æ®ç”¨æˆ·è®¾ç½®çš„week_number_startè‡ªåŠ¨è®¡ç®—å¹¶æ˜¾ç¤º
```

## ğŸ“ ç”¨æˆ·è®¾ç½®

### é…ç½®èµ·å§‹æ—¥æœŸ

ç”¨æˆ·å¯ä»¥åœ¨è®¾ç½®ä¸­ä¿®æ”¹å­¦æœŸ/å¹´åº¦èµ·å§‹æ—¥æœŸ:

1. æ‰“å¼€è®¾ç½®: ç”¨æˆ·å¤´åƒ â†’ è®¾ç½®
2. åˆ‡æ¢åˆ°"åŸºæœ¬è®¾ç½®"æ ‡ç­¾
3. è®¾ç½®"å‘¨æ•°èµ·å§‹æœˆä»½"å’Œ"å‘¨æ•°èµ·å§‹æ—¥æœŸ"
4. ä¿å­˜è®¾ç½®

**æ³¨æ„**: æ­¤åŠŸèƒ½ç›®å‰æ ‡è®°ä¸º"å³å°†æ¨å‡º",UIå·²ç¦ç”¨,ä½†åç«¯æ•°æ®ç»“æ„å·²å°±ç»ªã€‚

### é»˜è®¤è®¾ç½®
```json
{
  "week_number_start": {
    "month": 2,
    "day": 24
  }
}
```

## ğŸ” æŠ€æœ¯è¦ç‚¹

### 1. ä¾èµ–ç”¨æˆ·è®¾ç½®

å‘¨æ•°è®¡ç®—ä¾èµ– `window.userSettings.week_number_start`:
- é¡µé¢åŠ è½½æ—¶é€šè¿‡ `loadUserSettingsToGlobal()` åŠ è½½
- å­˜å‚¨åœ¨å…¨å±€å˜é‡ `window.userSettings`
- å¦‚æœæœªåŠ è½½,ä½¿ç”¨é»˜è®¤å€¼ `{month: 2, day: 24}`

### 2. æ—¶åºæ§åˆ¶

```
é¡µé¢åŠ è½½
  â†“
åŠ è½½ç”¨æˆ·è®¾ç½® (å¼‚æ­¥)
  â†“
åˆå§‹åŒ–æ—¥å†
  â†“
åˆå§‹åŒ–å‘¨æ•°æ˜¾ç¤º
  â†“
ç­‰å¾…æ—¥å†ready
  â†“
é¦–æ¬¡æ˜¾ç¤ºå‘¨æ•°
  â†“
ç›‘å¬datesSetäº‹ä»¶
  â†“
è‡ªåŠ¨æ›´æ–°å‘¨æ•°
```

### 3. FullCalendaräº‹ä»¶

ä½¿ç”¨ `datesSet` äº‹ä»¶ç›‘å¬è§†å›¾å˜åŒ–:

```javascript
calendar.on('datesSet', function(info) {
    // info.start - è§†å›¾å¼€å§‹æ—¥æœŸ
    // info.end - è§†å›¾ç»“æŸæ—¥æœŸ
    // info.view - å½“å‰è§†å›¾å¯¹è±¡
    updateWeekNumberDisplay();
});
```

### 4. è·¨å¹´å¤„ç†

```javascript
// ç¤ºä¾‹: 2024å¹´2æœˆ24æ—¥èµ·å§‹
// 2024-02-23 â†’ ä½¿ç”¨2023å¹´çš„èµ·å§‹æ—¥æœŸ (2023-02-24)
// 2024-02-24 â†’ ä½¿ç”¨2024å¹´çš„èµ·å§‹æ—¥æœŸ (2024-02-24)
// 2024-02-25 â†’ ä½¿ç”¨2024å¹´çš„èµ·å§‹æ—¥æœŸ (2024-02-24)
```

## ğŸ“Š ä»£ç æ–‡ä»¶

### å‰ç«¯æ–‡ä»¶
- `core/templates/home_new.html`
  - `calculateWeekNumber()` - å‘¨æ•°è®¡ç®—
  - `updateWeekNumberDisplay()` - æ›´æ–°æ˜¾ç¤º
  - `initWeekNumberDisplay()` - åˆå§‹åŒ–

### åç«¯æ–‡ä»¶
- `core/views.py`
  - ç§»é™¤äº† `currentWeek` ç›¸å…³ä»£ç 
  - æ·»åŠ äº†è¿ç§»æ³¨é‡Š

### æ•°æ®æ¨¡å‹
- `core/models.py`
  - `user_preference.week_number_start` - èµ·å§‹æ—¥æœŸé…ç½®

### æ–‡æ¡£æ–‡ä»¶
- `docs/å‘¨æ•°æ˜¾ç¤ºåŠŸèƒ½å®ç°æ–‡æ¡£.md` - æœ¬æ–‡æ¡£

## âœ… æµ‹è¯•æ¸…å•

- [ ] é¡µé¢åŠ è½½åå¾½ç« æ­£ç¡®æ˜¾ç¤º
- [ ] åˆ‡æ¢åˆ°ä¸åŒå‘¨æ—¶å‘¨æ•°æ­£ç¡®æ›´æ–°
- [ ] åˆ‡æ¢ä¸åŒè§†å›¾(æœˆ/å‘¨/æ—¥)å‘¨æ•°æ­£ç¡®
- [ ] ç‚¹å‡»"ä»Šå¤©"æŒ‰é’®å‘¨æ•°æ›´æ–°
- [ ] è·¨å¹´åœºæ™¯å‘¨æ•°è®¡ç®—æ­£ç¡®
- [ ] ä¿®æ”¹èµ·å§‹æ—¥æœŸåå‘¨æ•°é‡æ–°è®¡ç®—
- [ ] æ§åˆ¶å°æ— é”™è¯¯ä¿¡æ¯
- [ ] å¾½ç« æ ·å¼ç¬¦åˆè®¾è®¡

## ğŸ¨ æ ·å¼å®šåˆ¶

### ä¿®æ”¹å¾½ç« é¢œè‰²
```javascript
weekBadge.className = 'badge bg-success ms-3';  // ç»¿è‰²
weekBadge.className = 'badge bg-warning ms-3';  // é»„è‰²
weekBadge.className = 'badge bg-danger ms-3';   // çº¢è‰²
```

### ä¿®æ”¹å¾½ç« å¤§å°
```javascript
weekBadge.style.fontSize = '1.0rem';  // æ›´å¤§
weekBadge.style.fontSize = '0.8rem';  // æ›´å°
```

### ä¿®æ”¹é—´è·
```javascript
weekBadge.className = 'badge bg-primary ms-2';  // æ›´è¿‘
weekBadge.className = 'badge bg-primary ms-4';  // æ›´è¿œ
```

## ğŸ› å¸¸è§é—®é¢˜

### Q: å‘¨æ•°æ˜¾ç¤ºä¸æ­£ç¡®?
A: æ£€æŸ¥ç”¨æˆ·è®¾ç½®ä¸­çš„ `week_number_start` æ˜¯å¦æ­£ç¡®ã€‚é»˜è®¤ä¸º2æœˆ24æ—¥ã€‚

### Q: å¾½ç« æ²¡æœ‰å‡ºç°?
A: æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°,ç¡®è®¤:
1. æ—¥å†å·²åˆå§‹åŒ– (`window.eventManager.calendar` å­˜åœ¨)
2. `initWeekNumberDisplay()` å·²è°ƒç”¨
3. æ²¡æœ‰JavaScripté”™è¯¯

### Q: åˆ‡æ¢è§†å›¾åå‘¨æ•°ä¸æ›´æ–°?
A: æ£€æŸ¥ `datesSet` äº‹ä»¶ç›‘å¬æ˜¯å¦æ­£å¸¸:
```javascript
console.log('datesSetç›‘å¬å·²æ³¨å†Œ:', !!calendarInstance._handlers?.datesSet);
```

### Q: å¦‚ä½•ä¿®æ”¹é»˜è®¤èµ·å§‹æ—¥æœŸ?
A: ä¿®æ”¹ `loadUserSettingsToGlobal()` ä¸­çš„é»˜è®¤å€¼:
```javascript
window.userSettings = {
    week_number_start: { month: 9, day: 1 }  // æ”¹ä¸º9æœˆ1æ—¥
};
```

## ğŸ’¡ æœªæ¥æ”¹è¿›

1. **å¯ç”¨è®¾ç½®UI**: å…è®¸ç”¨æˆ·åœ¨ç•Œé¢ä¸­ä¿®æ”¹èµ·å§‹æ—¥æœŸ
2. **å¤šèµ·å§‹æ—¥æœŸ**: æ”¯æŒä¸åŒå­¦æœŸä½¿ç”¨ä¸åŒèµ·å§‹æ—¥æœŸ
3. **å­¦æœŸæ¨¡å¼**: è‡ªåŠ¨è¯†åˆ«å­¦æœŸ(æ˜¥/ç§‹)å¹¶ä½¿ç”¨å¯¹åº”èµ·å§‹æ—¥æœŸ
4. **å‘¨æ•°æ ·å¼**: æ ¹æ®å‘¨æ•°èŒƒå›´æ˜¾ç¤ºä¸åŒé¢œè‰²(å¼€å­¦/æœŸä¸­/æœŸæœ«)
5. **æ‚¬åœæç¤º**: é¼ æ ‡æ‚¬åœæ˜¾ç¤ºèµ·å§‹æ—¥æœŸå’Œå¤©æ•°ä¿¡æ¯
6. **å¿«é€Ÿè·³è½¬**: ç‚¹å‡»å‘¨æ•°å¾½ç« å¿«é€Ÿè·³è½¬åˆ°è¯¥å‘¨çš„å¼€å§‹

## ğŸ‰ ç‰ˆæœ¬å†å²

- **v20251102-005**: å®Œæ•´å®ç°å‘¨æ•°æ˜¾ç¤ºåŠŸèƒ½
  - âœ… å‰ç«¯å‘¨æ•°è®¡ç®—
  - âœ… åŠ¨æ€å¾½ç« æ˜¾ç¤º
  - âœ… è‡ªåŠ¨æ›´æ–°æœºåˆ¶
  - âœ… åç«¯ä»£ç æ¸…ç†
  - âœ… å®Œæ•´æ–‡æ¡£

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [è‡ªåŠ¨DDLåŠŸèƒ½è¯´æ˜.md](è‡ªåŠ¨DDLåŠŸèƒ½è¯´æ˜.md)
- [ç”¨æˆ·è®¾ç½®åŠŸèƒ½æ–‡æ¡£.md](./ç”¨æˆ·è®¾ç½®åŠŸèƒ½æ–‡æ¡£.md)

---

**æœ€åæ›´æ–°**: 2025-11-02  
**ç»´æŠ¤è€…**: UniSchedulerSuper å¼€å‘å›¢é˜Ÿ
