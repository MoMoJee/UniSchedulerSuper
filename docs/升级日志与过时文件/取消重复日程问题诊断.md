# 取消重复日程问题诊断

## 前端修改

### 位置: core/static/js/modal-manager.js 行1086-1097

**修改前:**
```javascript
const updateData = {
    // ... 其他字段 ...
};

// 只有当rrule确实存在且不为空时才包含在更新数据中
if (eventData.rrule && eventData.rrule.trim() !== '') {
    updateData.rrule = eventData.rrule;
}
```

**问题:** 当用户取消勾选重复选项时，`eventData.rrule` 是空字符串，但前端不会发送它，导致后端无法知道用户想取消重复。

**修改后:**
```javascript
const updateData = {
    // ... 其他字段 ...
    // 始终包含rrule字段，即使为空（空字符串表示取消重复）
    rrule: eventData.rrule || ''
};
```

**效果:** 现在始终发送 `rrule` 字段。

---

## 后端处理流程

### 场景: 用户从某时间点开始取消重复 (edit_scope='future')

#### Step 1: 接收数据 (views_events.py 行1487)
```python
updates = {k: v for k, v in updates.items() 
           if v is not None and (v != '' or k in ['title', 'description', 'ddl', 'rrule'])}
```
- `rrule: ''` 被保留在 `updates` 中 ✅

#### Step 2: 检测RRule字段 (行1936)
```python
if 'rrule' in updates:
    new_rrule = updates.get('rrule')  # ''
    # ... 获取原始rrule ...
    original_rrule = 'FREQ=DAILY;INTERVAL=1'  # 例如
```
- 检测到有 rrule 字段 ✅

#### Step 3: 比较RRule (行1954)
```python
if original_rrule and original_rrule == new_rrule:
    # RRule没有变化，按非RRule修改处理
else:
    # RRule确实发生了变化
```
- `'FREQ=DAILY;INTERVAL=1' == ''` → False
- 进入 "RRule确实发生了变化" 分支 ✅

#### Step 4: 检测取消重复 (行2018)
```python
if new_rrule == '':
    logger.info(f"Canceling recurrence from {cutoff_time}...")
    # 清除从cutoff_time开始的所有实例的重复字段
    # 截断RRule系列
```
- 检测到空rrule，执行取消重复逻辑 ✅

---

## 可能的问题

### 问题1: 前端没有重新加载静态文件

**症状:** 修改了 modal-manager.js，但浏览器仍使用缓存的旧版本

**解决:**
1. 硬刷新: Ctrl+F5 或 Ctrl+Shift+R
2. 清除浏览器缓存
3. 开发者工具 → Network → 勾选 "Disable cache"

### 问题2: 前端报错导致请求未发送

**症状:** settings-manager.js:170 和 event-manager.js:1688 报错

**可能原因:**
- 网络错误
- CSRF token 问题
- 请求超时
- 服务器返回非 JSON 响应

**检查:** 浏览器开发者工具 → Network 标签 → 查看请求详情

### 问题3: series_id 未正确传递

**症状:** 后端找不到要更新的事件

**原因:** 如果 `series_id` 为空或不匹配，后端循环中不会更新任何事件

**检查:** 
```python
for event in events:
    if (event.get('series_id') == series_id and ...):
        # 这里需要series_id匹配
```

### 问题4: cutoff_time 计算错误

**症状:** 时间比较失败，导致应该更新的事件没有被更新

**原因:** 时区转换问题

**检查日志:**
```
Checking event xxx at 2025-10-14 07:00:00 >= 2025-10-14 07:00:00: True
```

---

## 测试步骤

### 1. 硬刷新浏览器
```
Ctrl + F5
```

### 2. 打开浏览器控制台
```
F12 → Console 标签
```

### 3. 创建测试日程
- 创建一个每日重复日程（10-17至10-21，共5天）
- 确认所有5个实例都显示在日历上

### 4. 编辑并取消重复
1. 点击10-19的日程
2. 取消勾选 "重复日程" 复选框
3. 选择 "保存此日程及以后"
4. 查看控制台输出

### 5. 检查控制台日志
应该看到:
```javascript
handleUpdateEvent - eventData: { ..., rrule: '' }
handleUpdateEvent - updateData: { ..., rrule: '' }
API response status: 200
API response result: { status: 'success', updated_count: 3 }
```

### 6. 检查后端日志
```powershell
Get-Content "d:\PROJECTS\UniSchedulerSuper\logs\application.log" -Tail 20
```

应该看到:
```
Bulk edit events - Operation: edit, Scope: future
[DEBUG] Filtered updates: {..., 'rrule': ''}
RRule detected in updates: 
Original RRule: FREQ=DAILY;INTERVAL=1, New RRule: 
Canceling recurrence from 2025-10-19 00:00:00...
Cleared recurring fields for event xxx
Truncated series xxx until 2025-10-19 00:00:00
```

### 7. 刷新页面验证
- 10-17和10-18应该仍然是重复日程
- 10-19、10-20、10-21应该是独立的单个日程
- 不应该出现10-22及以后的日程

---

## 诊断命令

### 查看前端发送的请求
```javascript
// 在浏览器控制台运行
// F12 → Network 标签 → 筛选 XHR → 查看 bulk-edit 请求
// → Request Payload 查看发送的数据
```

### 查看后端日志
```powershell
# 实时查看日志
Get-Content "d:\PROJECTS\UniSchedulerSuper\logs\application.log" -Wait -Tail 50

# 搜索特定内容
Get-Content "d:\PROJECTS\UniSchedulerSuper\logs\application.log" | Select-String "Canceling recurrence"
```

### 检查数据库中的事件
```python
# Django shell
python manage.py shell

from core.models import UserData
from django.contrib.auth.models import User

user = User.objects.get(username='your_username')
events_data = UserData.objects.get(user=user, key='events')
events = events_data.get_value()

# 查找特定series_id的事件
target_series = 'xxx-xxx-xxx'
for e in events:
    if e.get('series_id') == target_series:
        print(f"{e['start']}: is_recurring={e.get('is_recurring')}, rrule={e.get('rrule')}")
```
