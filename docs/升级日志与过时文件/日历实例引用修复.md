# æ—¥å†å®ä¾‹å¼•ç”¨ä¿®å¤

**ç‰ˆæœ¬**: v20251102-003  
**æ—¥æœŸ**: 2025å¹´11æœˆ2æ—¥  
**é—®é¢˜**: è®¾ç½®ä¿å­˜æˆåŠŸï¼Œä½†åº”ç”¨ç«‹å³ç”Ÿæ•ˆæ—¶å‡ºé”™

---

## ğŸ› é—®é¢˜æè¿°

### é”™è¯¯ä¿¡æ¯
```
ä¿å­˜è®¾ç½®å¤±è´¥: TypeError: calendar.changeView is not a function
    at applyImmediateSettings (home/:2131:26)
```

### é—®é¢˜åˆ†æ
1. âœ… è®¾ç½®æˆåŠŸä¿å­˜åˆ°åç«¯
2. âœ… åç«¯æ­£ç¡®è¿”å›æˆåŠŸå“åº”
3. âŒ è°ƒç”¨ `applyImmediateSettings()` æ—¶å‡ºé”™

### æ ¹æœ¬åŸå› 
ä»£ç ä¸­ä½¿ç”¨äº† `window.calendar` å’Œ `calendar` å˜é‡ï¼Œä½†å®é™…ä¸Šæ—¥å†å®ä¾‹åœ¨ `eventManager.calendar` ä¸­ã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®æ”¹å‰çš„ä»£ç 
```javascript
function applyImmediateSettings(settings) {
    // âŒ é”™è¯¯ï¼šcalendar ä¸æ˜¯å…¨å±€å˜é‡
    if (settings.calendar_view_default && window.calendar) {
        calendar.changeView(settings.calendar_view_default);
    }
    
    if (settings.show_weekends !== undefined && window.calendar) {
        calendar.setOption('weekends', settings.show_weekends);
    }
}
```

### ä¿®æ”¹åçš„ä»£ç 
```javascript
function applyImmediateSettings(settings) {
    // âœ… æ­£ç¡®ï¼šä» eventManager è·å–æ—¥å†å®ä¾‹
    const calendarInstance = window.eventManager?.calendar;
    
    if (!calendarInstance) {
        console.log('æ—¥å†å®ä¾‹å°šæœªåˆå§‹åŒ–ï¼Œè®¾ç½®å°†åœ¨ä¸‹æ¬¡é¡µé¢åŠ è½½æ—¶ç”Ÿæ•ˆ');
        return;
    }
    
    // åº”ç”¨æ—¥å†è§†å›¾è®¾ç½®
    if (settings.calendar_view_default) {
        try {
            calendarInstance.changeView(settings.calendar_view_default);
            console.log('æ—¥å†è§†å›¾å·²åˆ‡æ¢è‡³:', settings.calendar_view_default);
        } catch (error) {
            console.error('åˆ‡æ¢æ—¥å†è§†å›¾å¤±è´¥:', error);
        }
    }
    
    // åº”ç”¨å‘¨æœ«æ˜¾ç¤ºè®¾ç½®
    if (settings.show_weekends !== undefined) {
        try {
            calendarInstance.setOption('weekends', settings.show_weekends);
            console.log('å‘¨æœ«æ˜¾ç¤ºå·²æ›´æ–°ä¸º:', settings.show_weekends);
        } catch (error) {
            console.error('æ›´æ–°å‘¨æœ«æ˜¾ç¤ºå¤±è´¥:', error);
        }
    }
}
```

---

## ğŸ”§ æ”¹è¿›ç‚¹

### 1. æ­£ç¡®çš„æ—¥å†å®ä¾‹å¼•ç”¨
- **ä¿®æ”¹å‰**: `window.calendar` å’Œ `calendar`ï¼ˆä¸å­˜åœ¨ï¼‰
- **ä¿®æ”¹å**: `window.eventManager?.calendar`ï¼ˆå®é™…å­˜åœ¨çš„ä½ç½®ï¼‰

### 2. å¯é€‰é“¾æ“ä½œç¬¦ (`?.`)
- å®‰å…¨åœ°è®¿é—®å¯èƒ½ä¸å­˜åœ¨çš„å±æ€§
- é¿å…è¿è¡Œæ—¶é”™è¯¯
- ä»£ç æ›´åŠ å¥å£®

### 3. æå‰è¿”å›æ¨¡å¼
```javascript
if (!calendarInstance) {
    console.log('æ—¥å†å®ä¾‹å°šæœªåˆå§‹åŒ–ï¼Œè®¾ç½®å°†åœ¨ä¸‹æ¬¡é¡µé¢åŠ è½½æ—¶ç”Ÿæ•ˆ');
    return;  // æå‰è¿”å›ï¼Œé¿å…ç»§ç»­æ‰§è¡Œ
}
```

### 4. Try-Catch é”™è¯¯å¤„ç†
- æ¯ä¸ªæ—¥å†æ“ä½œéƒ½åŒ…è£¹åœ¨ try-catch ä¸­
- å³ä½¿æŸä¸ªæ“ä½œå¤±è´¥ï¼Œå…¶ä»–æ“ä½œä»èƒ½ç»§ç»­
- æä¾›è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

### 5. æ›´å¥½çš„æ—¥å¿—è¾“å‡º
```javascript
console.log('æ—¥å†è§†å›¾å·²åˆ‡æ¢è‡³:', settings.calendar_view_default);
console.log('å‘¨æœ«æ˜¾ç¤ºå·²æ›´æ–°ä¸º:', settings.show_weekends);
```

---

## ğŸ“Š ä»£ç ç»“æ„å¯¹æ¯”

| æ–¹é¢ | ä¿®æ”¹å‰ | ä¿®æ”¹å |
|------|--------|--------|
| **æ—¥å†å¼•ç”¨** | `window.calendar` | `window.eventManager?.calendar` |
| **å­˜åœ¨æ€§æ£€æŸ¥** | `if (window.calendar)` | `if (!calendarInstance) return;` |
| **é”™è¯¯å¤„ç†** | æ—  | `try-catch` åŒ…è£¹æ¯ä¸ªæ“ä½œ |
| **æ—¥å¿—è¾“å‡º** | ä»…ä¸€æ¡æ—¥å¿— | æ¯ä¸ªæ“ä½œéƒ½æœ‰æ—¥å¿— |
| **å¥å£®æ€§** | âŒ ä¼šæŠ›å‡ºé”™è¯¯ | âœ… ä¼˜é›…é™çº§ |

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤ï¼š

1. âœ… æ‰“å¼€ç”¨æˆ·è®¾ç½®
2. âœ… ä¿®æ”¹"é»˜è®¤æ—¥å†è§†å›¾"ï¼ˆå¦‚åˆ‡æ¢åˆ°"å‘¨è§†å›¾"ï¼‰
3. âœ… ä¿®æ”¹"æ—¥å†æ˜¾ç¤ºå‘¨æœ«"ï¼ˆå–æ¶ˆå‹¾é€‰ï¼‰
4. âœ… ç‚¹å‡»"ä¿å­˜è®¾ç½®"
5. âœ… è§‚å¯Ÿæµè§ˆå™¨æ§åˆ¶å°

### é¢„æœŸç»“æœï¼š

**æ§åˆ¶å°è¾“å‡º**:
```
ä¿å­˜çš„è®¾ç½®: {...}
è®¾ç½®ä¿å­˜æˆåŠŸ: {status: 'success', message: 'è®¾ç½®å·²ä¿å­˜'}
æ—¥å†è§†å›¾å·²åˆ‡æ¢è‡³: timeGridWeek
å‘¨æœ«æ˜¾ç¤ºå·²æ›´æ–°ä¸º: false
```

**ç•Œé¢æ•ˆæœ**:
- âœ… æ— é”™è¯¯ä¿¡æ¯
- âœ… ç»¿è‰² Toast æç¤º"è®¾ç½®å·²ä¿å­˜"
- âœ… æ—¥å†ç«‹å³åˆ‡æ¢åˆ°å‘¨è§†å›¾
- âœ… å‘¨æœ«åˆ—è¢«éšè—ï¼ˆå¦‚æœå–æ¶ˆå‹¾é€‰ï¼‰
- âœ… æ¨¡æ€æ¡†è‡ªåŠ¨å…³é—­

### è¾¹ç•Œæƒ…å†µæµ‹è¯•ï¼š

| åœºæ™¯ | é¢„æœŸè¡Œä¸º |
|------|----------|
| **é¡µé¢åˆšåŠ è½½ï¼Œæ—¥å†æœªåˆå§‹åŒ–** | è¾“å‡º"æ—¥å†å®ä¾‹å°šæœªåˆå§‹åŒ–"ï¼Œä¼˜é›…é™çº§ |
| **eventManager ä¸å­˜åœ¨** | ä½¿ç”¨ `?.` å®‰å…¨è®¿é—®ï¼Œä¸ä¼šæŠ¥é”™ |
| **æ—¥å†æ–¹æ³•è°ƒç”¨å¤±è´¥** | æ•è·é”™è¯¯ï¼Œè¾“å‡ºæ—¥å¿—ï¼Œç»§ç»­æ‰§è¡Œå…¶ä»–æ“ä½œ |

---

## ğŸ¯ ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸ªé—®é¢˜ï¼Ÿ

### é¡¹ç›®çš„æ—¥å†æ¶æ„

åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œæ—¥å†å®ä¾‹çš„ç®¡ç†æ–¹å¼å¦‚ä¸‹ï¼š

```javascript
// æ—¥å†ä¸æ˜¯ç›´æ¥æŒ‚è½½åœ¨ window ä¸Š
// è€Œæ˜¯åœ¨ eventManager å¯¹è±¡ä¸­

window.eventManager = {
    calendar: FullCalendar.Calendar instance,
    // ... å…¶ä»–æ–¹æ³•
};

// åœ¨ HTML ä¸­å¯ä»¥çœ‹åˆ°ï¼š
<button onclick="eventManager.calendar.today()">ä»Šå¤©</button>
<button onclick="eventManager.calendar.prev()">ä¸Šä¸€æœˆ</button>
<button onclick="eventManager.calendar.next()">ä¸‹ä¸€æœˆ</button>
```

### ä¸ºä»€ä¹ˆä¹‹å‰çš„ä»£ç æ²¡æœ‰æŠ¥é”™ï¼Ÿ

å› ä¸ºåœ¨é¡µé¢çš„å…¶ä»–åœ°æ–¹ï¼ˆå¯¼èˆªæŒ‰é’®ç­‰ï¼‰ï¼Œä»£ç å·²ç»æ­£ç¡®ä½¿ç”¨äº† `eventManager.calendar`ï¼Œåªæ˜¯åœ¨æ–°å¢çš„è®¾ç½®åŠŸèƒ½ä¸­é”™è¯¯åœ°ä½¿ç”¨äº† `window.calendar`ã€‚

---

## ğŸ’¡ å­¦ä¹ è¦ç‚¹

### 1. æ­£ç¡®ç†è§£å˜é‡ä½œç”¨åŸŸ
- ä¸è¦å‡è®¾å…¨å±€å˜é‡çš„å­˜åœ¨
- ä½¿ç”¨å¼€å‘è€…å·¥å…·æ£€æŸ¥å®é™…çš„å¯¹è±¡ç»“æ„

### 2. ä½¿ç”¨ç°ä»£ JavaScript ç‰¹æ€§
- **å¯é€‰é“¾** (`?.`): å®‰å…¨è®¿é—®åµŒå¥—å±æ€§
- **ç©ºå€¼åˆå¹¶** (`??`): æä¾›é»˜è®¤å€¼
- **æå‰è¿”å›**: å‡å°‘åµŒå¥—ï¼Œæé«˜å¯è¯»æ€§

### 3. å®Œå–„çš„é”™è¯¯å¤„ç†
```javascript
try {
    // å¯èƒ½å¤±è´¥çš„æ“ä½œ
} catch (error) {
    console.error('æ“ä½œå¤±è´¥:', error);
    // ä¸å½±å“å…¶ä»–ä»£ç ç»§ç»­æ‰§è¡Œ
}
```

### 4. æœ‰æ„ä¹‰çš„æ—¥å¿—
```javascript
// âŒ ä¸å¥½çš„æ—¥å¿—
console.log('ok');

// âœ… å¥½çš„æ—¥å¿—
console.log('æ—¥å†è§†å›¾å·²åˆ‡æ¢è‡³:', settings.calendar_view_default);
```

---

## ğŸ”„ å®Œæ•´çš„è®¾ç½®ä¿å­˜æµç¨‹

ç°åœ¨è®¾ç½®ä¿å­˜çš„å®Œæ•´æµç¨‹å¦‚ä¸‹ï¼š

```
ç”¨æˆ·ç‚¹å‡»"ä¿å­˜è®¾ç½®"
    â†“
æ”¶é›†æ‰€æœ‰è¡¨å•æ•°æ®
    â†“
å‘é€ POST è¯·æ±‚åˆ°åç«¯
    â†“
åç«¯éªŒè¯å¹¶ä¿å­˜ï¼ˆä½¿ç”¨ DATA_SCHEMAï¼‰
    â†“
è¿”å›æˆåŠŸå“åº”
    â†“
æ˜¾ç¤º Toast æç¤º"è®¾ç½®å·²ä¿å­˜" âœ…
    â†“
è°ƒç”¨ applyImmediateSettings()
    â†“
æ£€æŸ¥ eventManager.calendar æ˜¯å¦å­˜åœ¨
    â†“
åº”ç”¨æ—¥å†è§†å›¾åˆ‡æ¢ âœ…
    â†“
åº”ç”¨å‘¨æœ«æ˜¾ç¤ºè®¾ç½® âœ…
    â†“
å…³é—­æ¨¡æ€æ¡† âœ…
    â†“
å®Œæˆï¼ğŸ‰
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

- `core/templates/home_new.html` - `applyImmediateSettings()` å‡½æ•°

---

## âœ… éªŒè¯æ¸…å•

- [x] ä¿®å¤æ—¥å†å®ä¾‹å¼•ç”¨é”™è¯¯
- [x] æ·»åŠ å­˜åœ¨æ€§æ£€æŸ¥
- [x] æ·»åŠ  try-catch é”™è¯¯å¤„ç†
- [x] æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
- [x] ä½¿ç”¨å¯é€‰é“¾æ“ä½œç¬¦å¢å¼ºå¥å£®æ€§
- [x] æµ‹è¯•è®¾ç½®ä¿å­˜å’Œç«‹å³åº”ç”¨åŠŸèƒ½
- [x] ç¡®ä¿æ— æ§åˆ¶å°é”™è¯¯

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

1. **ç»Ÿä¸€æ—¥å†å®ä¾‹è®¿é—®**: å¯ä»¥è€ƒè™‘åœ¨å…¨å±€æ·»åŠ ä¸€ä¸ª getter
   ```javascript
   window.getCalendar = () => window.eventManager?.calendar;
   ```

2. **è®¾ç½®åº”ç”¨åé¦ˆ**: å¯ä»¥åœ¨ Toast ä¸­æ˜¾ç¤ºå“ªäº›è®¾ç½®ç«‹å³ç”Ÿæ•ˆï¼Œå“ªäº›éœ€è¦åˆ·æ–°
   ```javascript
   showToast('è®¾ç½®å·²ä¿å­˜ã€‚æ—¥å†è§†å›¾å·²ç«‹å³æ›´æ–°ï¼Œå…¶ä»–è®¾ç½®å°†åœ¨åˆ·æ–°é¡µé¢åç”Ÿæ•ˆã€‚', 'success');
   ```

3. **è®¾ç½®é¢„è§ˆ**: åœ¨ä¿å­˜å‰æä¾›é¢„è§ˆåŠŸèƒ½ï¼Œè®©ç”¨æˆ·çœ‹åˆ°è®¾ç½®æ•ˆæœ

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025å¹´11æœˆ2æ—¥  
**æµ‹è¯•çŠ¶æ€**: å¾…ç”¨æˆ·éªŒè¯  
**å½±å“èŒƒå›´**: ç”¨æˆ·è®¾ç½®çš„ç«‹å³åº”ç”¨åŠŸèƒ½
