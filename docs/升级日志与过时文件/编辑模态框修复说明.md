# ç¼–è¾‘æ¨¡æ€æ¡†"ä»…æ­¤æ—¥ç¨‹"æ¨¡å¼è‡ªåŠ¨è¡¥å…¨é—®é¢˜ä¿®å¤

## é—®é¢˜æè¿°
é€šè¿‡ç¼–è¾‘æ¨¡æ€æ¡†ä½¿ç”¨"ä»…æ­¤æ—¥ç¨‹"æ¨¡å¼ç¼–è¾‘é‡å¤äº‹ä»¶æ—¶ï¼Œå³ä½¿åªä¿®æ”¹äº†åç§°ã€ä¼˜å…ˆçº§ç­‰å±æ€§ï¼ˆæ²¡æ”¹æ—¶é—´ï¼‰ï¼Œä¹Ÿä¼šåœ¨åŸä½ç½®è‡ªåŠ¨è¡¥å…¨å‡ºä¸€ä¸ªæ–°æ—¥ç¨‹ã€‚

## é—®é¢˜æ ¹æº

### ä»£ç æµç¨‹åˆ†æ

1. **å‰ç«¯**: ç¼–è¾‘æ¨¡æ€æ¡† â†’ `modal-manager.js` â†’ `handleUpdateEvent()`
2. **åˆ¤æ–­**: å¦‚æœæœ‰ `pendingBulkEdit`ï¼Œè°ƒç”¨ `performBulkOperation()`
3. **API**: å‘é€åˆ° `/api/events/bulk-edit/` ç«¯ç‚¹
4. **åç«¯**: `bulk_edit_events_impl()` å¤„ç†ï¼Œ`edit_scope='single'`

### æ ¸å¿ƒé—®é¢˜

åœ¨ `bulk_edit_events_impl` çš„ `edit_scope == 'single'` åˆ†æ”¯ï¼ˆ1505è¡Œï¼‰ï¼š

**ä¿®å¤å‰çš„ä»£ç **ï¼š
```python
if edit_scope == 'single':
    for event in events:
        if event.get('id') == event_id:
            was_recurring = event.get('series_id') or event.get('rrule')
            
            if was_recurring:
                # âŒ åªæ˜¯è„±ç¦»ç³»åˆ—ï¼Œä½†æ²¡æœ‰ç»™åŸç³»åˆ—æ·»åŠ EXDATE
                event['is_detached'] = True
                event['series_id'] = ''
                event['is_recurring'] = False
                # ...
```

**ç¼ºå°‘çš„å…³é”®æ­¥éª¤**: æ²¡æœ‰ç»™åŸç³»åˆ—çš„ RRule æ·»åŠ  **EXDATE**

## å¯¹æ¯”ï¼šæ‹–æ‹½ vs ç¼–è¾‘æ¨¡æ€æ¡†

### æ‹–æ‹½æ“ä½œï¼ˆå·²ä¿®å¤ï¼‰
- å‰ç«¯: `handleEventDragDrop()` â†’ `updateEventDrag()`
- åç«¯: `update_events_impl()` â†’ `rrule_change_scope='single'`
- âœ… æ·»åŠ äº† EXDATE é€»è¾‘

### ç¼–è¾‘æ¨¡æ€æ¡†ï¼ˆæœ¬æ¬¡ä¿®å¤ï¼‰
- å‰ç«¯: `handleUpdateEvent()` â†’ `performBulkOperation()`
- åç«¯: `bulk_edit_events_impl()` â†’ `edit_scope='single'`
- âŒ **ä¹‹å‰ç¼ºå°‘** EXDATE é€»è¾‘
- âœ… **ç°å·²æ·»åŠ ** EXDATE é€»è¾‘

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹æ–‡ä»¶: `core/views_events.py`

åœ¨ `bulk_edit_events_impl()` çš„ `edit_scope == 'single'` åˆ†æ”¯ä¸­ï¼Œæ·»åŠ å®Œæ•´çš„ EXDATE å¤„ç†ï¼š

```python
if edit_scope == 'single':
    for event in events:
        if event.get('id') == event_id:
            was_recurring = event.get('series_id') or event.get('rrule')
            original_series_id = event.get('series_id', '')
            
            if was_recurring and original_series_id:
                # 1. è·å–åŸå§‹äº‹ä»¶çš„æ—¶é—´
                target_event_time = datetime.datetime.fromisoformat(event.get('start'))
                
                # 2. æ·»åŠ EXDATEä¾‹å¤–åˆ°åŸç³»åˆ—
                manager.rrule_engine.delete_instance(original_series_id, target_event_time)
                
                # 3. è·å–æ›´æ–°åçš„ç³»åˆ—ä¿¡æ¯ï¼ˆåŒ…å«EXDATEï¼‰
                updated_series = manager.rrule_engine.get_series(original_series_id)
                segments_data = updated_series.get_segments_data()
                main_segment = segments_data[0]
                updated_rrule = main_segment['rrule_str']
                
                # 4. æ·»åŠ EXDATEä¿¡æ¯åˆ°rruleå­—ç¬¦ä¸²
                if main_segment.get('exdates'):
                    exdate_strs = [exdate.strftime('%Y%m%dT%H%M%S') 
                                   for exdate in main_segment['exdates']]
                    updated_rrule += ';EXDATE=' + ','.join(exdate_strs)
                
                # 5. æ›´æ–°æ‰€æœ‰åŒç³»åˆ—äº‹ä»¶çš„rruleå­—æ®µ
                for evt in events:
                    if evt.get('series_id') == original_series_id:
                        evt['rrule'] = updated_rrule
                
                # 6. è½¬æ¢UTCæ—¶é—´ä¸ºæœ¬åœ°æ—¶é—´ï¼ˆå¦‚æœéœ€è¦ï¼‰
                if 'start' in updates and updates['start'].endswith('Z'):
                    utc_time = datetime.datetime.fromisoformat(
                        updates['start'].replace('Z', '+00:00'))
                    local_time = utc_time - timedelta(hours=-8)
                    updates['start'] = local_time.strftime('%Y-%m-%dT%H:%M:%S')
                
                # 7. æ›´æ–°äº‹ä»¶å¹¶è„±ç¦»ç³»åˆ—
                event.update(updates)
                event['is_exception'] = True
                event['is_detached'] = True
                event['series_id'] = ''
                event['is_recurring'] = False
                event['rrule'] = ''
                event['original_series_id'] = original_series_id
```

## ä¿®å¤çš„å…³é”®ç‚¹

### 1. æ·»åŠ  EXDATE
```python
manager.rrule_engine.delete_instance(original_series_id, target_event_time)
```
è¿™ä¼šåœ¨ RRule å¼•æ“ä¸­ä¸ºåŸç³»åˆ—æ·»åŠ ä¾‹å¤–æ—¥æœŸã€‚

### 2. æ›´æ–° RRule å­—ç¬¦ä¸²
```python
updated_rrule = main_segment['rrule_str'] + ';EXDATE=' + exdate_strs
```
å°†åŒ…å« EXDATE çš„ rrule æ›´æ–°åˆ°æ‰€æœ‰åŒç³»åˆ—äº‹ä»¶ã€‚

### 3. æ—¶é—´æ ¼å¼è½¬æ¢
```python
if updates['start'].endswith('Z'):
    # UTC â†’ æœ¬åœ°æ—¶é—´
    local_time = utc_time - timedelta(hours=-8)  # ç›¸å½“äº +8å°æ—¶
```
ç¡®ä¿æ—¶é—´æ ¼å¼ä¸€è‡´ï¼ˆ`%Y-%m-%dT%H:%M:%S`ï¼Œæ— .000Zï¼‰ã€‚

### 4. æ ‡è®°ä¾‹å¤–äº‹ä»¶
```python
event['is_exception'] = True
event['original_series_id'] = original_series_id
```
ä¿ç•™è¿½æº¯ä¿¡æ¯ã€‚

## ä¸ update_events_impl çš„ä¸€è‡´æ€§

ç°åœ¨ä¸¤ä¸ªç¼–è¾‘è·¯å¾„ä½¿ç”¨ç›¸åŒçš„ EXDATE é€»è¾‘ï¼š

| æ“ä½œæ–¹å¼ | APIç«¯ç‚¹ | åç«¯å‡½æ•° | EXDATEé€»è¾‘ |
|---------|---------|----------|-----------|
| æ‹–æ‹½äº‹ä»¶ | `/get_calendar/update_events/` | `update_events_impl` | âœ… å·²æœ‰ |
| ç¼–è¾‘æ¨¡æ€æ¡† | `/api/events/bulk-edit/` | `bulk_edit_events_impl` | âœ… å·²æ·»åŠ  |

## æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤
1. åˆ›å»ºä¸€ä¸ªæ¯æ—¥é‡å¤çš„æµ‹è¯•äº‹ä»¶
2. ç‚¹å‡»æŸä¸ªå®ä¾‹ï¼Œè¿›å…¥ç¼–è¾‘æ¨¡æ€æ¡†
3. é€‰æ‹©"ä»…æ­¤æ—¥ç¨‹"ç¼–è¾‘æ¨¡å¼
4. åªä¿®æ”¹æ ‡é¢˜æˆ–ä¼˜å…ˆçº§ï¼ˆä¸æ”¹æ—¶é—´ï¼‰
5. ä¿å­˜

### æœŸæœ›ç»“æœ
- âœ… è¢«ç¼–è¾‘çš„å®ä¾‹å˜ä¸ºç‹¬ç«‹äº‹ä»¶ï¼Œå±æ€§å·²æ›´æ–°
- âœ… åŸä½ç½®**ä¸å†**è‡ªåŠ¨è¡¥å…¨æ–°æ—¥ç¨‹
- âœ… ç³»åˆ—çš„å…¶ä»–å®ä¾‹æ­£å¸¸æ˜¾ç¤º
- âœ… æ•°æ®åº“ä¸­æ—¶é—´æ ¼å¼æ­£ç¡®ï¼ˆæœ¬åœ°æ—¶é—´ï¼Œæ— .000Zï¼‰

### æ•°æ®åº“éªŒè¯
```json
// è¢«ç¼–è¾‘çš„äº‹ä»¶
{
  "id": "...",
  "title": "ä¿®æ”¹åçš„æ ‡é¢˜",  // å·²æ›´æ–°
  "start": "2025-10-14T19:00:00",  // æœ¬åœ°æ—¶é—´æ ¼å¼ âœ…
  "series_id": "",  // å·²è„±ç¦»
  "is_recurring": false,
  "is_exception": true,
  "is_detached": true,
  "original_series_id": "...",  // è®°å½•åŸç³»åˆ—
  "rrule": ""
}

// ç³»åˆ—ä¸»äº‹ä»¶
{
  "series_id": "...",
  "is_main_event": true,
  "rrule": "FREQ=DAILY;INTERVAL=1;EXDATE=20251014T190000"  // åŒ…å«EXDATE âœ…
}
```

## ç›¸å…³ä»£ç ä½ç½®

- **bulk_edit_events_impl**: `core/views_events.py` ç¬¬1505-1595è¡Œ
- **update_events_impl**: `core/views_events.py` ç¬¬2063-2133è¡Œ  
- **delete_instance (EXDATE)**: å‚è€ƒåˆ é™¤æ“ä½œ ç¬¬1400-1450è¡Œ

## æ€»ç»“

è¿™æ¬¡ä¿®å¤ç¡®ä¿äº†**æ‰€æœ‰**"ä»…æ­¤æ—¥ç¨‹"ç¼–è¾‘æ“ä½œéƒ½ä¼šï¼š
1. âœ… ç»™åŸç³»åˆ—æ·»åŠ  EXDATE
2. âœ… æ›´æ–°ç³»åˆ—çš„ rrule å­—ç¬¦ä¸²
3. âœ… å°†äº‹ä»¶ç‹¬ç«‹å‡ºå»
4. âœ… ä¿æŒæ—¶é—´æ ¼å¼ä¸€è‡´

ç°åœ¨æ— è®ºæ˜¯é€šè¿‡**æ‹–æ‹½**è¿˜æ˜¯**ç¼–è¾‘æ¨¡æ€æ¡†**ä¿®æ”¹é‡å¤äº‹ä»¶çš„å•ä¸ªå®ä¾‹ï¼Œéƒ½ä¸ä¼šå‡ºç°è‡ªåŠ¨è¡¥å…¨çš„é—®é¢˜äº†ï¼ğŸ‰
