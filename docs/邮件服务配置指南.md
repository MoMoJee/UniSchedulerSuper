# 邮件服务配置指南

## 概述

本系统支持通过 SMTP 发送邮件验证码，用于用户注册和密码重置功能。如果不配置邮件服务，系统会自动降级为**测试模式**，验证码将显示在页面上（仅供开发测试）。

## 测试模式（默认）

### 特性
- 无需任何配置即可使用
- 验证码不会真正发送邮件
- 验证码会显示在网页上（6位数字）
- 适合开发环境和快速测试

### 使用场景
- 本地开发调试
- 快速测试注册和密码重置流程
- 不需要真实邮件通知的场景

### 识别测试模式
当系统处于测试模式时，会在注册和找回密码页面顶部显示黄色提示横幅：
```
⚠️ 测试模式 - 邮件服务未配置
```

---

## 生产模式配置

### 步骤 1：创建配置文件

复制示例配置文件并修改为实际配置：

```bash
cd config
cp email.example.json email.json
```

### 步骤 2：编辑配置文件

根据您使用的邮件服务商填写 `config/email.json`：

```json
{
  "enabled": true,
  "smtp_host": "smtp.exmail.qq.com",
  "smtp_port": 465,
  "smtp_user": "noreply@yourdomain.com",
  "smtp_password": "your_smtp_password",
  "from_email": "noreply@yourdomain.com",
  "from_name": "时间管理大师"
}
```

### 配置说明

| 字段 | 说明 | 示例 |
|------|------|------|
| `enabled` | 是否启用邮件功能 | `true` / `false` |
| `smtp_host` | SMTP 服务器地址 | `smtp.exmail.qq.com` (腾讯企业邮箱) |
| `smtp_port` | SMTP 端口 | `465` (SSL) 或 `587` (TLS) |
| `smtp_user` | SMTP 用户名（通常是完整邮箱地址） | `noreply@yourdomain.com` |
| `smtp_password` | SMTP 密码或授权码 | 从邮件服务商获取 |
| `from_email` | 发件人邮箱地址 | `noreply@yourdomain.com` |
| `from_name` | 发件人显示名称 | `时间管理大师` |

---

## 常见邮件服务商配置

### 腾讯企业邮箱（推荐）

```json
{
  "smtp_host": "smtp.exmail.qq.com",
  "smtp_port": 465,
  "smtp_user": "your@domain.com",
  "smtp_password": "密码或授权码"
}
```

**注意**：
- 使用 SSL 加密（端口 465）
- 如果邮箱开启了两步验证，需使用授权码而非密码

### 阿里云邮件推送

```json
{
  "smtp_host": "smtpdm.aliyun.com",
  "smtp_port": 465,
  "smtp_user": "your@domain.com",
  "smtp_password": "SMTP密码"
}
```

### QQ 邮箱

```json
{
  "smtp_host": "smtp.qq.com",
  "smtp_port": 465,
  "smtp_user": "your@qq.com",
  "smtp_password": "授权码（非邮箱密码）"
}
```

**获取授权码**：
1. 登录 QQ 邮箱
2. 设置 → 账户 → POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务
3. 开启 SMTP 服务
4. 生成授权码

### Gmail

```json
{
  "smtp_host": "smtp.gmail.com",
  "smtp_port": 587,
  "smtp_user": "your@gmail.com",
  "smtp_password": "应用专用密码"
}
```

**获取应用专用密码**：
1. 开启两步验证
2. Google 账号 → 安全性 → 应用专用密码
3. 生成新的应用专用密码

---

## 测试配置

系统提供了自动测试工具来验证 SMTP 配置：

```bash
python test_smtp_config.py
```

该工具会自动测试 6 种常见配置组合：
- SMTP 服务器地址（腾讯云、阿里云等）
- 端口号（465、587、25）
- SSL/TLS 加密方式

测试结果会显示：
- ✅ 连接成功的配置
- ❌ 连接失败的原因

---

## 故障排查

### 问题：连接超时

**可能原因**：
- 防火墙阻止 SMTP 端口
- SMTP 服务器地址错误
- 网络连接问题

**解决方法**：
1. 检查防火墙设置
2. 确认 SMTP 服务器地址正确
3. 尝试使用 `test_smtp_config.py` 自动测试

### 问题：535 Authentication failure

**可能原因**：
- SMTP 用户名或密码错误
- 需要使用授权码而非邮箱密码
- 邮箱未开启 SMTP 服务

**解决方法**：
1. 确认用户名（通常是完整邮箱地址）
2. 检查密码是否正确
3. 如使用 QQ/Gmail，需使用授权码
4. 确认邮箱已开启 SMTP 服务

### 问题：Connection unexpectedly closed

**可能原因**：
- SSL/TLS 配置错误
- 端口号不匹配

**解决方法**：
1. 465 端口使用 SSL 加密
2. 587 端口使用 TLS 加密
3. 确认服务商要求的端口和加密方式

---

## 安全建议

1. **不要提交配置文件到 Git**
   - `email.json` 已添加到 `.gitignore`
   - 切勿将包含密码的文件推送到代码仓库

2. **使用授权码**
   - 优先使用应用专用密码/授权码
   - 避免使用邮箱登录密码

3. **限制权限**
   - 生产环境建议使用专用邮箱（如 `noreply@domain.com`）
   - 不要使用个人邮箱

4. **定期更换密码**
   - 定期更新 SMTP 密码
   - 发现泄露立即更换

---

## 从测试模式切换到生产模式

1. 创建并配置 `config/email.json`
2. 设置 `enabled: true`
3. 运行 `python test_smtp_config.py` 验证配置
4. 重启 Django 服务器
5. 访问注册/找回密码页面，确认黄色提示消失

---

## 常见问题

**Q: 为什么我收不到邮件？**

A: 检查以下几点：
1. 邮件可能在垃圾箱
2. 检查 `config/email.json` 中 `enabled` 是否为 `true`
3. 查看 Django 日志文件 `logs/application.log`
4. 使用 `test_smtp_config.py` 测试连接

**Q: 测试模式下验证码显示在哪里？**

A: 
- 注册页面：邮箱验证步骤会显示黄色框，内含验证码
- 找回密码页面：提交邮箱后，验证码会显示在页面上
- 后端日志：查看 `logs/application.log` 也会记录验证码

**Q: 如何临时禁用邮件发送？**

A: 修改 `config/email.json`，将 `enabled` 改为 `false`，系统会自动降级为测试模式。

---

## 联系支持

如遇到其他问题，请：
1. 查看 Django 日志：`logs/application.log`
2. 运行测试工具：`python test_smtp_config.py`
3. 检查服务商官方文档
