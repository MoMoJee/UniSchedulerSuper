# å‰ç«¯ä¸Šä¸‹æ–‡ç”¨é‡æ¡å½¢å›¾æ•°æ®æµåˆ†æ

**æ—¶é—´**: 2026-02-18  
**é—®é¢˜**: å‰ç«¯æ˜¾ç¤ºçš„ Token ç»Ÿè®¡æ˜¯å¦å‡†ç¡®ï¼Ÿåˆ‡æ¢æ¨¡å‹æ—¶å¦‚ä½•åº”å¯¹ï¼Ÿ

---

## ä¸€ã€æ ¸å¿ƒå‘ç°æ€»ç»“

### âš ï¸ é‡è¦ç»“è®º

**å‰ç«¯æ˜¾ç¤ºçš„ Token æ•°æ® 100% ä½¿ç”¨é¢„ä¼°å€¼ï¼Œä¸æ˜¯å®é™…è®¡è´¹æ•°æ®ï¼**

| é¡¹ç›® | æ•°æ®æ¥æº | è®¡ç®—æ–¹å¼ | å‡†ç¡®æ€§ |
|------|----------|----------|--------|
| **å‰ç«¯æ˜¾ç¤º** | æœ¬åœ°ä¼°ç®— | å­—ç¬¦æ•°å…¬å¼ | â­â­ ç²—ç•¥ |
| **å®é™…è®¡è´¹** | API è¿”å› | `response.usage_metadata` | â­â­â­â­â­ ç²¾ç¡® |

**ä¸ä¸€è‡´åŸå› **ï¼š
- âŒ å‰ç«¯ä¸åŒ…å«å·¥å…·å®šä¹‰çš„ Token æ•°ï¼ˆ~4000-5000 tokensï¼‰
- âŒ å‰ç«¯ä½¿ç”¨ç®€åŒ–çš„å­—ç¬¦æ•°ä¼°ç®—å…¬å¼
- âŒ å›¾ç‰‡å›ºå®šæŒ‰ 85 tokens ä¼°ç®—ï¼ˆå®é™… 85-765 tokensï¼‰

---

## äºŒã€æ•°æ®æµå®Œæ•´è¿½è¸ª

### 2.1 å®Œæ•´æ•°æ®é“¾è·¯å›¾

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
    â†“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å‰ç«¯æ˜¾ç¤ºè·¯å¾„ï¼ˆé¢„ä¼°ï¼Œä¸å‡†ç¡®ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    â†“
å‰ç«¯ JS: agentChat.updateContextUsageBar()
    â†“
è°ƒç”¨ API: GET /api/agent/context-usage/?session_id=xxx
    â†“
åç«¯: views_api.py â†’ get_context_usage()
    â”‚
    â”œâ”€ è·å–æ¨¡å‹é…ç½®: get_current_model_config(user)
    â”‚   â””â”€ è¯»å– UserData.agent_config â†’ current_model_id
    â”‚   â””â”€ è¿”å› context_window (æ¨¡å‹ä¸Šä¸‹æ–‡çª—å£)
    â”‚
    â”œâ”€ è·å–ä¼šè¯æ¶ˆæ¯: app.get_state(config)
    â”‚
    â”œâ”€ éå†æ¶ˆæ¯ï¼Œä½¿ç”¨ estimate_tokens() ä¼°ç®—
    â”‚   â”œâ”€ ä¸­æ–‡å­—ç¬¦ Ã— 0.7
    â”‚   â”œâ”€ å…¶ä»–å­—ç¬¦ Ã— 0.3
    â”‚   â”œâ”€ å›¾ç‰‡å›ºå®š 85 tokens
    â”‚   â””â”€ æ¶ˆæ¯å¼€é”€ +4
    â”‚
    â””â”€ è¿”å›å‰ç«¯: {summary_tokens, recent_tokens, remaining_tokens, ...}
    â†“
å‰ç«¯æ¸²æŸ“: renderContextUsageBar(data)
    â†“
æ˜¾ç¤ºç™¾åˆ†æ¯”æ¡å½¢å›¾
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å®é™…è®¡è´¹è·¯å¾„ï¼ˆç²¾ç¡®ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    â†“
Agent è¯·æ±‚ LLM API
    â†“
LLM è¿”å›: response.usage_metadata {input_tokens, output_tokens}
    â†“
agent_graph.py â†’ update_token_usage()
    â†“
ä¿å­˜åˆ° UserData.agent_token_usage (ç”¨äºè®¡è´¹)
```

---

## ä¸‰ã€æ•°æ®æ¥æºè¯¦ç»†åˆ†æ

### 3.1 å‰ç«¯æ˜¾ç¤ºçš„"å·²ä½¿ç”¨ Token æ•°"

**æ¥æºæ–‡ä»¶**: `agent_service/views_api.py`  
**å‡½æ•°**: `get_context_usage()` (line 1801-1940)  
**API ç«¯ç‚¹**: `GET /api/agent/context-usage/?session_id=xxx`

**è®¡ç®—é€»è¾‘**ï¼š

```python
def estimate_tokens(text):
    """å‰ç«¯æ˜¾ç¤ºç”¨çš„ Token ä¼°ç®—ï¼ˆä¸å‡†ç¡®ï¼‰"""
    if isinstance(text, list):  # å¤šæ¨¡æ€æ¶ˆæ¯
        total = 0
        for block in text:
            if block.get('type') == 'text':
                total += estimate_tokens(block.get('text', ''))
            elif block.get('type') == 'image_url':
                total += 85  # âš ï¸ å›ºå®šå€¼ï¼Œå®é™… 85-765 tokens
        return total
    
    # æ–‡æœ¬ä¼°ç®—
    chinese_chars = sum(1 for c in text if '\u4e00' <= c <= '\u9fff')
    other_chars = len(text) - chinese_chars
    return int(chinese_chars * 0.7 + other_chars * 0.3) + 4  # +4 æ¶ˆæ¯å¼€é”€
```

**è¿”å›æ•°æ®ç»“æ„**ï¼š

```json
{
    "session_id": "user_123_default",
    "context_window": 128000,       // ä» model_config è·å–
    "target_max_tokens": 76800,     // context_window Ã— 0.6
    "trigger_tokens": 38400,        // target_max_tokens Ã— 0.5
    "summary_tokens": 1500,         // å†å²æ€»ç»“çš„ tokens (æ¥è‡ª AgentSession è¡¨)
    "recent_tokens": 5000,          // âš ï¸ é¢„ä¼°å€¼ï¼ˆéå†æ¶ˆæ¯è®¡ç®—ï¼‰
    "remaining_tokens": 70300,      // target_max_tokens - total_tokens
    "total_tokens": 6500,           // summary_tokens + recent_tokens
    "has_summary": true
}
```

### 3.2 "ç³»ç»Ÿå·²ä½¿ç”¨ Token æ•°" (System Prompt)

**æ¥æº**ï¼šå‰ç«¯è®¡ç®—ä¸­åŒ…å«åœ¨ `recent_tokens` ä¸­

**ç»„æˆ**ï¼š
- System Message (SystemMessage): Agent æŒ‡ä»¤ã€å·¥å…·åˆ—è¡¨
- ç”¨æˆ·æ¶ˆæ¯ (HumanMessage)
- AI å›å¤ (AIMessage)
- å·¥å…·è°ƒç”¨ (ToolMessage)

**æ³¨æ„âš ï¸**ï¼š
- å‰ç«¯ä¼°ç®—**ä¸åŒ…å«**å·¥å…·å®šä¹‰çš„ JSON Schemaï¼ˆ~4000 tokensï¼‰
- è¿™æ˜¯é€ æˆæ˜¾ç¤ºå€¼è¿œå°äºå®é™…å€¼çš„ä¸»è¦åŸå› 

---

## å››ã€é¢„ä¼°å€¼çš„é—®é¢˜

### 4.1 ä¸ºä»€ä¹ˆ Token å€¼å¾ˆä¸å‡†ï¼Ÿ

#### âŒ é—®é¢˜ 1: ä¸åŒ…å«å·¥å…·å®šä¹‰

**ç¤ºä¾‹**ï¼š
- å‰ç«¯æ˜¾ç¤º: `recent_tokens = 399`
- å®é™…è®¡è´¹: `input_tokens = 4648`

**å·®å€¼ 4249 tokens** = å·¥å…·å®šä¹‰ JSON Schemaï¼ˆ50+ å·¥å…·ï¼‰

#### âŒ é—®é¢˜ 2: å›¾ç‰‡ Token ä¼°ç®—ä¸å‡†

**å‰ç«¯å›ºå®šå€¼**: 85 tokens/å›¾  
**å®é™…æ¶ˆè€—**ï¼ˆå–å†³äº `detail` å‚æ•°ï¼‰:
- `detail="low"`: ~85 tokens âœ… æ¥è¿‘
- `detail="high"`: ~170-765 tokens âŒ åå·®å·¨å¤§
- `detail="auto"`: ç”± API å†³å®š âŒ ä¸å¯é¢„æµ‹

#### âŒ é—®é¢˜ 3: å­—ç¬¦æ•°ä¼°ç®—å…¬å¼ç²—ç³™

**å‰ç«¯å…¬å¼**:
```python
tokens = chinese_chars * 0.7 + other_chars * 0.3 + 4
```

**é—®é¢˜**:
- ä¸åŒæ¨¡å‹çš„ tokenizer ä¸åŒï¼ˆGPT vs DeepSeek vs Qwenï¼‰
- ç‰¹æ®Šå­—ç¬¦ã€Emojiã€ä»£ç çš„ token åŒ–è§„åˆ™å¤æ‚
- å¤šè¯­è¨€æ··åˆåœºæ™¯è¯¯å·®æ›´å¤§

**å®é™…åå·®**: Â±20-30%

---

## äº”ã€æ¨¡å‹åˆ‡æ¢æ—¶çš„åº”å¯¹æœºåˆ¶

### 5.1 ä½•æ—¶è§¦å‘æ›´æ–°ï¼Ÿ

**è§¦å‘æ—¶æœº**ï¼ˆä» `agent-config.js` åˆ†æï¼‰:

| æ“ä½œ | è§¦å‘ä½ç½® | ä»£ç è¡Œ |
|------|----------|--------|
| åˆ‡æ¢æ¨¡å‹ | `switchModel()` | line 151-153 |
| æ·»åŠ è‡ªå®šä¹‰æ¨¡å‹ | `addCustomModel()` | line 461-463 |
| åˆ é™¤è‡ªå®šä¹‰æ¨¡å‹ | `deleteCustomModel()` | line 494-496 |
| ä¿®æ”¹ä¼˜åŒ–é…ç½® | `saveOptimizationConfig()` | line 627-629 |
| ä¿®æ”¹æ€»ç»“é…ç½® | `saveSummaryConfig()` | line 737-739 |

**è°ƒç”¨ä»£ç **ï¼š
```javascript
if (typeof agentChat !== 'undefined' && agentChat) {
    console.log('ğŸ“Š åˆ·æ–°ä¸Šä¸‹æ–‡æ¡å½¢å›¾ (æ¨¡å‹åˆ‡æ¢)');
    agentChat.updateContextUsageBar();
}
```

### 5.2 æ¨¡å‹åˆ‡æ¢çš„æ•°æ®æµ

```
ç”¨æˆ·ç‚¹å‡»åˆ‡æ¢æ¨¡å‹
    â†“
å‰ç«¯: agent-config.js â†’ switchModel(newModelId)
    â†“
è°ƒç”¨ API: POST /api/agent/model-config/update/
    body: {current_model_id: "new_model_id"}
    â†“
åç«¯: æ›´æ–° UserData.agent_config
    â†“
å‰ç«¯: è°ƒç”¨ agentChat.updateContextUsageBar()
    â†“
å‰ç«¯: è°ƒç”¨ API: GET /api/agent/context-usage/?session_id=xxx
    â†“
åç«¯: get_current_model_config(user) â† è¯»å–åˆšæ›´æ–°çš„é…ç½®
    â†“
è¿”å›æ–°æ¨¡å‹çš„ context_window å’Œé‡æ–°è®¡ç®—çš„ Token æ•°
    â†“
å‰ç«¯: renderContextUsageBar(data) â† é‡æ–°æ¸²æŸ“æ¡å½¢å›¾
```

### 5.3 æ”¯æŒ/ä¸æ”¯æŒå¤šæ¨¡æ€åˆ‡æ¢æ—¶çš„ç‰¹æ®Šå¤„ç†

#### Vision â†’ é Visionï¼ˆéœ€è¦ OCRï¼‰

**ä»£ç ä½ç½®**: `agent-config.js` line 158-163

```javascript
// æ£€æŸ¥æ˜¯å¦ä» Vision æ¨¡å‹åˆ‡æ¢åˆ°çº¯æ–‡æœ¬æ¨¡å‹
const newSupportsVision = newModel?.supports_vision || false;

if (prevSupportsVision && !newSupportsVision) {
    // ä» Vision â†’ çº¯æ–‡æœ¬ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å¾… OCR çš„å›¾ç‰‡
    this.checkPendingOCR();
}
```

**å¤„ç†é€»è¾‘**:
1. æ£€æµ‹æ¨¡å‹èƒ½åŠ›å˜åŒ–ï¼ˆ`prevSupportsVision` vs `newSupportsVision`ï¼‰
2. å¦‚æœä» Vision åˆ‡æ¢åˆ°é Visionï¼Œè°ƒç”¨ `checkPendingOCR()`
3. æç¤ºç”¨æˆ·æ˜¯å¦éœ€è¦å¯¹å†å²å›¾ç‰‡è¿›è¡Œ OCR å¤„ç†

**Token ç»Ÿè®¡å½±å“**:
- Vision æ¨¡å¼: å›¾ç‰‡æŒ‰ Base64 å‘é€ï¼Œ~85-765 tokens/å›¾
- OCR æ¨¡å¼: å›¾ç‰‡å…ˆæå–æ–‡å­—ï¼ŒæŒ‰æ–‡å­—é•¿åº¦è®¡è´¹
- åˆ‡æ¢æ—¶ï¼Œ**å†å²æ¶ˆæ¯çš„ Token ä¼°ç®—å€¼ä¸ä¼šè‡ªåŠ¨é‡ç®—**
- åªæœ‰æ–°æ¶ˆæ¯ä¼šä½¿ç”¨æ–°çš„ä¼°ç®—æ–¹å¼

---

## å…­ã€å…³é”®é—®é¢˜å›ç­”

### Q1: å‰ç«¯æ˜¾ç¤ºçš„å½“å‰å·²ä½¿ç”¨ Token æ•°æ¥æºäºå“ªé‡Œï¼Ÿ

**A**: 
- **æ¥æº**: `/api/agent/context-usage/` API
- **è®¡ç®—**: `views_api.py` ä¸­çš„ `estimate_tokens()` å‡½æ•°
- **æ–¹æ³•**: å­—ç¬¦æ•°å…¬å¼ï¼ˆä¸­æ–‡ Ã— 0.7 + å…¶ä»– Ã— 0.3 + 4ï¼‰
- **çŠ¶æ€**: âš ï¸ **é¢„ä¼°å€¼ï¼Œä¸å‡†ç¡®**

---

### Q2: ç³»ç»Ÿå·²ä½¿ç”¨ Token æ•°æ¥æºäºå“ªé‡Œï¼Ÿ

**A**: 
åŒ…å«åœ¨ `recent_tokens` ä¸­ï¼Œå…·ä½“ç»„æˆï¼š
- System Prompt (Agent æŒ‡ä»¤)
- ç”¨æˆ·æ¶ˆæ¯å†å²
- AI å›å¤å†å²
- å·¥å…·è°ƒç”¨ç»“æœ

**æ³¨æ„**: âŒ **ä¸åŒ…å«å·¥å…·å®šä¹‰ JSON Schema**ï¼ˆ~4000 tokensï¼‰

---

### Q3: æ˜¯å¦å­˜åœ¨é¢„ä¼°çš„æƒ…å†µï¼Ÿ

**A**: 
âœ… **æ˜¯çš„ï¼Œ100% ä½¿ç”¨é¢„ä¼°å€¼ï¼**

å‰ç«¯æ˜¾ç¤ºçš„æ‰€æœ‰ Token æ•°æ®éƒ½æ¥è‡ªæœ¬åœ°ä¼°ç®—ï¼š
- `estimate_tokens()` å‡½æ•°ï¼ˆå­—ç¬¦æ•°å…¬å¼ï¼‰
- å›¾ç‰‡å›ºå®š 85 tokens
- ä¸åŒ…å«å·¥å…·å®šä¹‰

**è®¡è´¹æ•°æ®æ¥æºä¸åŒ**:
- è®¡è´¹: `response.usage_metadata`ï¼ˆAPI è¿”å›ï¼Œç²¾ç¡®ï¼‰
- æ˜¾ç¤º: `estimate_tokens()`ï¼ˆæœ¬åœ°è®¡ç®—ï¼Œç²—ç•¥ï¼‰

---

### Q4: åˆ‡æ¢æ¨¡å‹æ—¶ï¼ŒToken ç»Ÿè®¡æ˜¯å¦èƒ½æ­£ç¡®åº”å˜ï¼Ÿ

**A**: 
âœ… **èƒ½ï¼Œä½†ä»…é™æ–°æ¶ˆæ¯**

**åº”å˜æœºåˆ¶**:
1. åˆ‡æ¢æ¨¡å‹åç«‹å³è°ƒç”¨ `updateContextUsageBar()`
2. é‡æ–°è·å– `context_window`ï¼ˆæ–°æ¨¡å‹çš„ä¸Šä¸‹æ–‡çª—å£ï¼‰
3. é‡æ–°è®¡ç®— `target_max_tokens` å’Œ `trigger_tokens`
4. é‡æ–°éå†æ¶ˆæ¯ï¼Œä½¿ç”¨ `estimate_tokens()` è®¡ç®—

**å±€é™**:
- âŒ å†å²æ¶ˆæ¯çš„ä¼°ç®—å€¼ä¸ä¼šæ”¹å˜ï¼ˆä»ä½¿ç”¨å­—ç¬¦æ•°å…¬å¼ï¼‰
- âŒ ä¸ä¼šè¿½æº¯é‡æ–°è®¡ç®—å†å²å›¾ç‰‡çš„ Token æ•°
- âŒ ä¸ä¼šè€ƒè™‘ä¸åŒæ¨¡å‹çš„ tokenizer å·®å¼‚

---

### Q5: æ”¹å˜çš„æ—¶æœºæ˜¯ä»€ä¹ˆï¼Ÿ

**A**: 
**ç«‹å³æ”¹å˜**ï¼ˆåŒæ­¥æ›´æ–°ï¼‰

```
åˆ‡æ¢æ¨¡å‹ â†’ ä¿å­˜é…ç½® â†’ updateContextUsageBar() â†’ é‡æ–°æ¸²æŸ“
            â†‘____________å®Œæˆåè§¦å‘____________â†‘
```

**æ—¶é—´çº¿**:
- 0ms: ç”¨æˆ·ç‚¹å‡»åˆ‡æ¢
- ~100ms: POST /api/agent/model-config/update/ å®Œæˆ
- ~200ms: GET /api/agent/context-usage/ è¿”å›æ–°æ•°æ®
- ~300ms: renderContextUsageBar() é‡æ–°æ¸²æŸ“

---

### Q6: æ”¹å˜å€¼æ˜¯åŸºäºä»€ä¹ˆï¼Ÿ

**A**: 
**åŸºäºæ–°æ¨¡å‹çš„é…ç½® + é‡æ–°ä¼°ç®—**

**æ”¹å˜çš„å€¼**:
- `context_window`: ä»æ–°æ¨¡å‹çš„ `model_config` è·å–
- `target_max_tokens`: `context_window Ã— target_usage_ratio`
- `trigger_tokens`: `target_max_tokens Ã— summary_trigger_ratio`
- `recent_tokens`: é‡æ–°éå†æ¶ˆæ¯ï¼Œä½¿ç”¨ `estimate_tokens()` è®¡ç®—

**ä¸å˜çš„å€¼**:
- `summary_tokens`: ä» `AgentSession` è¡¨è¯»å–ï¼ˆå†å²æ€»ç»“çš„å®é™… Token æ•°ï¼‰
- æ¶ˆæ¯å†…å®¹æœ¬èº«

---

## ä¸ƒã€Vision â†” é Vision åˆ‡æ¢çš„ç‰¹æ®Šæƒ…å†µ

### 7.1 Vision â†’ é Visionï¼ˆæ”¯æŒ â†’ ä¸æ”¯æŒï¼‰

**é—®é¢˜**: å†å²å›¾ç‰‡ä½¿ç”¨äº† Base64 æ–¹å¼ï¼Œä½†æ–°æ¨¡å‹ä¸æ”¯æŒ

**å¤„ç†**:
```javascript
if (prevSupportsVision && !newSupportsVision) {
    this.checkPendingOCR();  // æç¤ºç”¨æˆ·å¯¹å†å²å›¾ç‰‡è¿›è¡Œ OCR
}
```

**Token ç»Ÿè®¡å˜åŒ–**:

| é¡¹ç›® | åˆ‡æ¢å‰ï¼ˆVisionï¼‰ | åˆ‡æ¢åï¼ˆé Visionï¼‰ |
|------|------------------|---------------------|
| å†å²å›¾ç‰‡ Token | 85-765 tokens/å›¾ | âŒ æ— æ³•é‡æ–°è®¡ç®— |
| æ–°ä¸Šä¼ å›¾ç‰‡ Token | 85-765 tokens/å›¾ | æŒ‰ OCR æ–‡å­—é•¿åº¦è®¡ç®— |
| å‰ç«¯æ˜¾ç¤º | å›ºå®š 85 tokens/å›¾ | å›ºå®š 85 tokens/å›¾ |

**âš ï¸ æ³¨æ„**: åˆ‡æ¢åï¼Œå†å²å›¾ç‰‡çš„ Token ä¼°ç®—å€¼**ä¸ä¼šè‡ªåŠ¨æ›´æ–°**

---

### 7.2 é Vision â†’ Visionï¼ˆä¸æ”¯æŒ â†’ æ”¯æŒï¼‰

**Token ç»Ÿè®¡å˜åŒ–**:

| é¡¹ç›® | åˆ‡æ¢å‰ï¼ˆé Visionï¼‰ | åˆ‡æ¢åï¼ˆVisionï¼‰ |
|------|---------------------|------------------|
| å†å²å›¾ç‰‡ Token | æŒ‰ OCR æ–‡å­—é•¿åº¦ | âŒ æ— æ³•é‡æ–°è®¡ç®— |
| æ–°ä¸Šä¼ å›¾ç‰‡ Token | æŒ‰ OCR æ–‡å­—é•¿åº¦ | 85-765 tokens/å›¾ |
| å‰ç«¯æ˜¾ç¤º | å›ºå®š 85 tokens/å›¾ | å›ºå®š 85 tokens/å›¾ |

**âš ï¸ æ³¨æ„**: åˆ‡æ¢åï¼Œå†å²å›¾ç‰‡çš„ Token ä¼°ç®—å€¼**ä¸ä¼šè‡ªåŠ¨æ›´æ–°**

---

## å…«ã€å­˜åœ¨çš„é—®é¢˜ä¸ä¼˜åŒ–å»ºè®®

### 8.1 å­˜åœ¨çš„é—®é¢˜

| é—®é¢˜ | å½±å“ | ä¸¥é‡æ€§ |
|------|------|--------|
| âŒ å‰ç«¯æ˜¾ç¤ºä¸åŒ…å«å·¥å…·å®šä¹‰ | æ˜¾ç¤ºå€¼è¿œå°äºå®é™…å€¼ï¼ˆ~4000 tokens åå·®ï¼‰ | ğŸ”´ é«˜ |
| âŒ å›¾ç‰‡ Token å›ºå®š 85 | Vision é«˜æ¸…å›¾ç‰‡æ—¶åå·®å¤§ï¼ˆå®é™…å¯è¾¾ 765 tokensï¼‰ | ğŸŸ¡ ä¸­ |
| âŒ å­—ç¬¦æ•°ä¼°ç®—ä¸å‡† | Â±20-30% è¯¯å·® | ğŸŸ¡ ä¸­ |
| âŒ å†å²æ¶ˆæ¯ä¸è¿½æº¯é‡ç®— | æ¨¡å‹åˆ‡æ¢åï¼Œå†å² Token æ•°ä¸å‡† | ğŸŸ¢ ä½ |
| âŒ ä¸åŒæ¨¡å‹ tokenizer ä¸åŒ | GPT vs DeepSeek vs Qwen çš„ä¼°ç®—åå·® | ğŸŸ¢ ä½ |

---

### 8.2 ä¼˜åŒ–å»ºè®®

#### ğŸ¯ å»ºè®® 1: å‰ç«¯æ˜¾ç¤ºæ ‡æ³¨"é¢„ä¼°å€¼"

**ä¿®æ”¹ä½ç½®**: `core/templates/home.html` line 795-800

```html
<div class="context-usage-bar-container" id="contextUsageBarContainer" 
     title="ä¸Šä¸‹æ–‡ä½¿ç”¨æƒ…å†µï¼ˆé¢„ä¼°å€¼ï¼Œä¸å«å·¥å…·å®šä¹‰ï¼‰">
    <!-- ... -->
</div>
```

**ä¿®æ”¹ tooltip å†…å®¹**: `agent-chat.js` line 4975

```javascript
tooltipHTML += `<div class="tooltip-divider"></div>`;
tooltipHTML += `<div>æ€»è®¡: ${this.formatTokens(total_tokens)} / ${this.formatTokens(target_max_tokens)}</div>`;
tooltipHTML += `<div style="color: #999; font-size: 0.9em;">âš ï¸ é¢„ä¼°å€¼ï¼Œä¸å«å·¥å…·å®šä¹‰ï¼ˆ~4k tokensï¼‰</div>`;  // â† æ–°å¢
tooltipHTML += `<div><span class="tooltip-trigger">âš¡</span> ${triggerPercent.toFixed(0)}% æ—¶è§¦å‘æ€»ç»“</div>`;
```

---

#### ğŸ¯ å»ºè®® 2: åç«¯ä¼°ç®—æ—¶è€ƒè™‘å·¥å…·å®šä¹‰

**ä¿®æ”¹ä½ç½®**: `agent_service/views_api.py` line 1870

```python
def estimate_tokens(text):
    # ... existing code ...
    return int(chinese_chars * 0.7 + other_chars * 0.3) + 4

# æ–°å¢ï¼šä¼°ç®—å·¥å…·å®šä¹‰çš„ Token æ•°
def estimate_tool_definition_tokens(user):
    """ä¼°ç®—å½“å‰å¯ç”¨çš„å·¥å…·å®šä¹‰çš„ Token æ•°"""
    # ç®€å•ä¼°ç®—ï¼šæ¯ä¸ªå·¥å…·çº¦ 80 tokens
    # TODO: å¯ä»¥ä» agent_graph.py è·å–å®é™…å·¥å…·åˆ—è¡¨
    return 50 * 80  # å‡è®¾ 50 ä¸ªå·¥å…·
```

**ä¿®æ”¹æ€»è®¡ç®—**:
```python
total_tokens = summary_tokens + recent_tokens + estimate_tool_definition_tokens(user)
```

---

#### ğŸ¯ å»ºè®® 3: æ”¯æŒä½¿ç”¨ tiktoken ç²¾ç¡®è®¡ç®—

**ä¿®æ”¹ä½ç½®**: `agent_service/views_api.py` line 1870

```python
def estimate_tokens(text, use_tiktoken=False, model_name='gpt-3.5-turbo'):
    """
    ä¼°ç®— Token æ•°
    
    Args:
        text: æ–‡æœ¬å†…å®¹
        use_tiktoken: æ˜¯å¦ä½¿ç”¨ tiktoken åº“ï¼ˆæ›´å‡†ç¡®ï¼‰
        model_name: æ¨¡å‹åç§°ï¼ˆç”¨äºé€‰æ‹© tokenizerï¼‰
    """
    if use_tiktoken:
        try:
            import tiktoken
            encoding = tiktoken.encoding_for_model(model_name)
            return len(encoding.encode(str(text)))
        except Exception as e:
            logger.warning(f"tiktoken è®¡ç®—å¤±è´¥ï¼Œé™çº§ä¸ºå­—ç¬¦æ•°ä¼°ç®—: {e}")
    
    # é™çº§ä¸ºå­—ç¬¦æ•°ä¼°ç®—
    # ... existing code ...
```

---

#### ğŸ¯ å»ºè®® 4: æ¨¡å‹åˆ‡æ¢æ—¶æ˜¾ç¤ºè­¦å‘Š

**ä¿®æ”¹ä½ç½®**: `agent-config.js` line 158

```javascript
if (prevSupportsVision && !newSupportsVision) {
    this.showWarning('âš ï¸ å·²åˆ‡æ¢åˆ°éè§†è§‰æ¨¡å‹ï¼Œå†å²å›¾ç‰‡ Token ç»Ÿè®¡å¯èƒ½ä¸å‡†ç¡®');
    this.checkPendingOCR();
}
```

---

#### ğŸ¯ å»ºè®® 5: æ·»åŠ "é‡æ–°è®¡ç®—"æŒ‰é’®

**æ–°å¢åŠŸèƒ½**: å…è®¸ç”¨æˆ·æ‰‹åŠ¨è§¦å‘ Token é‡æ–°è®¡ç®—

```javascript
async recalculateContextUsage() {
    // è°ƒç”¨åç«¯æ¥å£ï¼Œä½¿ç”¨å½“å‰æ¨¡å‹çš„ tokenizer é‡æ–°è®¡ç®—æ‰€æœ‰æ¶ˆæ¯
    const response = await fetch('/api/agent/context-usage/recalculate/', {
        method: 'POST',
        body: JSON.stringify({session_id: this.sessionId})
    });
    // ...
}
```

---

## ä¹ã€ä»£ç ä¿®æ”¹æ¸…å•

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | ä¼˜å…ˆçº§ |
|------|----------|--------|
| `core/templates/home.html` | æ·»åŠ "é¢„ä¼°å€¼"æç¤º | ğŸ”´ é«˜ |
| `core/static/js/agent-chat.js` | ä¿®æ”¹ tooltip å†…å®¹ï¼Œæ ‡æ³¨é¢„ä¼°è­¦å‘Š | ğŸ”´ é«˜ |
| `agent_service/views_api.py` | æ·»åŠ å·¥å…·å®šä¹‰ Token ä¼°ç®— | ğŸŸ¡ ä¸­ |
| `agent_service/views_api.py` | æ”¯æŒä½¿ç”¨ tiktoken ç²¾ç¡®è®¡ç®— | ğŸŸ¡ ä¸­ |
| `agent-config.js` | æ¨¡å‹åˆ‡æ¢æ—¶æ˜¾ç¤ºè­¦å‘Š | ğŸŸ¢ ä½ |
| `agent_service/views_api.py` | æ–°å¢ `/recalculate/` API | ğŸŸ¢ ä½ |

---

## åã€æ€»ç»“

### å…³é”®è¦ç‚¹

1. âš ï¸ **å‰ç«¯æ˜¾ç¤ºçš„ Token æ•°æ˜¯é¢„ä¼°å€¼ï¼Œä¸æ˜¯å®é™…è®¡è´¹æ•°æ®**
2. âš ï¸ **é¢„ä¼°å€¼ä¸åŒ…å«å·¥å…·å®šä¹‰ï¼ˆ~4000 tokensï¼‰ï¼Œå¯¼è‡´æ˜¾ç¤ºå€¼è¿œå°äºå®é™…å€¼**
3. âœ… **åˆ‡æ¢æ¨¡å‹æ—¶ä¼šç«‹å³é‡æ–°è®¡ç®—å¹¶æ›´æ–°æ˜¾ç¤º**
4. âš ï¸ **åˆ‡æ¢ Vision â†” é Vision æ¨¡å‹æ—¶ï¼Œå†å²å›¾ç‰‡çš„ Token æ•°ä¸ä¼šè¿½æº¯é‡ç®—**
5. âœ… **è®¡è´¹æ•°æ®ä½¿ç”¨ API è¿”å›çš„ç²¾ç¡®å€¼ï¼ˆ`response.usage_metadata`ï¼‰ï¼Œä¸å—å‰ç«¯æ˜¾ç¤ºå½±å“**

### ç”¨æˆ·å»ºè®®

1. **ä¸è¦ä¾èµ–å‰ç«¯æ˜¾ç¤ºåˆ¤æ–­å®é™…æ¶ˆè€—**ï¼šå‰ç«¯å€¼ä»…ä¾›å‚è€ƒ
2. **æŸ¥çœ‹è®¡è´¹è¯¦æƒ…**ï¼šä½¿ç”¨ `/api/agent/token-usage/` æŸ¥çœ‹å‡†ç¡®çš„è®¡è´¹è®°å½•
3. **åˆ‡æ¢æ¨¡å‹åæ£€æŸ¥ä¸Šä¸‹æ–‡**ï¼šVision â†” é Vision åˆ‡æ¢æ—¶ï¼Œæ³¨æ„ Token ç»Ÿè®¡å·®å¼‚
4. **å®šæœŸæ¸…ç†ä¼šè¯**ï¼šé¿å…ä¸Šä¸‹æ–‡è¿‡é•¿å¯¼è‡´ä¼°ç®—è¯¯å·®ç´¯ç§¯

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¥æœŸ**: 2026-02-18  
**ç»´æŠ¤è€…**: AI Assistant
