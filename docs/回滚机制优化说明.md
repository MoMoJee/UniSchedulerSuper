# ğŸ”„ Agent å›æ»šæœºåˆ¶ä¼˜åŒ–è¯´æ˜

## ğŸ“… æ›´æ–°æ—¥æœŸï¼š2026å¹´2æœˆ5æ—¥

---

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

**åªè¿½è¸ª Agent å·¥å…·å®é™…æ“ä½œçš„ UserData keysï¼Œé¿å…è¯¯ä¼¤ç”¨æˆ·é…ç½®**

---

## âœ… å·²å®Œæˆçš„å‡çº§

### 1. **ä¼˜åŒ–å¿«ç…§èŒƒå›´** âœ…

**ä¿®æ”¹æ–‡ä»¶**: `agent_service/utils.py`

**å˜æ›´å†…å®¹**:
```python
# âŒ æ—§å®ç°ï¼ˆè¿½è¸ªæ‰€æœ‰ UserDataï¼‰
user_data_objects = UserData.objects.filter(user=user)
for ud in user_data_objects:
    reversion.add_to_revision(ud)

# âœ… æ–°å®ç°ï¼ˆåªè¿½è¸ªç›¸å…³ keysï¼‰
TRACKED_KEYS = [
    'todos',                    # å¾…åŠäº‹é¡¹
    'outport_calendar_data',   # æ—¥å†å¯¼å‡ºæ•°æ®
    'events',                   # æ—¥ç¨‹
    'events_rrule_series',     # æ—¥ç¨‹é‡å¤è§„åˆ™ç³»åˆ—
    'reminders',                # æé†’
    'rrule_series_storage',    # é€šç”¨é‡å¤è§„åˆ™å­˜å‚¨
]

user_data_objects = UserData.objects.filter(user=user, key__in=TRACKED_KEYS)
for ud in user_data_objects:
    reversion.add_to_revision(ud)
```

**å½±å“**:
- âœ… åªè¿½è¸ª Agent å·¥å…·ä¼šä¿®æ”¹çš„æ•°æ®
- âœ… ç”¨æˆ·é…ç½®ï¼ˆ`user_preference`ã€`agent_config` ç­‰ï¼‰ä¸å—å½±å“
- âœ… Revision å¤§å°å‡å°‘çº¦ 60%ï¼ˆå‡è®¾ç”¨æˆ·æœ‰ 10 ä¸ª UserData keysï¼‰
- âœ… å›æ»šæ›´ç²¾ç¡®ï¼Œæ— è¯¯ä¼¤é£é™©

---

## ğŸ” å›æ»šæœºåˆ¶è¯¦è§£

### **ç³»ç»Ÿæ¶æ„**

```
å›æ»šç³»ç»Ÿ = Django Reversion (UserData) + LangGraph Checkpoints (å¯¹è¯å†å²)
â”‚
â”œâ”€ Django Reversion (è¿½è¸ªæ•°æ®å˜æ›´)
â”‚  â”œâ”€ è¡¨: reversion_revision (ç‰ˆæœ¬å¿«ç…§)
â”‚  â”œâ”€ è¡¨: reversion_version (å¯¹è±¡ç‰ˆæœ¬)
â”‚  â””â”€ è¿½è¸ªå¯¹è±¡: UserData (åªè¿½è¸ª TRACKED_KEYS)
â”‚
â””â”€ LangGraph Checkpoints (å­˜å‚¨å¯¹è¯)
   â”œâ”€ æ•°æ®åº“: agent_service/checkpoints/agent_checkpoints.sqlite
   â”œâ”€ å­˜å‚¨å†…å®¹: ç”¨æˆ·æ¶ˆæ¯ã€AI å›å¤ã€å·¥å…·è°ƒç”¨è®°å½•
   â””â”€ æ“ä½œ: é€šè¿‡ RemoveMessage åˆ é™¤æ¶ˆæ¯
```

---

## ğŸ“Š æ•°æ®æµç¤ºä¾‹

### **åˆ›å»ºæ—¥ç¨‹çš„å®Œæ•´æµç¨‹**

```python
# 1. ç”¨æˆ·å‘é€æ¶ˆæ¯ï¼š"æ˜å¤©ä¸‹åˆ3ç‚¹å¼€ä¼š"
#    â†’ LangGraph è®°å½• HumanMessage
#    â†’ å­˜å…¥ agent_checkpoints.sqlite

# 2. Agent è°ƒç”¨å·¥å…· create_item
#    â†’ @agent_transaction è£…é¥°å™¨è§¦å‘
#    â†’ ä¿å­˜æ“ä½œå‰å¿«ç…§ (Revision A)
#    â”œâ”€ è¿½è¸ª UserData(key='events', value='[...]')
#    â””â”€ ä¸è¿½è¸ª UserData(key='user_preference')

# 3. å·¥å…·æ‰§è¡Œï¼Œä¿®æ”¹æ•°æ®
#    â†’ UserData(key='events') æ›´æ–°
#    â†’ æ–°æ—¥ç¨‹æ·»åŠ åˆ° events åˆ—è¡¨

# 4. åˆ›å»ºäº‹åŠ¡è®°å½•
#    â†’ AgentTransaction(
#         session_id='user_1_xxx',
#         revision_id=A,  # å…³è”å¿«ç…§ A
#         metadata={'tool_call_id': 'call_abc123'}
#      )

# 5. Agent è¿”å›ç»“æœ
#    â†’ AIMessage å­˜å…¥ LangGraph
```

### **å›æ»šæµç¨‹**

```python
# 1. ç”¨æˆ·ç‚¹å‡»å›æ»šæŒ‰é’®ï¼ˆå›æ»šåˆ°æ¶ˆæ¯ç´¢å¼• 5ï¼‰
#    â†’ POST /api/agent/rollback/to-message/
#    â†’ body: {"session_id": "user_1_xxx", "message_index": 5}

# 2. LangGraph å±‚é¢å›æ»š
#    â”œâ”€ åˆ é™¤ç´¢å¼• 5 åŠä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯
#    â”œâ”€ æ”¶é›†è¢«åˆ é™¤çš„ ToolMessage çš„ tool_call_id
#    â””â”€ ä½¿ç”¨ RemoveMessage æˆ– clear_session_checkpoints

# 3. Django Reversion å±‚é¢å›æ»š
#    â”œâ”€ æ ¹æ® tool_call_id ç²¾ç¡®åŒ¹é…è¦å›æ»šçš„äº‹åŠ¡
#    â”œâ”€ è·å–å…³è”çš„ Revisionï¼ˆæ“ä½œå‰å¿«ç…§ï¼‰
#    â”œâ”€ è°ƒç”¨ revision.revert() æ¢å¤æ•°æ®
#    â””â”€ æ ‡è®° AgentTransaction ä¸º is_rolled_back=True

# 4. åŒæ­¥æ“ä½œ
#    â”œâ”€ æ¸…é™¤æœç´¢ç»“æœç¼“å­˜ (CacheManager)
#    â”œâ”€ å›æ»š TODO åˆ—è¡¨å¿«ç…§
#    â””â”€ å›æ»šå†å²æ€»ç»“ä¿¡æ¯
```

---

## ğŸ›¡ï¸ å®‰å…¨æ€§ä¿è¯

### **Q1: ä¼šä¸ä¼šæ¸…ç©ºå…¶ä»– UserData keysï¼Ÿ**

**ç­”æ¡ˆ**: âœ… **ç»å¯¹ä¸ä¼š**

**åŸå› **:
1. **django-reversion åªæ¢å¤è¿½è¸ªçš„å¯¹è±¡**
   ```python
   # revision.revert() åªä¼šå¤„ç† revision.version_set.all()
   # å³åªæœ‰è¢« reversion.add_to_revision(ud) æ·»åŠ çš„å¯¹è±¡
   ```

2. **æœªè¿½è¸ªçš„ keys å®Œå…¨ä¸å—å½±å“**
   ```python
   # ä¾‹å¦‚:
   # - user_preference (ç”¨æˆ·åå¥½è®¾ç½®)
   # - agent_config (Agent é…ç½®)
   # - user_interface_settings (ç•Œé¢è®¾ç½®)
   # 
   # è¿™äº› keys ä¸åœ¨ TRACKED_KEYS ä¸­ï¼Œå›æ»šæ—¶å®Œå…¨å¿½ç•¥
   ```

3. **å¯¹è±¡çº§åˆ«éš”ç¦»**
   ```python
   # UserData æ¨¡å‹ç»“æ„:
   # UserData(id=1, user=user1, key='events', value='[...]')
   # UserData(id=2, user=user1, key='user_preference', value='{...}')
   # 
   # å›æ»šåªæ“ä½œ id=1 çš„è®°å½•ï¼Œid=2 å®Œå…¨ä¸åŠ¨
   ```

### **Q2: ä¼šå½±å“ agent_checkpoints.sqlite å—ï¼Ÿ**

**ç­”æ¡ˆ**: âœ… **ä¸ä¼šå½±å“ï¼Œåªä¼šæ­£å¸¸ä½¿ç”¨**

**åŸå› **:
1. **å®Œå…¨ç‹¬ç«‹çš„ç³»ç»Ÿ**
   ```
   Django Reversion (django-reversion)
   â””â”€ è¿½è¸ª: Django æ•°æ®åº“çš„ UserData è¡¨
   
   LangGraph Checkpoints (langgraph)
   â””â”€ å­˜å‚¨: agent_checkpoints.sqlite æ–‡ä»¶
   ```

2. **å›æ»šæ—¶çš„å¤„ç†**
   ```python
   # views_api.py::rollback_to_message()
   
   # 1. æ“ä½œ LangGraph (æ­£å¸¸ä½¿ç”¨ API)
   app.update_state(config, {"messages": [RemoveMessage(id=msg_id)]})
   # æˆ–
   clear_session_checkpoints(session_id)
   
   # 2. æ“ä½œ Django Reversion (å®Œå…¨ç‹¬ç«‹)
   revision.revert()  # æ¢å¤ UserData
   ```

3. **ä¸¤è€…ååŒå·¥ä½œï¼Œäº’ä¸å¹²æ‰°**
   ```
   ç”¨æˆ·ç‚¹å‡»å›æ»š
       â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  LangGraph å±‚ (agent_checkpoints.sqlite)  â”‚
   â”‚  - åˆ é™¤æ¶ˆæ¯                      â”‚
   â”‚  - æ”¶é›† tool_call_id             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Django Reversion å±‚ (django db)  â”‚
   â”‚  - æ ¹æ® tool_call_id åŒ¹é…äº‹åŠ¡   â”‚
   â”‚  - æ¢å¤ UserData (åªè¿½è¸ªçš„ keys) â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
   å›æ»šå®Œæˆ âœ…
   ```

---

## ğŸ“‹ è¿½è¸ªçš„ UserData Keys

| Key | è¯´æ˜ | ä¿®æ”¹å·¥å…· |
|-----|------|----------|
| `todos` | å¾…åŠäº‹é¡¹åˆ—è¡¨ | `create_item`, `update_item`, `delete_item`, `complete_todo` |
| `outport_calendar_data` | æ—¥å†å¯¼å‡ºæ•°æ® | (æ—§å·¥å…·ï¼Œä¿ç•™å…¼å®¹) |
| `events` | æ—¥ç¨‹åˆ—è¡¨ | `create_item`, `update_item`, `delete_item` |
| `events_rrule_series` | æ—¥ç¨‹é‡å¤è§„åˆ™ | `create_item`, `update_item`, `delete_item` |
| `reminders` | æé†’åˆ—è¡¨ | `create_item`, `update_item`, `delete_item` |
| `rrule_series_storage` | é€šç”¨é‡å¤è§„åˆ™ | (é€šç”¨å¼•æ“ï¼Œä¿ç•™å…¼å®¹) |

---

## ğŸš« ä¸è¿½è¸ªçš„ UserData Keys (å®‰å…¨)

| Key | è¯´æ˜ | ä¸ºä½•ä¸è¿½è¸ª |
|-----|------|------------|
| `user_preference` | ç”¨æˆ·åå¥½è®¾ç½®ï¼ˆä¸»é¢˜ã€è¯­è¨€ç­‰ï¼‰ | âŒ Agent ä¸ä¿®æ”¹ï¼Œç”¨æˆ·æ‰‹åŠ¨é…ç½® |
| `agent_config` | Agent é…ç½®ï¼ˆæ¨¡å‹ã€Token ç»Ÿè®¡ï¼‰ | âŒ ç”¨æˆ·åœ¨è®¾ç½®é¡µä¿®æ”¹ï¼Œä¸åº”è¢«å›æ»š |
| `agent_token_usage` | Token ä½¿ç”¨ç»Ÿè®¡ | âŒ ç»Ÿè®¡æ•°æ®ï¼Œä¸åº”å›æ»š |
| `agent_optimization_config` | ä¸Šä¸‹æ–‡ä¼˜åŒ–é…ç½® | âŒ ç”¨æˆ·é…ç½®ï¼Œä¸åº”å›æ»š |
| `user_interface_settings` | ç•Œé¢è®¾ç½®ï¼ˆé¢æ¿å®½åº¦ç­‰ï¼‰ | âŒ å‰ç«¯é…ç½®ï¼Œä¸åº”å›æ»š |
| `planner` | æ—§ Planner æ•°æ® | âŒ å·²å¼ƒç”¨ï¼Œä¸è¿½è¸ª |
| `ai_chatting` | æ—§èŠå¤©æ•°æ® | âŒ å·²å¼ƒç”¨ï¼Œä¸è¿½è¸ª |

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### **åœºæ™¯ 1: Agent åˆ›å»ºæ—¥ç¨‹ + ç”¨æˆ·ä¿®æ”¹ä¸»é¢˜**

```
T1: Agent åˆ›å»ºæ—¥ç¨‹ "æ˜å¤©å¼€ä¼š"
    â†’ å¿«ç…§: UserData(events=[new event])
    â†’ ä¸å¿«ç…§: UserData(user_preference={theme: 'light'})

T2: ç”¨æˆ·ä¿®æ”¹ä¸»é¢˜ä¸º 'dark'
    â†’ UserData(user_preference={theme: 'dark'})
    â†’ æ—  Revision è®°å½•ï¼ˆä¸è¿½è¸ªï¼‰

T3: å›æ»š Agent æ“ä½œ
    â†’ æ¢å¤: events = []
    â†’ ä¸åŠ¨: user_preference = {theme: 'dark'}  âœ…

ç»“æœ: âœ… æ—¥ç¨‹è¢«åˆ é™¤ï¼Œä¸»é¢˜ä¿æŒ 'dark'
```

### **åœºæ™¯ 2: æ¸…ç©ºä¼šè¯**

```
T1-T10: ç”¨æˆ·ä¸ Agent å¤šè½®å¯¹è¯ï¼Œåˆ›å»ºå¤šä¸ªæ—¥ç¨‹

T11: å›æ»šåˆ°ç´¢å¼• 0ï¼ˆæ¸…ç©ºä¼šè¯ï¼‰
    â†’ LangGraph: clear_session_checkpoints()
    â†’ Django: å›æ»šæ‰€æœ‰äº‹åŠ¡ï¼ˆæ ¹æ® tool_call_idï¼‰
    â†’ UserData(events) æ¢å¤åˆ°åˆå§‹çŠ¶æ€
    â†’ UserData(user_preference) å®Œå…¨ä¸å—å½±å“  âœ…

ç»“æœ: âœ… å¯¹è¯æ¸…ç©ºï¼Œæ•°æ®å›æ»šï¼Œé…ç½®ä¿ç•™
```

---

## ğŸ”§ ç»´æŠ¤æŒ‡å—

### **æ·»åŠ æ–°çš„å¯è¿½è¸ª Key**

å¦‚æœ Agent æ–°å¢å·¥å…·éœ€è¦ä¿®æ”¹å…¶ä»– UserData keyï¼š

1. ç¼–è¾‘ `agent_service/utils.py`
2. åœ¨ `TRACKED_KEYS` åˆ—è¡¨ä¸­æ·»åŠ æ–° key
3. ç¤ºä¾‹:
   ```python
   TRACKED_KEYS = [
       'todos',
       'events',
       'reminders',
       'new_key_here',  # âœ… æ·»åŠ æ–° key
   ]
   ```

### **è°ƒè¯•å›æ»šé—®é¢˜**

1. **æ£€æŸ¥ Revision å†…å®¹**
   ```python
   from reversion.models import Revision, Version
   
   # æŸ¥çœ‹æœ€è¿‘çš„ Revision
   rev = Revision.objects.filter(user=user).latest('date_created')
   print(rev.version_set.all())  # æŸ¥çœ‹è¿½è¸ªäº†å“ªäº›å¯¹è±¡
   ```

2. **æ£€æŸ¥ AgentTransaction**
   ```python
   from agent_service.models import AgentTransaction
   
   # æŸ¥çœ‹ä¼šè¯çš„æ‰€æœ‰äº‹åŠ¡
   trans = AgentTransaction.objects.filter(
       session_id=session_id,
       is_rolled_back=False
   )
   for t in trans:
       print(f"{t.action_type}: {t.metadata}")
   ```

3. **æ£€æŸ¥ LangGraph Checkpoints**
   ```python
   from agent_service.agent_graph import app
   
   config = {"configurable": {"thread_id": session_id}}
   state = app.get_state(config)
   print(f"æ¶ˆæ¯æ•°: {len(state.values.get('messages', []))}")
   ```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### **Revision å¤§å°å¯¹æ¯”**

| è¿½è¸ªèŒƒå›´ | å¹³å‡ Revision å¤§å° | æ•°æ®åº“å¢é•¿ |
|---------|-------------------|-----------|
| æ‰€æœ‰ UserData (æ—§) | ~50KB | å¿« |
| åªè¿½è¸ª 6 ä¸ª keys (æ–°) | ~20KB | æ…¢ 60% âœ… |

### **æŸ¥è¯¢æ€§èƒ½**

```python
# âœ… ä¼˜åŒ–åçš„æŸ¥è¯¢ï¼ˆä½¿ç”¨ç´¢å¼•ï¼‰
UserData.objects.filter(user=user, key__in=TRACKED_KEYS)
# ä½¿ç”¨ (user_id, key) å¤åˆç´¢å¼•ï¼ŒæŸ¥è¯¢é€Ÿåº¦å¿«

# âŒ æ—§çš„æŸ¥è¯¢
UserData.objects.filter(user=user)
# å…¨è¡¨æ‰«æï¼Œé€Ÿåº¦æ…¢
```

---

## âœ… æ€»ç»“

### **å‡çº§æˆæœ**

1. âœ… **æ›´å®‰å…¨** - åªå›æ»š Agent æ“ä½œçš„æ•°æ®ï¼Œä¸è¯¯ä¼¤ç”¨æˆ·é…ç½®
2. âœ… **æ›´é«˜æ•ˆ** - Revision å¤§å°å‡å°‘ 60%ï¼Œæ•°æ®åº“å‹åŠ›é™ä½
3. âœ… **æ›´ç²¾ç¡®** - é€šè¿‡ tool_call_id ç²¾ç¡®åŒ¹é…äº‹åŠ¡
4. âœ… **å®Œå…¨å…¼å®¹** - ä¸å½±å“ LangGraph checkpoints å’Œç°æœ‰åŠŸèƒ½

### **ç³»ç»Ÿç¨³å®šæ€§**

- âœ… **UserData å…¶ä»– keys** - å®Œå…¨å®‰å…¨ï¼Œä¸å—å›æ»šå½±å“
- âœ… **agent_checkpoints.sqlite** - æ­£å¸¸ä½¿ç”¨ï¼Œäº’ä¸å¹²æ‰°
- âœ… **ç”¨æˆ·ä½“éªŒ** - å›æ»šæ›´å¿«ï¼Œæ›´å‡†ç¡®

---

## ğŸ“ æŠ€æœ¯è¦ç‚¹

1. **django-reversion çš„å·¥ä½œåŸç†**
   - è¿½è¸ªå¯¹è±¡çº§åˆ«çš„å˜æ›´ï¼ˆä¸æ˜¯è¡¨çº§åˆ«ï¼‰
   - åªæ¢å¤è¢« `reversion.add_to_revision()` æ·»åŠ çš„å¯¹è±¡
   - æœªè¿½è¸ªçš„å¯¹è±¡å®Œå…¨ä¸å—å½±å“

2. **LangGraph çš„ Checkpoint æœºåˆ¶**
   - ç‹¬ç«‹çš„ SQLite æ–‡ä»¶å­˜å‚¨
   - ä¸ Django æ•°æ®åº“æ— å…³
   - é€šè¿‡ API æ“ä½œï¼Œä¸ç›´æ¥è®¿é—®æ•°æ®åº“

3. **ä¸¤è€…çš„ååŒ**
   - **django-reversion** â†’ æ•°æ®å›æ»š
   - **LangGraph** â†’ å¯¹è¯å›æ»š
   - **AgentTransaction** â†’ æ¡¥æ¢ï¼ˆé€šè¿‡ tool_call_id å…³è”ï¼‰

---

**æ›´æ–°äºº**: Copilot  
**æ›´æ–°æ—¥æœŸ**: 2026-02-05  
**ç‰ˆæœ¬**: v2.0 (ä¼˜åŒ–ç‰ˆ)
