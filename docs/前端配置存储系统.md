你7/j、u# 前端配置存储系统

## 概述

Agent Chat 模块使用 localStorage 实现用户配置的持久化存储，确保刷新页面后配置能够恢复。

## 存储 Key 规范

| Key 格式 | 说明 | 示例 |
|----------|------|------|
| `agent_config_{userId}` | 用户全局配置 | `agent_config_1` |
| `agent_session_id` | 当前会话 ID | - |
| `rollback_base_{sessionId}` | 会话回滚基准点 | `rollback_base_user_1_xxx` |

## 配置结构

```javascript
// agent_config_{userId}
{
    // 当前启用的工具列表，null 表示使用服务器默认值
    activeTools: ["get_events", "create_event", ...] | null,
    
    // LLM 模型选择（预留字段）
    llmModel: "deepseek-chat",
    
    // LLM 温度参数（预留字段）
    llmTemperature: 0,
    
    // 主题设置（预留字段）
    theme: "auto" | "light" | "dark"
}
```

## API 方法

### 获取配置存储 Key
```javascript
getConfigStorageKey(): string
// 返回: `agent_config_${this.userId}`
```

### 加载用户配置
```javascript
loadUserConfig(): Object
// 返回完整配置对象，如果没有存储则返回默认值
```

### 保存用户配置
```javascript
saveUserConfig(config: Object): void
// 合并保存配置，不会覆盖未传入的字段
```

### 工具选择专用方法
```javascript
getSavedActiveTools(): Array | null
// 获取已保存的工具选择，null 表示使用默认

saveActiveTools(tools: Array): void
// 保存工具选择
```

## 使用示例

### 保存工具选择
```javascript
this.saveActiveTools(['get_events', 'create_event', 'get_reminders']);
```

### 加载时恢复工具选择
```javascript
const savedTools = this.getSavedActiveTools();
if (savedTools !== null) {
    // 过滤掉不再可用的工具
    const allToolNames = this.availableTools.flatMap(cat => cat.tools.map(t => t.name));
    this.activeTools = savedTools.filter(t => allToolNames.includes(t));
} else {
    this.activeTools = data.default_tools || [];
}
```

### 保存 LLM 配置（未来扩展）
```javascript
this.saveUserConfig({
    llmModel: 'gpt-4',
    llmTemperature: 0.7
});
```

## 注意事项

1. **工具可用性过滤**：加载工具选择时，会过滤掉服务器不再提供的工具
2. **合并保存**：`saveUserConfig` 会与现有配置合并，不会丢失其他字段
3. **用户隔离**：配置以 userId 为 key，不同用户互不影响
4. **会话隔离**：回滚基准点以 sessionId 为 key，不同会话互不影响

## 后端工具权限检查

当用户在前端取消选择某个工具后，后端也会进行权限检查：

1. Agent 绑定工具时只绑定 `active_tools` 中的工具
2. ToolNode 执行前检查工具是否在 `active_tools` 中
3. 如果工具未启用，返回错误消息给 Agent：
   ```
   工具 'xxx' 未启用。请在工具选择面板中启用该工具后再试。
   ```
4. Agent 会将此错误信息转述给用户
