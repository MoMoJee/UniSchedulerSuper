# 日历筛选功能实现文档

## 功能概述

在日历界面右上角工具栏（2日、月、周等按钮左侧）添加了"筛选"按钮，支持多维度筛选日程和提醒事件。

## 筛选条件

### 1. 四象限筛选（重要性 + 紧急性）
- ✅ 重要且紧急
- ✅ 重要不紧急
- ✅ 不重要但紧急
- ✅ 不重要不紧急

### 2. 截止时间筛选
- ✅ 有截止时间
- ✅ 无截止时间

### 3. 重复事件筛选
- ✅ 重复事件
- ✅ 单次事件

### 4. 提醒显示
- ✅ 显示提醒（独立控制，提醒不受其他筛选条件影响）

### 5. 日程组筛选
- 可选择特定日程组
- 未选择任何日程组时显示所有分组
- 显示分组颜色标识

## 实现细节

### 1. 数据模型 (`core/models.py`)
在 `user_interface_settings` 的 `DATA_SCHEMA` 中添加了 `calendarFilters` 配置：

```python
"calendarFilters": {
    "quadrants": {
        "importantUrgent": bool,
        "importantNotUrgent": bool,
        "notImportantUrgent": bool,
        "notImportantNotUrgent": bool
    },
    "hasDDL": bool,
    "noDDL": bool,
    "isRecurring": bool,
    "notRecurring": bool,
    "groups": list,  # 选中的日程组ID列表
    "showReminders": bool
}
```

### 2. 设置管理器 (`core/static/js/settings-manager.js`)
添加了：
- `calendarFilters` 默认配置（所有条件默认为 true）
- `onCalendarFilterChange()` - 筛选变化监听
- `applyCalendarFilters()` - 应用筛选设置

### 3. 事件管理器 (`core/static/js/event-manager.js`)
添加了：
- `applyCalendarFilters(events)` - 核心筛选逻辑
- `getEventQuadrant(importance, urgency)` - 象限判断
- `toggleFilterDropdown()` - 显示/隐藏筛选菜单
- `loadFiltersToUI()` - 加载当前筛选配置到UI
- `updateGroupFilterList()` - 更新日程组列表
- `applyFiltersFromUI()` - 从UI读取并应用筛选
- `resetFilters()` - 重置为默认筛选

### 4. UI界面 (`core/templates/home_new.html`)
在日历容器中添加了筛选下拉菜单：
- 位置：日历工具栏筛选按钮下方
- 包含所有筛选条件的复选框
- 应用和重置按钮
- 点击外部自动关闭

### 5. 样式 (`core/static/css/home-styles.css`)
添加了：
- `.calendar-filter-dropdown` - 下拉菜单容器样式
- `.filter-section` - 筛选分组样式
- `.filter-title` - 筛选标题样式
- `.group-color-dot` - 日程组颜色点样式
- `.filter-actions` - 操作按钮区域样式
- 暗色主题适配样式

## 筛选逻辑

### 提醒事件
- 只受 `showReminders` 开关控制
- 不受象限、DDL、重复、分组筛选影响

### 普通事件
需同时满足以下所有条件才显示：

1. **象限检查**：根据 `importance` 和 `urgency` 判断所属象限，检查该象限是否被勾选
2. **DDL检查**：
   - 如果事件有DDL，检查 `hasDDL` 是否为 true
   - 如果事件无DDL，检查 `noDDL` 是否为 true
3. **重复检查**：
   - 如果事件是重复事件（`rrule` 包含 'FREQ='），检查 `isRecurring` 是否为 true
   - 如果事件是单次事件，检查 `notRecurring` 是否为 true
4. **分组检查**：
   - 如果 `groups` 数组为空，显示所有分组
   - 如果 `groups` 数组不为空，只显示数组中指定的分组

## 持久化存储

- 筛选配置保存在 `UserData.user_interface_settings.calendarFilters`
- 通过 `settingsManager` 自动同步到 localStorage 和后端
- 刷新页面后筛选配置保持不变

## 使用说明

1. 点击日历右上角的"筛选"按钮打开筛选菜单
2. 勾选/取消勾选需要的筛选条件
3. 点击"应用"按钮使筛选生效
4. 点击"重置"按钮恢复默认筛选（显示所有）

## 主题适配

筛选UI使用CSS变量，自动适配所有13个主题：
- `--card-bg` - 下拉菜单背景
- `--border-color` - 边框颜色
- `--text-primary` - 主文字颜色
- `--text-secondary` - 次要文字颜色
- `--primary` - 主题色（按钮、勾选框）
- `--primary-hover` - 主题色悬停

## 注意事项

1. 提醒始终独立筛选，不受象限、DDL等条件影响
2. 所有筛选条件默认全选（显示所有内容）
3. 日程组筛选为空表示显示所有分组
4. 筛选实时生效，无需刷新页面
