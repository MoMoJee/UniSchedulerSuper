# 日程组功能恢复文档

## 概述
本次升级完全恢复了 `home_new.html` 中的日程组（Events Group）管理功能，包括UI界面、JavaScript逻辑和与事件/待办事项的集成。

## 文件修改

### 1. 核心JavaScript模块
**文件**: `core/static/js/group-manager.js` (新建)
- **功能**: 日程组管理核心逻辑
- **主要类**: `GroupManager`
- **功能模块**:
  - 日程组CRUD操作（创建、读取、更新、删除）
  - 模态框管理
  - 日程组选择框刷新
  - 与后端API通信

**关键方法**:
```javascript
- init(): 初始化管理器，加载日程组数据
- showManageGroupsModal(): 显示日程组管理界面
- createGroup(): 创建新日程组
- updateGroup(): 更新日程组信息
- confirmDeleteGroup(): 删除日程组（可选删除关联事件）
- refreshGroupSelects(): 刷新所有日程组下拉选择框
- reloadGroups(): 从服务器重新加载日程组列表
```

### 2. 前端UI模板
**文件**: `core/templates/home_new.html`

**修改内容**:

1. **导航菜单** (第50行附近)
   - 添加"管理日程组"菜单项
   - 调用 `groupManager.showManageGroupsModal()`

2. **模态框** (第1400行附近)
   - `manageGroupsModal`: 日程组列表管理界面
   - `createGroupModal`: 创建日程组表单
   - `editGroupModal`: 编辑日程组表单
   - `deleteGroupModal`: 删除确认对话框（支持两种删除模式）

3. **JavaScript引入** (第1540行附近)
   ```html
   <script src="{% static 'js/group-manager.js' %}"></script>
   ```

4. **初始化代码** (第1710行附近)
   ```javascript
   window.groupManager.init();
   ```

### 3. 待办事项视觉增强
**文件**: `core/static/js/todo-manager.js`

**修改内容**:
- 在 `createTodoElement` 方法中添加日程组颜色指示器
- 使用左边框颜色标识待办事项所属的日程组

```javascript
if (todo.groupID && window.groupManager) {
    const group = window.groupManager.getGroupById(todo.groupID);
    if (group) {
        div.style.borderLeft = `4px solid ${group.color}`;
    }
}
```

## 功能特性

### 1. 日程组管理
- **查看列表**: 显示所有日程组，包括名称、描述和颜色标识
- **创建组**: 输入名称、描述和选择颜色
- **编辑组**: 修改日程组信息，自动更新所有关联事件的颜色
- **删除组**: 两种删除模式
  - **仅删除组**: 保留事件，清空其组关联
  - **删除组及事件**: 同时删除组和所有关联的事件/待办事项

### 2. 事件集成
- **创建事件**: 可选择日程组
- **编辑事件**: 可更改所属日程组
- **颜色显示**: 事件自动使用所属日程组的颜色
- **自动刷新**: 日程组颜色修改后，日历自动重新加载

### 3. 待办事项集成
- **创建待办**: 可选择日程组
- **编辑待办**: 可更改所属日程组
- **颜色标识**: 左边框颜色显示所属日程组
- **自动刷新**: 删除日程组时自动刷新待办列表

## API接口

### 后端API (已存在)
- **GET** `/get_calendar/get_events/`: 获取日程组列表
- **POST** `/get_calendar/create_events_group/`: 创建日程组
  - 参数: `{name, description, color}`
- **POST** `/get_calendar/update_events_group/`: 更新日程组
  - 参数: `{groupID, title, description, color}`
- **POST** `/get_calendar/delete_event_groups/`: 删除日程组
  - 参数: `{groupIds: [], deleteEvents: boolean}`

### 前端API
```javascript
// 全局实例
window.groupManager

// 主要方法
groupManager.showManageGroupsModal()  // 打开管理界面
groupManager.createGroup()            // 创建日程组
groupManager.updateGroup()            // 更新日程组
groupManager.confirmDeleteGroup()     // 删除日程组
groupManager.getGroupById(id)         // 根据ID获取日程组
groupManager.refreshGroupSelects()    // 刷新选择框
```

## 数据结构

### 日程组对象
```javascript
{
    id: "uuid-string",           // 唯一标识符
    name: "日程组名称",          // 组名
    description: "描述信息",     // 可选描述
    color: "#3788d8"             // 16进制颜色代码
}
```

### 存储位置
- **全局变量**: `window.events_groups` (数组)
- **数据库**: `UserData` 模型，`key="events_groups"`，JSON数组

## 用户交互流程

### 创建日程组
1. 点击导航栏"更多" → "管理日程组"
2. 点击"创建新日程组"按钮
3. 填写名称、描述（可选）、选择颜色
4. 点击"创建"
5. 系统自动刷新所有日程组选择框

### 编辑日程组
1. 在日程组管理界面点击"编辑"按钮
2. 修改信息
3. 点击"保存"
4. 系统自动刷新选择框和日历视图

### 删除日程组
1. 在日程组管理界面点击"删除"按钮
2. 选择删除模式：
   - **仅删除日程组**: 保留事件，清空组关联
   - **删除日程组及关联事件**: 同时删除所有关联内容
3. 点击"确认删除"
4. 系统自动刷新所有视图

## 技术要点

### 1. 模态框管理
- 使用Bootstrap 5的Modal组件
- 通过 `this.modals` 对象统一管理所有模态框实例
- 支持编程式打开/关闭

### 2. 数据同步
- 创建/更新/删除后自动调用 `reloadGroups()` 重新获取最新数据
- 同步更新 `this.groups` 和 `window.events_groups`
- 刷新所有UI组件（选择框、日历、待办列表）

### 3. 颜色管理
- 使用HTML5 color input选择颜色
- 默认颜色: `#3788d8` (蓝色)
- 事件通过 `getEventColor()` 方法获取日程组颜色
- 待办事项通过左边框显示颜色

### 4. 错误处理
- 所有API调用使用 try-catch 包裹
- 失败时显示友好错误提示
- console.log 记录关键操作日志

## 测试建议

### 功能测试
1. 创建日程组，验证是否出现在选择框中
2. 创建带日程组的事件，验证颜色是否正确
3. 编辑日程组颜色，验证事件颜色是否更新
4. 删除日程组（仅删除组），验证事件是否保留
5. 删除日程组（删除组及事件），验证事件是否删除
6. 创建带日程组的待办事项，验证左边框颜色

### 边界测试
1. 空名称提交（应拦截）
2. 删除不存在的日程组
3. 编辑已删除的日程组
4. 网络错误情况

## 兼容性说明
- **浏览器**: 支持Bootstrap 5和现代JavaScript特性的浏览器
- **向后兼容**: 无日程组的事件/待办使用默认颜色
- **数据迁移**: 旧数据自动兼容，新功能不影响现有数据

## 未来扩展建议
1. 日程组图标支持
2. 日程组权重/优先级
3. 日程组统计信息（包含事件数量）
4. 批量操作（批量删除、批量修改颜色）
5. 日程组导入/导出
6. 日程组模板预设

## 相关文档
- [Events功能分析与问题总结.md](Events功能分析与问题总结.md)
- [重复事件编辑问题修复总结.md](重复事件编辑问题修复总结.md)
- [升级详细文档.md](../../升级详细文档.md)

---

**文档创建时间**: 2024年
**最后更新**: 日程组功能完全恢复
**状态**: ✅ 已完成
