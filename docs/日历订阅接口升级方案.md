# 日历订阅接口升级方案（Apple Calendar / iCalendar Feed）

## 背景

用户需要通过 Apple 日历（iOS/macOS）订阅 UniScheduler 中的日程、待办和提醒数据。
Apple 日历通过 HTTP(S) 定期轮询一个 URL，获取 RFC 5545 标准的 `.ics` 文件实现只读订阅。

## 核心设计决策

### 鉴权方式

Apple 日历 **不支持自定义 HTTP 请求头**（如 `Authorization: Token xxx`），因此采用 **URL 查询参数** 传递 token：

```
GET /api/calendar/feed/?token=<用户token>
```

### 数据映射

| 项目数据类型 | iCalendar 组件 | 说明 |
|-------------|---------------|------|
| Events（日程） | `VEVENT` | 完整映射，含 RRULE、LOCATION、STATUS |
| Todos（待办） | `VEVENT` + `VALARM` | 仅发送带 due_date 的待办，标题前缀 `[待办]`，时长 5min |
| Reminders（提醒） | `VEVENT` + `VALARM` | 标题前缀 `[提醒]`，时长 5min，不映射 priority/status |

### ⚠️ 关于 Apple 日历订阅的重要说明

**Apple 日历的 HTTP 订阅（webcal://）只解析 VEVENT 组件，完全忽略 VTODO。**

因此：
- Todos 和 Reminders 均转换为带 VALARM 的特殊 VEVENT
- VALARM 的 TRIGGER 设为 0（事件开始时立刻弹出通知）
- 不映射 Reminder 的 priority、status 等无法融入 VEVENT 的属性
- 无 due_date 的待办不会发送

### Reminder 的 RRule 机制

Reminder 有自己独立的 RRule 系统，与 Events 结构类似：
- 使用 `is_main_reminder: True` 标记主提醒（对应 Events 的 `is_main_event`）
- 使用 `is_instance: True, is_main_reminder: False` 标记系统生成的实例
- 使用 `is_detached: True` 标记脱离的实例
- 使用 `series_id` 关联同一重复系列

**过滤策略（与 Events 一致）：**
- 主提醒 (`is_main_reminder=True`)：✅ 发送（带 RRULE，Apple 自行展开）
- 生成的实例 (`is_instance=True, is_main_reminder=False`)：❌ 跳过
- 脱离的实例 (`is_detached=True`)：✅ 发送（独立 VEVENT + RECURRENCE-ID）
- 普通非重复提醒：✅ 发送

## 技术规范

### URL 端点

```
GET /api/calendar/feed/?token=<token>&type=<all|events|todos|reminders>
```

| 参数 | 必填 | 默认 | 说明 |
|------|------|------|------|
| `token` | ✅ | — | 用户 API Token |
| `type` | ❌ | `all` | 订阅内容类型筛选 |

### Apple Calendar 强制要求

1. **HTTPS**：iOS 14+ 起，HTTP 订阅会触发安全警告或被拒绝
2. **VTIMEZONE**：必须内嵌时区定义（Asia/Shanghai），否则时间解析异常
3. **UID 稳定性**：每个事件/待办的 UID 必须在所有请求中保持一致，Apple 依赖 UID 做增量更新
4. **DTSTAMP**：每个组件必须包含 DTSTAMP 字段
5. **Content-Type**：响应头必须为 `text/calendar; charset=utf-8`
6. **X-WR-CALNAME**：Apple 用此属性作为日历显示名称
7. **X-PUBLISHED-TTL / REFRESH-INTERVAL**：声明建议刷新间隔

### HTTP 响应格式

```
Content-Type: text/calendar; charset=utf-8
```

### UID 生成规则

- Events: `evt-{event.id}@unischeduler`（普通日程）/ `evt-series-{series_id}@unischeduler`（重复系列）
- Todos: `todo-{todo.id}@unischeduler`
- Reminders: `rem-{reminder.id}@unischeduler`（普通提醒）/ `rem-series-{series_id}@unischeduler`（重复系列）

### 状态映射

**Event status:**
- `confirmed` → `CONFIRMED`
- `tentative` → `TENTATIVE`
- `cancelled` → `CANCELLED`

**Todo / Reminder:** 不映射 status（转为 VEVENT 后无对应语义）

**Priority 映射（importance × urgency → iCalendar 1-9）:**
- important + urgent → 1
- important + not-urgent → 3
- not-important + urgent → 5
- not-important + not-urgent → 9
- 未指定 → 0（未定义）

## 文件结构

新建 `core/views_calendar_subscription.py`，在 `core/urls.py` 注册路由。

## Apple 日历使用步骤

1. 在 iOS 上：设置 → 日历 → 账户 → 添加账户 → 其他 → 添加已订阅的日历
2. 输入 URL：`https://yourserver.com/api/calendar/feed/?token=xxx`
3. Apple 将定期自动刷新，最短间隔约 15 分钟
