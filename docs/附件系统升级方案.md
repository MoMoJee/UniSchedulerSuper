# ğŸ“ ç»Ÿä¸€é™„ä»¶ç³»ç»Ÿ - å‡çº§æ–¹æ¡ˆ

**ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2026-02-10  
**çŠ¶æ€**: ğŸ“ è§„åˆ’ä¸­

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#1-æ¦‚è¿°)
2. [æ ¸å¿ƒåŠŸèƒ½](#2-æ ¸å¿ƒåŠŸèƒ½)
3. [æ¶æ„è®¾è®¡](#3-æ¶æ„è®¾è®¡)
4. [æ•°æ®æ¨¡å‹](#4-æ•°æ®æ¨¡å‹)
5. [è§£æå™¨ç³»ç»Ÿ](#5-è§£æå™¨ç³»ç»Ÿ)
6. [å¤šæ¨¡æ€é€‚é…](#6-å¤šæ¨¡æ€é€‚é…)
7. [å‰ç«¯äº¤äº’](#7-å‰ç«¯äº¤äº’)
8. [æ–‡ä»¶å­˜å‚¨](#8-æ–‡ä»¶å­˜å‚¨)
9. [è¾¹ç¼˜æƒ…å†µå¤„ç†](#9-è¾¹ç¼˜æƒ…å†µå¤„ç†)
10. [API è®¾è®¡](#10-api-è®¾è®¡)
11. [å®ç°è·¯çº¿å›¾](#11-å®ç°è·¯çº¿å›¾)

---

## 1. æ¦‚è¿°

### 1.1 èƒŒæ™¯

å½“å‰ç³»ç»Ÿå·²å®ç°åŸºç¡€çš„å·¥ä½œæµæç¤ºé™„ä»¶åŠŸèƒ½ï¼Œä½†å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
- âŒ ç”Ÿç¡¬çš„æ–‡æœ¬æ‹¼æ¥ï¼Œç”¨æˆ·ä½“éªŒå·®
- âŒ ä¸æ”¯æŒå¤–éƒ¨æ–‡ä»¶ä¸Šä¼ 
- âŒ ç¼ºä¹å¤šæ¨¡æ€èƒ½åŠ›
- âŒ æ— æ³•å°†å†…éƒ¨å…ƒç´ ï¼ˆevents/todo/reminderï¼‰ä½œä¸ºé™„ä»¶

### 1.2 ç›®æ ‡

æ„å»ºç°ä»£åŒ–çš„ç»Ÿä¸€é™„ä»¶ç³»ç»Ÿï¼Œæ”¯æŒï¼š
1. âœ… å†…éƒ¨å…ƒç´ é™„ä»¶ï¼ˆevents, todos, remindersï¼‰
2. âœ… å¤–éƒ¨æ–‡ä»¶ä¸Šä¼ ï¼ˆå›¾ç‰‡ã€PDFã€Office æ–‡æ¡£ï¼‰
3. âœ… å¤šæ¨¡æ€èƒ½åŠ›é€‚é…ï¼ˆæ ¹æ®æ¨¡å‹è‡ªåŠ¨é™çº§ï¼‰
4. âœ… æ‹–æ‹½äº¤äº’ï¼ˆä»åˆ—è¡¨æ‹–å…¥ Agent ä¾§è¾¹æ ï¼‰
5. âœ… ä¼šè¯çº§å­˜å‚¨ï¼ˆ7å¤©è‡ªåŠ¨è¿‡æœŸï¼‰
6. âœ… æ–‡ä»¶é¢„è§ˆä¸ç®¡ç†

### 1.3 å‚è€ƒæ¡ˆä¾‹

- **Cursor**: æ‹–æ‹½ä»£ç ç‰‡æ®µã€æ–‡ä»¶ä¸Šä¼ ã€å¤šæ¨¡æ€æ”¯æŒ
- **ChatGPT**: å›¾ç‰‡ä¸Šä¼ ã€PDF è§£æã€å¤šæ¨¡æ€å¯¹è¯
- **Claude**: Artifactsã€æ–‡æ¡£ç†è§£ã€ç»“æ„åŒ–è¾“å‡º
- **Notion AI**: å†…éƒ¨å…ƒç´ å¼•ç”¨ã€@mention è¯­æ³•

---

## 2. æ ¸å¿ƒåŠŸèƒ½

### 2.1 åŠŸèƒ½æ¸…å•

#### Phase 1 - æ ¸å¿ƒåŠŸèƒ½ (MVP)
- [ ] 2.1.1 å†…éƒ¨å…ƒç´ é™„ä»¶
  - [ ] Events æ‹–æ‹½åˆ° Agent
  - [ ] Todos æ‹–æ‹½åˆ° Agent
  - [ ] Reminders æ‹–æ‹½åˆ° Agent
  - [ ] Markdown æ ¼å¼åŒ–
- [ ] 2.1.2 å›¾ç‰‡ä¸Šä¼ 
  - [ ] æ‹–æ‹½/ç‚¹å‡»ä¸Šä¼ 
  - [ ] ç¼©ç•¥å›¾ç”Ÿæˆ
  - [ ] OCR æ–‡å­—æå–ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
- [ ] 2.1.3 æ–‡ä»¶å­˜å‚¨
  - [ ] ä¼šè¯çº§ç›®å½•
  - [ ] æ–‡ä»¶å…ƒä¿¡æ¯ç®¡ç†
  - [ ] è‡ªåŠ¨è¿‡æœŸæ¸…ç†

#### Phase 2 - æ–‡æ¡£æ”¯æŒ
- [ ] 2.2.1 PDF è§£æ
  - [ ] æ–‡å­—æå–
  - [ ] è¡¨æ ¼è¯†åˆ«
  - [ ] é¡µé¢æˆªå›¾
- [ ] 2.2.2 Office æ–‡æ¡£è§£æ
  - [ ] Word (python-docx)
  - [ ] Excel (openpyxl)
  - [ ] PowerPoint (python-pptx)
- [ ] 2.2.3 é¢„è§ˆåŠŸèƒ½
  - [ ] å‰ç«¯é¢„è§ˆç»„ä»¶
  - [ ] åˆ†é¡µæµè§ˆ
  - [ ] ä¸‹è½½åŸæ–‡ä»¶

#### Phase 3 - å¤šæ¨¡æ€é€‚é…
- [ ] 2.3.1 æ¨¡å‹èƒ½åŠ›æ£€æµ‹
  - [ ] api_keys.json é…ç½®æ‰©å±•
  - [ ] ModelCapabilities å·¥å…·ç±»
  - [ ] åŠ¨æ€èƒ½åŠ›æŸ¥è¯¢
- [ ] 2.3.2 Base64 å›¾ç‰‡æ”¯æŒ
  - [ ] å›¾ç‰‡ç¼–ç 
  - [ ] æ ¼å¼éªŒè¯
  - [ ] å¤§å°é™åˆ¶
- [ ] 2.3.3 è‡ªåŠ¨é™çº§ç­–ç•¥
  - [ ] Vision â†’ OCR Text
  - [ ] å›¾ç‰‡è´¨é‡è°ƒæ•´
  - [ ] Token ä¼˜åŒ–

#### Phase 4 - ç”¨æˆ·ä½“éªŒ
- [ ] 2.4.1 æ‹–æ‹½ä¸Šä¼ 
  - [ ] Drop Zone å®ç°
  - [ ] æ‹–æ‹½é¢„è§ˆ
  - [ ] è¿›åº¦åé¦ˆ
- [ ] 2.4.2 æ‰¹é‡å¤„ç†
  - [ ] å¤šæ–‡ä»¶ä¸Šä¼ 
  - [ ] æ‰¹é‡åˆ é™¤
  - [ ] æ‰¹é‡ä¸‹è½½
- [ ] 2.4.3 çŠ¶æ€ç®¡ç†
  - [ ] ä¸Šä¼ è¿›åº¦
  - [ ] è§£æçŠ¶æ€
  - [ ] é”™è¯¯å¤„ç†

---

## 3. æ¶æ„è®¾è®¡

### 3.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯å±‚                                â”‚
â”‚                     (agent-chat.js)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é™„ä»¶ç®¡ç†å™¨     â”‚   æ‹–æ‹½äº¤äº’æ¨¡å—   â”‚   é¢„è§ˆ/ä¸‹è½½æ¨¡å—         â”‚
â”‚ AttachmentMgr  â”‚  DragAndDrop     â”‚  PreviewPanel          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                 â”‚                  â”‚
         â”‚ HTTP POST       â”‚ HTTP POST        â”‚ HTTP GET
         â”‚                 â”‚                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åç«¯ API å±‚                           â”‚
â”‚                  (agent_service/views_api.py)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ POST /api/agent/attachments/upload/   æ–‡ä»¶ä¸Šä¼            â”‚
â”‚  â€¢ GET  /api/agent/attachments/          åˆ—å‡ºå¯é™„åŠ é¡¹        â”‚
â”‚  â€¢ POST /api/agent/attachments/format/   æ ¼å¼åŒ–å†…å®¹(ç°æœ‰)   â”‚
â”‚  â€¢ GET  /api/agent/attachments/preview/  é¢„è§ˆæ–‡ä»¶           â”‚
â”‚  â€¢ DELETE /api/agent/attachments/{id}/   åˆ é™¤é™„ä»¶           â”‚
â”‚  â€¢ POST /api/agent/attachments/restore/  æ¢å¤é™„ä»¶(å›æ»šç”¨)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ è°ƒç”¨
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ä¸šåŠ¡é€»è¾‘å±‚                              â”‚
â”‚              (agent_service/attachment_handler.py)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  AttachmentHandler:                                          â”‚
â”‚    â€¢ handle_upload()      å¤„ç†æ–‡ä»¶ä¸Šä¼                        â”‚
â”‚    â€¢ handle_internal()    å¤„ç†å†…éƒ¨å…ƒç´                        â”‚
â”‚    â€¢ get_formatted()      è·å–æ ¼å¼åŒ–å†…å®¹                     â”‚
â”‚    â€¢ detect_model_caps()  æ£€æµ‹æ¨¡å‹èƒ½åŠ›                       â”‚
â”‚    â€¢ choose_format()      é€‰æ‹©åˆé€‚çš„æ ¼å¼                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                â”‚
         â”‚                â”‚ è°ƒç”¨è§£æå™¨
         â”‚                â”‚
         â”‚         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚         â”‚      è§£æå™¨æ±  (Parser Pool)      â”‚
         â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚         â”‚  â€¢ ImageParser (OCR)            â”‚
         â”‚         â”‚  â€¢ PDFParser                    â”‚
         â”‚         â”‚  â€¢ DocumentParser (Word/Excel)  â”‚
         â”‚         â”‚  â€¢ InternalElementParser        â”‚
         â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ è¯»å†™æ•°æ®åº“
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ•°æ®æŒä¹…å±‚                               â”‚
â”‚              (agent_service/models.py)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  SessionAttachment æ¨¡å‹:                                      â”‚
â”‚    â€¢ é™„ä»¶å…ƒä¿¡æ¯ï¼ˆæ–‡ä»¶åã€ç±»å‹ã€å¤§å°ç­‰ï¼‰                        â”‚
â”‚    â€¢ åŸå§‹æ–‡ä»¶è·¯å¾„                                              â”‚
â”‚    â€¢ Base64 ç¼–ç æ•°æ®ï¼ˆå¤šæ¨¡æ€ï¼‰                                 â”‚
â”‚    â€¢ è§£ææ–‡æœ¬ï¼ˆé™çº§æ–¹æ¡ˆï¼‰                                      â”‚
â”‚    â€¢ å…³è” session_id å’Œ message_index                         â”‚
â”‚    â€¢ è½¯åˆ é™¤æ ‡è®°å’Œæ¢å¤ä¿¡æ¯                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ ç‰©ç†å­˜å‚¨
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ–‡ä»¶å­˜å‚¨å±‚                               â”‚
â”‚                  (media/attachments/)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç›®å½•ç»“æ„:                                                     â”‚
â”‚    media/attachments/{session_id}/                            â”‚
â”‚      â”œâ”€â”€ original_{uuid}.{ext}    åŸå§‹æ–‡ä»¶                    â”‚
â”‚      â””â”€â”€ thumb_{uuid}.{ext}       ç¼©ç•¥å›¾                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ç»„ä»¶å…³ç³»

#### 3.2.1 æ ¸å¿ƒç»„ä»¶

**AttachmentHandler** (ä¸šåŠ¡é€»è¾‘ä¸­å¿ƒ):
- åè°ƒå„ä¸ªè§£æå™¨
- æ£€æµ‹æ¨¡å‹èƒ½åŠ›
- å†³å®šä½¿ç”¨å“ªç§æ ¼å¼ï¼ˆbase64 vs textï¼‰
- ç®¡ç†é™„ä»¶ç”Ÿå‘½å‘¨æœŸ

**Parser Pool** (è§£æå™¨é›†åˆ):
- `ImageParser`: å¤„ç†å›¾ç‰‡ï¼ˆOCRã€ç¼©ç•¥å›¾ï¼‰
- `PDFParser`: æå– PDF æ–‡æœ¬å’Œè¡¨æ ¼
- `DocumentParser`: è§£æ Word/Excel
- `InternalElementParser`: æ ¼å¼åŒ–å†…éƒ¨å…ƒç´ ï¼ˆevents/todos/remindersï¼‰

**ModelCapabilityDetector** (èƒ½åŠ›æ£€æµ‹):
- è¯»å– `config/api_keys.json` çš„æ¨¡å‹é…ç½®
- ä» `core.UserData` è¯»å–ç”¨æˆ·å½“å‰æ¨¡å‹ (`agent_config.model_id`)
- è¿”å›æ¨¡å‹çš„ `supports_vision` å’Œ `supports_multimodal` æ ‡å¿—

#### 3.2.2 æ•°æ®æµ

**ä¸Šä¼ æµç¨‹**:
```
1. å‰ç«¯: ç”¨æˆ·æ‹–æ‹½æ–‡ä»¶æˆ–ç‚¹å‡»ä¸Šä¼ 
2. å‰ç«¯: FormData åŒ…å«æ–‡ä»¶ + session_id
3. åç«¯: views_api æ¥æ”¶è¯·æ±‚
4. åç«¯: AttachmentHandler.handle_upload()
5. åç«¯: ä¿å­˜åŸå§‹æ–‡ä»¶åˆ° media/attachments/{session_id}/
6. åç«¯: æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©è§£æå™¨
7. è§£æå™¨: ç”Ÿæˆç¼©ç•¥å›¾ + OCR/æ–‡æœ¬æå–
8. åç«¯: åˆ›å»º SessionAttachment è®°å½•ï¼ˆåŒæ—¶å­˜å‚¨ base64 å’Œ parsed_textï¼‰
9. åç«¯: è¿”å›é™„ä»¶ä¿¡æ¯ç»™å‰ç«¯
10. å‰ç«¯: æ˜¾ç¤ºåœ¨é™„ä»¶åˆ—è¡¨ä¸­
```

**æ ¼å¼åŒ–æµç¨‹** (å‘é€æ¶ˆæ¯æ—¶):
```
1. å‰ç«¯: ç”¨æˆ·ç‚¹å‡»"å‘é€"
2. å‰ç«¯: è°ƒç”¨ /api/agent/attachments/format/ åŒ…å«é™„ä»¶ ID åˆ—è¡¨
3. åç«¯: AttachmentHandler.get_formatted()
4. åç«¯: ModelCapabilityDetector æ£€æµ‹å½“å‰æ¨¡å‹èƒ½åŠ›
5. åç«¯: æ ¹æ®èƒ½åŠ›é€‰æ‹©æ ¼å¼:
   - Vision æ¨¡å‹ â†’ è¿”å› base64 æ ¼å¼æŒ‡ä»¤
   - é Vision æ¨¡å‹ â†’ è¿”å› parsed_text
6. å‰ç«¯: å°†æ ¼å¼åŒ–å†…å®¹é™„åŠ åˆ°ç”¨æˆ·æ¶ˆæ¯
7. å‰ç«¯: å‘é€åˆ° Agent (WebSocket)
```

**å›æ»šæµç¨‹**:
```
1. å‰ç«¯: ç”¨æˆ·ç‚¹å‡»å›æ»šåˆ°æ¶ˆæ¯ #N
2. å‰ç«¯: è°ƒç”¨ /api/agent/rollback/to-message/
3. åç«¯: æŸ¥è¯¢å—å½±å“çš„é™„ä»¶ (message_index >= N)
4. åç«¯: è¿”å›ç¡®è®¤ä¿¡æ¯ï¼ˆé™„ä»¶åˆ—è¡¨ã€æ€»å¤§å°ï¼‰
5. å‰ç«¯: æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
6. ç”¨æˆ·ç¡®è®¤å:
   a. åç«¯: è½¯åˆ é™¤é™„ä»¶ (is_deleted=True, deleted_at=now())
   b. åç«¯: å›æ»šæ¶ˆæ¯ï¼ˆç°æœ‰é€»è¾‘ï¼‰
   c. å‰ç«¯: åˆ·æ–°é™„ä»¶åˆ—è¡¨
7. Celery ä»»åŠ¡: 7å¤©åç‰©ç†åˆ é™¤æ–‡ä»¶
```

### 3.3 ä¸ç°æœ‰ç³»ç»Ÿé›†æˆ

#### 3.3.1 ä¸ AgentSession çš„å…³ç³»

```python
# SessionAttachment é€šè¿‡ session_id å…³è” AgentSession
SessionAttachment.session_id â†’ AgentSession.session_id

# æ¯ä¸ªé™„ä»¶è¿˜è®°å½•å®ƒåœ¨å“ªæ¡æ¶ˆæ¯ä¸­è¢«å‘é€
SessionAttachment.message_index â†’ å¯¹åº” LangGraph messages æ•°ç»„ç´¢å¼•
```

#### 3.3.2 ä¸ UserData çš„å…³ç³»

```python
# æ¨¡å‹é…ç½®å­˜å‚¨åœ¨ UserData
UserData.objects.get(user=user, key='agent_config')
# è¿”å›: {"model_id": "system_deepseek", ...}

# AttachmentHandler è¯»å–é…ç½®ç¡®å®šå½“å‰æ¨¡å‹
# ç„¶åä» config/api_keys.json è¯»å–æ¨¡å‹èƒ½åŠ›
```

#### 3.3.3 ä¸ç°æœ‰é™„ä»¶ç³»ç»Ÿçš„å…¼å®¹

- **ç°æœ‰**: workflow é™„ä»¶é€šè¿‡ `/api/agent/attachments/format/` è¿”å›æ–‡æœ¬
- **å‡çº§**: ä¿æŒæ­¤æ¥å£ï¼Œæ‰©å±•æ”¯æŒæ–‡ä»¶é™„ä»¶
- **å‰ç«¯**: `selectedAttachments` æ•°ç»„åŒæ—¶æ”¯æŒ `{type: 'workflow', id: 1}` å’Œ `{type: 'file', id: 5}`

---

## 4. æ•°æ®æ¨¡å‹

### 4.1 SessionAttachment æ¨¡å‹

#### 4.1.1 å®Œæ•´å­—æ®µè®¾è®¡

```python
# agent_service/models.py

from django.db import models
from django.contrib.auth.models import User
from django.utils import timezone
from datetime import timedelta

class SessionAttachment(models.Model):
    """
    ä¼šè¯é™„ä»¶æ¨¡å‹
    æ”¯æŒå¤–éƒ¨æ–‡ä»¶å’Œå†…éƒ¨å…ƒç´ ä½œä¸ºé™„ä»¶
    """
    
    # ========== ç±»å‹å®šä¹‰ ==========
    TYPE_CHOICES = [
        ('image', 'å›¾ç‰‡'),
        ('pdf', 'PDFæ–‡æ¡£'),
        ('word', 'Wordæ–‡æ¡£'),
        ('excel', 'Excelè¡¨æ ¼'),
        ('workflow', 'å·¥ä½œæµè§„åˆ™'),
        ('event', 'æ—¥ç¨‹äº‹ä»¶'),
        ('todo', 'å¾…åŠäº‹é¡¹'),
        ('reminder', 'æé†’'),
    ]
    
    # ========== åŸºç¡€ä¿¡æ¯ ==========
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='session_attachments')
    session_id = models.CharField(max_length=200, db_index=True, help_text="å…³è”çš„ AgentSession.session_id")
    
    type = models.CharField(max_length=20, choices=TYPE_CHOICES, help_text="é™„ä»¶ç±»å‹")
    filename = models.CharField(max_length=255, help_text="æ–‡ä»¶åæˆ–å…ƒç´ æ ‡é¢˜")
    
    # ========== æ¶ˆæ¯å…³è” ==========
    message_index = models.IntegerField(
        null=True, 
        blank=True, 
        help_text="é™„ä»¶è¢«å‘é€æ—¶çš„æ¶ˆæ¯ç´¢å¼•ï¼ˆLangGraph messages æ•°ç»„ç´¢å¼•ï¼‰"
    )
    sent_at = models.DateTimeField(null=True, blank=True, help_text="å‘é€æ—¶é—´")
    
    # ========== æ–‡ä»¶å­˜å‚¨ï¼ˆå¤–éƒ¨æ–‡ä»¶ï¼‰ ==========
    file = models.FileField(
        upload_to='attachments/%Y/%m/%d/', 
        null=True, 
        blank=True, 
        help_text="åŸå§‹æ–‡ä»¶"
    )
    file_size = models.BigIntegerField(default=0, help_text="æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰")
    mime_type = models.CharField(max_length=100, blank=True, default='', help_text="MIME ç±»å‹")
    thumbnail_url = models.CharField(max_length=500, blank=True, default='', help_text="ç¼©ç•¥å›¾ URL")
    
    # ========== å¤šæ¨¡æ€æ”¯æŒ ==========
    base64_data = models.TextField(
        blank=True, 
        default='', 
        help_text="Base64 ç¼–ç çš„å›¾ç‰‡æ•°æ®ï¼ˆç”¨äº vision æ¨¡å‹ï¼‰"
    )
    
    # ========== é™çº§æ–¹æ¡ˆ ==========
    parsed_text = models.TextField(
        blank=True, 
        default='', 
        help_text="è§£æåçš„æ–‡æœ¬å†…å®¹ï¼ˆOCR/æ–‡æ¡£æå–ï¼Œç”¨äºé vision æ¨¡å‹ï¼‰"
    )
    
    # ========== å†…éƒ¨å…ƒç´ å¼•ç”¨ï¼ˆå†…éƒ¨é™„ä»¶ï¼‰ ==========
    internal_type = models.CharField(
        max_length=20, 
        blank=True, 
        default='', 
        help_text="å†…éƒ¨å…ƒç´ ç±»å‹ï¼ševent, todo, reminder, workflow"
    )
    internal_id = models.IntegerField(
        null=True, 
        blank=True, 
        help_text="å†…éƒ¨å…ƒç´ çš„ IDï¼ˆå¦‚ Event.id, Todo.idï¼‰"
    )
    internal_snapshot = models.JSONField(
        default=dict, 
        blank=True, 
        help_text="å†…éƒ¨å…ƒç´ çš„å¿«ç…§ï¼ˆé˜²æ­¢å…ƒç´ è¢«åˆ é™¤æˆ–ä¿®æ”¹ï¼‰"
    )
    
    # ========== å‘é€è®°å½• ==========
    sent_as_format = models.CharField(
        max_length=20, 
        blank=True, 
        default='', 
        help_text="å®é™…å‘é€æ—¶ä½¿ç”¨çš„æ ¼å¼ï¼šbase64, text, markdown"
    )
    sent_with_model = models.CharField(
        max_length=100, 
        blank=True, 
        default='', 
        help_text="å‘é€æ—¶ä½¿ç”¨çš„æ¨¡å‹ IDï¼ˆç”¨äºè¿½è¸ªï¼‰"
    )
    
    # ========== è½¯åˆ é™¤æ”¯æŒ ==========
    is_deleted = models.BooleanField(default=False, help_text="æ˜¯å¦å·²è½¯åˆ é™¤")
    deleted_at = models.DateTimeField(null=True, blank=True, help_text="è½¯åˆ é™¤æ—¶é—´")
    deleted_with_message_index = models.IntegerField(
        null=True, 
        blank=True, 
        help_text="å›æ»šæ—¶ä¸€èµ·åˆ é™¤çš„æ¶ˆæ¯ç´¢å¼•"
    )
    deleted_reason = models.CharField(
        max_length=50, 
        blank=True, 
        default='', 
        help_text="åˆ é™¤åŸå› ï¼šrollback, manual, expired"
    )
    
    # ========== æ—¶é—´æˆ³ ==========
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        ordering = ['-created_at']
        verbose_name = "ä¼šè¯é™„ä»¶"
        verbose_name_plural = "ä¼šè¯é™„ä»¶"
        indexes = [
            models.Index(fields=['session_id', 'is_deleted']),
            models.Index(fields=['user', 'is_deleted']),
            models.Index(fields=['deleted_at']),  # ç”¨äºæ¸…ç†ä»»åŠ¡
        ]
    
    def __str__(self):
        return f"{self.user.username}: {self.filename} ({self.type})"
    
    @property
    def can_restore(self):
        """æ˜¯å¦å¯ä»¥æ¢å¤ï¼ˆ7å¤©å†…ï¼‰"""
        if not self.is_deleted or not self.deleted_at:
            return False
        grace_period = timedelta(days=7)
        return timezone.now() - self.deleted_at < grace_period
    
    @property
    def is_internal(self):
        """æ˜¯å¦ä¸ºå†…éƒ¨å…ƒç´ é™„ä»¶"""
        return self.internal_type in ['event', 'todo', 'reminder', 'workflow']
    
    @property
    def is_file(self):
        """æ˜¯å¦ä¸ºå¤–éƒ¨æ–‡ä»¶é™„ä»¶"""
        return self.type in ['image', 'pdf', 'word', 'excel']
    
    def get_display_name(self):
        """è·å–æ˜¾ç¤ºåç§°"""
        if self.is_internal:
            return self.internal_snapshot.get('title') or self.filename
        return self.filename
    
    def get_formatted_content(self, model_supports_vision=False):
        """
        æ ¹æ®æ¨¡å‹èƒ½åŠ›è¿”å›æ ¼å¼åŒ–å†…å®¹
        
        Args:
            model_supports_vision: å½“å‰æ¨¡å‹æ˜¯å¦æ”¯æŒ vision
            
        Returns:
            dict: {
                "type": "base64" | "text" | "markdown",
                "content": str,
                "metadata": dict
            }
        """
        if self.is_internal:
            # å†…éƒ¨å…ƒç´ å§‹ç»ˆè¿”å› Markdown æ ¼å¼
            return {
                "type": "markdown",
                "content": self.parsed_text or self._format_internal_element(),
                "metadata": {
                    "internal_type": self.internal_type,
                    "internal_id": self.internal_id
                }
            }
        
        # å¤–éƒ¨æ–‡ä»¶æ ¹æ®æ¨¡å‹èƒ½åŠ›å†³å®š
        if model_supports_vision and self.base64_data and self.type == 'image':
            return {
                "type": "base64",
                "content": self.base64_data,
                "metadata": {
                    "filename": self.filename,
                    "mime_type": self.mime_type
                }
            }
        else:
            # é™çº§åˆ°æ–‡æœ¬
            return {
                "type": "text",
                "content": self.parsed_text or "[æ— æ³•è§£æå†…å®¹]",
                "metadata": {
                    "filename": self.filename,
                    "original_type": self.type
                }
            }
    
    def _format_internal_element(self):
        """æ ¼å¼åŒ–å†…éƒ¨å…ƒç´ ä¸º Markdown"""
        snapshot = self.internal_snapshot or {}
        
        if self.internal_type == 'event':
            return f"""### ğŸ“… {snapshot.get('title', 'æ— æ ‡é¢˜äº‹ä»¶')}
- **æ—¶é—´**: {snapshot.get('start', '')} ~ {snapshot.get('end', '')}
- **æè¿°**: {snapshot.get('description', 'æ— æè¿°')}
"""
        elif self.internal_type == 'todo':
            return f"""### âœ… {snapshot.get('title', 'æ— æ ‡é¢˜ä»»åŠ¡')}
- **çŠ¶æ€**: {'å·²å®Œæˆ' if snapshot.get('completed') else 'å¾…å®Œæˆ'}
- **æˆªæ­¢æ—¶é—´**: {snapshot.get('due_date', 'æ— ')}
"""
        elif self.internal_type == 'reminder':
            return f"""### â° {snapshot.get('title', 'æ— æ ‡é¢˜æé†’')}
- **æé†’æ—¶é—´**: {snapshot.get('remind_at', '')}
- **å†…å®¹**: {snapshot.get('message', '')}
"""
        elif self.internal_type == 'workflow':
            return f"""### ğŸ”„ {snapshot.get('name', 'å·¥ä½œæµè§„åˆ™')}
- **è§¦å‘æ¡ä»¶**: {snapshot.get('trigger', '')}
- **æ‰§è¡Œæ­¥éª¤**: {snapshot.get('steps', '')}
"""
        return "[æœªçŸ¥å…ƒç´ ç±»å‹]"
    
    def soft_delete(self, reason='manual', message_index=None):
        """è½¯åˆ é™¤é™„ä»¶"""
        self.is_deleted = True
        self.deleted_at = timezone.now()
        self.deleted_reason = reason
        if message_index is not None:
            self.deleted_with_message_index = message_index
        self.save(update_fields=['is_deleted', 'deleted_at', 'deleted_reason', 'deleted_with_message_index'])
    
    def restore(self):
        """æ¢å¤é™„ä»¶"""
        if self.can_restore:
            self.is_deleted = False
            self.deleted_at = None
            self.deleted_reason = ''
            self.deleted_with_message_index = None
            self.save(update_fields=['is_deleted', 'deleted_at', 'deleted_reason', 'deleted_with_message_index'])
            return True
        return False
    
    def hard_delete(self):
        """ç‰©ç†åˆ é™¤ï¼ˆåŒ…æ‹¬æ–‡ä»¶ï¼‰"""
        # åˆ é™¤æ–‡ä»¶
        if self.file:
            try:
                self.file.delete(save=False)
            except Exception as e:
                from logger import logger
                logger.warning(f"åˆ é™¤é™„ä»¶æ–‡ä»¶å¤±è´¥ {self.id}: {e}")
        
        # åˆ é™¤ç¼©ç•¥å›¾
        if self.thumbnail_url:
            try:
                import os
                from django.conf import settings
                thumb_path = os.path.join(settings.MEDIA_ROOT, self.thumbnail_url)
                if os.path.exists(thumb_path):
                    os.remove(thumb_path)
            except Exception as e:
                from logger import logger
                logger.warning(f"åˆ é™¤ç¼©ç•¥å›¾å¤±è´¥ {self.id}: {e}")
        
        # åˆ é™¤æ•°æ®åº“è®°å½•
        self.delete()
```

#### 4.1.2 å­—æ®µè¯´æ˜

**åŸºç¡€ä¿¡æ¯**:
- `user`, `session_id`: å…³è”åˆ°ç”¨æˆ·å’Œä¼šè¯
- `type`: é™„ä»¶ç±»å‹ï¼ˆ8ç§ç±»å‹ï¼‰
- `filename`: æ˜¾ç¤ºåç§°

**æ¶ˆæ¯å…³è”**:
- `message_index`: è®°å½•åœ¨å“ªæ¡æ¶ˆæ¯ä¸­å‘é€ï¼Œç”¨äºå›æ»šæ—¶å®šä½
- `sent_at`: å‘é€æ—¶é—´æˆ³

**æ–‡ä»¶å­˜å‚¨**:
- `file`: Django FileFieldï¼Œè‡ªåŠ¨ç®¡ç†æ–‡ä»¶ä¸Šä¼ 
- `file_size`, `mime_type`: æ–‡ä»¶å…ƒä¿¡æ¯
- `thumbnail_url`: ç¼©ç•¥å›¾è·¯å¾„ï¼ˆå›¾ç‰‡é™„ä»¶ï¼‰

**åŒæ ¼å¼å­˜å‚¨**:
- `base64_data`: å›¾ç‰‡çš„ base64 ç¼–ç ï¼ˆvision æ¨¡å‹ä½¿ç”¨ï¼‰
- `parsed_text`: OCR/æ–‡æ¡£æå–çš„æ–‡æœ¬ï¼ˆé vision æ¨¡å‹ä½¿ç”¨ï¼‰

**å†…éƒ¨å…ƒç´ **:
- `internal_type`, `internal_id`: å¼•ç”¨å†…éƒ¨å…ƒç´ 
- `internal_snapshot`: JSON å¿«ç…§ï¼Œé˜²æ­¢å…ƒç´ è¢«åˆ é™¤

**è½¯åˆ é™¤**:
- `is_deleted`: æ ‡è®°æ˜¯å¦åˆ é™¤
- `deleted_at`: åˆ é™¤æ—¶é—´ï¼ˆç”¨äº 7 å¤©æ¸…ç†ï¼‰
- `deleted_with_message_index`: å›æ»šæ—¶å…³è”çš„æ¶ˆæ¯ç´¢å¼•
- `deleted_reason`: åˆ é™¤åŸå› ï¼ˆå›æ»š/æ‰‹åŠ¨/è¿‡æœŸï¼‰

### 4.2 æ•°æ®åº“è¿ç§»

#### 4.2.1 åˆ›å»ºè¿ç§»

ä¸å†å¯¼å…¥ä¸å­˜åœ¨çš„ AttachmentFileï¼Œè€Œæ˜¯ç›´æ¥å®šä¹‰ SessionAttachmentï¼š

```python
# agent_service/models.py (ä¿®æ”¹)
# ç§»é™¤è¿™ä¸€è¡Œï¼š
# from .models_attachment import AttachmentFile

# åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ  SessionAttachment æ¨¡å‹ï¼ˆè§ 4.1.1ï¼‰
```

ç”Ÿæˆè¿ç§»æ–‡ä»¶ï¼š
```bash
python manage.py makemigrations agent_service
```

åº”ç”¨è¿ç§»ï¼š
```bash
python manage.py migrate agent_service
```

#### 4.2.2 è¿ç§»å†…å®¹é¢„è§ˆ

Django å°†ç”Ÿæˆç±»ä¼¼ä»¥ä¸‹çš„è¿ç§»æ–‡ä»¶ï¼š

```python
# agent_service/migrations/000X_sessionattachment.py

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion

class Migration(migrations.Migration):

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ('agent_service', '000X_previous_migration'),
    ]

    operations = [
        migrations.CreateModel(
            name='SessionAttachment',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('session_id', models.CharField(db_index=True, help_text='å…³è”çš„ AgentSession.session_id', max_length=200)),
                ('type', models.CharField(choices=[...], help_text='é™„ä»¶ç±»å‹', max_length=20)),
                ('filename', models.CharField(help_text='æ–‡ä»¶åæˆ–å…ƒç´ æ ‡é¢˜', max_length=255)),
                ('message_index', models.IntegerField(blank=True, help_text='é™„ä»¶è¢«å‘é€æ—¶çš„æ¶ˆæ¯ç´¢å¼•', null=True)),
                # ... å…¶ä»–å­—æ®µ
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='session_attachments', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'ä¼šè¯é™„ä»¶',
                'verbose_name_plural': 'ä¼šè¯é™„ä»¶',
                'ordering': ['-created_at'],
            },
        ),
        migrations.AddIndex(
            model_name='sessionattachment',
            index=models.Index(fields=['session_id', 'is_deleted'], name='agent_servi_session_idx'),
        ),
        # ... å…¶ä»–ç´¢å¼•
    ]
```

#### 4.2.3 é…ç½® media æ–‡ä»¶

åœ¨ `UniSchedulerSuper/settings.py` ä¸­ç¡®ä¿é…ç½®äº† MEDIA è®¾ç½®ï¼š

```python
# settings.py

import os
from pathlib import Path

BASE_DIR = Path(__file__).resolve().parent.parent

# Media æ–‡ä»¶é…ç½®
MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')

# ç¡®ä¿ç›®å½•å­˜åœ¨
os.makedirs(MEDIA_ROOT, exist_ok=True)
```

åœ¨å¼€å‘ç¯å¢ƒçš„ `urls.py` ä¸­æ·»åŠ  media è·¯ç”±ï¼š

```python
# UniSchedulerSuper/urls.py

from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    # ... ç°æœ‰è·¯ç”±
]

# å¼€å‘ç¯å¢ƒæä¾› media æ–‡ä»¶
if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
```

---

## 5. è§£æå™¨ç³»ç»Ÿ

### 5.1 è§£æå™¨æ¥å£

å®šä¹‰ç»Ÿä¸€çš„è§£æå™¨æ¥å£ï¼Œæ‰€æœ‰è§£æå™¨å®ç°åŒä¸€å¥— APIï¼š

```python
# agent_service/parsers/base.py

from abc import ABC, abstractmethod
from typing import Dict, Any, Optional

class BaseParser(ABC):
    """è§£æå™¨åŸºç±»"""
    
    @abstractmethod
    def can_parse(self, file_path: str, mime_type: str) -> bool:
        """
        åˆ¤æ–­æ˜¯å¦èƒ½è§£æè¯¥æ–‡ä»¶
        
        Args:
            file_path: æ–‡ä»¶è·¯å¾„
            mime_type: MIME ç±»å‹
            
        Returns:
            æ˜¯å¦æ”¯æŒè§£æ
        """
        pass
    
    @abstractmethod
    def parse(self, file_path: str, **kwargs) -> Dict[str, Any]:
        """
        è§£ææ–‡ä»¶
        
        Args:
            file_path: æ–‡ä»¶è·¯å¾„
            **kwargs: é¢å¤–å‚æ•°
            
        Returns:
            {
                "text": str,          # æå–çš„æ–‡æœ¬
                "metadata": dict,     # å…ƒä¿¡æ¯
                "success": bool,      # æ˜¯å¦æˆåŠŸ
                "error": str          # é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœå¤±è´¥ï¼‰
            }
        """
        pass
    
    def generate_thumbnail(self, file_path: str, output_path: str, size: tuple = (200, 200)) -> bool:
        """
        ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆå¯é€‰å®ç°ï¼‰
        
        Args:
            file_path: åŸæ–‡ä»¶è·¯å¾„
            output_path: è¾“å‡ºè·¯å¾„
            size: ç¼©ç•¥å›¾å°ºå¯¸
            
        Returns:
            æ˜¯å¦æˆåŠŸç”Ÿæˆ
        """
        return False
```

### 5.2 å›¾ç‰‡è§£æå™¨

```python
# agent_service/parsers/image_parser.py

import os
import base64
from PIL import Image
from typing import Dict, Any
from .base import BaseParser

class ImageParser(BaseParser):
    """å›¾ç‰‡è§£æå™¨ - OCR + Base64 ç¼–ç  + ç¼©ç•¥å›¾"""
    
    SUPPORTED_FORMATS = ['image/jpeg', 'image/png', 'image/gif', 'image/webp']
    
    def can_parse(self, file_path: str, mime_type: str) -> bool:
        return mime_type in self.SUPPORTED_FORMATS
    
    def parse(self, file_path: str, **kwargs) -> Dict[str, Any]:
        """
        è§£æå›¾ç‰‡
        - ç”Ÿæˆ base64 ç¼–ç ï¼ˆç”¨äº vision æ¨¡å‹ï¼‰
        - OCR æå–æ–‡å­—ï¼ˆç”¨äºé vision æ¨¡å‹é™çº§ï¼‰
        """
        try:
            # 1. è¯»å–å›¾ç‰‡å¹¶ç”Ÿæˆ base64
            with open(file_path, 'rb') as f:
                image_data = f.read()
                base64_str = base64.b64encode(image_data).decode('utf-8')
            
            # 2. OCR æ–‡å­—æå–ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
            ocr_text = self._extract_text_ocr(file_path)
            
            # 3. è·å–å›¾ç‰‡å…ƒä¿¡æ¯
            with Image.open(file_path) as img:
                metadata = {
                    "width": img.width,
                    "height": img.height,
                    "format": img.format,
                    "mode": img.mode
                }
            
            return {
                "success": True,
                "text": ocr_text or "[å›¾ç‰‡ï¼Œæ— æ–‡å­—å†…å®¹]",
                "base64": base64_str,
                "metadata": metadata,
                "error": ""
            }
            
        except Exception as e:
            return {
                "success": False,
                "text": "",
                "base64": "",
                "metadata": {},
                "error": str(e)
            }
    
    def _extract_text_ocr(self, file_path: str) -> str:
        """
        ä½¿ç”¨ OCR æå–å›¾ç‰‡ä¸­çš„æ–‡å­—
        ä¼˜å…ˆä½¿ç”¨ EasyOCRï¼Œå¦‚æœä¸å¯ç”¨åˆ™è¿”å›å ä½ç¬¦
        """
        try:
            # å°è¯•å¯¼å…¥ EasyOCR
            import easyocr
            
            # åˆå§‹åŒ– OCRï¼ˆåªåœ¨éœ€è¦æ—¶åŠ è½½ï¼‰
            if not hasattr(self, '_ocr_reader'):
                self._ocr_reader = easyocr.Reader(['ch_sim', 'en'])
            
            # æå–æ–‡å­—
            results = self._ocr_reader.readtext(file_path, detail=0)
            text = '\n'.join(results)
            
            return text if text.strip() else ""
            
        except ImportError:
            # EasyOCR æœªå®‰è£…ï¼Œè¿”å›æç¤º
            return "[éœ€è¦å®‰è£… easyocr åº“ä»¥æå–å›¾ç‰‡æ–‡å­—]"
        except Exception as e:
            from logger import logger
            logger.warning(f"OCR æå–å¤±è´¥: {e}")
            return ""
    
    def generate_thumbnail(self, file_path: str, output_path: str, size: tuple = (200, 200)) -> bool:
        """ç”Ÿæˆç¼©ç•¥å›¾"""
        try:
            with Image.open(file_path) as img:
                # è½¬æ¢ä¸º RGBï¼ˆå¤„ç† RGBAã€P æ¨¡å¼ï¼‰
                if img.mode in ('RGBA', 'LA', 'P'):
                    background = Image.new('RGB', img.size, (255, 255, 255))
                    if img.mode == 'P':
                        img = img.convert('RGBA')
                    background.paste(img, mask=img.split()[-1] if img.mode in ('RGBA', 'LA') else None)
                    img = background
                elif img.mode != 'RGB':
                    img = img.convert('RGB')
                
                # ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆä¿æŒå®½é«˜æ¯”ï¼‰
                img.thumbnail(size, Image.Resampling.LANCZOS)
                
                # ä¿å­˜
                os.makedirs(os.path.dirname(output_path), exist_ok=True)
                img.save(output_path, 'JPEG', quality=85)
                
                return True
        except Exception as e:
            from logger import logger
            logger.error(f"ç”Ÿæˆç¼©ç•¥å›¾å¤±è´¥: {e}")
            return False
```

### 5.3 æ–‡æ¡£è§£æå™¨

```python
# agent_service/parsers/document_parser.py

from typing import Dict, Any
from .base import BaseParser

class PDFParser(BaseParser):
    """PDF è§£æå™¨"""
    
    def can_parse(self, file_path: str, mime_type: str) -> bool:
        return mime_type == 'application/pdf'
    
    def parse(self, file_path: str, **kwargs) -> Dict[str, Any]:
        """è§£æ PDF æ–‡ä»¶"""
        try:
            import pdfplumber
            
            text_content = []
            metadata = {"pages": 0, "has_tables": False}
            
            with pdfplumber.open(file_path) as pdf:
                metadata["pages"] = len(pdf.pages)
                
                for page in pdf.pages:
                    # æå–æ–‡æœ¬
                    page_text = page.extract_text()
                    if page_text:
                        text_content.append(page_text)
                    
                    # æ£€æµ‹è¡¨æ ¼
                    tables = page.extract_tables()
                    if tables:
                        metadata["has_tables"] = True
                        for table in tables:
                            # å°†è¡¨æ ¼è½¬æ¢ä¸º Markdown
                            table_md = self._table_to_markdown(table)
                            text_content.append(table_md)
            
            full_text = '\n\n'.join(text_content)
            
            return {
                "success": True,
                "text": full_text or "[PDF æ— æ–‡æœ¬å†…å®¹]",
                "metadata": metadata,
                "error": ""
            }
            
        except ImportError:
            return {
                "success": False,
                "text": "",
                "metadata": {},
                "error": "éœ€è¦å®‰è£… pdfplumber åº“"
            }
        except Exception as e:
            return {
                "success": False,
                "text": "",
                "metadata": {},
                "error": str(e)
            }
    
    def _table_to_markdown(self, table) -> str:
        """å°†è¡¨æ ¼è½¬æ¢ä¸º Markdown æ ¼å¼"""
        if not table or len(table) == 0:
            return ""
        
        lines = []
        
        # è¡¨å¤´
        header = table[0]
        lines.append('| ' + ' | '.join(str(cell or '') for cell in header) + ' |')
        lines.append('| ' + ' | '.join(['---'] * len(header)) + ' |')
        
        # æ•°æ®è¡Œ
        for row in table[1:]:
            lines.append('| ' + ' | '.join(str(cell or '') for cell in row) + ' |')
        
        return '\n'.join(lines)


class WordParser(BaseParser):
    """Word æ–‡æ¡£è§£æå™¨"""
    
    def can_parse(self, file_path: str, mime_type: str) -> bool:
        return mime_type in [
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'application/msword'
        ]
    
    def parse(self, file_path: str, **kwargs) -> Dict[str, Any]:
        """è§£æ Word æ–‡æ¡£"""
        try:
            from docx import Document
            
            doc = Document(file_path)
            
            # æå–æ®µè½
            paragraphs = [p.text for p in doc.paragraphs if p.text.strip()]
            
            # æå–è¡¨æ ¼
            tables_text = []
            for table in doc.tables:
                table_data = []
                for row in table.rows:
                    row_data = [cell.text for cell in row.cells]
                    table_data.append(row_data)
                
                # è½¬æ¢ä¸º Markdown
                if table_data:
                    tables_text.append(self._table_to_markdown(table_data))
            
            full_text = '\n\n'.join(paragraphs + tables_text)
            
            metadata = {
                "paragraphs": len(paragraphs),
                "tables": len(doc.tables)
            }
            
            return {
                "success": True,
                "text": full_text or "[Word æ–‡æ¡£æ— å†…å®¹]",
                "metadata": metadata,
                "error": ""
            }
            
        except ImportError:
            return {
                "success": False,
                "text": "",
                "metadata": {},
                "error": "éœ€è¦å®‰è£… python-docx åº“"
            }
        except Exception as e:
            return {
                "success": False,
                "text": "",
                "metadata": {},
                "error": str(e)
            }
    
    def _table_to_markdown(self, table_data) -> str:
        """åŒ PDFParser çš„å®ç°"""
        if not table_data or len(table_data) == 0:
            return ""
        
        lines = []
        header = table_data[0]
        lines.append('| ' + ' | '.join(str(cell or '') for cell in header) + ' |')
        lines.append('| ' + ' | '.join(['---'] * len(header)) + ' |')
        
        for row in table_data[1:]:
            lines.append('| ' + ' | '.join(str(cell or '') for cell in row) + ' |')
        
        return '\n'.join(lines)


class ExcelParser(BaseParser):
    """Excel è¡¨æ ¼è§£æå™¨"""
    
    def can_parse(self, file_path: str, mime_type: str) -> bool:
        return mime_type in [
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            'application/vnd.ms-excel'
        ]
    
    def parse(self, file_path: str, **kwargs) -> Dict[str, Any]:
        """è§£æ Excel æ–‡ä»¶"""
        try:
            import openpyxl
            
            wb = openpyxl.load_workbook(file_path, data_only=True)
            sheets_text = []
            
            for sheet_name in wb.sheetnames:
                ws = wb[sheet_name]
                
                # è·å–æ•°æ®
                data = []
                for row in ws.iter_rows(values_only=True):
                    if any(cell is not None for cell in row):
                        data.append([str(cell) if cell is not None else '' for cell in row])
                
                if data:
                    sheet_md = f"## Sheet: {sheet_name}\n\n"
                    sheet_md += self._table_to_markdown(data)
                    sheets_text.append(sheet_md)
            
            full_text = '\n\n'.join(sheets_text)
            
            metadata = {
                "sheets": len(wb.sheetnames),
                "sheet_names": wb.sheetnames
            }
            
            return {
                "success": True,
                "text": full_text or "[Excel æ–‡ä»¶æ— æ•°æ®]",
                "metadata": metadata,
                "error": ""
            }
            
        except ImportError:
            return {
                "success": False,
                "text": "",
                "metadata": {},
                "error": "éœ€è¦å®‰è£… openpyxl åº“"
            }
        except Exception as e:
            return {
                "success": False,
                "text": "",
                "metadata": {},
                "error": str(e)
            }
    
    def _table_to_markdown(self, table_data) -> str:
        """åŒä¸Š"""
        if not table_data or len(table_data) == 0:
            return ""
        
        lines = []
        header = table_data[0]
        lines.append('| ' + ' | '.join(str(cell) for cell in header) + ' |')
        lines.append('| ' + ' | '.join(['---'] * len(header)) + ' |')
        
        for row in table_data[1:]:
            lines.append('| ' + ' | '.join(str(cell) for cell in row) + ' |')
        
        return '\n'.join(lines)
```

### 5.4 å†…éƒ¨å…ƒç´ è§£æå™¨

```python
# agent_service/parsers/internal_parser.py

from typing import Dict, Any, Optional
from django.contrib.auth.models import User
from .base import BaseParser

class InternalElementParser(BaseParser):
    """å†…éƒ¨å…ƒç´ è§£æå™¨ - å¤„ç† events, todos, reminders, workflows"""
    
    def can_parse(self, file_path: str, mime_type: str) -> bool:
        # å†…éƒ¨å…ƒç´ ä¸èµ°æ–‡ä»¶è§£ææµç¨‹
        return False
    
    def parse_element(self, user: User, element_type: str, element_id: int) -> Dict[str, Any]:
        """
        è§£æå†…éƒ¨å…ƒç´ 
        
        Args:
            user: ç”¨æˆ·å¯¹è±¡
            element_type: å…ƒç´ ç±»å‹ (event, todo, reminder, workflow)
            element_id: å…ƒç´  ID
            
        Returns:
            {
                "success": bool,
                "markdown": str,      # Markdown æ ¼å¼åŒ–å†…å®¹
                "snapshot": dict,     # å…ƒç´ å¿«ç…§
                "error": str
            }
        """
        try:
            if element_type == 'event':
                return self._parse_event(user, element_id)
            elif element_type == 'todo':
                return self._parse_todo(user, element_id)
            elif element_type == 'reminder':
                return self._parse_reminder(user, element_id)
            elif element_type == 'workflow':
                return self._parse_workflow(user, element_id)
            else:
                return {
                    "success": False,
                    "markdown": "",
                    "snapshot": {},
                    "error": f"ä¸æ”¯æŒçš„å…ƒç´ ç±»å‹: {element_type}"
                }
        except Exception as e:
            return {
                "success": False,
                "markdown": "",
                "snapshot": {},
                "error": str(e)
            }
    
    def _parse_event(self, user: User, event_id: int) -> Dict[str, Any]:
        """è§£æ Event"""
        from core.models import Event
        
        try:
            event = Event.objects.get(id=event_id, user=user)
        except Event.DoesNotExist:
            return {
                "success": False,
                "markdown": "",
                "snapshot": {},
                "error": "æ—¥ç¨‹ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®"
            }
        
        snapshot = {
            "id": event.id,
            "title": event.title,
            "start": event.start.isoformat() if event.start else "",
            "end": event.end.isoformat() if event.end else "",
            "description": event.description or "",
            "location": event.location or "",
            "is_all_day": event.is_all_day
        }
        
        markdown = f"""### ğŸ“… {event.title}

- **å¼€å§‹æ—¶é—´**: {event.start.strftime('%Y-%m-%d %H:%M') if event.start else 'æœªè®¾ç½®'}
- **ç»“æŸæ—¶é—´**: {event.end.strftime('%Y-%m-%d %H:%M') if event.end else 'æœªè®¾ç½®'}
"""
        
        if event.is_all_day:
            markdown += "- **å…¨å¤©äº‹ä»¶**: æ˜¯\n"
        
        if event.location:
            markdown += f"- **åœ°ç‚¹**: {event.location}\n"
        
        if event.description:
            markdown += f"\n**æè¿°**:\n{event.description}\n"
        
        return {
            "success": True,
            "markdown": markdown,
            "snapshot": snapshot,
            "error": ""
        }
    
    def _parse_todo(self, user: User, todo_id: int) -> Dict[str, Any]:
        """è§£æ Todo"""
        from core.models import Todo
        
        try:
            todo = Todo.objects.get(id=todo_id, user=user)
        except Todo.DoesNotExist:
            return {
                "success": False,
                "markdown": "",
                "snapshot": {},
                "error": "å¾…åŠäº‹é¡¹ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®"
            }
        
        snapshot = {
            "id": todo.id,
            "title": todo.title,
            "completed": todo.completed,
            "due_date": todo.due_date.isoformat() if hasattr(todo, 'due_date') and todo.due_date else "",
            "description": getattr(todo, 'description', '') or ""
        }
        
        status_icon = "âœ…" if todo.completed else "â¬œ"
        markdown = f"""### {status_icon} {todo.title}

- **çŠ¶æ€**: {'å·²å®Œæˆ' if todo.completed else 'å¾…å®Œæˆ'}
"""
        
        if hasattr(todo, 'due_date') and todo.due_date:
            markdown += f"- **æˆªæ­¢æ—¶é—´**: {todo.due_date.strftime('%Y-%m-%d %H:%M')}\n"
        
        if hasattr(todo, 'description') and todo.description:
            markdown += f"\n**æè¿°**:\n{todo.description}\n"
        
        return {
            "success": True,
            "markdown": markdown,
            "snapshot": snapshot,
            "error": ""
        }
    
    def _parse_reminder(self, user: User, reminder_id: int) -> Dict[str, Any]:
        """è§£æ Reminder"""
        from core.models import Reminder
        
        try:
            reminder = Reminder.objects.get(id=reminder_id, user=user)
        except Reminder.DoesNotExist:
            return {
                "success": False,
                "markdown": "",
                "snapshot": {},
                "error": "æé†’ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®"
            }
        
        snapshot = {
            "id": reminder.id,
            "title": reminder.title,
            "remind_at": reminder.remind_at.isoformat() if reminder.remind_at else "",
            "message": reminder.message or ""
        }
        
        markdown = f"""### â° {reminder.title}

- **æé†’æ—¶é—´**: {reminder.remind_at.strftime('%Y-%m-%d %H:%M') if reminder.remind_at else 'æœªè®¾ç½®'}
"""
        
        if reminder.message:
            markdown += f"- **å†…å®¹**: {reminder.message}\n"
        
        return {
            "success": True,
            "markdown": markdown,
            "snapshot": snapshot,
            "error": ""
        }
    
    def _parse_workflow(self, user: User, workflow_id: int) -> Dict[str, Any]:
        """è§£æ WorkflowRule"""
        from agent_service.models import WorkflowRule
        
        try:
            workflow = WorkflowRule.objects.get(id=workflow_id, user=user, is_active=True)
        except WorkflowRule.DoesNotExist:
            return {
                "success": False,
                "markdown": "",
                "snapshot": {},
                "error": "å·¥ä½œæµè§„åˆ™ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨"
            }
        
        snapshot = {
            "id": workflow.id,
            "name": workflow.name,
            "trigger": workflow.trigger,
            "steps": workflow.steps
        }
        
        markdown = f"""### ğŸ”„ {workflow.name}

**è§¦å‘æ¡ä»¶**:
{workflow.trigger}

**æ‰§è¡Œæ­¥éª¤**:
{workflow.steps}
"""
        
        return {
            "success": True,
            "markdown": markdown,
            "snapshot": snapshot,
            "error": ""
        }
    
    def parse(self, file_path: str, **kwargs) -> Dict[str, Any]:
        """ä¸ä½¿ç”¨ï¼ˆå†…éƒ¨å…ƒç´ ä¸èµ°æ–‡ä»¶è§£æï¼‰"""
        raise NotImplementedError("Use parse_element() instead")
```

### 5.5 è§£æå™¨å·¥å‚

```python
# agent_service/parsers/__init__.py

from .base import BaseParser
from .image_parser import ImageParser
from .document_parser import PDFParser, WordParser, ExcelParser
from .internal_parser import InternalElementParser

class ParserFactory:
    """è§£æå™¨å·¥å‚ - æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©åˆé€‚çš„è§£æå™¨"""
    
    def __init__(self):
        self.parsers = [
            ImageParser(),
            PDFParser(),
            WordParser(),
            ExcelParser(),
        ]
        self.internal_parser = InternalElementParser()
    
    def get_parser(self, file_path: str, mime_type: str) -> BaseParser:
        """
        æ ¹æ®æ–‡ä»¶ç±»å‹è·å–è§£æå™¨
        
        Args:
            file_path: æ–‡ä»¶è·¯å¾„
            mime_type: MIME ç±»å‹
            
        Returns:
            åˆé€‚çš„è§£æå™¨ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å› None
        """
        for parser in self.parsers:
            if parser.can_parse(file_path, mime_type):
                return parser
        return None
    
    def get_internal_parser(self) -> InternalElementParser:
        """è·å–å†…éƒ¨å…ƒç´ è§£æå™¨"""
        return self.internal_parser

# å…¨å±€å•ä¾‹
parser_factory = ParserFactory()
```

---

## 6. å¤šæ¨¡æ€é€‚é…

### 6.1 æ¨¡å‹èƒ½åŠ›é…ç½®

#### 6.1.1 ç°æœ‰é…ç½®ç»“æ„

å½“å‰ `config/api_keys.json` å·²æœ‰æ¨¡å‹èƒ½åŠ›å­—æ®µï¼š

```json
{
    "system_models": {
        "system_deepseek": {
            "name": "DeepSeek V3ï¼ˆç³»ç»Ÿæä¾›ï¼‰",
            "model_name": "deepseek-chat",
            "supports_tools": true,
            "supports_vision": false,     // â† å…³é”®å­—æ®µ
            "supports_multimodal": false, // â† å…³é”®å­—æ®µ
            ...
        },
        "system_gpt4v": {
            "name": "GPT-4 Vision",
            "model_name": "gpt-4-vision-preview",
            "supports_vision": true,      // â† Vision æ¨¡å‹
            "supports_multimodal": true,
            ...
        }
    },
    "custom_models": {
        // ç”¨æˆ·è‡ªå®šä¹‰æ¨¡å‹...
    }
}
```

**æ— éœ€ä¿®æ”¹é…ç½®æ–‡ä»¶æ ¼å¼**ï¼Œç°æœ‰å­—æ®µå·²è¶³å¤Ÿä½¿ç”¨ã€‚

#### 6.1.2 èƒ½åŠ›å­—æ®µè¯´æ˜

- **supports_vision**: æ˜¯å¦æ”¯æŒå›¾ç‰‡ç†è§£ï¼ˆå¦‚ GPT-4V, Claude 3.5 Sonnetï¼‰
- **supports_multimodal**: æ˜¯å¦æ”¯æŒå¤šæ¨¡æ€è¾“å…¥ï¼ˆæœªæ¥æ‰©å±•ï¼šéŸ³é¢‘ã€è§†é¢‘ç­‰ï¼‰

**åˆ¤æ–­é€»è¾‘**:
```python
if model_config.get('supports_vision', False):
    # å¯ä»¥ç›´æ¥å‘é€ base64 å›¾ç‰‡
    use_base64_images = True
else:
    # éœ€è¦é™çº§åˆ° OCR æ–‡æœ¬
    use_base64_images = False
```

### 6.2 èƒ½åŠ›æ£€æµ‹

#### 6.2.1 ModelCapabilities å·¥å…·ç±»

```python
# agent_service/model_capabilities.py

from typing import Dict, Any, Optional
from django.contrib.auth.models import User
from config.api_keys_manager import get_all_models
from core.models import UserData

class ModelCapabilities:
    """æ¨¡å‹èƒ½åŠ›æ£€æµ‹å™¨"""
    
    @staticmethod
    def get_current_model_config(user: User) -> tuple[str, Dict[str, Any]]:
        """
        è·å–ç”¨æˆ·å½“å‰ä½¿ç”¨çš„æ¨¡å‹é…ç½®
        
        Returns:
            (model_id, model_config)
        """
        try:
            # ä» UserData è¯»å–ç”¨æˆ·é€‰æ‹©çš„æ¨¡å‹
            user_data = UserData.objects.get(user=user, key='agent_config')
            agent_config = user_data.data
            model_id = agent_config.get('model_id', 'system_deepseek')
        except UserData.DoesNotExist:
            # é»˜è®¤ä½¿ç”¨ system_deepseek
            model_id = 'system_deepseek'
        
        # ä» api_keys.json è¯»å–æ¨¡å‹é…ç½®
        all_models = get_all_models()
        model_config = all_models.get(model_id, {})
        
        return model_id, model_config
    
    @staticmethod
    def supports_vision(user: User) -> bool:
        """
        æ£€æµ‹ç”¨æˆ·å½“å‰æ¨¡å‹æ˜¯å¦æ”¯æŒ vision
        
        Args:
            user: ç”¨æˆ·å¯¹è±¡
            
        Returns:
            æ˜¯å¦æ”¯æŒ vision
        """
        model_id, model_config = ModelCapabilities.get_current_model_config(user)
        return model_config.get('supports_vision', False)
    
    @staticmethod
    def supports_multimodal(user: User) -> bool:
        """
        æ£€æµ‹ç”¨æˆ·å½“å‰æ¨¡å‹æ˜¯å¦æ”¯æŒå¤šæ¨¡æ€
        
        Args:
            user: ç”¨æˆ·å¯¹è±¡
            
        Returns:
            æ˜¯å¦æ”¯æŒå¤šæ¨¡æ€
        """
        model_id, model_config = ModelCapabilities.get_current_model_config(user)
        return model_config.get('supports_multimodal', False)
    
    @staticmethod
    def get_capabilities(user: User) -> Dict[str, Any]:
        """
        è·å–ç”¨æˆ·å½“å‰æ¨¡å‹çš„æ‰€æœ‰èƒ½åŠ›
        
        Returns:
            {
                "model_id": str,
                "model_name": str,
                "supports_vision": bool,
                "supports_multimodal": bool,
                "supports_tools": bool,
                "context_window": int
            }
        """
        model_id, model_config = ModelCapabilities.get_current_model_config(user)
        
        return {
            "model_id": model_id,
            "model_name": model_config.get('model_name', ''),
            "supports_vision": model_config.get('supports_vision', False),
            "supports_multimodal": model_config.get('supports_multimodal', False),
            "supports_tools": model_config.get('supports_tools', True),
            "context_window": model_config.get('context_window', 128000)
        }
```

#### 6.2.2 ä½¿ç”¨ç¤ºä¾‹

```python
# åœ¨ views_api.py æˆ– agent_graph.py ä¸­ä½¿ç”¨

from agent_service.model_capabilities import ModelCapabilities

def format_attachment_for_agent(user, attachment_id):
    """æ ¼å¼åŒ–é™„ä»¶ç”¨äº Agent"""
    
    # 1. æ£€æµ‹æ¨¡å‹èƒ½åŠ›
    capabilities = ModelCapabilities.get_capabilities(user)
    supports_vision = capabilities['supports_vision']
    
    # 2. è·å–é™„ä»¶
    attachment = SessionAttachment.objects.get(id=attachment_id, user=user)
    
    # 3. æ ¹æ®èƒ½åŠ›é€‰æ‹©æ ¼å¼
    formatted = attachment.get_formatted_content(
        model_supports_vision=supports_vision
    )
    
    return formatted
```

### 6.3 é™çº§ç­–ç•¥

#### 6.3.1 è‡ªåŠ¨é™çº§æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·å‘é€æ¶ˆæ¯ï¼ˆåŒ…å«å›¾ç‰‡é™„ä»¶ï¼‰            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯è°ƒç”¨ /api/agent/attachments/format/â”‚
â”‚  Body: {"attachments": [{"type": "file", â”‚
â”‚          "id": 5}]}                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åç«¯: ModelCapabilities.supports_vision()â”‚
â”‚  æ£€æµ‹å½“å‰æ¨¡å‹æ˜¯å¦æ”¯æŒ vision             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
        â”‚          â”‚
      Yes         No
        â”‚          â”‚
        â–¼          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Base64 â”‚  â”‚ OCR Text â”‚
   â”‚ å›¾ç‰‡   â”‚  â”‚ é™çº§æ–¹æ¡ˆ â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚          â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿”å›æ ¼å¼åŒ–å†…å®¹ç»™å‰ç«¯                    â”‚
â”‚  {                                      â”‚
â”‚    "formatted_content": "...",         â”‚
â”‚    "attachments_metadata": [...]       â”‚
â”‚  }                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 6.3.2 é™çº§è§„åˆ™è¡¨

| é™„ä»¶ç±»å‹ | Vision æ¨¡å‹ | é Vision æ¨¡å‹ |
|---------|------------|---------------|
| **å›¾ç‰‡** | Base64 ç¼–ç  | OCR æ–‡å­— + å›¾ç‰‡æè¿° |
| **PDF** | é¡µé¢æˆªå›¾ (Base64) | æ–‡å­—æå– + è¡¨æ ¼ Markdown |
| **Word** | ä¸é€‚ç”¨ | æ–‡å­—æå– + è¡¨æ ¼ Markdown |
| **Excel** | ä¸é€‚ç”¨ | è¡¨æ ¼ Markdown |
| **å†…éƒ¨å…ƒç´ ** | Markdown | Markdown (ç›¸åŒ) |

#### 6.3.3 é™çº§å®ç°

```python
# agent_service/attachment_handler.py

class AttachmentHandler:
    """é™„ä»¶å¤„ç†å™¨ - ç»Ÿä¸€å…¥å£"""
    
    def __init__(self, user: User):
        self.user = user
        self.capabilities = ModelCapabilities.get_capabilities(user)
    
    def format_attachments_for_message(self, attachment_ids: list) -> str:
        """
        æ ¼å¼åŒ–å¤šä¸ªé™„ä»¶ç”¨äºå‘é€æ¶ˆæ¯
        
        Args:
            attachment_ids: é™„ä»¶ ID åˆ—è¡¨
            
        Returns:
            æ ¼å¼åŒ–çš„å†…å®¹å­—ç¬¦ä¸²
        """
        from agent_service.models import SessionAttachment
        
        attachments = SessionAttachment.objects.filter(
            id__in=attachment_ids,
            user=self.user,
            is_deleted=False
        )
        
        formatted_parts = []
        
        for att in attachments:
            formatted = self._format_single_attachment(att)
            formatted_parts.append(formatted)
        
        return '\n\n'.join(formatted_parts)
    
    def _format_single_attachment(self, attachment) -> str:
        """æ ¼å¼åŒ–å•ä¸ªé™„ä»¶"""
        
        # è·å–æ ¼å¼åŒ–å†…å®¹
        result = attachment.get_formatted_content(
            model_supports_vision=self.capabilities['supports_vision']
        )
        
        content_type = result['type']
        content = result['content']
        metadata = result['metadata']
        
        # æ ¹æ®ç±»å‹ç”Ÿæˆæœ€ç»ˆå­—ç¬¦ä¸²
        if content_type == 'base64':
            # Vision æ¨¡å‹ï¼šè¿”å›ç‰¹æ®Šæ ‡è®°ï¼ˆç”± agent_graph è½¬æ¢ä¸º ImageURLï¼‰
            return f"[IMAGE:{metadata['filename']}|{content[:100]}...]"
        
        elif content_type == 'text':
            # é™çº§æ–¹æ¡ˆï¼šè¿”å›æ–‡æœ¬
            filename = metadata.get('filename', 'é™„ä»¶')
            return f"""ã€é™„ä»¶ï¼š{filename}ã€‘
ç±»å‹ï¼š{metadata.get('original_type', 'æœªçŸ¥')}ï¼ˆå·²è½¬æ¢ä¸ºæ–‡å­—ï¼‰

{content}
"""
        
        elif content_type == 'markdown':
            # å†…éƒ¨å…ƒç´ ï¼šè¿”å› Markdown
            return content
        
        else:
            return "[æœªçŸ¥é™„ä»¶ç±»å‹]"
```

#### 6.3.4 å‰ç«¯æ˜¾ç¤ºé€‚é…

```javascript
// core/static/js/agent-chat.js

async function sendMessageWithAttachments() {
    const attachmentIds = this.selectedAttachments.map(a => a.id);
    
    // 1. è·å–æ ¼å¼åŒ–å†…å®¹
    const response = await fetch('/api/agent/attachments/format/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': this.csrfToken
        },
        body: JSON.stringify({
            attachment_ids: attachmentIds
        })
    });
    
    const data = await response.json();
    
    // 2. æ˜¾ç¤ºé™„ä»¶ä¿¡æ¯ï¼ˆä¸åŒæ ¼å¼ï¼‰
    data.attachments_metadata.forEach(meta => {
        if (meta.format === 'base64') {
            // Vision æ¨¡å¼ï¼šæ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
            this.showAttachmentPreview(meta, 'image');
        } else if (meta.format === 'text') {
            // é™çº§æ¨¡å¼ï¼šæ˜¾ç¤º"å·²è½¬æ¢ä¸ºæ–‡å­—"æ ‡è®°
            this.showAttachmentPreview(meta, 'text-fallback');
        } else {
            // Markdown æ¨¡å¼ï¼šæ˜¾ç¤ºå…ƒç´ å›¾æ ‡
            this.showAttachmentPreview(meta, 'markdown');
        }
    });
    
    // 3. å‘é€æ¶ˆæ¯ï¼ˆé™„ä»¶å†…å®¹å·²åŒ…å«åœ¨ formatted_content ä¸­ï¼‰
    this.sendMessage(userInput + '\n\n' + data.formatted_content);
}
```

#### 6.3.5 åˆ‡æ¢æ¨¡å‹æ—¶çš„å¤„ç†

æ ¹æ®ç¬¬ 9.1 èŠ‚çš„æ–¹æ¡ˆï¼Œåˆ‡æ¢æ¨¡å‹æ—¶ï¼š

1. **å†å²æ¶ˆæ¯**ï¼šä¿æŒåŸæ ·ï¼Œå‰ç«¯æ˜¾ç¤ºå ä½ç¬¦
2. **æ–°æ¶ˆæ¯**ï¼šæ ¹æ®æ–°æ¨¡å‹èƒ½åŠ›è‡ªåŠ¨é€‰æ‹©æ ¼å¼
3. **SessionAttachment è®°å½•**ï¼šåŒæ ¼å¼å­˜å‚¨ï¼ˆbase64 + parsed_textï¼‰æ— éœ€ä¿®æ”¹

**å®ç°**:
```python
# agent_service/views_api.py

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def switch_model(request):
    """åˆ‡æ¢æ¨¡å‹æ—¶æ›´æ–°å‰ç«¯é™„ä»¶æ˜¾ç¤º"""
    
    new_model_id = request.data.get('model_id')
    
    # æ›´æ–° UserData
    user_data, _ = UserData.objects.get_or_create(
        user=request.user,
        key='agent_config'
    )
    agent_config = user_data.data
    agent_config['model_id'] = new_model_id
    user_data.data = agent_config
    user_data.save()
    
    # è¿”å›æ–°æ¨¡å‹èƒ½åŠ›
    capabilities = ModelCapabilities.get_capabilities(request.user)
    
    return Response({
        "success": True,
        "capabilities": capabilities
    })
```

**å‰ç«¯å¤„ç†**:
```javascript
// æ¨¡å‹åˆ‡æ¢åæ›´æ–°é™„ä»¶æ˜¾ç¤ºæ¨¡å¼
async onModelSwitch(newModelId) {
    // 1. è°ƒç”¨ API åˆ‡æ¢
    const response = await fetch('/api/agent/config/switch-model/', {
        method: 'POST',
        body: JSON.stringify({model_id: newModelId}),
        ...
    });
    
    const data = await response.json();
    
    // 2. æ›´æ–°å‰ç«¯èƒ½åŠ›æ ‡å¿—
    this.currentModelSupportsVision = data.capabilities.supports_vision;
    
    // 3. é‡æ–°æ¸²æŸ“å†å²æ¶ˆæ¯ä¸­çš„é™„ä»¶
    this.rerenderAttachmentsInHistory();
}

rerenderAttachmentsInHistory() {
    // éå†å†å²æ¶ˆæ¯ï¼Œæ ¹æ®æ–°èƒ½åŠ›æ›´æ–°é™„ä»¶æ˜¾ç¤º
    document.querySelectorAll('.message-attachment').forEach(attEl => {
        const attId = attEl.dataset.attachmentId;
        const attType = attEl.dataset.attachmentType;
        
        if (attType === 'image') {
            if (this.currentModelSupportsVision) {
                // æ˜¾ç¤ºå›¾ç‰‡
                attEl.classList.remove('fallback');
                attEl.querySelector('img').style.display = 'block';
            } else {
                // æ˜¾ç¤ºé™çº§æ ‡è®°
                attEl.classList.add('fallback');
                attEl.querySelector('.fallback-notice').textContent = 
                    '[è¯¥å›¾ç‰‡åœ¨å½“å‰æ¨¡å‹ä¸‹æ˜¾ç¤ºä¸ºæ–‡å­—]';
            }
        }
    });
}
```

---

## 7. å‰ç«¯äº¤äº’

### 7.1 é™„ä»¶ç®¡ç†å™¨æ‰©å±•

åŸºäºç°æœ‰çš„ `agent-chat.js` ä¸­çš„é™„ä»¶é€»è¾‘ï¼Œéœ€è¦æ‰©å±•ä»¥ä¸‹åŠŸèƒ½ï¼š

#### 7.1.1 å½“å‰å®ç°

```javascript
// ç°æœ‰é€»è¾‘ï¼ˆagent-chat.jsï¼‰
class AgentChat {
    constructor() {
        this.selectedAttachments = [];  // å•é€‰æ¨¡å¼
        this.currentAttachmentType = 'workflow';  // å½“å‰åªæ”¯æŒ workflow
    }
    
    async loadAttachmentContent(type) {
        // GET /api/agent/attachments/?type=workflow
    }
    
    async getFormattedAttachmentContent() {
        // POST /api/agent/attachments/format/
    }
}
```

#### 7.1.2 éœ€è¦æ‰©å±•çš„åŠŸèƒ½

**æ”¯æŒå¤šç§é™„ä»¶ç±»å‹**:
```javascript
// æ‰©å±•ç±»å‹
supportedTypes: ['workflow', 'file', 'event', 'todo', 'reminder']

// æ›´æ–° UI æ ‡ç­¾
const typeLabels = {
    'workflow': 'å·¥ä½œæµè§„åˆ™',
    'file': 'æ–‡ä»¶',
    'event': 'æ—¥ç¨‹',
    'todo': 'å¾…åŠ',
    'reminder': 'æé†’'
};
```

**æ–‡ä»¶ä¸Šä¼ **:
```javascript
async uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('session_id', this.sessionId);
    
    const response = await fetch('/api/agent/attachments/upload/', {
        method: 'POST',
        headers: {'X-CSRFToken': this.csrfToken},
        body: formData
    });
    
    const data = await response.json();
    
    // æ·»åŠ åˆ°å·²é€‰é™„ä»¶
    this.selectedAttachments.push({
        type: 'file',
        id: data.attachment_id,
        name: data.filename
    });
    
    this.updateAttachmentBadge();
    this.renderSelectedAttachments();
}
```

**æ‹–æ‹½ä¸Šä¼ **:
```javascript
setupDragAndDrop() {
    const dropZone = document.getElementById('agentChatInput');
    
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });
    
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
    });
    
    dropZone.addEventListener('drop', async (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        
        const files = Array.from(e.dataTransfer.files);
        
        for (const file of files) {
            await this.uploadFile(file);
        }
    });
}
```

### 7.2 æ‹–æ‹½å†…éƒ¨å…ƒç´ 

æ”¯æŒä»æ—¥å†/å¾…åŠåˆ—è¡¨æ‹–æ‹½å…ƒç´ åˆ° Agent ä¾§è¾¹æ ï¼š

#### 7.2.1 äº‹ä»¶æºè®¾ç½®

```javascript
// core/static/js/calendar-main.js

function setupDraggableEvents() {
    // FullCalendar äº‹ä»¶å¯æ‹–æ‹½
    const eventEls = document.querySelectorAll('.fc-event');
    
    eventEls.forEach(el => {
        el.draggable = true;
        el.addEventListener('dragstart', (e) => {
            const eventId = el.dataset.eventId;
            e.dataTransfer.setData('application/json', JSON.stringify({
                type: 'event',
                id: eventId,
                name: el.textContent
            }));
        });
    });
}

// å¾…åŠåˆ—è¡¨ç±»ä¼¼
function setupDraggableTodos() {
    const todoEls = document.querySelectorAll('.todo-item');
    
    todoEls.forEach(el => {
        el.draggable = true;
        el.addEventListener('dragstart', (e) => {
            const todoId = el.dataset.todoId;
            e.dataTransfer.setData('application/json', JSON.stringify({
                type: 'todo',
                id: todoId,
                name: el.textContent
            }));
        });
    });
}
```

#### 7.2.2 Agent ä¾§è¾¹æ æ¥æ”¶

```javascript
// agent-chat.js

setupInternalElementDrop() {
    const agentSidebar = document.getElementById('agentChatContainer');
    
    agentSidebar.addEventListener('dragover', (e) => {
        e.preventDefault();
        // æ˜¾ç¤ºå¯æ”¾ç½®æç¤º
    });
    
    agentSidebar.addEventListener('drop', async (e) => {
        e.preventDefault();
        
        const data = JSON.parse(e.dataTransfer.getData('application/json'));
        
        // æ·»åŠ åˆ°é™„ä»¶åˆ—è¡¨
        this.selectedAttachments.push(data);
        this.updateAttachmentBadge();
        this.renderSelectedAttachments();
    });
}
```

### 7.3 UI ç»„ä»¶

#### 7.3.1 é™„ä»¶é¢„è§ˆå¡ç‰‡

```html
<!-- é™„ä»¶é¢„è§ˆç»„ä»¶ -->
<div class="attachment-preview-card">
    <!-- å›¾ç‰‡é™„ä»¶ -->
    <div class="attachment-image">
        <img src="data:image/png;base64,..." alt="attachment">
        <div class="attachment-meta">
            <i class="fas fa-image"></i>
            <span>screenshot.png (450 KB)</span>
            <button class="btn-remove"><i class="fas fa-times"></i></button>
        </div>
    </div>
    
    <!-- æ–‡æ¡£é™„ä»¶ -->
    <div class="attachment-document">
        <i class="fas fa-file-pdf"></i>
        <div class="attachment-info">
            <span class="filename">report.pdf</span>
            <span class="filesize">2.3 MB</span>
        </div>
        <button class="btn-remove"><i class="fas fa-times"></i></button>
    </div>
    
    <!-- å†…éƒ¨å…ƒç´ é™„ä»¶ -->
    <div class="attachment-internal">
        <i class="fas fa-calendar-alt"></i>
        <div class="attachment-info">
            <span class="title">å›¢é˜Ÿä¼šè®®</span>
            <span class="subtitle">2026-02-15 14:00</span>
        </div>
        <button class="btn-remove"><i class="fas fa-times"></i></button>
    </div>
</div>
```

#### 7.3.2 é™çº§æç¤º

```html
<!-- æ¨¡å‹ä¸æ”¯æŒå›¾ç‰‡æ—¶çš„é™çº§æç¤º -->
<div class="attachment-fallback">
    <i class="fas fa-image text-muted"></i>
    <span class="text-muted">[å›¾ç‰‡å·²è½¬æ¢ä¸ºæ–‡å­—]</span>
    <details>
        <summary>æŸ¥çœ‹è¯†åˆ«å†…å®¹</summary>
        <pre>OCR æå–çš„æ–‡å­—å†…å®¹...</pre>
    </details>
</div>
```

---

## 8. æ–‡ä»¶å­˜å‚¨

### 8.1 ç›®å½•ç»“æ„

```
media/
â””â”€â”€ attachments/
    â”œâ”€â”€ 2026/
    â”‚   â”œâ”€â”€ 02/
    â”‚   â”‚   â”œâ”€â”€ 10/
    â”‚   â”‚   â”‚   â”œâ”€â”€ original_a1b2c3d4.png    # åŸå§‹æ–‡ä»¶
    â”‚   â”‚   â”‚   â”œâ”€â”€ thumb_a1b2c3d4.jpg       # ç¼©ç•¥å›¾
    â”‚   â”‚   â”‚   â”œâ”€â”€ original_e5f6g7h8.pdf
    â”‚   â”‚   â”‚   â””â”€â”€ ...
    â”‚   â”‚   â””â”€â”€ 11/
    â”‚   â”‚       â””â”€â”€ ...
    â”‚   â””â”€â”€ 03/
    â”‚       â””â”€â”€ ...
    â””â”€â”€ ...
```

**è¯´æ˜**:
- Django FileField è‡ªåŠ¨ç®¡ç† `upload_to='attachments/%Y/%m/%d/'`
- åŸå§‹æ–‡ä»¶ï¼š`original_{uuid}.{ext}`
- ç¼©ç•¥å›¾ï¼š`thumb_{uuid}.jpg`ï¼ˆç»Ÿä¸€ JPEG æ ¼å¼ï¼‰

### 8.2 æ¸…ç†ç­–ç•¥

#### 8.2.1 è‡ªåŠ¨æ¸…ç†ä»»åŠ¡

ä½¿ç”¨ Django ç®¡ç†å‘½ä»¤æˆ– Celery å®šæœŸä»»åŠ¡ï¼š

```python
# agent_service/management/commands/cleanup_attachments.py

from django.core.management.base import BaseCommand
from django.utils import timezone
from datetime import timedelta
from agent_service.models import SessionAttachment
from logger import logger

class Command(BaseCommand):
    help = 'æ¸…ç†è¶…è¿‡ 7 å¤©çš„è½¯åˆ é™¤é™„ä»¶'
    
    def handle(self, *args, **options):
        grace_period = timezone.now() - timedelta(days=7)
        
        # æŸ¥è¯¢è¶…è¿‡ 7 å¤©çš„è½¯åˆ é™¤é™„ä»¶
        expired = SessionAttachment.objects.filter(
            is_deleted=True,
            deleted_at__lt=grace_period
        )
        
        count = expired.count()
        logger.info(f"å‘ç° {count} ä¸ªè¿‡æœŸé™„ä»¶")
        
        for attachment in expired:
            try:
                # ç‰©ç†åˆ é™¤
                attachment.hard_delete()
                logger.info(f"å·²åˆ é™¤é™„ä»¶: {attachment.id} - {attachment.filename}")
            except Exception as e:
                logger.error(f"åˆ é™¤é™„ä»¶å¤±è´¥ {attachment.id}: {e}")
        
        self.stdout.write(
            self.style.SUCCESS(f'æˆåŠŸæ¸…ç† {count} ä¸ªè¿‡æœŸé™„ä»¶')
        )
```

**é…ç½® crontab** (Linux/Mac):
```bash
# æ¯å¤©å‡Œæ™¨ 3 ç‚¹æ‰§è¡Œ
0 3 * * * cd /path/to/project && python manage.py cleanup_attachments
```

**æˆ–ä½¿ç”¨ Celery** (å¦‚æœå·²é…ç½®):
```python
# agent_service/tasks.py

from celery import shared_task
from django.core.management import call_command

@shared_task
def cleanup_expired_attachments():
    """æ¸…ç†è¿‡æœŸé™„ä»¶ï¼ˆCelery ä»»åŠ¡ï¼‰"""
    call_command('cleanup_attachments')

# é…ç½®å®šæœŸæ‰§è¡Œï¼ˆcelery beatï¼‰
from celery.schedules import crontab

app.conf.beat_schedule = {
    'cleanup-attachments-daily': {
        'task': 'agent_service.tasks.cleanup_expired_attachments',
        'schedule': crontab(hour=3, minute=0),  # æ¯å¤©å‡Œæ™¨ 3 ç‚¹
    },
}
```

#### 8.2.2 æ‰‹åŠ¨æ¸…ç†

ç®¡ç†å‘˜å¯ä»¥æ‰‹åŠ¨è§¦å‘æ¸…ç†ï¼š

```bash
python manage.py cleanup_attachments
```

#### 8.2.3 å­¤å„¿æ–‡ä»¶æ¸…ç†

æ¸…ç†æ•°æ®åº“ä¸­ä¸å­˜åœ¨çš„æ–‡ä»¶ï¼ˆé˜²æ­¢æ„å¤–æ®‹ç•™ï¼‰ï¼š

```python
# agent_service/management/commands/cleanup_orphan_files.py

import os
from django.core.management.base import BaseCommand
from django.conf import settings
from agent_service.models import SessionAttachment
from logger import logger

class Command(BaseCommand):
    help = 'æ¸…ç†å­¤å„¿é™„ä»¶æ–‡ä»¶ï¼ˆæ•°æ®åº“ä¸­ä¸å­˜åœ¨çš„æ–‡ä»¶ï¼‰'
    
    def handle(self, *args, **options):
        attachments_dir = os.path.join(settings.MEDIA_ROOT, 'attachments')
        
        if not os.path.exists(attachments_dir):
            self.stdout.write('é™„ä»¶ç›®å½•ä¸å­˜åœ¨')
            return
        
        # è·å–æ•°æ®åº“ä¸­æ‰€æœ‰æ–‡ä»¶è·¯å¾„
        db_files = set()
        for att in SessionAttachment.objects.all():
            if att.file:
                db_files.add(att.file.path)
        
        # æ‰«ææ–‡ä»¶ç³»ç»Ÿ
        orphan_files = []
        for root, dirs, files in os.walk(attachments_dir):
            for filename in files:
                filepath = os.path.join(root, filename)
                if filepath not in db_files:
                    orphan_files.append(filepath)
        
        # åˆ é™¤å­¤å„¿æ–‡ä»¶
        for filepath in orphan_files:
            try:
                os.remove(filepath)
                logger.info(f"åˆ é™¤å­¤å„¿æ–‡ä»¶: {filepath}")
            except Exception as e:
                logger.error(f"åˆ é™¤å­¤å„¿æ–‡ä»¶å¤±è´¥: {e}")
        
        self.stdout.write(
            self.style.SUCCESS(f'æ¸…ç†äº† {len(orphan_files)} ä¸ªå­¤å„¿æ–‡ä»¶')
        )
```

### 8.3 å­˜å‚¨ä¼˜åŒ–

#### 8.3.1 æ–‡ä»¶å¤§å°é™åˆ¶

```python
# settings.py

# æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶
FILE_UPLOAD_MAX_MEMORY_SIZE = 10 * 1024 * 1024  # 10 MB
DATA_UPLOAD_MAX_MEMORY_SIZE = 10 * 1024 * 1024  # 10 MB

# é™„ä»¶å¤§å°é™åˆ¶ï¼ˆåœ¨ views ä¸­æ£€æŸ¥ï¼‰
ATTACHMENT_MAX_SIZE = 20 * 1024 * 1024  # 20 MB
```

**API æ ¡éªŒ**:
```python
# views_api.py

@api_view(['POST'])
def upload_attachment(request):
    file = request.FILES.get('file')
    
    if not file:
        return Response({"error": "æœªæä¾›æ–‡ä»¶"}, status=400)
    
    # æ£€æŸ¥æ–‡ä»¶å¤§å°
    from django.conf import settings
    max_size = getattr(settings, 'ATTACHMENT_MAX_SIZE', 20 * 1024 * 1024)
    
    if file.size > max_size:
        return Response({
            "error": f"æ–‡ä»¶è¿‡å¤§ï¼Œæœ€å¤§æ”¯æŒ {max_size // (1024*1024)} MB"
        }, status=400)
    
    # ... ç»§ç»­å¤„ç†
```

#### 8.3.2 ç¼©ç•¥å›¾å‹ç¼©

```python
# parsers/image_parser.py

def generate_thumbnail(self, file_path: str, output_path: str, size: tuple = (200, 200)) -> bool:
    """ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆä¼˜åŒ–ï¼‰"""
    with Image.open(file_path) as img:
        # ...
        # ä¿å­˜æ—¶ä½¿ç”¨è¾ƒä½è´¨é‡
        img.save(output_path, 'JPEG', quality=75, optimize=True)  # 75% è´¨é‡
```

#### 8.3.3 Base64 å­˜å‚¨ä¼˜åŒ–

å¯¹äºå¤§å›¾ç‰‡ï¼Œbase64 æ•°æ®å¯èƒ½å¾ˆå¤§ã€‚ä¼˜åŒ–ç­–ç•¥ï¼š

```python
# SessionAttachment æ¨¡å‹

def save_base64_optimized(self, file_path: str):
    """ä¼˜åŒ– base64 å­˜å‚¨"""
    from PIL import Image
    from io import BytesIO
    import base64
    
    with Image.open(file_path) as img:
        # å¦‚æœå›¾ç‰‡è¿‡å¤§ï¼Œå…ˆå‹ç¼©
        max_dimension = 1024
        if img.width > max_dimension or img.height > max_dimension:
            img.thumbnail((max_dimension, max_dimension), Image.Resampling.LANCZOS)
        
        # è½¬æ¢ä¸º RGB
        if img.mode != 'RGB':
            img = img.convert('RGB')
        
        # ä¿å­˜åˆ°å†…å­˜
        buffer = BytesIO()
        img.save(buffer, format='JPEG', quality=85)
        buffer.seek(0)
        
        # ç¼–ç ä¸º base64
        self.base64_data = base64.b64encode(buffer.read()).decode('utf-8')
```

---

## 9. è¾¹ç¼˜æƒ…å†µå¤„ç†

### 9.1 åˆ‡æ¢æ¨¡å‹æ—¶çš„é™„ä»¶å¤„ç†

#### 9.1.1 é—®é¢˜åœºæ™¯

ç”¨æˆ·åœ¨å¯¹è¯è¿‡ç¨‹ä¸­åˆ‡æ¢æ¨¡å‹ï¼ˆå¦‚ä» GPT-4V åˆ‡æ¢åˆ° DeepSeekï¼‰ï¼Œå‰åæ¨¡å‹å¯¹å¤šæ¨¡æ€çš„æ”¯æŒä¸åŒï¼š
- **åœºæ™¯ A**: Vision â†’ Non-Visionï¼ˆå·²å‘é€ base64 å›¾ç‰‡ï¼Œæ–°æ¨¡å‹ä¸æ”¯æŒï¼‰
- **åœºæ™¯ B**: Non-Vision â†’ Visionï¼ˆå·²å‘é€ OCR æ–‡æœ¬ï¼Œæ–°æ¨¡å‹æ”¯æŒåŸå›¾ï¼‰

#### 9.1.2 ä¸šç•Œæ–¹æ¡ˆ

**ChatGPT çš„åšæ³•**:
```
- å†å²æ¶ˆæ¯ä¿æŒä¸å˜ï¼ˆæ•°æ®åº“ä¸ä¿®æ”¹ï¼‰
- å›¾ç‰‡åœ¨å†å²ä¸­æ˜¾ç¤ºä¸ºå ä½ç¬¦ï¼š[å›¾ç‰‡: screenshot.png]
- ç‚¹å‡»å¯æŸ¥çœ‹åŸå›¾ï¼Œä½†ä¸ä¼šé‡æ–°å‘é€ç»™æ–°æ¨¡å‹
- æ–°å›å¤åªåŸºäºæ–‡æœ¬ä¸Šä¸‹æ–‡
```

**Cursor çš„åšæ³•**:
```
- å†å²æ¶ˆæ¯ä¸é‡æ–°å¤„ç†
- æ–°æ¨¡å‹ä»åˆ‡æ¢ç‚¹å¼€å§‹å·¥ä½œ
- å¦‚æœéœ€è¦å†å²ä¸Šä¸‹æ–‡ï¼Œä¼šæ™ºèƒ½æ‘˜è¦ï¼ˆä¸åŒ…å«ä¸å…¼å®¹å†…å®¹ï¼‰
```

#### 9.1.3 æ¨èæ–¹æ¡ˆ

**æ ¸å¿ƒåŸåˆ™**:
1. âœ… **ä¸ä¿®æ”¹å†å²æ•°æ®** - å·²å‘é€çš„æ¶ˆæ¯ä¿æŒåŸæ ·
2. âœ… **åŒæ ¼å¼ç¼“å­˜** - åŒæ—¶ä¿å­˜ base64 å’Œ OCR æ–‡æœ¬
3. âœ… **å‰ç«¯é€‚é…** - æ ¹æ®å½“å‰æ¨¡å‹æ˜¾ç¤ºä¸åŒçš„ UI
4. âœ… **æ™ºèƒ½å¼•ç”¨** - éœ€è¦å†å²ä¸Šä¸‹æ–‡æ—¶ä½¿ç”¨åˆé€‚çš„æ ¼å¼

**æ•°æ®å­˜å‚¨ç»“æ„**:
```python
SessionAttachment:
    - file: åŸå§‹æ–‡ä»¶ï¼ˆæ°¸è¿œä¿ç•™ï¼‰
    - base64_data: base64 ç¼–ç ï¼ˆvision æ¨¡å¼ï¼‰
    - parsed_text: OCR/è§£ææ–‡æœ¬ï¼ˆé™çº§æ¨¡å¼ï¼‰
    - sent_as_format: è®°å½•å®é™…å‘é€æ ¼å¼
    - model_id: å‘é€æ—¶ä½¿ç”¨çš„æ¨¡å‹
```

**åˆ‡æ¢é€»è¾‘**:
```python
def handle_model_switch(session_id, old_model, new_model):
    """å¤„ç†æ¨¡å‹åˆ‡æ¢"""
    
    # 1. æ£€æŸ¥èƒ½åŠ›å·®å¼‚
    old_caps = ModelCapabilities.get(old_model)
    new_caps = ModelCapabilities.get(new_model)
    
    # 2. å†å²æ¶ˆæ¯å¤„ç†
    history_messages = get_history(session_id)
    for msg in history_messages:
        if msg.has_attachments:
            for att in msg.attachments:
                # å‰ç«¯æ˜¾ç¤ºé€»è¾‘
                if new_caps.supports_vision and att.base64_data:
                    att.display_mode = 'image'  # æ˜¾ç¤ºå›¾ç‰‡
                elif att.parsed_text:
                    att.display_mode = 'text'   # æ˜¾ç¤ºæ–‡æœ¬
                else:
                    att.display_mode = 'placeholder'  # æ˜¾ç¤ºå ä½ç¬¦
    
    # 3. æ–°æ¶ˆæ¯å¤„ç†
    # æ ¹æ®æ–°æ¨¡å‹èƒ½åŠ›è‡ªåŠ¨é€‰æ‹©æ ¼å¼
    return new_caps
```

**å‰ç«¯æ˜¾ç¤ºä¼ªä»£ç **:
```javascript
function renderAttachment(attachment, currentModel) {
    const caps = getModelCapabilities(currentModel);
    
    if (caps.supports_vision && attachment.base64_data) {
        // æ˜¾ç¤ºå›¾ç‰‡
        return `<img src="data:image/png;base64,${attachment.base64_data}">`;
    } else if (attachment.parsed_text) {
        // æ˜¾ç¤ºæ–‡æœ¬æ‘˜è¦
        return `
            <div class="attachment-fallback">
                <i class="fas fa-image"></i>
                <span>[å›¾ç‰‡å·²è½¬æ¢ä¸ºæ–‡å­—]</span>
                <details>
                    <summary>æŸ¥çœ‹è¯†åˆ«å†…å®¹</summary>
                    <pre>${attachment.parsed_text}</pre>
                </details>
            </div>
        `;
    } else {
        // æ˜¾ç¤ºå ä½ç¬¦
        return `
            <div class="attachment-placeholder">
                <i class="fas fa-file-image"></i>
                <a href="${attachment.file_url}" target="_blank">
                    ${attachment.filename}
                </a>
                <span class="text-muted">(ç‚¹å‡»æŸ¥çœ‹)</span>
            </div>
        `;
    }
}
```

---

### 9.2 å›æ»šæ“ä½œä¸­çš„é™„ä»¶å¤„ç†

#### 9.2.1 é—®é¢˜åœºæ™¯

ç”¨æˆ·æ‰§è¡Œå›æ»šæ“ä½œï¼ˆåˆ é™¤æ¶ˆæ¯ç´¢å¼• N åŠä¹‹åçš„æ¶ˆæ¯ï¼‰ï¼Œéœ€è¦å†³å®šï¼š
- æ˜¯å¦åˆ é™¤ç›¸å…³é™„ä»¶ï¼Ÿ
- å¦‚ä½•æç¤ºç”¨æˆ·ï¼Ÿ
- æ˜¯å¦æ”¯æŒæ¢å¤ï¼Ÿ

#### 9.2.2 ä¸šç•Œæ–¹æ¡ˆ

**ChatGPT çš„åšæ³•**:
```
- æ¶ˆæ¯åˆ é™¤ï¼Œä½†é™„ä»¶æ–‡ä»¶ä¿ç•™ 30 å¤©
- å‰ç«¯ä¸å†æ˜¾ç¤ºï¼Œä½†åå°å¯æ¢å¤
- ç”¨äºå®¡è®¡å’Œç”¨æˆ·åæ‚”
```

**Cursor çš„åšæ³•**:
```
- æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼š
  "æ­¤æ“ä½œå°†åˆ é™¤ 2 ä¸ªé™„ä»¶ï¼š
   - report.pdf (2.3 MB)
   - screenshot.png (450 KB)
   ç»§ç»­ï¼Ÿ"
- ç¡®è®¤åç«‹å³åˆ é™¤æ–‡ä»¶
- ä¸å¯æ¢å¤
```

**Notion AI çš„åšæ³•**:
```
- é™„ä»¶ä¸åˆ é™¤ï¼Œä½†ä»å½“å‰ä¸Šä¸‹æ–‡ç§»é™¤
- å¯åœ¨"é™„ä»¶åº“"ä¸­æŸ¥çœ‹æ‰€æœ‰å†å²é™„ä»¶
- æ”¯æŒé‡æ–°å¼•ç”¨
```

#### 9.2.3 æ¨èæ–¹æ¡ˆ

**æ ¸å¿ƒåŸåˆ™**:
1. âœ… **æ˜ç¡®æç¤º** - å‘ŠçŸ¥ç”¨æˆ·å°†åˆ é™¤å“ªäº›é™„ä»¶
2. âœ… **è½¯åˆ é™¤** - 7å¤©ç¼“å†²æœŸï¼Œæ”¯æŒæ¢å¤
3. âœ… **å…³è”è¿½è¸ª** - è®°å½•é™„ä»¶ä¸æ¶ˆæ¯çš„å…³ç³»
4. âœ… **æ‰¹é‡æ“ä½œ** - å›æ»šæ—¶ä¸€æ¬¡æ€§å¤„ç†

**ç¡®è®¤å¯¹è¯æ¡†è®¾è®¡**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸ å›æ»šç¡®è®¤                            â”‚
â”‚                                        â”‚
â”‚  æ­¤æ“ä½œå°†å›æ»šåˆ°æ¶ˆæ¯ #5ï¼Œå¹¶åˆ é™¤å…¶åçš„   â”‚
â”‚  3 æ¡æ¶ˆæ¯å’Œä»¥ä¸‹é™„ä»¶ï¼š                  â”‚
â”‚                                        â”‚
â”‚  ğŸ“„ ä¼šè®®çºªè¦.pdf (2.3 MB)             â”‚
â”‚     â””â”€ æ¶ˆæ¯ #6                         â”‚
â”‚  ğŸ“Š æ•°æ®è¡¨æ ¼.xlsx (1.8 MB)            â”‚
â”‚     â””â”€ æ¶ˆæ¯ #7                         â”‚
â”‚  ğŸ–¼ï¸ æˆªå›¾.png (450 KB)                â”‚
â”‚     â””â”€ æ¶ˆæ¯ #8                         â”‚
â”‚                                        â”‚
â”‚  âš ï¸ é™„ä»¶å°†åœ¨ 7 å¤©åæ°¸ä¹…åˆ é™¤           â”‚
â”‚  ï¼ˆæœŸé—´å¯é€šè¿‡é™„ä»¶åº“æ¢å¤ï¼‰              â”‚
â”‚                                        â”‚
â”‚  [å–æ¶ˆ]  [ç¡®è®¤å›æ»š]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®æ¨¡å‹æ‰©å±•**:
```python
class SessionAttachment(models.Model):
    # ... ç°æœ‰å­—æ®µ ...
    
    # è½¯åˆ é™¤ç›¸å…³
    is_deleted = BooleanField(default=False)
    deleted_at = DateTimeField(null=True)
    deleted_with_message_index = IntegerField(null=True)
    deleted_reason = CharField(max_length=50, null=True)  # 'rollback', 'manual', 'expired'
    
    @property
    def can_restore(self):
        """æ˜¯å¦å¯ä»¥æ¢å¤ï¼ˆ7å¤©å†…ï¼‰"""
        if not self.is_deleted:
            return False
        grace_period = timedelta(days=7)
        return timezone.now() - self.deleted_at < grace_period
```

**å›æ»šæµç¨‹**:
```python
def rollback_with_attachments(session_id, message_index):
    """å›æ»šæ¶ˆæ¯å¹¶å¤„ç†é™„ä»¶"""
    
    # 1. æŸ¥æ‰¾å—å½±å“çš„é™„ä»¶
    affected_attachments = SessionAttachment.objects.filter(
        session_id=session_id,
        message_index__gte=message_index,
        is_deleted=False
    )
    
    # 2. ç”Ÿæˆæç¤ºä¿¡æ¯
    attachment_info = []
    for att in affected_attachments:
        attachment_info.append({
            'filename': att.filename,
            'size': att.file_size,
            'message_index': att.message_index,
            'type': att.type
        })
    
    # 3. è¿”å›ç¡®è®¤ä¿¡æ¯ï¼ˆå‰ç«¯æ˜¾ç¤ºå¯¹è¯æ¡†ï¼‰
    return {
        'requires_confirmation': True,
        'affected_messages': count_messages_after(message_index),
        'affected_attachments': attachment_info,
        'total_size': sum(a['size'] for a in attachment_info)
    }

def confirm_rollback(session_id, message_index):
    """ç”¨æˆ·ç¡®è®¤åæ‰§è¡Œå›æ»š"""
    
    # 1. è½¯åˆ é™¤é™„ä»¶
    affected = SessionAttachment.objects.filter(
        session_id=session_id,
        message_index__gte=message_index,
        is_deleted=False
    )
    
    for att in affected:
        att.is_deleted = True
        att.deleted_at = timezone.now()
        att.deleted_with_message_index = message_index
        att.deleted_reason = 'rollback'
        att.save()
    
    # 2. æ‰§è¡Œæ¶ˆæ¯å›æ»šï¼ˆç°æœ‰é€»è¾‘ï¼‰
    rollback_messages(session_id, message_index)
    
    # 3. è¿”å›ç»“æœ
    return {
        'success': True,
        'rolled_back_messages': count,
        'soft_deleted_attachments': affected.count()
    }
```

**æ¢å¤æœºåˆ¶**:
```python
# API: POST /api/agent/attachments/restore/
def restore_attachments(session_id, attachment_ids):
    """æ¢å¤è¢«è½¯åˆ é™¤çš„é™„ä»¶"""
    
    attachments = SessionAttachment.objects.filter(
        id__in=attachment_ids,
        session_id=session_id,
        is_deleted=True
    )
    
    restored = []
    for att in attachments:
        if att.can_restore:
            att.is_deleted = False
            att.deleted_at = None
            att.deleted_with_message_index = None
            att.save()
            restored.append(att.id)
    
    return {'restored_count': len(restored)}
```

**å®šæœŸæ¸…ç†ä»»åŠ¡**:
```python
@periodic_task(run_every=crontab(hour=3, minute=0))
def cleanup_soft_deleted_attachments():
    """æ¸…ç†è¶…è¿‡ 7 å¤©çš„è½¯åˆ é™¤é™„ä»¶"""
    
    grace_period = timezone.now() - timedelta(days=7)
    
    expired = SessionAttachment.objects.filter(
        is_deleted=True,
        deleted_at__lt=grace_period
    )
    
    for att in expired:
        # ç‰©ç†åˆ é™¤æ–‡ä»¶
        if att.file:
            att.file.delete()
        if att.thumbnail_url:
            delete_thumbnail(att.thumbnail_url)
        
        # åˆ é™¤æ•°æ®åº“è®°å½•
        att.delete()
    
    logger.info(f"æ¸…ç†äº† {expired.count()} ä¸ªè¿‡æœŸé™„ä»¶")
```

---

## 10. API è®¾è®¡

### 10.1 æ–‡ä»¶ä¸Šä¼  API

#### POST /api/agent/attachments/upload/

**åŠŸèƒ½**: ä¸Šä¼ æ–‡ä»¶é™„ä»¶

**è¯·æ±‚**:
```http
POST /api/agent/attachments/upload/
Content-Type: multipart/form-data

FormData:
  - file: (binary)
  - session_id: "user_1_abc123"
```

**å“åº”**:
```json
{
    "success": true,
    "attachment_id": 42,
    "filename": "report.pdf",
    "type": "pdf",
    "file_size": 2457600,
    "thumbnail_url": "/media/attachments/2026/02/10/thumb_a1b2c3d4.jpg",
    "parsed_preview": "æ–‡æ¡£å¼€å¤´å†…å®¹...",
    "metadata": {
        "pages": 15,
        "has_tables": true
    }
}
```

**é”™è¯¯å“åº”**:
```json
{
    "success": false,
    "error": "æ–‡ä»¶è¿‡å¤§ï¼Œæœ€å¤§æ”¯æŒ 20 MB"
}
```

---

### 10.2 å†…éƒ¨å…ƒç´ é™„åŠ  API

#### POST /api/agent/attachments/attach-internal/

**åŠŸèƒ½**: å°†å†…éƒ¨å…ƒç´ ï¼ˆevent/todo/reminderï¼‰æ·»åŠ ä¸ºé™„ä»¶

**è¯·æ±‚**:
```json
{
    "session_id": "user_1_abc123",
    "element_type": "event",   // event, todo, reminder, workflow
    "element_id": 123
}
```

**å“åº”**:
```json
{
    "success": true,
    "attachment_id": 43,
    "element_type": "event",
    "element_id": 123,
    "preview": "### ğŸ“… å›¢é˜Ÿä¼šè®®\n- **æ—¶é—´**: 2026-02-15 14:00 ~ 15:00\n...",
    "snapshot": {
        "id": 123,
        "title": "å›¢é˜Ÿä¼šè®®",
        "start": "2026-02-15T14:00:00Z",
        ...
    }
}
```

---

### 10.3 æ ¼å¼åŒ–é™„ä»¶ API (æ‰©å±•ç°æœ‰)

#### POST /api/agent/attachments/format/

**åŠŸèƒ½**: æ ¼å¼åŒ–é™„ä»¶å†…å®¹ç”¨äºå‘é€åˆ° Agent

**è¯·æ±‚**:
```json
{
    "attachment_ids": [42, 43, 44]
}
```

**å“åº”**:
```json
{
    "success": true,
    "formatted_content": "ã€é™„ä»¶ï¼šreport.pdfã€‘\nç±»å‹ï¼šPDFï¼ˆå·²è½¬æ¢ä¸ºæ–‡å­—ï¼‰\n\nç¬¬ä¸€é¡µå†…å®¹...\n\n### ğŸ“… å›¢é˜Ÿä¼šè®®\n- **æ—¶é—´**: ...",
    "attachments_metadata": [
        {
            "id": 42,
            "type": "pdf",
            "filename": "report.pdf",
            "format": "text",
            "sent_with_model": "system_deepseek"
        },
        {
            "id": 43,
            "type": "event",
            "element_id": 123,
            "format": "markdown"
        }
    ],
    "count": 2
}
```

---

### 10.4 åˆ—å‡ºå¯é™„åŠ é¡¹ API (æ‰©å±•ç°æœ‰)

#### GET /api/agent/attachments/

**åŠŸèƒ½**: è·å–å¯ç”¨äºé™„ä»¶çš„èµ„æºåˆ—è¡¨

**è¯·æ±‚**:
```http
GET /api/agent/attachments/?type=event&session_id=user_1_abc123
```

**å“åº”**:
```json
{
    "items": [
        {
            "type": "event",
            "id": 123,
            "name": "å›¢é˜Ÿä¼šè®®",
            "preview": "2026-02-15 14:00",
            "metadata": {
                "start": "2026-02-15T14:00:00Z",
                "end": "2026-02-15T15:00:00Z"
            }
        },
        ...
    ],
    "types": ["workflow", "file", "event", "todo", "reminder"]
}
```

---

### 10.5 é¢„è§ˆé™„ä»¶ API

#### GET /api/agent/attachments/preview/{id}/

**åŠŸèƒ½**: é¢„è§ˆé™„ä»¶å†…å®¹ï¼ˆå‰ç«¯é¢„è§ˆç”¨ï¼‰

**å“åº”**:
```json
{
    "id": 42,
    "filename": "report.pdf",
    "type": "pdf",
    "thumbnail_url": "/media/attachments/.../thumb.jpg",
    "preview_text": "æ–‡æ¡£å‰ 500 å­—ç¬¦...",
    "metadata": {
        "pages": 15,
        "file_size": 2457600
    }
}
```

---

### 10.6 åˆ é™¤é™„ä»¶ API

#### DELETE /api/agent/attachments/{id}/

**åŠŸèƒ½**: åˆ é™¤é™„ä»¶ï¼ˆè½¯åˆ é™¤ï¼‰

**å“åº”**:
```json
{
    "success": true,
    "message": "é™„ä»¶å·²æ ‡è®°ä¸ºåˆ é™¤ï¼Œ7å¤©åå°†æ°¸ä¹…åˆ é™¤"
}
```

---

### 10.7 æ¢å¤é™„ä»¶ API

#### POST /api/agent/attachments/restore/

**åŠŸèƒ½**: æ¢å¤è½¯åˆ é™¤çš„é™„ä»¶

**è¯·æ±‚**:
```json
{
    "session_id": "user_1_abc123",
    "attachment_ids": [42, 43]
}
```

**å“åº”**:
```json
{
    "success": true,
    "restored_count": 2,
    "failed": []
}
```

---

### 10.8 å›æ»šç¡®è®¤ API (æ‰©å±•ç°æœ‰)

#### GET /api/agent/rollback/preview/?session_id=xxx&message_index=10

**åŠŸèƒ½**: é¢„è§ˆå›æ»šå½±å“çš„é™„ä»¶

**å“åº”**:
```json
{
    "affected_messages": 5,
    "affected_attachments": [
        {
            "id": 42,
            "filename": "report.pdf",
            "file_size": 2457600,
            "message_index": 12
        },
        {
            "id": 43,
            "element_type": "event",
            "name": "å›¢é˜Ÿä¼šè®®",
            "message_index": 14
        }
    ],
    "total_size": 3840000
}
```

---

### 10.9 æ¨¡å‹èƒ½åŠ›æŸ¥è¯¢ API

#### GET /api/agent/model-capabilities/

**åŠŸèƒ½**: æŸ¥è¯¢å½“å‰æ¨¡å‹èƒ½åŠ›

**å“åº”**:
```json
{
    "model_id": "system_deepseek",
    "model_name": "deepseek-chat",
    "supports_vision": false,
    "supports_multimodal": false,
    "supports_tools": true,
    "context_window": 131072
}
```

---

## 11. å®ç°è·¯çº¿å›¾

### 11.1 Phase 1 - MVP æ ¸å¿ƒåŠŸèƒ½ï¼ˆ1-2 å‘¨ï¼‰

#### ç›®æ ‡
- âœ… åŸºç¡€é™„ä»¶ä¸Šä¼ å’Œç®¡ç†
- âœ… å†…éƒ¨å…ƒç´ é™„ä»¶æ”¯æŒ
- âœ… å›¾ç‰‡ OCR é™çº§æ–¹æ¡ˆ
- âœ… ä¼šè¯çº§å­˜å‚¨

#### ä»»åŠ¡æ¸…å•

**åç«¯ - æ•°æ®å±‚**:
- [ ] 1.1 åˆ›å»º SessionAttachment æ¨¡å‹
  - [ ] åœ¨ `agent_service/models.py` ä¸­æ·»åŠ æ¨¡å‹å®šä¹‰
  - [ ] ç§»é™¤ä¸å­˜åœ¨çš„ `AttachmentFile` å¯¼å…¥
  - [ ] è¿è¡Œ `python manage.py makemigrations agent_service`
  - [ ] è¿è¡Œ `python manage.py migrate agent_service`
  - [ ] é…ç½® `settings.py` çš„ MEDIA è®¾ç½®

**åç«¯ - è§£æå™¨**:
- [ ] 1.2 åˆ›å»ºè§£æå™¨ç³»ç»Ÿ
  - [ ] `agent_service/parsers/base.py` - åŸºç±»
  - [ ] `agent_service/parsers/image_parser.py` - å›¾ç‰‡è§£æï¼ˆOCRï¼‰
  - [ ] `agent_service/parsers/internal_parser.py` - å†…éƒ¨å…ƒç´ è§£æ
  - [ ] `agent_service/parsers/__init__.py` - å·¥å‚ç±»

**åç«¯ - ä¸šåŠ¡é€»è¾‘**:
- [ ] 1.3 åˆ›å»º AttachmentHandler
  - [ ] `agent_service/attachment_handler.py`
  - [ ] å®ç°æ–‡ä»¶ä¸Šä¼ å¤„ç†
  - [ ] å®ç°å†…éƒ¨å…ƒç´ é™„åŠ 
  - [ ] å®ç°æ ¼å¼åŒ–é€»è¾‘

**åç«¯ - API**:
- [ ] 1.4 åˆ›å»º API ç«¯ç‚¹
  - [ ] `POST /api/agent/attachments/upload/` - æ–‡ä»¶ä¸Šä¼ 
  - [ ] `POST /api/agent/attachments/attach-internal/` - å†…éƒ¨å…ƒç´ é™„åŠ 
  - [ ] æ‰©å±• `POST /api/agent/attachments/format/` - æ”¯æŒæ–°ç±»å‹
  - [ ] æ‰©å±• `GET /api/agent/attachments/` - è¿”å›å¤šç§ç±»å‹

**å‰ç«¯ - UI**:
- [ ] 1.5 æ‰©å±•å‰ç«¯é™„ä»¶ç³»ç»Ÿ
  - [ ] æ‰©å±• `selectedAttachments` æ”¯æŒå¤šç§ç±»å‹
  - [ ] æ·»åŠ æ–‡ä»¶ä¸Šä¼ æŒ‰é’®å’Œå¤„ç†é€»è¾‘
  - [ ] å®ç° `uploadFile()` æ–¹æ³•
  - [ ] æ›´æ–°é™„ä»¶é¢„è§ˆ UI

**æµ‹è¯•**:
- [ ] 1.6 åŸºç¡€æµ‹è¯•
  - [ ] æµ‹è¯•å›¾ç‰‡ä¸Šä¼ å’Œ OCR
  - [ ] æµ‹è¯•å†…éƒ¨å…ƒç´ é™„åŠ 
  - [ ] æµ‹è¯•é™„ä»¶æ ¼å¼åŒ–
  - [ ] æµ‹è¯•é™„ä»¶åœ¨æ¶ˆæ¯ä¸­çš„æ˜¾ç¤º

---

### 11.2 Phase 2 - æ–‡æ¡£æ”¯æŒï¼ˆ1 å‘¨ï¼‰

#### ç›®æ ‡
- âœ… PDF æ–‡æ¡£è§£æ
- âœ… Word/Excel æ–‡æ¡£è§£æ
- âœ… æ–‡æ¡£é¢„è§ˆåŠŸèƒ½

#### ä»»åŠ¡æ¸…å•

**åç«¯ - è§£æå™¨æ‰©å±•**:
- [ ] 2.1 æ–‡æ¡£è§£æå™¨
  - [ ] `agent_service/parsers/document_parser.py` - PDF/Word/Excel
  - [ ] å®‰è£…ä¾èµ–ï¼š`pdfplumber`, `python-docx`, `openpyxl`
  - [ ] æ›´æ–° `requirements.txt`

**åç«¯ - API**:
- [ ] 2.2 é¢„è§ˆ API
  - [ ] `GET /api/agent/attachments/preview/{id}/` - é™„ä»¶é¢„è§ˆ

**å‰ç«¯ - é¢„è§ˆç»„ä»¶**:
- [ ] 2.3 æ–‡æ¡£é¢„è§ˆ UI
  - [ ] PDF é¢„è§ˆç»„ä»¶
  - [ ] æ–‡æ¡£ä¿¡æ¯å±•ç¤º
  - [ ] ä¸‹è½½åŠŸèƒ½

**æµ‹è¯•**:
- [ ] 2.4 æ–‡æ¡£è§£ææµ‹è¯•
  - [ ] æµ‹è¯• PDF æ–‡å­—æå–
  - [ ] æµ‹è¯• Word/Excel è§£æ
  - [ ] æµ‹è¯•è¡¨æ ¼è½¬ Markdown

---

### 11.3 Phase 3 - å¤šæ¨¡æ€é€‚é…ï¼ˆ1 å‘¨ï¼‰

#### ç›®æ ‡
- âœ… Vision æ¨¡å‹æ”¯æŒ
- âœ… Base64 å›¾ç‰‡ç¼–ç 
- âœ… è‡ªåŠ¨é™çº§ç­–ç•¥
- âœ… æ¨¡å‹åˆ‡æ¢é€‚é…

#### ä»»åŠ¡æ¸…å•

**åç«¯ - èƒ½åŠ›æ£€æµ‹**:
- [ ] 3.1 æ¨¡å‹èƒ½åŠ›ç³»ç»Ÿ
  - [ ] `agent_service/model_capabilities.py` - èƒ½åŠ›æ£€æµ‹ç±»
  - [ ] è¯»å– `config/api_keys.json` çš„ `supports_vision` å­—æ®µ
  - [ ] ä» `UserData.agent_config` è·å–å½“å‰æ¨¡å‹

**åç«¯ - å¤šæ¨¡æ€å¤„ç†**:
- [ ] 3.2 Base64 ç¼–ç 
  - [ ] åœ¨ ImageParser ä¸­ç”Ÿæˆ base64
  - [ ] SessionAttachment å­˜å‚¨ base64
  - [ ] å®ç°å›¾ç‰‡å‹ç¼©ä¼˜åŒ–

**åç«¯ - é™çº§é€»è¾‘**:
- [ ] 3.3 è‡ªåŠ¨é™çº§
  - [ ] AttachmentHandler æ ¹æ®æ¨¡å‹èƒ½åŠ›é€‰æ‹©æ ¼å¼
  - [ ] å®ç°åŒæ ¼å¼è¿”å›ï¼ˆbase64 + textï¼‰

**åç«¯ - Agent é›†æˆ**:
- [ ] 3.4 ä¿®æ”¹ agent_graph.py
  - [ ] æ”¯æŒ ImageURL ç±»å‹çš„æ¶ˆæ¯
  - [ ] å¤„ç† base64 å›¾ç‰‡å‘é€

**å‰ç«¯ - èƒ½åŠ›é€‚é…**:
- [ ] 3.5 å‰ç«¯èƒ½åŠ›æ£€æµ‹
  - [ ] æŸ¥è¯¢å½“å‰æ¨¡å‹èƒ½åŠ›
  - [ ] æ ¹æ®èƒ½åŠ›è°ƒæ•´é™„ä»¶æ˜¾ç¤º
  - [ ] å®ç°æ¨¡å‹åˆ‡æ¢åçš„ UI æ›´æ–°

**æµ‹è¯•**:
- [ ] 3.6 å¤šæ¨¡æ€æµ‹è¯•
  - [ ] æµ‹è¯• Vision æ¨¡å‹å›¾ç‰‡ç†è§£
  - [ ] æµ‹è¯•é Vision æ¨¡å‹é™çº§
  - [ ] æµ‹è¯•æ¨¡å‹åˆ‡æ¢åœºæ™¯

---

### 11.4 Phase 4 - ç”¨æˆ·ä½“éªŒä¼˜åŒ–ï¼ˆ1 å‘¨ï¼‰

#### ç›®æ ‡
- âœ… æ‹–æ‹½ä¸Šä¼ 
- âœ… æ‹–æ‹½å†…éƒ¨å…ƒç´ 
- âœ… æ‰¹é‡æ“ä½œ
- âœ… è¿›åº¦åé¦ˆ

#### ä»»åŠ¡æ¸…å•

**å‰ç«¯ - æ‹–æ‹½äº¤äº’**:
- [ ] 4.1 æ–‡ä»¶æ‹–æ‹½ä¸Šä¼ 
  - [ ] å®ç° Drop Zone
  - [ ] æ‹–æ‹½é¢„è§ˆæ•ˆæœ
  - [ ] ä¸Šä¼ è¿›åº¦æ¡

**å‰ç«¯ - å†…éƒ¨å…ƒç´ æ‹–æ‹½**:
- [ ] 4.2 å…ƒç´ æ‹–æ‹½
  - [ ] æ—¥å†äº‹ä»¶å¯æ‹–æ‹½
  - [ ] å¾…åŠäº‹é¡¹å¯æ‹–æ‹½
  - [ ] Agent ä¾§è¾¹æ æ¥æ”¶æ‹–æ‹½

**å‰ç«¯ - æ‰¹é‡æ“ä½œ**:
- [ ] 4.3 æ‰¹é‡ç®¡ç†
  - [ ] æ‰¹é‡åˆ é™¤é™„ä»¶
  - [ ] æ‰¹é‡ä¸‹è½½é™„ä»¶
  - [ ] æ‰¹é‡æ¢å¤é™„ä»¶

**å‰ç«¯ - ä½“éªŒä¼˜åŒ–**:
- [ ] 4.4 ç»†èŠ‚ä¼˜åŒ–
  - [ ] åŠ è½½çŠ¶æ€æç¤º
  - [ ] é”™è¯¯æç¤ºå‹å¥½åŒ–
  - [ ] é™„ä»¶é¢„è§ˆä¼˜åŒ–

---

### 11.5 Phase 5 - å›æ»šå¢å¼ºï¼ˆ3 å¤©ï¼‰

#### ç›®æ ‡
- âœ… å›æ»šé¢„è§ˆ
- âœ… è½¯åˆ é™¤æœºåˆ¶
- âœ… æ¢å¤åŠŸèƒ½
- âœ… è‡ªåŠ¨æ¸…ç†

#### ä»»åŠ¡æ¸…å•

**åç«¯ - å›æ»šå¤„ç†**:
- [ ] 5.1 å›æ»šé¢„è§ˆ API
  - [ ] `GET /api/agent/rollback/preview/` - é¢„è§ˆå½±å“
  - [ ] æŸ¥è¯¢å—å½±å“çš„é™„ä»¶åˆ—è¡¨

**åç«¯ - è½¯åˆ é™¤**:
- [ ] 5.2 è½¯åˆ é™¤é€»è¾‘
  - [ ] æ‰©å±• `views_rollback.py` è°ƒç”¨é™„ä»¶è½¯åˆ é™¤
  - [ ] å®ç° `SessionAttachment.soft_delete()`

**åç«¯ - æ¢å¤åŠŸèƒ½**:
- [ ] 5.3 æ¢å¤ API
  - [ ] `POST /api/agent/attachments/restore/` - æ¢å¤é™„ä»¶
  - [ ] å‰ç«¯"é™„ä»¶åº“"åŠŸèƒ½

**åç«¯ - è‡ªåŠ¨æ¸…ç†**:
- [ ] 5.4 æ¸…ç†ä»»åŠ¡
  - [ ] `agent_service/management/commands/cleanup_attachments.py`
  - [ ] é…ç½® Celery Beat æˆ– crontab
  - [ ] å®ç°å­¤å„¿æ–‡ä»¶æ¸…ç†

**å‰ç«¯ - å›æ»šç¡®è®¤**:
- [ ] 5.5 ç¡®è®¤å¯¹è¯æ¡†
  - [ ] æ˜¾ç¤ºå—å½±å“çš„é™„ä»¶åˆ—è¡¨
  - [ ] æ˜¾ç¤ºæ–‡ä»¶å¤§å°ç»Ÿè®¡
  - [ ] ç”¨æˆ·ç¡®è®¤åæ‰§è¡Œå›æ»š

---

### 11.2 ä¾èµ–å…³ç³»

```mermaid
graph TD
    Phase1[Phase 1: MVP æ ¸å¿ƒåŠŸèƒ½] --> Phase2[Phase 2: æ–‡æ¡£æ”¯æŒ]
    Phase1 --> Phase3[Phase 3: å¤šæ¨¡æ€é€‚é…]
    Phase2 --> Phase4[Phase 4: UX ä¼˜åŒ–]
    Phase3 --> Phase4
    Phase1 --> Phase5[Phase 5: å›æ»šå¢å¼º]
    
    Phase1:::critical
    Phase3:::critical
    Phase5:::critical
    
    classDef critical fill:#ff9999
```

**å…³é”®è·¯å¾„**: Phase 1 â†’ Phase 3 â†’ Phase 5

**å¯å¹¶è¡Œ**: Phase 2 å’Œ Phase 3 å¯ä»¥å¹¶è¡Œå¼€å‘

---

### 11.3 é£é™©è¯„ä¼°

| é£é™©é¡¹ | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|-------|------|------|---------|
| OCR åº“æ€§èƒ½é—®é¢˜ | é«˜ | ä¸­ | ä½¿ç”¨å¼‚æ­¥ä»»åŠ¡å¤„ç†ï¼Œæä¾›é™çº§æ–¹æ¡ˆ |
| Base64 æ•°æ®è¿‡å¤§ | ä¸­ | é«˜ | å›¾ç‰‡å‹ç¼©ï¼Œé™åˆ¶åˆ†è¾¨ç‡ |
| æ–‡ä»¶å­˜å‚¨ç©ºé—´ä¸è¶³ | é«˜ | ä½ | å®æ–½è‡ªåŠ¨æ¸…ç†ï¼Œè®¾ç½®é…é¢ |
| è¿ç§»å¤±è´¥ | é«˜ | ä½ | å¤‡ä»½æ•°æ®åº“ï¼Œåˆ†æ­¥è¿ç§» |
| å‰ç«¯æ‹–æ‹½å…¼å®¹æ€§ | ä½ | ä¸­ | æä¾›ä¼ ç»Ÿä¸Šä¼ æ–¹å¼ |

---

### 11.4 ä¾èµ–å®‰è£…

```bash
# requirements.txt æ–°å¢ä¾èµ–

# å›¾ç‰‡å¤„ç†å’Œ OCR
Pillow==10.1.0
easyocr==1.7.0  # å¯é€‰ï¼Œç”¨äº OCR

# æ–‡æ¡£è§£æ
pdfplumber==0.10.3
python-docx==1.1.0
openpyxl==3.1.2

# å·²æœ‰ä¾èµ–ï¼ˆç¡®ä¿ç‰ˆæœ¬ï¼‰
Django==5.1.8
djangorestframework==3.14.0
```

å®‰è£…å‘½ä»¤ï¼š
```bash
pip install -r requirements.txt
```

---

### 11.5 éªŒæ”¶æ ‡å‡†

#### Phase 1 MVP
- [ ] âœ… ç”¨æˆ·å¯ä»¥ä¸Šä¼ å›¾ç‰‡é™„ä»¶
- [ ] âœ… å›¾ç‰‡å¯ä»¥è¢« OCR è¯†åˆ«æ–‡å­—
- [ ] âœ… ç”¨æˆ·å¯ä»¥å°† event/todo/reminder ä½œä¸ºé™„ä»¶å‘é€
- [ ] âœ… é™„ä»¶åœ¨æ¶ˆæ¯ä¸­æ­£ç¡®æ˜¾ç¤º
- [ ] âœ… é™„ä»¶æ•°æ®æ­£ç¡®å­˜å‚¨åˆ°æ•°æ®åº“

#### Phase 2 æ–‡æ¡£
- [ ] âœ… ç”¨æˆ·å¯ä»¥ä¸Šä¼  PDF/Word/Excel
- [ ] âœ… æ–‡æ¡£å†…å®¹è¢«æ­£ç¡®æå–
- [ ] âœ… è¡¨æ ¼è½¬æ¢ä¸º Markdown æ ¼å¼
- [ ] âœ… å‰ç«¯å¯ä»¥é¢„è§ˆæ–‡æ¡£ä¿¡æ¯

#### Phase 3 å¤šæ¨¡æ€
- [ ] âœ… Vision æ¨¡å‹ç›´æ¥ç†è§£å›¾ç‰‡
- [ ] âœ… é Vision æ¨¡å‹è‡ªåŠ¨é™çº§åˆ°æ–‡å­—
- [ ] âœ… åˆ‡æ¢æ¨¡å‹åé™„ä»¶æ˜¾ç¤ºæ­£ç¡®
- [ ] âœ… Base64 å›¾ç‰‡æ­£ç¡®å‘é€åˆ° LLM

#### Phase 4 ç”¨æˆ·ä½“éªŒ
- [ ] âœ… æ‹–æ‹½æ–‡ä»¶å¯ä»¥ä¸Šä¼ 
- [ ] âœ… ä»æ—¥å†æ‹–æ‹½ event åˆ° Agent
- [ ] âœ… ä¸Šä¼ æ˜¾ç¤ºè¿›åº¦æ¡
- [ ] âœ… é”™è¯¯æç¤ºæ¸…æ™°å‹å¥½

#### Phase 5 å›æ»š
- [ ] âœ… å›æ»šå‰æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
- [ ] âœ… åˆ—å‡ºå—å½±å“çš„é™„ä»¶
- [ ] âœ… è½¯åˆ é™¤çš„é™„ä»¶å¯ä»¥æ¢å¤
- [ ] âœ… 7å¤©åè‡ªåŠ¨ç‰©ç†åˆ é™¤

---

**æ–‡æ¡£çŠ¶æ€**: 
- âœ… å¤§çº²å·²åˆ›å»º
- âœ… è¾¹ç¼˜æƒ…å†µå¤„ç†å·²å®Œå–„
- âœ… ç¬¬ 3 èŠ‚ - æ¶æ„è®¾è®¡å·²å®Œå–„
- âœ… ç¬¬ 4 èŠ‚ - æ•°æ®æ¨¡å‹å·²å®Œå–„
- âœ… ç¬¬ 5 èŠ‚ - è§£æå™¨ç³»ç»Ÿå·²å®Œå–„
- âœ… ç¬¬ 6 èŠ‚ - å¤šæ¨¡æ€é€‚é…å·²å®Œå–„
- âœ… ç¬¬ 7 èŠ‚ - å‰ç«¯äº¤äº’å·²å®Œå–„
- âœ… ç¬¬ 8 èŠ‚ - æ–‡ä»¶å­˜å‚¨å·²å®Œå–„
- âœ… ç¬¬ 9 èŠ‚ - è¾¹ç¼˜æƒ…å†µå¤„ç†å·²å®Œå–„
- âœ… ç¬¬ 10 èŠ‚ - API è®¾è®¡å·²å®Œå–„
- âœ… ç¬¬ 11 èŠ‚ - å®ç°è·¯çº¿å›¾å·²å®Œå–„

**ä¸‹ä¸€æ­¥**: å¼€å§‹ Phase 1 å®ç°

---

## é™„å½•

### A. æŠ€æœ¯é€‰å‹

*(æ­¤éƒ¨åˆ†å°†åœ¨åç»­å®Œå–„)*

### B. æ€§èƒ½ä¼˜åŒ–

*(æ­¤éƒ¨åˆ†å°†åœ¨åç»­å®Œå–„)*

### C. å®‰å…¨è€ƒè™‘

*(æ­¤éƒ¨åˆ†å°†åœ¨åç»­å®Œå–„)*

## é™„å½•

### A. æŠ€æœ¯é€‰å‹

#### A.1 OCR å¼•æ“é€‰æ‹©

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåº¦ |
|------|------|------|--------|
| **EasyOCR** | â€¢ æ”¯æŒä¸­è‹±æ–‡<br>â€¢ API ç®€å•<br>â€¢ å‡†ç¡®ç‡é«˜ | â€¢ æ¨¡å‹è¾ƒå¤§ï¼ˆ~400MBï¼‰<br>â€¢ é¦–æ¬¡åŠ è½½æ…¢ | â­â­â­â­â­ |
| Tesseract OCR | â€¢ å¼€æºå…è´¹<br>â€¢ æ”¯æŒå¤šè¯­è¨€ | â€¢ ä¸­æ–‡è¯†åˆ«ç‡ä¸€èˆ¬<br>â€¢ é…ç½®å¤æ‚ | â­â­â­ |
| ç™¾åº¦/è…¾è®¯äº‘ OCR | â€¢ å‡†ç¡®ç‡æé«˜<br>â€¢ æ— éœ€æœ¬åœ°æ¨¡å‹ | â€¢ éœ€è¦ä»˜è´¹<br>â€¢ ä¾èµ–å¤–éƒ¨æœåŠ¡ | â­â­â­â­ |

**æ¨è**: ä¼˜å…ˆä½¿ç”¨ **EasyOCR**ï¼Œæä¾›äº‘ç«¯ API ä½œä¸ºå¤‡é€‰ã€‚

#### A.2 æ–‡æ¡£è§£æåº“

| æ–‡ä»¶ç±»å‹ | æ¨èåº“ | ç†ç”± |
|---------|--------|------|
| PDF | **pdfplumber** | æ”¯æŒæ–‡æœ¬å’Œè¡¨æ ¼æå–ï¼ŒAPI å‹å¥½ |
| Word | **python-docx** | å®˜æ–¹æ¨èï¼ŒåŠŸèƒ½å®Œå–„ |
| Excel | **openpyxl** | æ”¯æŒ .xlsx æ ¼å¼ï¼Œæ€§èƒ½å¥½ |

#### A.3 æ–‡ä»¶å­˜å‚¨æ–¹æ¡ˆ

| æ–¹æ¡ˆ | é€‚ç”¨åœºæ™¯ | æˆæœ¬ |
|------|---------|------|
| **æœ¬åœ°å­˜å‚¨ (FileField)** | å°è§„æ¨¡éƒ¨ç½²ï¼Œå•æœåŠ¡å™¨ | æä½ |
| OSS/S3 | å¤§è§„æ¨¡éƒ¨ç½²ï¼Œå¤šæœåŠ¡å™¨ | ä¸­ |
| NAS/ç½‘ç»œå­˜å‚¨ | ä¼ä¸šå†…éƒ¨éƒ¨ç½² | ä¸­ |

**å½“å‰æ¨è**: æœ¬åœ°å­˜å‚¨ï¼Œé…åˆå®šæœŸæ¸…ç†ç­–ç•¥ã€‚

---

### B. æ€§èƒ½ä¼˜åŒ–

#### B.1 ä¸Šä¼ æ€§èƒ½

**ä¼˜åŒ–ç‚¹**:
1. **å¼‚æ­¥ä¸Šä¼ **ï¼šä½¿ç”¨ AJAX å¼‚æ­¥ä¸Šä¼ ï¼Œä¸é˜»å¡ç•Œé¢
2. **åˆ†å—ä¸Šä¼ **ï¼šå¤§æ–‡ä»¶åˆ†å—ä¸Šä¼ ï¼ˆ>10MBï¼‰
3. **è¿›åº¦åé¦ˆ**ï¼šæ˜¾ç¤ºå®æ—¶ä¸Šä¼ è¿›åº¦

**ä»£ç ç¤ºä¾‹**:
```javascript
// åˆ†å—ä¸Šä¼ 
async uploadLargeFile(file) {
    const chunkSize = 2 * 1024 * 1024; // 2MB per chunk
    const chunks = Math.ceil(file.size / chunkSize);
    
    for (let i = 0; i < chunks; i++) {
        const start = i * chunkSize;
        const end = Math.min(start + chunkSize, file.size);
        const chunk = file.slice(start, end);
        
        const formData = new FormData();
        formData.append('chunk', chunk);
        formData.append('chunk_index', i);
        formData.append('total_chunks', chunks);
        formData.append('filename', file.name);
        
        await fetch('/api/agent/attachments/upload-chunk/', {
            method: 'POST',
            body: formData
        });
        
        // æ›´æ–°è¿›åº¦
        this.updateProgress((i + 1) / chunks * 100);
    }
}
```

#### B.2 OCR æ€§èƒ½

**ä¼˜åŒ–ç­–ç•¥**:
1. **å¼‚æ­¥å¤„ç†**ï¼šOCR åœ¨åå°ä»»åŠ¡ä¸­æ‰§è¡Œ
2. **ç¼“å­˜ç»“æœ**ï¼šavoid é‡å¤ OCR åŒä¸€å›¾ç‰‡
3. **é™ä½åˆ†è¾¨ç‡**ï¼šOCR å‰å°†å›¾ç‰‡ç¼©æ”¾åˆ°åˆé€‚å°ºå¯¸ï¼ˆ1024pxï¼‰

**Celery å¼‚æ­¥ä»»åŠ¡**:
```python
# agent_service/tasks.py

from celery import shared_task
from agent_service.models import SessionAttachment
from agent_service.parsers import parser_factory

@shared_task
def process_attachment_async(attachment_id):
    """å¼‚æ­¥å¤„ç†é™„ä»¶ï¼ˆOCRã€æ–‡æ¡£è§£æç­‰ï¼‰"""
    try:
        attachment = SessionAttachment.objects.get(id=attachment_id)
        
        # è·å–è§£æå™¨
        parser = parser_factory.get_parser(
            attachment.file.path,
            attachment.mime_type
        )
        
        if parser:
            result = parser.parse(attachment.file.path)
            
            if result['success']:
                attachment.parsed_text = result['text']
                if 'base64' in result:
                    attachment.base64_data = result['base64']
                attachment.save()
        
        return {"success": True, "attachment_id": attachment_id}
    
    except Exception as e:
        logger.error(f"å¤„ç†é™„ä»¶å¤±è´¥ {attachment_id}: {e}")
        return {"success": False, "error": str(e)}
```

**è°ƒç”¨**:
```python
# views_api.py

def upload_attachment(request):
    # ... ä¿å­˜æ–‡ä»¶åˆ°æ•°æ®åº“ ...
    
    # å¼‚æ­¥å¤„ç†
    process_attachment_async.delay(attachment.id)
    
    # ç«‹å³è¿”å›
    return Response({
        "success": True,
        "attachment_id": attachment.id,
        "status": "processing"  # å‘Šè¯‰å‰ç«¯æ­£åœ¨å¤„ç†
    })
```

#### B.3 æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

**ä¼˜åŒ–ç‚¹**:
1. **select_related**: å‡å°‘ N+1 æŸ¥è¯¢
2. **only**: åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
3. **ç´¢å¼•**: ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•

**ç¤ºä¾‹**:
```python
# ä¼˜åŒ–å‰
attachments = SessionAttachment.objects.filter(session_id=session_id)
for att in attachments:
    print(att.user.username)  # N+1 æŸ¥è¯¢

# ä¼˜åŒ–å
attachments = SessionAttachment.objects.filter(
    session_id=session_id
).select_related('user').only(
    'id', 'filename', 'type', 'created_at', 'user__username'
)
```

#### B.4 Base64 ä¼˜åŒ–

**é—®é¢˜**: Base64 ç¼–ç ä¼šå¢åŠ  33% æ•°æ®é‡

**ä¼˜åŒ–**:
1. **å‹ç¼©å›¾ç‰‡**ï¼šé™ä½è´¨é‡åˆ° 85%ï¼Œç¼©æ”¾åˆ° 1024px
2. **ç¼“å­˜ç­–ç•¥**ï¼šåªåœ¨éœ€è¦æ—¶ç”Ÿæˆ base64
3. **åˆ†ç¦»å­˜å‚¨**ï¼šå¤§å›¾ç‰‡ä¸å­˜ base64ï¼Œå®æ—¶ç”Ÿæˆ

**ä¼˜åŒ–åçš„æ¨¡å‹æ–¹æ³•**:
```python
class SessionAttachment(models.Model):
    # base64_data å­—æ®µæ”¹ä¸ºå¯é€‰ï¼ˆèŠ‚çœç©ºé—´ï¼‰
    base64_data = models.TextField(blank=True, default='')
    
    def get_base64(self, force_regenerate=False):
        """æ‡’åŠ è½½ base64ï¼ˆéœ€è¦æ—¶æ‰ç”Ÿæˆï¼‰"""
        if self.base64_data and not force_regenerate:
            return self.base64_data
        
        if not self.file or not self.type == 'image':
            return ''
        
        # å®æ—¶ç”Ÿæˆ
        from agent_service.parsers.image_parser import ImageParser
        parser = ImageParser()
        result = parser.parse(self.file.path)
        
        if result['success'] and 'base64' in result:
            # ç¼“å­˜åˆ°æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰
            self.base64_data = result['base64']
            self.save(update_fields=['base64_data'])
            return result['base64']
        
        return ''
```

#### B.5 å‰ç«¯æ€§èƒ½

**ä¼˜åŒ–ç‚¹**:
1. **è™šæ‹Ÿæ»šåŠ¨**ï¼šé™„ä»¶åˆ—è¡¨å¾ˆé•¿æ—¶ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨
2. **æ‡’åŠ è½½ç¼©ç•¥å›¾**ï¼šä½¿ç”¨ Intersection Observer
3. **é˜²æŠ–ä¸Šä¼ **ï¼šé¿å…å¿«é€Ÿå¤šæ¬¡è§¦å‘ä¸Šä¼ 

**æ‡’åŠ è½½ç¤ºä¾‹**:
```javascript
// æ‡’åŠ è½½ç¼©ç•¥å›¾
const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            const img = entry.target;
            const src = img.dataset.src;
            img.src = src;
            observer.unobserve(img);
        }
    });
});

// åº”ç”¨åˆ°æ‰€æœ‰ç¼©ç•¥å›¾
document.querySelectorAll('.attachment-thumbnail').forEach(img => {
    observer.observe(img);
});
```

---

### C. å®‰å…¨è€ƒè™‘

#### C.1 æ–‡ä»¶ç±»å‹éªŒè¯

**ç™½åå•éªŒè¯**:
```python
ALLOWED_MIME_TYPES = [
    'image/jpeg',
    'image/png',
    'image/gif',
    'image/webp',
    'application/pdf',
    'application/msword',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    'application/vnd.ms-excel',
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
]

def validate_file_type(file):
    """éªŒè¯æ–‡ä»¶ç±»å‹"""
    import magic
    
    # æ£€æŸ¥ MIME ç±»å‹ï¼ˆä½¿ç”¨ python-magicï¼‰
    mime = magic.from_buffer(file.read(1024), mime=True)
    file.seek(0)  # é‡ç½®æŒ‡é’ˆ
    
    if mime not in ALLOWED_MIME_TYPES:
        raise ValueError(f"ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: {mime}")
    
    return mime
```

#### C.2 æ–‡ä»¶åå®‰å…¨

**é˜²æ­¢è·¯å¾„éå†æ”»å‡»**:
```python
from django.utils.text import get_valid_filename

def safe_filename(filename):
    """å®‰å…¨çš„æ–‡ä»¶åå¤„ç†"""
    # ç§»é™¤è·¯å¾„åˆ†éš”ç¬¦
    filename = os.path.basename(filename)
    
    # Django å†…ç½®æ¸…ç†
    filename = get_valid_filename(filename)
    
    # æ·»åŠ  UUID å‰ç¼€ï¼ˆé˜²æ­¢é‡åï¼‰
    import uuid
    ext = os.path.splitext(filename)[1]
    safe_name = f"{uuid.uuid4().hex[:8]}_{filename}"
    
    return safe_name
```

#### C.3 è®¿é—®æƒé™æ§åˆ¶

**ç¡®ä¿ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„é™„ä»¶**:
```python
@api_view(['GET'])
@permission_classes([IsAuthenticated])
def preview_attachment(request, attachment_id):
    """é¢„è§ˆé™„ä»¶ï¼ˆæƒé™æ£€æŸ¥ï¼‰"""
    try:
        # å¿…é¡»æ£€æŸ¥ user å½’å±
        attachment = SessionAttachment.objects.get(
            id=attachment_id,
            user=request.user  # â† å…³é”®
        )
    except SessionAttachment.DoesNotExist:
        return Response(
            {"error": "é™„ä»¶ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®"},
            status=404
        )
    
    # ... è¿”å›é™„ä»¶å†…å®¹ ...
```

#### C.4 æ¶æ„æ–‡ä»¶æ£€æµ‹

**é›†æˆç—…æ¯’æ‰«æï¼ˆå¯é€‰ï¼‰**:
```python
def scan_file(file_path):
    """æ‰«ææ–‡ä»¶ï¼ˆä½¿ç”¨ ClamAVï¼‰"""
    try:
        import pyclamd
        
        cd = pyclamd.ClamdUnixSocket()
        result = cd.scan_file(file_path)
        
        if result:
            # å‘ç°ç—…æ¯’
            raise ValueError(f"æ–‡ä»¶åŒ…å«æ¶æ„ä»£ç : {result}")
        
        return True
    except ImportError:
        # ClamAV æœªå®‰è£…ï¼Œè·³è¿‡æ‰«æ
        logger.warning("ClamAV æœªå®‰è£…ï¼Œè·³è¿‡ç—…æ¯’æ‰«æ")
        return True
```

---

### D. ç›‘æ§å’Œæ—¥å¿—

#### D.1 å…³é”®æŒ‡æ ‡

ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š

1. **é™„ä»¶æ•°é‡**ï¼šæ¯æ—¥æ–°å¢é™„ä»¶æ•°
2. **å­˜å‚¨ç©ºé—´**ï¼šæ€»å ç”¨ç©ºé—´ã€å¢é•¿è¶‹åŠ¿
3. **ä¸Šä¼ æˆåŠŸç‡**ï¼šä¸Šä¼ å¤±è´¥æ¬¡æ•°
4. **OCR å¤„ç†æ—¶é—´**ï¼šå¹³å‡å¤„ç†æ—¶é•¿
5. **æ¸…ç†æ•ˆæœ**ï¼šæ¯æ—¥æ¸…ç†çš„é™„ä»¶æ•°

#### D.2 æ—¥å¿—è®°å½•

```python
# å…³é”®æ“ä½œè®°å½•æ—¥å¿—
logger.info(f"ç”¨æˆ· {user.username} ä¸Šä¼ é™„ä»¶: {filename} ({file_size} bytes)")
logger.info(f"é™„ä»¶ {attachment_id} OCR æå–: {len(parsed_text)} å­—ç¬¦")
logger.warning(f"é™„ä»¶ {attachment_id} è§£æå¤±è´¥: {error}")
logger.info(f"æ¸…ç†äº† {count} ä¸ªè¿‡æœŸé™„ä»¶ï¼Œé‡Šæ”¾ {total_size} bytes")
```

#### D.3 å‘Šè­¦è§„åˆ™

è®¾ç½®å‘Šè­¦ï¼ˆå¦‚ä½¿ç”¨ Prometheus + Grafanaï¼‰ï¼š

- å­˜å‚¨ç©ºé—´è¶…è¿‡ 80% â†’ å‘é€é‚®ä»¶å‘Šè­¦
- ä¸Šä¼ å¤±è´¥ç‡ > 10% â†’ çŸ­ä¿¡å‘Šè­¦
- OCR å¤„ç†æ—¶é—´ > 30 ç§’ â†’ æ€§èƒ½å‘Šè­¦

---

**å‡çº§æ–¹æ¡ˆæ–‡æ¡£å®Œæˆï¼**
