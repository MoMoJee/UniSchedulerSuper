# Agent 附件系统接口文档

## 概述

附件系统允许用户在发送消息时附加额外的上下文信息（如工作流规则），使 Agent 能够更好地理解和执行任务。

系统设计为可扩展架构，当前支持工作流规则附件，未来可扩展支持文件上传、图片等类型。

## 后端 API

### 1. 获取可用附件列表

获取当前用户可用于附加的资源列表。

**请求**
```
GET /api/agent/attachments/
```

**Query 参数**
| 参数 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| type | string | 否 | 资源类型筛选。可选值: `workflow`。不传则返回所有类型 |

**响应**
```json
{
    "items": [
        {
            "type": "workflow",
            "id": 1,
            "name": "创建日程流程",
            "preview": "当用户要求创建日程时...",
            "metadata": {
                "trigger": "当用户要求创建日程时",
                "steps": "1. 确认时间\n2. 确认地点\n3. 设置提醒",
                "created_at": "2025-12-27T10:00:00",
                "updated_at": "2025-12-27T10:00:00"
            }
        }
    ],
    "types": ["workflow"]
}
```

**响应字段说明**
| 字段 | 类型 | 说明 |
|-----|------|------|
| items | array | 附件项列表 |
| items[].type | string | 附件类型 |
| items[].id | number | 资源 ID |
| items[].name | string | 显示名称 |
| items[].preview | string | 预览文本（截取前50字符） |
| items[].metadata | object | 类型特定的详细信息 |
| types | array | 当前支持的附件类型列表 |

---

### 2. 格式化附件内容

将选中的附件格式化为可发送给 Agent 的文本内容。

**请求**
```
POST /api/agent/attachments/format/
```

**请求体**
```json
{
    "attachments": [
        {"type": "workflow", "id": 1},
        {"type": "workflow", "id": 2}
    ]
}
```

**请求体字段说明**
| 字段 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| attachments | array | 是 | 要格式化的附件列表 |
| attachments[].type | string | 是 | 附件类型 |
| attachments[].id | number | 是 | 资源 ID |

**响应**
```json
{
    "formatted_content": "【附件：工作流规则】\n请参考以下工作流规则执行任务：\n\n### 1. 创建日程流程\n**触发条件**: 当用户要求创建日程时\n**执行步骤**: 1. 确认时间\n2. 确认地点\n\n",
    "count": 2
}
```

**响应字段说明**
| 字段 | 类型 | 说明 |
|-----|------|------|
| formatted_content | string | 格式化后的附件内容，将被添加到用户消息前面 |
| count | number | 成功格式化的附件数量 |

---

## 前端接口

### AgentChat 类扩展

#### 属性

```javascript
// 附件系统元素
this.attachmentBtn          // 附件按钮 DOM
this.attachmentPanel        // 附件面板 DOM
this.attachmentPanelBody    // 附件面板内容区 DOM
this.selectedAttachmentsContainer // 已选附件预览区 DOM

// 状态
this.selectedAttachments = []      // 已选择的附件列表 [{type, id, name}]
this.attachmentPanelVisible = false // 附件面板是否可见
```

#### 方法

##### toggleAttachmentPanel()
切换附件面板显示/隐藏。

##### showAttachmentPanel()
显示附件面板并加载可用附件列表。

##### hideAttachmentPanel()
隐藏附件面板。

##### loadAttachableItems()
从后端加载可用附件列表。

```javascript
async loadAttachableItems()
```

##### toggleAttachment(type, id, name, element)
切换单个附件的选择状态。

```javascript
toggleAttachment('workflow', 1, '创建日程流程', element)
```

##### removeAttachment(type, id)
移除已选择的附件。

```javascript
removeAttachment('workflow', 1)
```

##### clearSelectedAttachments()
清空所有已选附件。

##### getFormattedAttachmentContent()
获取已选附件的格式化内容（用于发送消息）。

```javascript
async getFormattedAttachmentContent() -> string
```

---

## 扩展指南

### 添加新的附件类型

#### 1. 后端

在 `views_api.py` 的 `get_attachable_items` 函数中添加新类型：

```python
# 在 available_types 中添加新类型
available_types = ['workflow', 'new_type']

# 添加新类型的处理逻辑
if resource_type is None or resource_type == 'new_type':
    resources = NewModel.objects.filter(user=user)
    for r in resources:
        items.append({
            "type": "new_type",
            "id": r.id,
            "name": r.name,
            "preview": r.description[:50],
            "metadata": {...}
        })
```

在 `format_attachment_content` 函数中添加格式化逻辑：

```python
# 收集新类型的附件
new_type_items = []
for att in attachments:
    if att.get('type') == 'new_type':
        try:
            item = NewModel.objects.get(id=att.get('id'), user=user)
            new_type_items.append(item)
            count += 1
        except NewModel.DoesNotExist:
            continue

# 格式化新类型的内容
if new_type_items:
    content = "【附件：新类型】\n"
    for item in new_type_items:
        content += f"- {item.name}: {item.content}\n"
    formatted_parts.append(content)
```

#### 2. 前端

在 `agent-chat.js` 的 `renderAttachmentPanel` 方法中添加类型标签：

```javascript
const typeLabels = {
    'workflow': { label: '工作流规则', icon: 'fa-project-diagram' },
    'new_type': { label: '新类型', icon: 'fa-icon-name' }
};
```

在 `renderSelectedAttachments` 方法中添加图标：

```javascript
const typeIcons = {
    'workflow': 'fa-project-diagram',
    'new_type': 'fa-icon-name'
};
```

#### 3. CSS

如需特殊样式，在 `agent-chat.css` 中添加：

```css
/* 新类型附件项的特殊样式 */
.attachment-item[data-type="new_type"] {
    /* 自定义样式 */
}
```

---

## 消息流程

1. **用户选择附件**
   - 点击附件按钮 → 显示附件面板
   - 点击附件项 → 添加到 `selectedAttachments`
   - 已选附件显示在输入框上方

2. **发送消息**
   - 调用 `sendMessage()`
   - 如果 `selectedAttachments` 不为空，调用 `getFormattedAttachmentContent()`
   - 将格式化内容添加到消息前面: `{attachmentContent}\n\n{userMessage}`
   - 清空已选附件
   - 发送到 WebSocket

3. **Agent 处理**
   - Agent 收到的消息包含附件内容
   - 根据附件中的工作流规则指导执行任务

---

## 注意事项

1. **权限控制**: 所有 API 都需要用户认证，只能访问自己的资源
2. **附件仅影响当前消息**: 附件内容只会被添加到即将发送的消息中，不会持久保存
3. **显示与发送分离**: 用户看到的是原始消息，实际发送的包含附件内容
4. **清空时机**: 消息发送后自动清空已选附件
