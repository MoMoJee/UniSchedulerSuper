# 课表导入功能升级方案

> 文档创建日期: 2025-12-29
> 状态: **已确认，开始实现**

---

## 📋 一、功能概述

### 1.1 当前状态

**现有实现** (`core/views_import_events.py`):
- 从学校教务系统 (jwxs.muc.edu.cn) 爬取课表数据
- 简单地将爬取的日程直接写入数据库
- 未处理 RRule 规则（每门课实际上是重复日程）
- 未解析 title 中的结构化信息（课程名、教室、教师）
- 没有前端界面，功能不可用

**数据源格式**:
```json
{
    "status": 200,
    "msg": "OK",
    "data": "[{\"id\":\"1037010044_09\",\"title\":\"中华民族共同体概论 丰台校区博文楼博文414 陈延斌\",\"start\":\"2025-09-02 08:00\",\"end\":\"2025-09-02 09:35\",\"backgroundColor\":\"#3a87ad\",\"showmsg\":\"课程@中华民族共同体概论@丰台校区博文楼博文414@陈延斌\"}, ...]"
}
```

**原始 ID 格式**: `1037010044_09` - 课程序号（非 UUID），可用于识别同一课程的不同课时

### 1.2 升级目标

1. **RRule 反向解析**: 分析同一课程的多个时间点，生成 RRule 重复规则
2. **标题解析**: 从 `title` 或 `showmsg` 中提取课程名、教室、教师信息
3. **创建日程接口集成**: 使用现有的 `/events/create_event/` 接口创建带 RRule 的日程
4. **前端界面**: 在 `home.html` 提供导入预览、确认、编辑功能
5. **批量导入**: 创建**少量带 RRule 规则的主日程**，后续实例由系统自动生成

---

## 📊 二、数据分析与 RRule 推断

### 2.1 原始数据结构分析

| 字段 | 示例值 | 用途 |
|------|--------|------|
| `id` | `1037010044_09` | 课程序号，用于分组识别同一课程 |
| `title` | `中华民族共同体概论 丰台校区博文楼博文414 陈延斌` | 包含课程名+教室+教师 |
| `start` | `2025-09-02 08:00` | 开始时间 |
| `end` | `2025-09-02 09:35` | 结束时间 |
| `showmsg` | `课程@中华民族共同体概论@丰台校区博文楼博文414@于香芝` | 结构化信息（@分隔） |

### 2.2 RRule 推断逻辑

**分组策略**: 
1. 先按 `id`（课程序号）分组
2. 再按**时间段**（start 的时:分）细分 → 同一课程不同时段创建**独立的重复日程**

**支持的 RRule 模式**:
| 模式 | 示例 | 说明 |
|------|------|------|
| 每周重复 | `FREQ=WEEKLY;BYDAY=MO;COUNT=16` | 每周一，共16次 |
| 每N周重复 | `FREQ=WEEKLY;INTERVAL=2;BYDAY=TU;COUNT=8` | 隔周二，共8次 |
| 每日重复 | `FREQ=DAILY;INTERVAL=1;COUNT=5` | 每天，共5次 |
| 每月重复 | `FREQ=MONTHLY;BYDAY=1MO;COUNT=4` | 每月第1个周一，共4次 |

**推断算法**:
```python
def infer_rrule(instances: List[Dict]) -> str:
    """
    从多个课程实例推断 RRule 规则
    1. 按时间排序
    2. 计算日期间隔（天数）
    3. 判断间隔模式：7天=每周, 14天=隔周, 1天=每日, 28-31天=每月
    4. 识别星期几 (BYDAY)
    5. 统计重复次数 (COUNT)
    """
```

### 2.3 标题解析逻辑

**优先使用 `showmsg`** (结构更清晰):
```python
# showmsg: "课程@中华民族共同体概论@丰台校区博文楼博文414@陈延斌"
parts = showmsg.split('@')
# parts[0]: "课程" (类型，忽略)
# parts[1]: "中华民族共同体概论" (课程名 → title)
# parts[2]: "丰台校区博文楼博文414" (教室 → description 的一部分)
# parts[3]: "陈延斌" (教师 → description 的一部分)
```

**备用解析 `title`** (空格分隔):
```python
# title: "中华民族共同体概论 丰台校区博文楼博文414 陈延斌"
# 最后一个词通常是教师名（2-4个汉字）
# 倒数第二个词通常是教室
# 剩余部分是课程名
```

### 2.4 转换后的日程格式

```json
{
    "title": "中华民族共同体概论",
    "start": "2025-09-02T08:00:00",
    "end": "2025-09-02T09:35:00",
    "description": "教室: 丰台校区博文楼博文414\n教师: 陈延斌",
    "importance": "",
    "urgency": "",
    "groupID": "用户选择的日程组ID",
    "rrule": "FREQ=WEEKLY;BYDAY=TU;COUNT=16"
}
```

---

## 🏗️ 三、技术架构

### 3.1 后端 API 设计

#### 3.1.1 获取并解析课表 API

**端点**: `POST /api/import/fetch-courses/`

**请求**:
```json
{
    "cookie": "JSESSIONID=xxxx; ..."
}
```

**响应**:
```json
{
    "status": "success",
    "courses": [
        {
            "course_id": "1037010044_09",
            "time_slot": "08:00-09:35",
            "title": "中华民族共同体概论",
            "location": "丰台校区博文楼博文414",
            "teacher": "陈延斌",
            "instance_count": 16,
            "rrule": "FREQ=WEEKLY;BYDAY=TU;COUNT=16",
            "rrule_text": "每周二，共16次",
            "first_start": "2025-09-02T08:00",
            "first_end": "2025-09-02T09:35"
        },
        ...
    ],
    "total_courses": 15,
    "raw_instance_count": 180
}
```

#### 3.1.2 确认导入 API

**端点**: `POST /api/import/confirm-courses/`

**请求**:
```json
{
    "courses": [
        {
            "title": "中华民族共同体概论",
            "start": "2025-09-02T08:00",
            "end": "2025-09-02T09:35",
            "description": "教室: 丰台校区博文楼博文414\n教师: 陈延斌",
            "rrule": "FREQ=WEEKLY;BYDAY=TU;COUNT=16",
            "groupID": "course-group-id"
        },
        ...
    ]
}
```

**响应**:
```json
{
    "status": "success",
    "imported_count": 15,
    "message": "成功导入 15 门课程"
}
```

### 3.2 后端实现模块

```
core/
├── views_import_events.py      # 升级: 课表导入核心逻辑
│   ├── parse_course_info()          # 解析课程信息 (showmsg/title)
│   ├── group_courses_by_timeslot()  # 按课程ID+时间段分组
│   ├── infer_rrule()                # RRule 推断算法
│   ├── fetch_and_parse_courses()    # API: 获取并解析课表
│   └── confirm_import_courses()     # API: 确认导入（调用 create_event）
├── urls.py                     # 添加新路由
```

### 3.3 前端界面设计

#### 3.3.1 入口位置

在 `home.html` 的侧边栏添加"导入课表"按钮

#### 3.3.2 导入流程 (Modal 弹窗)

```
┌─────────────────────────────────────────────────────────────┐
│  导入课表                                            [×]    │
├─────────────────────────────────────────────────────────────┤
│  Step 1: 输入 Cookie                                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 请粘贴教务系统 Cookie:                [如何获取?]    │   │
│  │ [                                              ]     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                        [获取课表]          │
├─────────────────────────────────────────────────────────────┤
│  Step 2: 预览并选择课程                                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ☑ 中华民族共同体概论                                 │   │
│  │   📍 博文414  👤 陈延斌                              │   │
│  │   🔄 每周二 08:00-09:35，共16次                      │   │
│  │ ☑ 高等数学                                          │   │
│  │   📍 日新314  👤 于香芝                              │   │
│  │   🔄 每周一 10:00-11:35，共16次                      │   │
│  │ ☐ 体育课                                            │   │
│  │   🔄 每周五 14:00-15:35，共16次                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  目标日程组: [▼ 学习          ] [+ 新建日程组]             │
│                                                             │
│                              [取消]  [导入选中课程 (12)]    │
├─────────────────────────────────────────────────────────────┤
│  Step 3: 导入完成                                           │
│  ✅ 成功导入 12 门课程，系统将自动生成后续课程实例          │
│                                        [完成]               │
└─────────────────────────────────────────────────────────────┘
```

---

## 📝 四、实现计划 (Checklist)

### Phase 1: 后端核心逻辑 ✅

- [x] **1.1 解析函数**
  - [x] `parse_course_info(item)` - 从 showmsg/title 解析课程名、教室、教师
  
- [x] **1.2 分组函数**
  - [x] `group_courses_by_timeslot(raw_items)` - 按课程ID+时间段分组
  
- [x] **1.3 RRule 推断**
  - [x] `infer_rrule(instances)` - 从实例列表推断 RRule
  - [x] `get_weekday_chinese(code)` - 将 RRule 转为可读文本
  
- [x] **1.4 API 实现**
  - [x] `fetch_and_parse_courses(request)` - POST /api/import/fetch-courses/
  - [x] `confirm_import_courses(request)` - POST /api/import/confirm-courses/
  
- [x] **1.5 URL 路由**
  - [x] 在 `core/urls.py` 添加两个新路由

### Phase 2: 前端界面 ✅

- [x] **2.1 导入弹窗**
  - [x] 在 `home.html` 添加导入课表 Modal
  - [x] Step 1: Cookie 输入 + 获取按钮
  - [x] Step 2: 课程预览列表（勾选框 + RRule 展示）
  - [x] Step 3: 导入结果
  
- [x] **2.2 日程组选择**
  - [x] 下拉选择现有日程组
  - [x] [+ 新建日程组] 按钮（调用现有创建日程组 API）
  
- [x] **2.3 入口按钮**
  - [x] 在日历控制区添加"导入课表"按钮

- [x] **2.4 JavaScript 逻辑**
  - [x] `courseImporter` 对象实现全部功能

### Phase 3: 文档

- [x] **3.1 Cookie 获取指南**
  - [x] 在 Cookie 帮助模态框中提供图文说明

---

## ✅ 已确认的设计决策

| 问题 | 决策 |
|------|------|
| 同一课程不同时段 | **创建多个独立的重复日程** |
| RRule 模式支持 | 每x日、每x周、每x月重复 + COUNT |
| 日程组 | 用户从现有组选择，或新建（复用 home.html 逻辑） |
| 学期时间范围 | 不需要用户指定，从数据推断 |
| 冲突检测 | 暂不实现 |
| 创建方式 | 调用 create_event 创建**带 RRule 的主日程**，系统自动生成实例 |

---

## 📎 参考资料

- 现有日程创建接口: [api_examples/example_events_api.py](../../api_examples/example_events_api.py)
- RRule 引擎实现: [rrule_engine.py](../../rrule_engine.py)
- 日程数据结构: [core/models.py](../../core/models.py) - `DATA_SCHEMA["events"]`
- 主界面: [core/templates/home.html](../../core/templates/home.html)
