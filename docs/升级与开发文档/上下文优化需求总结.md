# Agent 上下文优化 - 需求总结与修改说明

## 📋 用户需求整理

### 1. 模型配置存储位置调整

**原方案**: 在 `agent_service.DialogStyle` 中存储模型窗口大小等配置

**新需求**: 
- 配置应存储在 `core.UserData` 的新字段中
- 包含模型列表（系统预置 + 用户自定义）
- 每个模型包含：名称、上下文长度、API URL、密钥等
- 方便用户自行切换模型

**原因**:
- 当前实现硬编码了 DeepSeek 在代码中
- 用户无法选择或添加自己的模型
- 需要支持"网站提供的模型"和"用户自定义模型"两种类型

### 2. 配置界面位置调整

**原方案**: 在 Django Admin 中配置（Step 7）

**新需求**:
- 配置界面放在前端"设置 - AI设置"页面中
- 用户可以：
  - 选择系统提供的模型（如 DeepSeek）
  - 添加自己的 API Key 和 URL
  - 查看和管理自定义模型
  - 配置上下文优化参数

**原因**:
- Admin 界面对普通用户不友好
- 需要与现有的 AI 设置页面集成
- 提供更好的用户体验

### 3. Token 消耗统计功能

**新需求**:
- 从 LangGraph 的 `response_metadata['usage']` 收集 Token 消耗
- 存储在 `core.UserData.token_usage_stats` 中
- 记录内容：
  - 累计输入/输出 Token 数
  - 累计费用（根据模型价格计算）
  - 按日期的统计（每日消耗）
  - 按模型的统计（各模型对比）
- 暂时设置大额度（9999999），不做限额逻辑

**原因**:
- 需要让用户了解 Token 消耗情况
- 为未来的限额和计费功能打基础
- 帮助用户优化使用成本

### 4. 前端展示需求

**新需求**:
- 在"AI设置"页面显示：
  - 当前使用的模型信息
  - 模型列表（系统 + 自定义）
  - Token 消耗统计（今天/7天/全部）
  - 各模型使用对比
  - 上下文优化开关和参数

---

## 🔄 文档修改说明

### 修改的文件

1. **`上下文优化实施方案.md`**
   - ✅ 更新概述，强调模型配置在 UserData
   - ✅ 更新文件结构，添加 core 相关文件
   - ✅ Step 4: 新增 UserData 模型扩展（完整代码）
   - ✅ Step 5: 简化 DialogStyle（仅保留优化开关）
   - ✅ Step 6: agent_node 从 UserData 读取配置
   - ✅ Step 7: 改为前端 API 设计（删除 Admin 配置）
   - ✅ Step 8: 新增前端 AI 设置界面（完整 HTML/JS）
   - ✅ Step 9: 更新数据库迁移说明
   - ✅ 更新附录 7.1: 配置参数参考（区分存储位置）
   - ✅ 更新实施完成标志

2. **`上下文优化方案.md`**（战略文档）
   - ✅ 更新问题分析，添加模型硬编码和 Token 统计需求
   - ✅ 更新设计目标，强调用户配置化和 Token 统计
   - ✅ 更新配置参数部分，说明存储在 UserData
   - ✅ 调整实施计划阶段：
     - Phase 2: 模型配置系统
     - Phase 3: Token 统计与监控
     - Phase 4: 智能总结机制（原 Phase 3）
   - ✅ 更新监控指标，添加成本指标和用户配置指标

---

## 📊 核心数据结构

### UserData 新增字段

```python
class UserData(models.Model):
    # 1. Agent 模型配置
    agent_model_config = JSONField(default=dict)
    # {
    #   "current_model_id": "system_deepseek",
    #   "models": {
    #     "system_deepseek": {
    #       "name": "DeepSeek Chat",
    #       "provider": "system",
    #       "api_url": "...",
    #       "api_key": "...",
    #       "context_window": 128000,
    #       "cost_per_1k_input": 0.00014,
    #       "cost_per_1k_output": 0.00028
    #     }
    #   }
    # }
    
    # 2. 上下文优化配置
    context_optimization_config = JSONField(default=dict)
    # {
    #   "enable_optimization": True,
    #   "target_usage_ratio": 0.6,
    #   "summary_token_ratio": 0.26,
    #   ...
    # }
    
    # 3. Token 消耗统计
    token_usage_stats = JSONField(default=dict)
    # {
    #   "total_input_tokens": 1500000,
    #   "total_output_tokens": 500000,
    #   "total_cost": 12.50,
    #   "quota": 9999999,
    #   "daily_stats": {
    #     "2026-01-02": {
    #       "input_tokens": 50000,
    #       "output_tokens": 20000,
    #       "cost": 0.45
    #     }
    #   },
    #   "model_stats": {
    #     "system_deepseek": {
    #       "input_tokens": 1200000,
    #       "output_tokens": 400000,
    #       "cost": 10.20
    #     }
    #   }
    # }
```

### DialogStyle 简化

```python
class DialogStyle(models.Model):
    # ... 现有字段 ...
    
    # 仅保留总开关
    enable_context_optimization = BooleanField(
        default=True,
        help_text="详细配置在用户设置中"
    )
```

---

## 🔌 新增 API 端点

```python
# core/urls.py

urlpatterns = [
    # 模型配置管理
    path('api/agent/model-config/', views.get_model_config),
    path('api/agent/model-config/update/', views.update_model_config),
    
    # Token 统计查询
    path('api/agent/token-usage/', views.get_token_usage),
]
```

### API 功能说明

1. **GET /api/agent/model-config/**
   - 返回：系统模型 + 用户自定义模型列表 + 当前选择

2. **POST /api/agent/model-config/update/**
   - 操作：
     - `select_model`: 切换当前模型
     - `add_custom_model`: 添加自定义模型
     - `delete_custom_model`: 删除自定义模型
     - `update_optimization`: 更新优化配置

3. **GET /api/agent/token-usage/?period=today|week|all**
   - 返回：指定时间段的 Token 统计和费用

---

## 🎨 前端界面组成

### AI 设置页面新增区域

1. **Agent 模型配置**
   - 当前模型卡片（名称、窗口大小、类型）
   - 切换模型按钮 → 模型选择器模态框
   - 系统模型列表
   - 自定义模型列表 + 添加按钮

2. **Token 使用统计**
   - 时间段选择（今天/7天/全部）
   - 统计卡片：输入/输出/费用/剩余额度
   - 按模型统计表格

3. **上下文优化配置**
   - 启用/禁用开关
   - 目标窗口使用率滑块
   - 启用智能总结开关
   - 启用工具压缩开关

---

## ✅ 与原方案的对比

| 方面 | 原方案 | 新方案 |
|------|--------|--------|
| **配置存储** | agent_service.DialogStyle | core.UserData (3个JSON字段) |
| **模型管理** | 硬编码 DeepSeek | 系统预置 + 用户自定义 |
| **配置界面** | Django Admin | 前端 AI 设置页面 |
| **模型切换** | 修改代码 | 界面选择 |
| **Token 统计** | 无 | 实时收集、多维度统计 |
| **费用计算** | 无 | 根据模型价格自动计算 |
| **用户体验** | 开发者向 | 用户友好 |

---

## 🚀 实施优先级

### 阶段 1: 数据模型和 API（必须先做）
1. 修改 `core/models.py` - 添加 UserData 字段
2. 创建数据库迁移
3. 实现 `core/views.py` - API 端点
4. 测试 API 功能

### 阶段 2: Agent 集成（核心功能）
5. 创建 `agent_service/context_optimizer.py`
6. 创建 `agent_service/context_summarizer.py`
7. 修改 `agent_service/agent_graph.py` - 从 UserData 读取配置
8. 集成 Token 统计逻辑

### 阶段 3: 前端界面（用户可见）
9. 修改 AI 设置页面 HTML
10. 实现 JavaScript 交互
11. 测试界面功能

### 阶段 4: 测试和优化
12. 单元测试
13. 集成测试
14. 性能测试
15. 灰度发布

---

## 📝 注意事项

1. **安全性**：
   - 用户的 API Key 应加密存储（生产环境）
   - 前端不应显示完整的 API Key

2. **兼容性**：
   - 现有用户的配置需要迁移逻辑
   - 提供默认的系统模型配置

3. **性能**：
   - Token 统计不应影响 Agent 响应速度
   - 考虑异步更新统计数据

4. **可扩展性**：
   - 预留限额检查的接口
   - 支持未来添加更多系统模型

---

## 🎯 预期成果

完成后，用户将能够：

✅ 在前端界面选择不同的 AI 模型
✅ 添加自己的 API Key 使用自定义模型
✅ 实时查看 Token 消耗和费用统计
✅ 对比不同模型的使用情况
✅ 配置上下文优化参数
✅ 系统自动根据模型窗口大小优化 Token 使用

开发者将获得：
✅ 灵活的模型配置系统
✅ 完整的 Token 监控数据
✅ 易于扩展的架构
✅ 用户友好的配置界面
