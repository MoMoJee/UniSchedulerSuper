# UniScheduler AI Agent 升级详细文档

## 1. 整体架构升级概述

### 1.1 核心理念转变
- **从工具型转向智能代理型**: AI从被动响应转为主动理解、规划、执行
- **操作透明化**: 所有AI操作可视化，用户可控制每个操作的执行
- **上下文感知**: AI维护完整的对话和操作历史，提供连贯的交互体验

### 1.2 主界面布局调整
```
┌─────────────────────────┬─────────────────────────┬─────────────────────────┐
│                        │                        │                        │
│      FullCalendar      │      待办事项面板       │       AI聊天界面        │
│                        │                        │                        │
│   • 事件显示            │   • Todo列表            │   • 对话历史            │
│   • 提醒集成            │   • 拖拽到日历          │   • 操作可视化          │
│   • RRule重复事件       │   • 重要性/紧急性标识   │   • 批量操作确认        │
│   • 多类型区分显示      │   • 快速时间设置        │   • 智能建议            │
│                        │                        │                        │
└─────────────────────────┴─────────────────────────┴─────────────────────────┘
```

## 2. 数据模型升级

### 2.1 事件模型增强 (Events)
在现有Event格式基础上增加：
```json
{
  // 现有字段保持不变
  "id": "uuid",
  "title": "string",
  "start": "datetime",
  "end": "datetime", 
  "description": "string",
  "importance": "important|not-important",
  "urgency": "urgent|not-urgent",
  "groupID": "uuid",
  "ddl": "datetime",
  "last_modified": "datetime",
  
  // 新增字段
  "rrule": "string",                    // RRule格式重复规则
  "rrule_generated": false,             // 是否为RRule生成的实例
  "rrule_parent_id": "uuid",           // 父RRule事件ID
  "linked_reminders": ["uuid"],         // 关联的提醒ID列表
  "tags": ["string"],                   // 标签
  "location": "string",                 // 地点
  "status": "confirmed|tentative|cancelled" // 状态
}
```

### 2.2 待办事项模型 (Todos)
```json
{
  "id": "uuid",
  "title": "string",
  "description": "string",
  "importance": "critical|high|medium|low",
  "urgency": "urgent|normal|not-urgent",
  "tags": ["string"],
  "created_at": "datetime",
  "due_date": "datetime",              // 可选截止日期
  "estimated_duration": "duration",    // 预估耗时
  "groupID": "uuid",                   // 关联日程组
  "status": "pending|in-progress|completed|cancelled",
  "dependencies": ["uuid"],            // 依赖的其他待办
  "linked_reminders": ["uuid"],        // 关联提醒
  "priority_score": "float",           // AI计算的优先级分数
  "last_modified": "datetime"
}
```

### 2.3 提醒模型 (Reminders)
```json
{
  "id": "uuid",
  "title": "string",
  "content": "string",
  "trigger_time": "datetime",
  "priority": "critical|high|normal|low|debug",
  "advance_triggers": [
    {
      "time_before": "duration",       // 提前时间（如：15m, 1h, 1d）
      "priority": "priority_level",
      "message": "string"              // 可自定义提醒内容
    }
  ],
  "rrule": "string",                   // 重复提醒规则
  "linked_event_id": "uuid",           // 关联的事件ID
  "linked_todo_id": "uuid",            // 关联的待办ID
  "status": "active|dismissed|snoozed",
  "snooze_until": "datetime",          // 延迟到的时间
  "notification_sent": "boolean",      // 是否已发送通知
  "created_at": "datetime",
  "last_modified": "datetime"
}
```

### 2.4 AI操作记录模型 (Agent_Operations)
替换现有的temp_events：
```json
{
  "operation_id": "uuid",
  "session_id": "uuid",               // 对话会话ID
  "type": "create|update|delete|query|batch",
  "target_type": "event|todo|reminder|group",
  "target_id": "uuid",
  "operation_details": {
    "before": {},                      // 操作前状态
    "after": {},                       // 操作后状态
    "changes": {}                      // 具体变更内容
  },
  "ai_reasoning": "string",            // AI操作理由
  "confidence_score": "float",         // AI决策置信度
  "user_feedback": "pending|accepted|rejected|modified",
  "user_comment": "string",            // 用户反馈评论
  "timestamp": "datetime",
  "dependencies": ["operation_id"],    // 依赖的其他操作
  "auto_executed": "boolean",          // 是否自动执行
  "rollback_data": {}                  // 回滚数据
}
```

### 2.5 日程组模型增强 (Events_Groups)
现有实现已经包含基本功能，增强如下：
```json
{
  // 现有字段
  "id": "uuid",
  "name": "string", 
  "description": "string",
  "color": "string",
  
  // 新增字段
  "type": "work|personal|study|health|social|other",
  "default_duration": "duration",      // 该组默认事件时长
  "default_importance": "level",       // 默认重要性
  "default_urgency": "level",          // 默认紧急性
  "ai_priority": "float",              // AI管理优先级
  "auto_scheduling": "boolean",        // 是否允许AI自动调度
  "working_hours": {                   // 该组的工作时间
    "start": "time",
    "end": "time",
    "days": ["monday", "tuesday", ...]
  },
  "created_at": "datetime",
  "last_modified": "datetime"
}
```

## 3. AI Agent核心功能

### 3.1 智能查询系统
#### 查询类型：
1. **时间范围查询**: 
   - 今天/明天/本周的日程
   - 指定日期范围的日程
   - 空闲时间查询

2. **内容关联查询**:
   - 关键词搜索相关事件/待办
   - 标签/日程组过滤
   - 重要性/紧急性筛选

3. **智能推理查询**:
   - 冲突检测
   - 相关事件发现
   - 优化建议生成

#### 实现方式：
```python
class AIQueryEngine:
    def query_events_by_time(self, start_date, end_date, include_rrule=True):
        """时间范围查询，包含RRule展开"""
        pass
    
    def query_related_items(self, keywords, context):
        """基于关键词和上下文的智能查询"""
        pass
    
    def detect_conflicts(self, proposed_events, existing_events):
        """冲突检测"""
        pass
```

### 3.2 操作可视化系统
#### 操作卡片组件：
```javascript
class OperationCard {
    constructor(operation) {
        this.operation = operation;
        this.element = this.createCard();
    }
    
    createCard() {
        // 创建操作卡片DOM
        // 包含：操作类型、目标对象、变更预览、AI理由、操作按钮
    }
    
    showPreview() {
        // 显示操作结果预览
    }
    
    accept() {
        // 接受操作
    }
    
    reject() {
        // 拒绝操作
    }
}
```

### 3.3 RRule支持系统
#### 前端实现：
```javascript
// 使用rrule.js库
import { RRule } from 'rrule';

class RRuleManager {
    generateInstances(rruleString, startDate, endDate) {
        // 生成指定时间范围内的重复事件实例
        const rule = RRule.fromString(rruleString);
        return rule.between(startDate, endDate);
    }
    
    updateCalendarWithRRule(eventData) {
        // 在FullCalendar中动态显示RRule事件
    }
}
```

#### 后端实现：
```python
from dateutil.rrule import rrule, rrulestr
from datetime import datetime, timedelta

class RRuleProcessor:
    def expand_rrule_events(self, events, start_date, end_date):
        """展开指定时间范围内的RRule事件"""
        expanded_events = []
        
        for event in events:
            if event.get('rrule'):
                # 解析RRule并生成实例
                rule = rrulestr(event['rrule'])
                instances = rule.between(start_date, end_date)
                
                for instance in instances:
                    # 创建事件实例
                    instance_event = event.copy()
                    instance_event.update({
                        'id': f"{event['id']}_{instance.isoformat()}",
                        'start': instance.isoformat(),
                        'end': (instance + timedelta(hours=1)).isoformat(),  # 默认时长
                        'rrule_generated': True,
                        'rrule_parent_id': event['id']
                    })
                    expanded_events.append(instance_event)
        
        return expanded_events
```

## 4. 前端界面升级

### 4.1 FullCalendar增强
#### 提醒集成：
```javascript
// 在FullCalendar中显示提醒
calendar.addEventSource({
    events: function(fetchInfo, successCallback, failureCallback) {
        // 获取事件和提醒
        Promise.all([
            fetchEvents(fetchInfo.start, fetchInfo.end),
            fetchReminders(fetchInfo.start, fetchInfo.end)
        ]).then(([events, reminders]) => {
            // 将提醒转换为FullCalendar事件格式
            const reminderEvents = reminders.map(reminder => ({
                id: reminder.id,
                title: `🔔 ${reminder.title}`,
                start: reminder.trigger_time,
                allDay: false,
                display: 'list-item',  // 显示为列表项而不是时间块
                backgroundColor: getPriorityColor(reminder.priority),
                classNames: ['reminder-event']
            }));
            
            successCallback([...events, ...reminderEvents]);
        });
    }
});
```

### 4.2 待办事项面板
```javascript
class TodoPanel {
    constructor() {
        this.todos = [];
        this.initDragDrop();
    }
    
    initDragDrop() {
        // 实现拖拽到日历功能
        new Draggable(this.element, {
            eventData: function(eventEl) {
                return {
                    title: eventEl.innerText,
                    duration: '01:00'  // 默认1小时
                };
            }
        });
    }
    
    renderTodos() {
        // 按重要性和紧急性排序显示
        const sortedTodos = this.todos.sort((a, b) => {
            return b.priority_score - a.priority_score;
        });
        
        // 渲染待办列表
    }
}
```

### 4.3 AI聊天界面升级
```javascript
class AIChatInterface {
    constructor() {
        this.operations = [];
        this.dialogue = [];
    }
    
    addOperationCard(operation) {
        // 添加操作卡片到聊天界面
        const card = new OperationCard(operation);
        this.chatContainer.appendChild(card.element);
    }
    
    handleBatchOperation(operations) {
        // 处理批量操作
        const batchCard = new BatchOperationCard(operations);
        this.chatContainer.appendChild(batchCard.element);
    }
}
```

## 5. 后端API升级

### 5.1 新增API端点
```python
# AI查询相关
@api_view(['POST'])
def ai_query_events(request):
    """智能查询事件"""
    pass

@api_view(['POST']) 
def ai_propose_operations(request):
    """AI提出操作建议"""
    pass

# 待办事项相关
@api_view(['GET', 'POST'])
def todos_api(request):
    """待办事项CRUD"""
    pass

# 提醒相关
@api_view(['GET', 'POST'])
def reminders_api(request):
    """提醒CRUD"""
    pass

# RRule相关
@api_view(['POST'])
def expand_rrule_events(request):
    """展开RRule事件"""
    pass

# 操作管理
@api_view(['POST'])
def execute_ai_operation(request):
    """执行AI操作"""
    pass

@api_view(['POST'])
def batch_execute_operations(request):
    """批量执行操作"""
    pass
```

### 5.2 AI决策引擎
```python
class AIDecisionEngine:
    def __init__(self):
        self.context_manager = ContextManager()
        self.query_engine = AIQueryEngine()
        
    def process_user_input(self, user_input, user_context):
        """处理用户输入，生成操作计划"""
        # 1. 理解用户意图
        intent = self.parse_intent(user_input)
        
        # 2. 查询相关数据
        relevant_data = self.query_engine.query_relevant_data(intent)
        
        # 3. 生成操作计划
        operations = self.generate_operations(intent, relevant_data)
        
        # 4. 返回可视化操作
        return operations
```

## 6. 实施计划

### 阶段一：数据模型重构（2-3周）
1. **数据库Schema升级**
   - 扩展现有数据模型
   - 添加新的Todo和Reminder模型
   - 升级Agent_Operations替换temp_events

2. **后端API基础**
   - 实现新增数据模型的CRUD操作
   - 建立RRule处理基础架构
   - 重构现有事件查询逻辑

### 阶段二：AI引擎重构（3-4周）
1. **智能查询系统**
   - 实现时间范围查询
   - 开发内容关联查询
   - 构建冲突检测机制

2. **决策引擎开发**
   - 重写AI决策逻辑
   - 实现操作可视化后端
   - 建立用户反馈学习机制

### 阶段三：前端界面升级（4-5周）
1. **主界面重构**
   - 调整三栏布局
   - 升级FullCalendar集成
   - 开发待办事项面板

2. **AI交互优化**
   - 实现操作卡片组件
   - 开发批量操作界面
   - 建立实时更新机制

### 阶段四：RRule和提醒系统（2-3周）
1. **RRule完整实现**
   - 前端rrule.js集成
   - 后端生成和查询优化
   - 界面创建和编辑支持

2. **提醒系统开发**
   - 提醒模型实现
   - FullCalendar集成
   - 通知机制准备

### 阶段五：测试和优化（2-3周）
1. **功能测试**
   - 单元测试覆盖
   - 集成测试验证
   - 用户体验测试

2. **性能优化**
   - 查询性能优化
   - 前端渲染优化
   - 实时更新优化

## 7. 技术风险和缓解策略

### 7.1 数据迁移风险
- **风险**: 现有用户数据兼容性
- **缓解**: 编写数据迁移脚本，保持向后兼容

### 7.2 性能风险
- **风险**: RRule展开可能影响性能
- **缓解**: 
  - 按需生成，只计算可视范围
  - 缓存机制
  - 异步处理

### 7.3 用户体验风险
- **风险**: 界面复杂度增加
- **缓解**:
  - 渐进式功能暴露
  - 用户引导和帮助
  - 可配置的复杂度级别

## 8. 成功指标

### 8.1 功能指标
- [ ] AI操作成功率 > 85%
- [ ] 用户操作接受率 > 70%
- [ ] RRule事件正确显示率 100%
- [ ] 查询响应时间 < 500ms

### 8.2 用户体验指标
- [ ] 用户学习成本降低 30%
- [ ] 日程管理效率提升 40%
- [ ] 用户满意度 > 4.0/5.0

这个升级将使UniScheduler从一个简单的日程管理工具转变为真正的智能时间管理助手，具备学习能力和主动服务能力。
