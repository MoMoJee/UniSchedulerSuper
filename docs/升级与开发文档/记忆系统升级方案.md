# è®°å¿†ç³»ç»Ÿå‡çº§æ–¹æ¡ˆ

## ä¸€ã€å‡çº§ç›®æ ‡

### 1.1 å¤šè®°å¿†è¡¨ç³»ç»Ÿ
å°†å•ä¸€çš„è®°å¿†å­˜å‚¨å‡çº§ä¸ºå¤šä¸ªä¸“ç”¨è®°å¿†è¡¨ï¼š

| è®°å¿†è¡¨ | ç”¨é€” | ç¤ºä¾‹ |
|--------|------|------|
| ç”¨æˆ·ä¸ªäººä¿¡æ¯ | å­˜å‚¨ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ã€åå¥½ | å§“åã€ç”Ÿæ—¥ã€å¸¸ç”¨åœ°å€ã€é¥®é£Ÿåå¥½ç­‰ |
| å¯¹è¯é£æ ¼/è§’è‰² | Agentçš„å¯¹è¯é£æ ¼å’Œè§’è‰²è®¾å®šï¼ˆå•ä¸€å®Œæ•´æ¨¡æ¿ï¼‰ | "ä½ æ˜¯ä¸€ä¸ªè´´å¿ƒçš„ç§˜ä¹¦ï¼Œå›ç­”ç®€æ´æ˜äº†..." |
| å·¥ä½œæµç¨‹è§„åˆ™ | å¤æ‚ä»»åŠ¡çš„æ‰§è¡Œæµç¨‹æŒ‡å¯¼ï¼ˆçº¯æ–‡æœ¬å»ºè®®ï¼‰ | "åˆ›å»ºæ—¥ç¨‹æ—¶ï¼Œå…ˆç¡®è®¤æ—¶é—´ï¼Œå†ç¡®è®¤åœ°ç‚¹ï¼Œæœ€åç¡®è®¤æé†’è®¾ç½®" |

### 1.2 ç”¨æˆ·å¯ç¼–è¾‘ç•Œé¢
åœ¨ è®¾ç½® > æˆ‘çš„ ä¸­æä¾›è®°å¿†ç¼–è¾‘ç•Œé¢ï¼š
- æŸ¥çœ‹æ‰€æœ‰è®°å¿†æ¡ç›®
- æ·»åŠ /ç¼–è¾‘/åˆ é™¤è®°å¿†
- åˆ†ç±»ç®¡ç†

### 1.3 ä¼šè¯çº§ TODO List
ä¸ºæ¯ä¸ªå¯¹è¯æ·»åŠ  TODO List å·¥å…·ï¼š
- é˜²æ­¢ Agent åœ¨é•¿ä»»åŠ¡ä¸­å¿˜è®°æ­¥éª¤
- ä»¥ä¼šè¯ä¸ºå•ä½å­˜å‚¨ï¼Œ**å¯è·¨å¤šè½®å¯¹è¯**
- Agent å¯ä»¥åˆ›å»ºã€æ›´æ–°ã€å®Œæˆ TODO é¡¹
- **å‰ç«¯ä¾§è¾¹æ æ˜¾ç¤º**ï¼šå½“æœ‰ TODO æ—¶ï¼Œåœ¨èŠå¤©ç•Œé¢ä¾§è¾¹æ ä¸Šæ–¹æ˜¾ç¤º TODO é¢æ¿
- **å›æ»šåŒæ­¥**ï¼šå¯¹è¯å›æ»šæ—¶ï¼ŒTODO åˆ—è¡¨åŒæ­¥å›æ»š
- **çŠ¶æ€å¯¹ç…§**ï¼šæ¯æ¬¡ä¿®æ”¹ TODO çŠ¶æ€æ—¶ï¼Œè¿”å›"ä¹‹å‰â†’ä¹‹å"å¯¹ç…§ï¼Œé˜²æ­¢ Agent é—å¿˜

### 1.4 è®°å¿†ä¼˜åŒ–åŠŸèƒ½ï¼ˆæ–°å¢ï¼‰
æä¾›è®°å¿†ä¼˜åŒ–åŠŸèƒ½ï¼Œæ‹¥æœ‰**å…¨å±€è§†è§’**åˆ†ææ•´ä¸ªä¼šè¯å†…å®¹ï¼š

**è§¦å‘æ–¹å¼**ï¼š
1. **è‡ªåŠ¨æç¤º**ï¼šä¼šè¯åˆ‡æ¢/æ–°å»ºä¼šè¯æ—¶ï¼Œè‡ªåŠ¨å¼¹å‡º"æ˜¯å¦ä¼˜åŒ–è®°å¿†"æç¤º
2. **æ‰‹åŠ¨è§¦å‘**ï¼šèŠå¤©ç•Œé¢ä¿ç•™"è®°å¿†ä¼˜åŒ–"æŒ‰é’®ï¼Œç”¨æˆ·å¯éšæ—¶ç‚¹å‡»

**åŠŸèƒ½**ï¼šå¯åŠ¨åå°è¿›ç¨‹åˆ†æä¼šè¯å†…å®¹ï¼Œæ‰§è¡Œè®°å¿†æ•´ç†

**å¤„ç†åœºæ™¯**ï¼š
- ç”¨æˆ·å¤šæ¬¡ä¿®æ”¹ã€çº æ­£å·¥ä½œæµç¨‹ï¼ˆå¦‚"å…ˆAå†B"â†’"ä¸å¯¹ï¼Œåº”è¯¥å…ˆC"ï¼‰
- ç”¨æˆ·ä¿¡æ¯å˜æ›´ï¼ˆå¦‚"æˆ‘ä»¥å‰ä½åŒ—äº¬ï¼Œç°åœ¨æ¬åˆ°ä¸Šæµ·äº†"ï¼‰
- ç¢ç‰‡åŒ–ä¿¡æ¯çš„æ•´åˆå½’çº³

**ä¼˜åŠ¿**ï¼šAgent åœ¨å¯¹è¯ä¸­éš¾ä»¥å¤„ç†çš„å¤æ‚é€»è¾‘å˜æ›´ï¼Œç”±å…¨å±€è§†è§’çš„ä¼˜åŒ–è¿›ç¨‹ç»Ÿä¸€å¤„ç†

---

## äºŒã€ç°æœ‰å®ç°åˆ†æ

### 2.1 ç°æœ‰è®°å¿†å·¥å…· (`agent_service/tools/memory_tools.py`)

ç°æœ‰3ä¸ªè®°å¿†å·¥å…·ï¼š

| å·¥å…·å | åŠŸèƒ½ | å‚æ•° |
|--------|------|------|
| `save_memory` | ä¿å­˜è®°å¿† | content, category(preference/fact/plan/general), importance(1-5) |
| `search_memory` | æœç´¢è®°å¿† | query, category(å¯é€‰) |
| `get_recent_memories` | è·å–æœ€è¿‘è®°å¿† | limit, category(å¯é€‰) |

**åˆ†ç±»ç³»ç»Ÿ**ï¼š
- `preference` - ç”¨æˆ·åå¥½
- `fact` - äº‹å®ä¿¡æ¯  
- `plan` - è®¡åˆ’/å®‰æ’
- `general` - é€šç”¨è®°å¿†

### 2.2 è®°å¿†æ•°æ®æ¨¡å‹ (`agent_service/models.py`)

```python
class UserMemory(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

class MemoryItem(models.Model):
    memory = models.ForeignKey(UserMemory, on_delete=models.CASCADE)
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    content = models.TextField()
    category = models.CharField(max_length=50)  # preference/fact/plan/general
    importance = models.IntegerField(default=3)  # 1-5
    created_at = models.DateTimeField(auto_now_add=True)
```

**é—®é¢˜**ï¼š
- å•ä¸€è¡¨ç»“æ„ï¼Œæ‰€æœ‰è®°å¿†æ··åœ¨ä¸€èµ·
- category ç”¨å­—ç¬¦ä¸²åŒºåˆ†ï¼Œä¸å¤Ÿç»“æ„åŒ–
- æ— æ³•æ”¯æŒç»“æ„åŒ–çš„å·¥ä½œæµè§„åˆ™å­˜å‚¨

### 2.3 ç”¨æˆ·æ•°æ®å­˜å‚¨ç³»ç»Ÿ (`core/models.py`)

å·²æœ‰é€šç”¨çš„ `UserData` æ¨¡å‹å’Œ `DATA_SCHEMA` ç³»ç»Ÿï¼š

```python
class UserData(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    key = models.CharField(max_length=100)  # æ•°æ®ç±»å‹æ ‡è¯†
    value = models.TextField()  # JSONåºåˆ—åŒ–å­˜å‚¨

# DATA_SCHEMA å®šä¹‰æ•°æ®ç»“æ„å’ŒéªŒè¯è§„åˆ™
DATA_SCHEMA = {
    "ai_chatting": { ... },
    "events": { ... },
    # å¯æ‰©å±•æ·»åŠ æ–°çš„key
}
```

**ä¼˜åŠ¿**ï¼šå¯ä»¥åˆ©ç”¨æ­¤ç³»ç»Ÿå­˜å‚¨ç»“æ„åŒ–çš„è®°å¿†æ•°æ®

### 2.4 è®¾ç½®é¡µé¢ç»“æ„ (`core/templates/home.html`)

è®¾ç½®æ¨¡æ€æ¡† (`#settingsModal`) åŒ…å«6ä¸ªæ ‡ç­¾é¡µï¼š
- `basic-settings` - åŸºæœ¬è®¾ç½®
- `schedule-settings` - æ—¥ç¨‹è®¾ç½®
- `display-settings` - æ˜¾ç¤ºè®¾ç½®
- `reminder-settings` - æé†’è®¾ç½®
- `ai-settings` - AIè®¾ç½®
- `profile-settings` - æˆ‘çš„ âœ¨ **ç›®æ ‡ä½ç½®**

**å½“å‰ "æˆ‘çš„" é¡µé¢å†…å®¹**ï¼š
- ç”¨æˆ·å¤´åƒå’Œé‚®ç®±æ˜¾ç¤º
- API Token ç®¡ç†ï¼ˆåˆ›å»º/å¤åˆ¶/åˆ é™¤ï¼‰

---

## ä¸‰ã€è¯¦ç»†è®¾è®¡æ–¹æ¡ˆ

### 3.1 æ•°æ®æ¨¡å‹è®¾è®¡

é‡‡ç”¨ç‹¬ç«‹æ¨¡å‹æ–¹æ¡ˆï¼š

```python
# agent_service/models.py

class UserPersonalInfo(models.Model):
    """ç”¨æˆ·ä¸ªäººä¿¡æ¯è®°å¿†"""
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    key = models.CharField(max_length=100)  # å¦‚ "å§“å", "ç”Ÿæ—¥", "é¥®é£Ÿåå¥½"
    value = models.TextField()
    description = models.TextField(blank=True)  # è¡¥å……è¯´æ˜
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        unique_together = ['user', 'key']

class DialogStyle(models.Model):
    """å¯¹è¯é£æ ¼/è§’è‰²è®¾å®š - æ¯ç”¨æˆ·ä¸€ä¸ªå®Œæ•´æ¨¡æ¿"""
    user = models.OneToOneField(User, on_delete=models.CASCADE)  # æ”¹ä¸º OneToOne
    content = models.TextField()  # å®Œæ•´çš„å¯¹è¯é£æ ¼æ¨¡æ¿
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    # é»˜è®¤æ¨¡æ¿
    DEFAULT_TEMPLATE = """ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½æ—¥ç¨‹ç®¡ç†åŠ©æ‰‹ã€‚
ä½ çš„èŒè´£æ˜¯å¸®åŠ©ç”¨æˆ·ç®¡ç†æ—¥ç¨‹ã€æé†’ã€å¾…åŠäº‹é¡¹ã€‚
å›ç­”é£æ ¼ï¼šç®€æ´æ˜äº†ï¼Œå‹å¥½ä¸“ä¸šã€‚
å½“éœ€è¦æ‰§è¡Œæ“ä½œæ—¶ï¼Œä½¿ç”¨å¯ç”¨çš„å·¥å…·å®Œæˆä»»åŠ¡ã€‚
å¦‚æœç”¨æˆ·æå‡ºäº†å¤æ‚çš„å¤šæ­¥éª¤ä»»åŠ¡ï¼Œä½ å¯ä»¥ä½¿ç”¨å·¥ä½œæµè§„åˆ™æ¥æŒ‡å¯¼æ‰§è¡Œé¡ºåºã€‚"""

class WorkflowRule(models.Model):
    """å·¥ä½œæµç¨‹è§„åˆ™ - çº¯æ–‡æœ¬å»ºè®®"""
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    name = models.CharField(max_length=100)  # è§„åˆ™åç§°ï¼Œå¦‚ "åˆ›å»ºæ—¥ç¨‹æµç¨‹"
    trigger = models.CharField(max_length=200)  # è§¦å‘æ¡ä»¶æè¿°
    steps = models.TextField()  # çº¯æ–‡æœ¬æ­¥éª¤æè¿°
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

class SessionTodoItem(models.Model):
    """ä¼šè¯çº§ TODO åˆ—è¡¨ - æ”¯æŒè·¨å¯¹è¯å’Œå›æ»š"""
    session = models.ForeignKey('AgentSession', on_delete=models.CASCADE)
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    title = models.CharField(max_length=200)
    description = models.TextField(blank=True)
    status = models.CharField(max_length=20, default='pending')  # pending/in_progress/done
    order = models.IntegerField(default=0)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

class SessionTodoSnapshot(models.Model):
    """TODO åˆ—è¡¨å¿«ç…§ - ç”¨äºå›æ»šåŒæ­¥ï¼ˆç±»ä¼¼æ—¥ç¨‹å›æ»šæœºåˆ¶ï¼‰"""
    session = models.ForeignKey('AgentSession', on_delete=models.CASCADE)
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    checkpoint_id = models.CharField(max_length=100)  # å¯¹åº”çš„å¯¹è¯æ£€æŸ¥ç‚¹ID
    snapshot_data = models.TextField()  # JSON: è¯¥æ£€æŸ¥ç‚¹æ—¶åˆ»çš„ TODO åˆ—è¡¨å®Œæ•´çŠ¶æ€
    created_at = models.DateTimeField(auto_now_add=True)
```

**æ•°æ®è¿ç§»**ï¼šç°æœ‰ `MemoryItem` æ•°æ®å…¨éƒ¨è¿ç§»åˆ° `UserPersonalInfo` è¡¨ã€‚

### 3.2 å·¥å…·æ¥å£è®¾è®¡

#### ä¸ªäººä¿¡æ¯å·¥å…·

```python
@tool
def save_personal_info(key: str, value: str, description: str = "") -> str:
    """ä¿å­˜ç”¨æˆ·ä¸ªäººä¿¡æ¯ï¼ˆæ–°å¢æˆ–æ›´æ–°ï¼‰"""

@tool  
def get_personal_info(key: str = None) -> str:
    """è·å–ç”¨æˆ·ä¸ªäººä¿¡æ¯ï¼ˆå¯æŒ‡å®škeyæˆ–è·å–å…¨éƒ¨ï¼‰"""

@tool
def update_personal_info(key: str, new_value: str, new_description: str = None) -> str:
    """æ›´æ–°å·²æœ‰çš„ä¸ªäººä¿¡æ¯"""

@tool
def delete_personal_info(key: str) -> str:
    """åˆ é™¤æŒ‡å®šçš„ä¸ªäººä¿¡æ¯"""
```

#### å¯¹è¯é£æ ¼å·¥å…·

```python
@tool
def get_dialog_style() -> str:
    """è·å–å½“å‰å¯¹è¯é£æ ¼æ¨¡æ¿"""

@tool
def update_dialog_style(content: str) -> str:
    """æ›´æ–°å¯¹è¯é£æ ¼æ¨¡æ¿"""
```

#### å·¥ä½œæµè§„åˆ™å·¥å…·

```python
@tool
def save_workflow_rule(name: str, trigger: str, steps: str) -> str:
    """ä¿å­˜å·¥ä½œæµç¨‹è§„åˆ™ï¼ˆçº¯æ–‡æœ¬ï¼‰"""

@tool
def get_workflow_rules(trigger: str = None) -> str:
    """è·å–å·¥ä½œæµè§„åˆ™ï¼ˆå¯æŒ‰è§¦å‘æ¡ä»¶ç­›é€‰ï¼‰"""

@tool
def update_workflow_rule(name: str, trigger: str = None, steps: str = None, is_active: bool = None) -> str:
    """æ›´æ–°å·¥ä½œæµè§„åˆ™"""

@tool
def delete_workflow_rule(name: str) -> str:
    """åˆ é™¤å·¥ä½œæµè§„åˆ™"""
```

#### TODO List å·¥å…·ï¼ˆå«çŠ¶æ€å¯¹ç…§ï¼‰

```python
@tool
def create_todo(title: str, description: str = "") -> str:
    """åˆ›å»ºå½“å‰ä¼šè¯çš„ TODO é¡¹
    è¿”å›ï¼šæ–°åˆ›å»ºçš„ TODO ä¿¡æ¯
    """

@tool
def update_todo_status(todo_id: int, new_status: str) -> str:
    """æ›´æ–° TODO çŠ¶æ€ (pending/in_progress/done)
    è¿”å›æ ¼å¼ï¼š
    âœ… TODO #{id} çŠ¶æ€å·²æ›´æ–°
    ã€ä¹‹å‰ã€‘{old_status}: {title}
    ã€ä¹‹åã€‘{new_status}: {title}
    
    å½“å‰ TODO åˆ—è¡¨ï¼š
    1. [pending] ä»»åŠ¡A
    2. [in_progress] ä»»åŠ¡B  â† åˆšæ›´æ–°
    3. [done] ä»»åŠ¡C
    """

@tool
def get_session_todos() -> str:
    """è·å–å½“å‰ä¼šè¯çš„æ‰€æœ‰ TODO"""

@tool
def clear_completed_todos() -> str:
    """æ¸…é™¤å·²å®Œæˆçš„ TODO"""
```

### 3.3 å‰ç«¯ç•Œé¢è®¾è®¡

#### 3.3.1 è®¾ç½® > æˆ‘çš„ - è®°å¿†ç®¡ç†ç•Œé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [ç”¨æˆ·å¤´åƒ] ç”¨æˆ·å                                       â”‚
â”‚  é‚®ç®±: user@example.com                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“Œ ä¸ªäººä¿¡æ¯                            [+ æ·»åŠ ]        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ å§“å: å¼ ä¸‰                              [ç¼–è¾‘][åˆ é™¤]â”‚ â”‚
â”‚  â”‚ ç”Ÿæ—¥: 1æœˆ15æ—¥                           [ç¼–è¾‘][åˆ é™¤]â”‚ â”‚
â”‚  â”‚ å±…ä½åŸå¸‚: ä¸Šæµ·                          [ç¼–è¾‘][åˆ é™¤]â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ’¬ å¯¹è¯é£æ ¼                              [é‡ç½®ä¸ºé»˜è®¤]  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ [å¯ç¼–è¾‘æ–‡æœ¬æ¡†]                                     â”‚ â”‚
â”‚  â”‚ ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½æ—¥ç¨‹ç®¡ç†åŠ©æ‰‹ã€‚                         â”‚ â”‚
â”‚  â”‚ ä½ çš„èŒè´£æ˜¯å¸®åŠ©ç”¨æˆ·ç®¡ç†æ—¥ç¨‹ã€æé†’ã€å¾…åŠäº‹é¡¹ã€‚        â”‚ â”‚
â”‚  â”‚ å›ç­”é£æ ¼ï¼šç®€æ´æ˜äº†ï¼Œå‹å¥½ä¸“ä¸šã€‚                      â”‚ â”‚
â”‚  â”‚ ...                                               â”‚ â”‚
â”‚  â”‚                                      [ä¿å­˜ä¿®æ”¹]   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âš™ï¸ å·¥ä½œæµç¨‹                            [+ æ·»åŠ ]        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ â˜‘ åˆ›å»ºæ—¥ç¨‹æµç¨‹                          [ç¼–è¾‘][åˆ é™¤]â”‚ â”‚
â”‚  â”‚   è§¦å‘: å½“ç”¨æˆ·è¦æ±‚åˆ›å»ºæ—¥ç¨‹æ—¶                       â”‚ â”‚
â”‚  â”‚   æ­¥éª¤: 1.ç¡®è®¤æ—¶é—´ â†’ 2.ç¡®è®¤åœ°ç‚¹ â†’ 3.è®¾ç½®æé†’       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”‘ API Token ç®¡ç†                                      â”‚
â”‚  [åˆ›å»ºæ–°Token] [å¤åˆ¶Token] [åˆ é™¤Token]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.3.2 èŠå¤©ç•Œé¢ - TODO é¢æ¿ï¼ˆä¾§è¾¹æ ä¸Šæ–¹ï¼‰

å½“ä¼šè¯æœ‰ TODO é¡¹æ—¶ï¼Œåœ¨ä¾§è¾¹æ ä¸Šæ–¹æ˜¾ç¤ºï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‹ ä»»åŠ¡åˆ—è¡¨                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ â˜ 1. æŸ¥è¯¢æ˜å¤©çš„æ—¥ç¨‹        â”‚â”‚
â”‚  â”‚ â³ 2. åˆ›å»ºæ–°æ—¥ç¨‹           â”‚â”‚
â”‚  â”‚ âœ… 3. è®¾ç½®æé†’             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                 â”‚
â”‚  [æ­£å¸¸çš„èŠå¤©å†å²åŒºåŸŸ]            â”‚
â”‚  ...                            â”‚
```

çŠ¶æ€å›¾æ ‡ï¼š
- â˜ `pending` - å¾…å¤„ç†
- â³ `in_progress` - è¿›è¡Œä¸­
- âœ… `done` - å·²å®Œæˆ

#### 3.3.3 èŠå¤©ç•Œé¢ - è®°å¿†ä¼˜åŒ–æŒ‰é’®

åœ¨èŠå¤©è¾“å…¥æ¡†åŒºåŸŸæ·»åŠ "è®°å¿†ä¼˜åŒ–"æŒ‰é’®ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [è¾“å…¥æ¡†...]                                            â”‚
â”‚                          [è®°å¿†ä¼˜åŒ–] [å‘é€]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ç‚¹å‡»åï¼š
1. æŒ‰é’®å˜ä¸ºç¦ç”¨çŠ¶æ€ï¼Œæ˜¾ç¤º"ä¼˜åŒ–ä¸­..."
2. Agent åŒºåŸŸæ˜¾ç¤ºå¤„ç†è¿›åº¦
3. å®Œæˆåæ˜¾ç¤ºä¼˜åŒ–ç»“æœæ‘˜è¦

### 3.4 ç³»ç»Ÿ Prompt é›†æˆ

**è®¾è®¡åŸåˆ™**ï¼š
- å¯¹è¯é£æ ¼æ¨¡æ¿ç›´æ¥ä½œä¸º system prompt ä¸»ä½“
- å·¥ä½œæµè§„åˆ™**ä¸é¢„åŠ è½½**ï¼Œåªæç¤º Agent å¯ä»¥æŸ¥è¯¢ä½¿ç”¨
- ä¸ªäººä¿¡æ¯å¯é€‰æ‹©æ€§åŠ è½½æ‘˜è¦

```python
def build_system_prompt(user):
    # 1. åŠ è½½ç”¨æˆ·çš„å¯¹è¯é£æ ¼æ¨¡æ¿ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤æ¨¡æ¿
    try:
        dialog_style = DialogStyle.objects.get(user=user)
        base_prompt = dialog_style.content
    except DialogStyle.DoesNotExist:
        base_prompt = DialogStyle.DEFAULT_TEMPLATE
    
    # 2. æ·»åŠ å·¥ä½œæµæç¤ºï¼ˆä¸é¢„åŠ è½½è§„åˆ™å†…å®¹ï¼‰
    workflow_hint = """

## å·¥ä½œæµè§„åˆ™
å¦‚æœç”¨æˆ·ç»™ä½ å¸ƒç½®äº†å¤æ‚çš„å¤šæ­¥éª¤ä»»åŠ¡ï¼Œä½ å¯ä»¥ï¼š
1. ä½¿ç”¨ `get_workflow_rules` å·¥å…·æŸ¥è¯¢æ˜¯å¦æœ‰ç›¸å…³çš„å·¥ä½œæµè§„åˆ™
2. æŒ‰ç…§è§„åˆ™æŒ‡å¯¼çš„æ­¥éª¤æ‰§è¡Œä»»åŠ¡
3. å¦‚æœç”¨æˆ·çº æ­£äº†æŸä¸ªæµç¨‹ï¼Œä½¿ç”¨ `update_workflow_rule` æ›´æ–°è§„åˆ™
"""
    
    # 3. å¯é€‰ï¼šåŠ è½½å°‘é‡å…³é”®ä¸ªäººä¿¡æ¯
    key_infos = UserPersonalInfo.objects.filter(user=user)[:5]
    if key_infos.exists():
        info_hint = "\n\n## ç”¨æˆ·åŸºæœ¬ä¿¡æ¯\n" + "\n".join([f"- {i.key}: {i.value}" for i in key_infos])
    else:
        info_hint = ""
    
    return base_prompt + workflow_hint + info_hint
```

**æ³¨æ„**ï¼šè¿™ä¸ªè®¾è®¡è®©ç”¨æˆ·å¯ä»¥å®Œå…¨è‡ªå®šä¹‰ Agent çš„"äººæ ¼"ï¼ŒåŒæ—¶ä¿æŒå·¥ä½œæµè§„åˆ™çš„æŒ‰éœ€åŠ è½½ã€‚

### 3.5 è®°å¿†ä¼˜åŒ–è¿›ç¨‹è®¾è®¡ï¼ˆæ–°å¢ï¼‰

#### è§¦å‘æµç¨‹

```
ç”¨æˆ·ç‚¹å‡» [è®°å¿†ä¼˜åŒ–] 
    â†“
å‰ç«¯å‘é€è¯·æ±‚åˆ° /api/agent/optimize-memory/
    â†“
åç«¯å¯åŠ¨å¼‚æ­¥ä»»åŠ¡ï¼ˆæˆ–åŒæ­¥å¤„ç†ï¼‰
    â†“
è¿”å›ä¼˜åŒ–ç»“æœæ‘˜è¦
```

#### ä¼˜åŒ–è¿›ç¨‹é€»è¾‘

```python
def optimize_memory(user, session_id):
    """
    åˆ†æä¼šè¯å†…å®¹ï¼Œä¼˜åŒ–è®°å¿†è¡¨
    """
    # 1. è·å–å½“å‰ä¼šè¯çš„æ‰€æœ‰å¯¹è¯å†…å®¹
    session = AgentSession.objects.get(id=session_id, user=user)
    messages = get_session_messages(session)  # ä» checkpointer è·å–
    
    # 2. æ„å»ºä¼˜åŒ– prompt
    optimize_prompt = f"""
ä½ æ˜¯ä¸€ä¸ªè®°å¿†ä¼˜åŒ–åŠ©æ‰‹ã€‚è¯·åˆ†æä»¥ä¸‹å¯¹è¯å†…å®¹ï¼Œå¹¶å†³å®šéœ€è¦å¯¹ç”¨æˆ·è®°å¿†è¿›è¡Œå“ªäº›æ“ä½œã€‚

## å½“å‰ç”¨æˆ·ä¸ªäººä¿¡æ¯
{format_personal_info(user)}

## å½“å‰å·¥ä½œæµè§„åˆ™
{format_workflow_rules(user)}

## æœ¬æ¬¡å¯¹è¯å†…å®¹
{format_messages(messages)}

## ä½ çš„ä»»åŠ¡
åˆ†æå¯¹è¯ä¸­çš„ä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦ï¼š
1. æ–°å¢ä¸ªäººä¿¡æ¯ï¼ˆç”¨æˆ·æåˆ°çš„æ–°äº‹å®ï¼‰
2. æ›´æ–°ä¸ªäººä¿¡æ¯ï¼ˆç”¨æˆ·çº æ­£çš„æ—§ä¿¡æ¯ï¼Œå¦‚"æˆ‘ä»¥å‰ä½åŒ—äº¬ï¼Œç°åœ¨æ¬ä¸Šæµ·äº†"ï¼‰
3. åˆ é™¤è¿‡æ—¶çš„ä¸ªäººä¿¡æ¯
4. æ–°å¢/æ›´æ–°/åˆ é™¤å·¥ä½œæµè§„åˆ™ï¼ˆç”¨æˆ·å¤šæ¬¡ä¿®æ”¹çš„æµç¨‹æŒ‡å¯¼ï¼‰

è¯·ä»¥ JSON æ ¼å¼è¾“å‡ºä½ çš„æ“ä½œå»ºè®®ï¼š
{{
  "personal_info": {{
    "add": [{{"key": "...", "value": "...", "description": "..."}}],
    "update": [{{"key": "...", "new_value": "...", "reason": "..."}}],
    "delete": [{{"key": "...", "reason": "..."}}]
  }},
  "workflow_rules": {{
    "add": [{{"name": "...", "trigger": "...", "steps": "..."}}],
    "update": [{{"name": "...", "new_steps": "...", "reason": "..."}}],
    "delete": [{{"name": "...", "reason": "..."}}]
  }},
  "summary": "æœ¬æ¬¡ä¼˜åŒ–çš„ç®€è¦è¯´æ˜"
}}
"""
    
    # 3. è°ƒç”¨ LLM åˆ†æ
    result = call_llm(optimize_prompt)
    
    # 4. è§£æå¹¶æ‰§è¡Œæ“ä½œ
    operations = parse_operations(result)
    execute_memory_operations(user, operations)
    
    # 5. è¿”å›æ‘˜è¦
    return operations['summary']
```

#### ä¼˜åŒ–åœºæ™¯ç¤ºä¾‹

**åœºæ™¯1ï¼šä¿¡æ¯çº æ­£**
```
å¯¹è¯å†…å®¹ï¼š
ç”¨æˆ·: å¸®æˆ‘æŸ¥ä¸€ä¸‹åŒ—äº¬çš„å¤©æ°”
Agent: å¥½çš„ï¼ŒåŒ—äº¬ä»Šå¤©...ï¼ˆæŸ¥è¯¢äº†ç”¨æˆ·è®°å¿†å‘ç°å±…ä½åŸå¸‚æ˜¯åŒ—äº¬ï¼‰
ç”¨æˆ·: å“¦å¯¹äº†ï¼Œæˆ‘ç°åœ¨æ¬åˆ°ä¸Šæµ·äº†

ä¼˜åŒ–ç»“æœï¼š
- æ›´æ–°ä¸ªäººä¿¡æ¯ï¼šå±…ä½åŸå¸‚ "åŒ—äº¬" â†’ "ä¸Šæµ·"
- åŸå› ï¼šç”¨æˆ·æ˜ç¡®è¡¨ç¤ºå·²æ¬å®¶
```

**åœºæ™¯2ï¼šå·¥ä½œæµæ•´åˆ**
```
å¯¹è¯å†…å®¹ï¼š
ç”¨æˆ·: å¸®æˆ‘åˆ›å»ºæ—¥ç¨‹çš„æ—¶å€™ï¼Œå…ˆç¡®è®¤æ—¶é—´
Agent: å¥½çš„ï¼Œæˆ‘è®°ä½äº†
ç”¨æˆ·: è¿˜è¦ç¡®è®¤åœ°ç‚¹
Agent: å¥½çš„
ç”¨æˆ·: ä¸å¯¹ï¼Œåº”è¯¥å…ˆç¡®è®¤æœ‰æ²¡æœ‰å†²çªï¼Œå†ç¡®è®¤æ—¶é—´

ä¼˜åŒ–ç»“æœï¼š
- æ–°å¢/æ›´æ–°å·¥ä½œæµï¼šåˆ›å»ºæ—¥ç¨‹æµç¨‹
- æ­¥éª¤ï¼š1.æ£€æŸ¥æ—¶é—´å†²çª â†’ 2.ç¡®è®¤æ—¶é—´ â†’ 3.ç¡®è®¤åœ°ç‚¹
```

---

## å››ã€å®æ–½è®¡åˆ’

### Phase 1: æ•°æ®æ¨¡å‹å‡çº§ âœ… å·²å®Œæˆ
- [x] 1.1 åˆ›å»ºæ–°æ¨¡å‹æ–‡ä»¶æˆ–æ›´æ–° `agent_service/models.py`
  - [x] UserPersonalInfo æ¨¡å‹
  - [x] DialogStyle æ¨¡å‹ï¼ˆå« DEFAULT_TEMPLATE ç¡¬ç¼–ç ï¼‰
  - [x] WorkflowRule æ¨¡å‹
  - [x] SessionTodoItem æ¨¡å‹
  - [x] SessionTodoSnapshot æ¨¡å‹ï¼ˆå¿«ç…§è¡¨ï¼‰
- [ ] 1.2 æ‰§è¡Œæ•°æ®åº“è¿ç§» `python manage.py makemigrations && migrate`
- [x] 1.3 ç¼–å†™æ•°æ®è¿ç§»è„šæœ¬ï¼šMemoryItem â†’ UserPersonalInfo
  - è„šæœ¬ä½ç½®: `agent_service/migrations/migrate_memory_data.py`
- [x] 1.4 ç¼–å†™åˆå§‹åŒ–è„šæœ¬ï¼šä¸ºç°æœ‰ç”¨æˆ·åˆ›å»ºé»˜è®¤ DialogStyle
  - åŒ…å«åœ¨è¿ç§»è„šæœ¬ä¸­

### Phase 2: åç«¯å·¥å…·å‡çº§ âœ… å·²å®Œæˆ
- [x] 2.1 åˆ›å»ºä¸ªäººä¿¡æ¯å·¥å…· (`memory_tools_v2.py`)
  - [x] save_personal_info
  - [x] get_personal_info
  - [x] update_personal_info
  - [x] delete_personal_info
- [x] 2.2 åˆ›å»ºå¯¹è¯é£æ ¼å·¥å…·
  - [x] get_dialog_style
  - [x] update_dialog_style
- [x] 2.3 åˆ›å»ºå·¥ä½œæµè§„åˆ™å·¥å…·
  - [x] save_workflow_rule
  - [x] get_workflow_rules
  - [x] update_workflow_rule
  - [x] delete_workflow_rule
- [x] 2.4 åˆ›å»º TODO List å·¥å…· (`todo_tools.py`)
  - [x] create_todoï¼ˆå«å¿«ç…§ä¿å­˜é€»è¾‘ï¼‰
  - [x] update_todo_statusï¼ˆå«"ä¹‹å‰â†’ä¹‹å"å¯¹ç…§è¾“å‡ºï¼‰
  - [x] get_session_todos
  - [x] clear_completed_todos
- [x] 2.5 æ³¨å†Œæ‰€æœ‰æ–°å·¥å…·åˆ°å·¥å…·ç»‘å®šå™¨
  - æ›´æ–°äº† `agent_graph.py` çš„ TOOL_CATEGORIES å’Œ ALL_TOOLS
- [x] 2.6 ä¿®æ”¹ system prompt æ„å»ºé€»è¾‘
  - [x] åŠ è½½ç”¨æˆ· DialogStyleï¼ˆæˆ–é»˜è®¤æ¨¡æ¿ï¼‰
  - [x] æ·»åŠ å·¥ä½œæµè§„åˆ™æŸ¥è¯¢æç¤º
  - [x] å¯é€‰åŠ è½½å°‘é‡ä¸ªäººä¿¡æ¯
  - æ–°å¢ `build_system_prompt()` å‡½æ•°

### Phase 3: TODO å›æ»šåŒæ­¥
- [ ] 3.1 å®ç° save_todo_snapshot å‡½æ•°
- [ ] 3.2 åœ¨ TODO å·¥å…·ä¸­é›†æˆå¿«ç…§ä¿å­˜
- [ ] 3.3 å®ç° rollback_todos å‡½æ•°
- [ ] 3.4 åœ¨ç°æœ‰å¯¹è¯å›æ»šé€»è¾‘ä¸­é›†æˆ TODO å›æ»š

### Phase 4: è®°å¿†ä¼˜åŒ–åŠŸèƒ½
- [ ] 4.1 åˆ›å»ºä¼˜åŒ–è¿›ç¨‹ API ç«¯ç‚¹ `/api/agent/optimize-memory/`
- [ ] 4.2 å®ç°ä¼˜åŒ– prompt æ¨¡æ¿
- [ ] 4.3 å®ç° LLM åˆ†æé€»è¾‘
- [ ] 4.4 å®ç°æ“ä½œè§£æå’Œæ‰§è¡Œé€»è¾‘
- [ ] 4.5 å‰ç«¯ï¼šèŠå¤©ç•Œé¢æ·»åŠ "è®°å¿†ä¼˜åŒ–"æŒ‰é’®
- [ ] 4.6 å‰ç«¯ï¼šä¼šè¯åˆ‡æ¢/æ–°å»ºæ—¶å¼¹å‡ºä¼˜åŒ–æç¤º

### Phase 5: å‰ç«¯ç•Œé¢ - è®°å¿†ç®¡ç†
- [ ] 5.1 è®¾ç½® > æˆ‘çš„é¡µé¢ - ä¸ªäººä¿¡æ¯ç®¡ç†
  - [ ] ä¿¡æ¯åˆ—è¡¨å±•ç¤º
  - [ ] æ·»åŠ /ç¼–è¾‘/åˆ é™¤åŠŸèƒ½
- [ ] 5.2 è®¾ç½® > æˆ‘çš„é¡µé¢ - å¯¹è¯é£æ ¼ç¼–è¾‘å™¨
  - [ ] æ–‡æœ¬ç¼–è¾‘åŒº
  - [ ] é‡ç½®ä¸ºé»˜è®¤æŒ‰é’®
  - [ ] ä¿å­˜æŒ‰é’®
- [ ] 5.3 è®¾ç½® > æˆ‘çš„é¡µé¢ - å·¥ä½œæµè§„åˆ™ç®¡ç†
  - [ ] è§„åˆ™åˆ—è¡¨å±•ç¤º
  - [ ] æ·»åŠ /ç¼–è¾‘/åˆ é™¤åŠŸèƒ½
  - [ ] å¯ç”¨/ç¦ç”¨å¼€å…³
- [ ] 5.4 å®ç°åç«¯ CRUD API ç«¯ç‚¹

### Phase 6: å‰ç«¯ç•Œé¢ - TODO é¢æ¿
- [ ] 6.1 èŠå¤©ç•Œé¢ä¾§è¾¹æ ä¸Šæ–¹æ·»åŠ  TODO é¢æ¿å®¹å™¨
- [ ] 6.2 å®ç° TODO åˆ—è¡¨æ¸²æŸ“ï¼ˆå«çŠ¶æ€å›¾æ ‡ï¼‰
- [ ] 6.3 WebSocket é›†æˆï¼šå®æ—¶æ›´æ–° TODO æ˜¾ç¤º
- [ ] 6.4 TODO é¢æ¿æ˜¾ç¤º/éšè—é€»è¾‘ï¼ˆæœ‰å†…å®¹æ—¶æ˜¾ç¤ºï¼‰

### Phase 7: æµ‹è¯•ä¸ä¼˜åŒ–
- [ ] 7.1 å•å…ƒæµ‹è¯•ï¼šå„å·¥å…·åŠŸèƒ½
- [ ] 7.2 é›†æˆæµ‹è¯•ï¼šå›æ»šåŒæ­¥
- [ ] 7.3 é›†æˆæµ‹è¯•ï¼šè®°å¿†ä¼˜åŒ–æµç¨‹
- [ ] 7.4 å‰ç«¯äº¤äº’æµ‹è¯•
- [ ] 7.5 æ€§èƒ½ä¼˜åŒ–ï¼ˆå¦‚æœ‰éœ€è¦ï¼‰

---

## äº”ã€å·²ç¡®è®¤çš„å†³ç­–

| é—®é¢˜ | å†³ç­– |
|------|------|
| ç°æœ‰æ•°æ®è¿ç§» | âœ… è¿ç§»åˆ° UserPersonalInfo è¡¨ |
| TODO List æ˜¾ç¤º | âœ… å‰ç«¯ä¾§è¾¹æ ä¸Šæ–¹æ˜¾ç¤º TODO é¢æ¿ |
| TODO è·¨å¯¹è¯ | âœ… æ”¯æŒï¼Œå›æ»šæ—¶åŒæ­¥å›æ»š TODO |
| TODO å›æ»šæ–¹å¼ | âœ… å¿«ç…§æœºåˆ¶ï¼ˆç±»ä¼¼æ—¥ç¨‹å›æ»šï¼‰ï¼Œæ¯è½®å¯¹è¯ä¿®æ”¹TODOå‰ä¿å­˜å¿«ç…§ |
| TODO çŠ¶æ€æ›´æ–° | âœ… è¿”å›"ä¹‹å‰â†’ä¹‹å"å¯¹ç…§ |
| å·¥ä½œæµè§„åˆ™æ ¼å¼ | âœ… çº¯æ–‡æœ¬ï¼ˆæŒ‡å¯¼æ€§å»ºè®®ï¼‰ |
| å®¹é‡é™åˆ¶ | âœ… æš‚ä¸é™åˆ¶ |
| å¯¹è¯é£æ ¼ | âœ… å•ä¸€å®Œæ•´æ¨¡æ¿ï¼Œå¯ç”¨æˆ·è‡ªå®šä¹‰ |
| å¯¹è¯é£æ ¼é»˜è®¤æ¨¡æ¿ | âœ… ä»£ç ç¡¬ç¼–ç ï¼ˆæš‚ä¸éœ€è¦é…ç½®ï¼‰ |
| å·¥ä½œæµé¢„åŠ è½½ | âŒ ä¸é¢„åŠ è½½ï¼Œåªæç¤º Agent å¯æŸ¥è¯¢ä½¿ç”¨ |
| ä¸ªäººä¿¡æ¯ key å‘½å | âœ… æš‚ä¸é¢„å®šä¹‰ï¼Œç”± Agent è‡ªç”±å‘½å |
| è®°å¿†ä¼˜åŒ–è§¦å‘ | âœ… ä¼šè¯åˆ‡æ¢/æ–°å»ºæ—¶è‡ªåŠ¨æç¤º + ä¿ç•™æ‰‹åŠ¨æŒ‰é’® |

---

## å…­ã€æŠ€æœ¯è¦ç‚¹

### 6.1 TODO å›æ»šåŒæ­¥ï¼ˆå¿«ç…§æœºåˆ¶ï¼‰

é‡‡ç”¨ä¸ç°æœ‰æ—¥ç¨‹å›æ»šç›¸åŒçš„å¿«ç…§æœºåˆ¶ï¼š

**åŸç†**ï¼šæ¯è½®å¯¹è¯ä¸­ï¼Œå¦‚æœæ¶‰åŠä¿®æ”¹ TODO Listï¼Œåœ¨ä¿®æ”¹ä¹‹å‰ä¿å­˜ä¸€ä»½åˆ—è¡¨çš„å®Œæ•´å¿«ç…§ã€‚

```python
def save_todo_snapshot(session, checkpoint_id):
    """åœ¨ä¿®æ”¹ TODO å‰ä¿å­˜å¿«ç…§"""
    todos = SessionTodoItem.objects.filter(session=session)
    snapshot_data = json.dumps([{
        'id': t.id,
        'title': t.title,
        'description': t.description,
        'status': t.status,
        'order': t.order
    } for t in todos])
    
    SessionTodoSnapshot.objects.create(
        session=session,
        user=session.user,
        checkpoint_id=checkpoint_id,
        snapshot_data=snapshot_data
    )

def rollback_todos(session_id, target_checkpoint):
    """å›æ»š TODO åˆ—è¡¨åˆ°æŒ‡å®šæ£€æŸ¥ç‚¹"""
    # 1. æ‰¾åˆ°è¯¥æ£€æŸ¥ç‚¹çš„å¿«ç…§
    snapshot = SessionTodoSnapshot.objects.filter(
        session_id=session_id,
        checkpoint_id=target_checkpoint
    ).first()
    
    if not snapshot:
        # å¦‚æœæ²¡æœ‰å¿«ç…§ï¼Œè¯´æ˜è¯¥æ£€æŸ¥ç‚¹æ—¶æ²¡æœ‰ TODOï¼Œæ¸…ç©ºåˆ—è¡¨
        SessionTodoItem.objects.filter(session_id=session_id).delete()
        return
    
    # 2. æ¢å¤å¿«ç…§æ•°æ®
    snapshot_todos = json.loads(snapshot.snapshot_data)
    
    # 3. æ¸…ç©ºå½“å‰ TODOï¼Œé‡å»ºå¿«ç…§çŠ¶æ€
    SessionTodoItem.objects.filter(session_id=session_id).delete()
    for todo_data in snapshot_todos:
        SessionTodoItem.objects.create(
            session_id=session_id,
            user_id=snapshot.user_id,
            **todo_data
        )
    
    # 4. åˆ é™¤è¯¥æ£€æŸ¥ç‚¹ä¹‹åçš„å¿«ç…§
    SessionTodoSnapshot.objects.filter(
        session_id=session_id,
        checkpoint_id__gt=target_checkpoint
    ).delete()
```

**ä¼˜åŠ¿**ï¼š
- ä¸ç°æœ‰æ—¥ç¨‹å›æ»šæœºåˆ¶ä¸€è‡´ï¼Œä»£ç æ¨¡å¼ç»Ÿä¸€
- ç²¾ç¡®æ¢å¤ä»»æ„æ£€æŸ¥ç‚¹çš„ TODO çŠ¶æ€
- æ”¯æŒ TODO çš„ä»»æ„ä¿®æ”¹ï¼ˆå¢åˆ æ”¹çŠ¶æ€ï¼‰éƒ½èƒ½æ­£ç¡®å›æ»š

### 6.2 è®°å¿†ä¼˜åŒ–çš„è°ƒç”¨æ–¹å¼

ä¸¤ç§å¯é€‰æ–¹æ¡ˆï¼š
- **åŒæ­¥è°ƒç”¨**ï¼šç”¨æˆ·ç­‰å¾…ä¼˜åŒ–å®Œæˆï¼ˆé€‚åˆå¿«é€Ÿ LLMï¼‰
- **å¼‚æ­¥ä»»åŠ¡**ï¼šä½¿ç”¨ Celery ç­‰ä»»åŠ¡é˜Ÿåˆ—ï¼ˆé€‚åˆè€—æ—¶è¾ƒé•¿çš„åœºæ™¯ï¼‰

å»ºè®®å…ˆç”¨åŒæ­¥è°ƒç”¨ï¼Œæ˜¾ç¤º loading çŠ¶æ€ã€‚

---

## ä¸ƒã€å‚è€ƒä»£ç ä½ç½®

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `agent_service/models.py` | ç°æœ‰è®°å¿†æ¨¡å‹ |
| `agent_service/tools/memory_tools.py` | ç°æœ‰è®°å¿†å·¥å…· |
| `agent_service/agent_graph.py` | Agent ä¸»é€»è¾‘ |
| `core/templates/home.html` | è®¾ç½®é¡µé¢æ¨¡æ¿ |
| `core/static/js/settings-manager.js` | è®¾ç½®ç®¡ç†å™¨ |
| `core/static/js/agent-chat.js` | Agent èŠå¤©é€»è¾‘ |
| `core/models.py` | UserData æ¨¡å‹å‚è€ƒ |
