# 邮件功能优雅降级 - 测试清单

## 测试前准备

### 环境 1: 测试模式（默认）
```bash
# 确保 email.json 不存在
cd d:\PROJECTS\UniSchedulerSuper\config
del email.json  # 如果存在的话

# 启动服务器
cd d:\PROJECTS\UniSchedulerSuper
python manage.py runserver
```

### 环境 2: 生产模式
```bash
# 确保 email.json 存在且配置正确
cd d:\PROJECTS\UniSchedulerSuper\config
# 如果不存在，复制并编辑：
# copy email.example.json email.json
# 编辑 email.json，设置 enabled=true

# 测试 SMTP 连接
cd d:\PROJECTS\UniSchedulerSuper
python test_smtp_config.py

# 启动服务器
python manage.py runserver
```

---

## 测试清单

### ✅ 测试 1: 注册页面 - 测试模式

**步骤**:
1. 浏览器访问: http://127.0.0.1:8000/user_register/
2. 检查是否显示黄色警告横幅
3. 填写注册信息（用户名、邮箱、密码）
4. 点击"下一步"

**预期结果**:
- ✅ 页面顶部显示黄色横幅："⚠️ 测试模式 - 邮件服务未配置，注册将跳过邮箱验证步骤"
- ✅ 点击"下一步"后，显示 Toast 提示："邮件功能未配置，使用测试模式注册..."
- ✅ 直接跳转到"注册成功"页面（步骤3）
- ✅ 2秒后自动跳转到首页
- ✅ 自动登录成功

**实际结果**: ___________

---

### ✅ 测试 2: 注册页面 - 生产模式

**步骤**:
1. 浏览器访问: http://127.0.0.1:8000/user_register/
2. 检查是否没有黄色警告横幅
3. 填写注册信息（用户名、邮箱、密码）
4. 点击"下一步"
5. 检查邮箱是否收到验证码
6. 输入验证码并提交

**预期结果**:
- ✅ 页面顶部没有黄色横幅
- ✅ 点击"下一步"后，进入"邮箱验证"步骤（步骤2）
- ✅ Toast 提示："验证码已发送到您的邮箱"
- ✅ 邮箱收到验证码邮件（6位数字）
- ✅ 输入正确验证码后跳转到"注册成功"
- ✅ 自动登录并跳转到首页

**实际结果**: ___________

---

### ✅ 测试 3: 找回密码 - 测试模式

**步骤**:
1. 浏览器访问: http://127.0.0.1:8000/password_reset/
2. 检查是否显示黄色警告横幅
3. 输入已注册的邮箱地址
4. 点击"获取验证码"
5. 检查验证码是否显示在页面上

**预期结果**:
- ✅ 页面顶部显示黄色横幅："⚠️ 测试模式 - 邮件服务未配置，验证码将显示在页面上"
- ✅ 点击"获取验证码"后，页面显示验证码（6位数字）
- ✅ 提示框中显示："验证码已生成：123456"（示例）
- ✅ 输入验证码可以成功验证
- ✅ 可以成功重置密码

**实际结果**: ___________

---

### ✅ 测试 4: 找回密码 - 生产模式

**步骤**:
1. 浏览器访问: http://127.0.0.1:8000/password_reset/
2. 检查是否没有黄色警告横幅
3. 输入已注册的邮箱地址
4. 点击"获取验证码"
5. 检查邮箱是否收到邮件

**预期结果**:
- ✅ 页面顶部没有黄色横幅
- ✅ 点击"获取验证码"后，Toast 提示："验证码已发送"
- ✅ 页面上不显示验证码
- ✅ 邮箱收到验证码邮件
- ✅ 输入邮件中的验证码可以成功验证
- ✅ 可以成功重置密码

**实际结果**: ___________

---

### ✅ 测试 5: 模式切换

**步骤**:
1. 在测试模式下访问注册页面
2. 创建 `config/email.json` 并配置
3. 重启 Django 服务器
4. 再次访问注册页面

**预期结果**:
- ✅ 测试模式下：显示黄色横幅
- ✅ 生产模式下：不显示黄色横幅
- ✅ 切换无需修改代码
- ✅ 行为正确改变（测试模式跳过验证，生产模式需要验证）

**实际结果**: ___________

---

### ✅ 测试 6: API Token 找回密码（不受影响）

**步骤**:
1. 浏览器访问: http://127.0.0.1:8000/password_reset/
2. 点击"API Token"标签页
3. 按照说明操作

**预期结果**:
- ✅ API Token 方式不受邮件配置影响
- ✅ 功能正常工作

**实际结果**: ___________

---

## 边界测试

### ✅ 测试 7: email.json 文件不存在

```bash
del config\email.json
python manage.py runserver
# 访问注册/找回密码页面
```

**预期**: 使用测试模式，显示黄色横幅

---

### ✅ 测试 8: email.json 存在但 enabled=false

```json
// config/email.json
{
  "enabled": false,
  ...
}
```

**预期**: 使用测试模式，显示黄色横幅

---

### ✅ 测试 9: email.json 配置错误（SMTP密码错误）

```json
{
  "enabled": true,
  "smtp_password": "wrong_password",
  ...
}
```

**预期**: 
- 生产模式（不显示黄色横幅）
- 发送邮件失败，返回错误提示
- 不应该崩溃或降级到测试模式

---

## 浏览器兼容性测试

### ✅ Chrome
- 注册功能: ___________
- 找回密码: ___________

### ✅ Firefox
- 注册功能: ___________
- 找回密码: ___________

### ✅ Edge
- 注册功能: ___________
- 找回密码: ___________

### ✅ Safari (如有)
- 注册功能: ___________
- 找回密码: ___________

---

## 日志检查

### 测试模式日志

```bash
# 查看日志文件
type logs\application.log | findstr "Email not enabled"
```

**预期**: 看到类似日志
```
WARNING - Email not enabled. Verification code for xxx@example.com: 123456
```

### 生产模式日志

```bash
type logs\application.log | findstr "sent to"
```

**预期**: 看到类似日志
```
INFO - Verification code sent to xxx@example.com
```

---

## 性能测试

### ✅ 测试 10: 快速切换注册

**步骤**:
1. 连续快速点击"下一步"按钮5次

**预期结果**:
- ✅ 不应出现重复请求
- ✅ 不应崩溃
- ✅ 按钮应有防抖或禁用处理

**实际结果**: ___________

---

## 安全测试

### ✅ 测试 11: 测试模式验证码可见性

**步骤**:
1. 测试模式下请求验证码
2. 检查浏览器控制台（F12）
3. 检查网络请求响应

**预期结果**:
- ✅ 验证码在页面上显示（预期行为）
- ✅ 响应中包含 `code` 字段（预期行为，仅测试模式）

**注意**: 生产环境必须设置 `enabled=true`

---

## 回归测试

### ✅ 测试 12: 其他功能不受影响

**检查项**:
- [ ] 登录功能正常
- [ ] 日程管理功能正常
- [ ] 待办事项功能正常
- [ ] API Token 认证正常
- [ ] 群组协作功能正常

---

## 文档测试

### ✅ 测试 13: 配置指南准确性

**步骤**:
1. 阅读 `docs/邮件服务配置指南.md`
2. 按照指南从零开始配置邮件
3. 验证每个步骤是否准确

**检查项**:
- [ ] 快速开始步骤正确
- [ ] SMTP 配置示例有效
- [ ] 故障排查建议有用
- [ ] 常见问题解答准确

---

## 测试总结

**日期**: __________  
**测试人**: __________  
**环境**: Windows / Django 5.1.8 / Python 3.12  

**通过测试**: _____ / 13  
**失败测试**: _____  

**主要问题**:
1. ___________
2. ___________

**建议改进**:
1. ___________
2. ___________

**总体评价**: ☐ 通过 ☐ 有问题 ☐ 需要修复
