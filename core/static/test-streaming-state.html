<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµå¼çŠ¶æ€è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h2 {
            margin-top: 0;
            color: #333;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 400px;
        }
        .log {
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        input {
            padding: 8px;
            margin: 5px;
            width: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Agent æµå¼çŠ¶æ€è°ƒè¯•å·¥å…·</h1>
    
    <div class="section">
        <h2>1. æŸ¥çœ‹æ‰€æœ‰ localStorage é”®</h2>
        <button onclick="showAllKeys()">æ˜¾ç¤ºæ‰€æœ‰é”®</button>
        <button onclick="showStreamingKeys()">ä»…æ˜¾ç¤ºæµå¼çŠ¶æ€é”®</button>
        <pre id="keysOutput"></pre>
    </div>
    
    <div class="section">
        <h2>2. æ¨¡æ‹Ÿä¿å­˜æµå¼çŠ¶æ€</h2>
        <div>
            <label>ç”¨æˆ·ID: <input type="text" id="userId" value="1"></label>
            <label>ä¼šè¯ID: <input type="text" id="sessionId" value="user_1_test_session"></label>
        </div>
        <div>
            <label>å†…å®¹: <input type="text" id="content" value="æµ‹è¯•å†…å®¹"></label>
        </div>
        <button onclick="saveTestState()">ä¿å­˜æµ‹è¯•çŠ¶æ€</button>
        <button onclick="loadTestState()">è¯»å–æµ‹è¯•çŠ¶æ€</button>
        <pre id="testOutput"></pre>
    </div>
    
    <div class="section">
        <h2>3. æ¸…é™¤æ“ä½œ</h2>
        <button class="danger" onclick="clearStreamingKeys()">æ¸…é™¤æ‰€æœ‰æµå¼çŠ¶æ€é”®</button>
        <button class="danger" onclick="clearAllAgentKeys()">æ¸…é™¤æ‰€æœ‰ Agent ç›¸å…³é”®</button>
        <pre id="clearOutput"></pre>
    </div>
    
    <div class="section">
        <h2>4. å®æ—¶ç›‘æ§</h2>
        <button onclick="startMonitor()">å¼€å§‹ç›‘æ§</button>
        <button onclick="stopMonitor()">åœæ­¢ç›‘æ§</button>
        <pre id="monitorOutput" class="log"></pre>
    </div>

    <script>
        let monitorInterval = null;
        
        function showAllKeys() {
            const output = document.getElementById('keysOutput');
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                keys.push({
                    key: key,
                    length: value.length,
                    preview: value.substring(0, 100)
                });
            }
            output.textContent = JSON.stringify(keys, null, 2);
        }
        
        function showStreamingKeys() {
            const output = document.getElementById('keysOutput');
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('agent_streaming_')) {
                    const value = localStorage.getItem(key);
                    try {
                        const parsed = JSON.parse(value);
                        keys.push({
                            key: key,
                            data: parsed
                        });
                    } catch (e) {
                        keys.push({
                            key: key,
                            error: 'è§£æå¤±è´¥',
                            raw: value
                        });
                    }
                }
            }
            
            if (keys.length === 0) {
                output.textContent = 'æ²¡æœ‰æ‰¾åˆ°æµå¼çŠ¶æ€é”®';
            } else {
                output.textContent = JSON.stringify(keys, null, 2);
            }
        }
        
        function saveTestState() {
            const userId = document.getElementById('userId').value;
            const sessionId = document.getElementById('sessionId').value;
            const content = document.getElementById('content').value;
            const output = document.getElementById('testOutput');
            
            const key = `agent_streaming_${userId}_${sessionId}`;
            const state = {
                isActive: true,
                content: content,
                timestamp: Date.now(),
                sessionId: sessionId
            };
            
            try {
                localStorage.setItem(key, JSON.stringify(state));
                output.innerHTML = `<span class="success">âœ“ ä¿å­˜æˆåŠŸï¼</span>\n` + 
                    `é”®: ${key}\n` +
                    `å†…å®¹: ${JSON.stringify(state, null, 2)}`;
            } catch (e) {
                output.innerHTML = `<span class="error">âœ— ä¿å­˜å¤±è´¥: ${e.message}</span>`;
            }
        }
        
        function loadTestState() {
            const userId = document.getElementById('userId').value;
            const sessionId = document.getElementById('sessionId').value;
            const output = document.getElementById('testOutput');
            
            const key = `agent_streaming_${userId}_${sessionId}`;
            const value = localStorage.getItem(key);
            
            if (value) {
                try {
                    const state = JSON.parse(value);
                    output.innerHTML = `<span class="success">âœ“ è¯»å–æˆåŠŸï¼</span>\n` +
                        `é”®: ${key}\n` +
                        `å†…å®¹: ${JSON.stringify(state, null, 2)}`;
                } catch (e) {
                    output.innerHTML = `<span class="error">âœ— è§£æå¤±è´¥: ${e.message}</span>\nåŸå§‹å€¼: ${value}`;
                }
            } else {
                output.innerHTML = `<span class="error">âœ— æœªæ‰¾åˆ°è¯¥é”®</span>\né”®: ${key}`;
            }
        }
        
        function clearStreamingKeys() {
            const output = document.getElementById('clearOutput');
            const keys = [];
            
            for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (key.startsWith('agent_streaming_')) {
                    keys.push(key);
                    localStorage.removeItem(key);
                }
            }
            
            output.textContent = keys.length > 0 
                ? `å·²æ¸…é™¤ ${keys.length} ä¸ªé”®:\n${keys.join('\n')}`
                : 'æ²¡æœ‰æ‰¾åˆ°éœ€è¦æ¸…é™¤çš„é”®';
        }
        
        function clearAllAgentKeys() {
            const output = document.getElementById('clearOutput');
            const keys = [];
            
            for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (key.startsWith('agent_')) {
                    keys.push(key);
                    localStorage.removeItem(key);
                }
            }
            
            output.textContent = keys.length > 0 
                ? `å·²æ¸…é™¤ ${keys.length} ä¸ªé”®:\n${keys.join('\n')}`
                : 'æ²¡æœ‰æ‰¾åˆ°éœ€è¦æ¸…é™¤çš„é”®';
        }
        
        function startMonitor() {
            const output = document.getElementById('monitorOutput');
            if (monitorInterval) {
                output.textContent += '\nç›‘æ§å·²åœ¨è¿è¡Œä¸­';
                return;
            }
            
            output.textContent = 'å¼€å§‹ç›‘æ§ localStorage å˜åŒ–...\n\n';
            let lastSnapshot = JSON.stringify(getStreamingSnapshot());
            
            monitorInterval = setInterval(() => {
                const currentSnapshot = JSON.stringify(getStreamingSnapshot());
                if (currentSnapshot !== lastSnapshot) {
                    const timestamp = new Date().toLocaleTimeString();
                    output.textContent += `[${timestamp}] æ£€æµ‹åˆ°å˜åŒ–:\n${getStreamingSnapshot().map(s => 
                        `  ${s.key}: ${s.isActive ? 'æ¿€æ´»' : 'æœªæ¿€æ´»'}, ${s.contentLength} å­—ç¬¦`
                    ).join('\n')}\n\n`;
                    lastSnapshot = currentSnapshot;
                    
                    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                    output.scrollTop = output.scrollHeight;
                }
            }, 500);
        }
        
        function stopMonitor() {
            if (monitorInterval) {
                clearInterval(monitorInterval);
                monitorInterval = null;
                const output = document.getElementById('monitorOutput');
                output.textContent += '\nç›‘æ§å·²åœæ­¢';
            }
        }
        
        function getStreamingSnapshot() {
            const snapshot = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('agent_streaming_')) {
                    try {
                        const state = JSON.parse(localStorage.getItem(key));
                        snapshot.push({
                            key: key,
                            isActive: state.isActive,
                            contentLength: state.content?.length || 0,
                            timestamp: state.timestamp
                        });
                    } catch (e) {}
                }
            }
            return snapshot;
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ˜¾ç¤ºæµå¼çŠ¶æ€é”®
        window.onload = function() {
            showStreamingKeys();
        };
    </script>
</body>
</html>
