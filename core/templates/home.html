<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Time Management</title>
    <link rel="stylesheet" href="css/home.css" />
    <link rel="stylesheet" href="css/css初始化.css" />

</head>
<body>
<h1>Welcome, {{ request.user.username }}!</h1>
    <a href="/user_logout" class="common1">退出登录</a>
    <br/>
    <a href="/ai_chatting" class="common">AI聊天</a>
    <a href="/planner" class="common">计划师</a>
    <a href="/about" class="common">关于我们</a>
    <a href="/user_data" class="common">我的</a>
    <button id="editEventGroupsButton" class="button1">编辑日程组</button>
    <button id="importEventsButton" class="button1">导入日程</button>
<div id="importEventsModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeImportEventsModal()">&times;</span>
        <h2>导入日程</h2>
        <p><strong>Cookie：</strong> <input type="text" id="importCookie"></p>
        <p><strong>选择日程组：</strong>
            <select id="importGroupId">
                <!-- 动态生成日程组选项 -->
            </select>
        </p>
        <button onclick="importEvents()">导入</button>
    </div>
</div>
<br/>
<div id="calendar"></div>
<!-- 点击后弹出的对话框 -->
<div id="myModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeUpdateEventFromModal()">&times;</span>
        <p><strong>日程名称：</strong> <input type="text" id="eventTitle"></p>
        <p><strong>从：</strong> <input type="datetime-local" id="eventStart"></p>
        <p><strong>到：</strong> <input type="datetime-local" id="eventEnd"></p>
        <p><strong>日程详情：</strong> <textarea id="eventDescription"></textarea></p>
        <div class="importance-urgency-matrix">
            <button type="button" onclick="setImportanceUrgency('important', 'urgent', this)" class="matrix-button">重要且紧急</button>
            <button type="button" onclick="setImportanceUrgency('important', 'not-urgent', this)" class="matrix-button">重要但不紧急</button>
            <button type="button" onclick="setImportanceUrgency('not-important', 'urgent', this)" class="matrix-button">不重要但紧急</button>
            <button type="button" onclick="setImportanceUrgency('not-important', 'not-urgent', this)" class="matrix-button">不重要且不紧急</button>
        </div>
        <p><strong>日程组：</strong>
            <select id="eventGroupId">
                <option value="">无</option>
                <!-- 动态生成日程组选项 -->
            </select>
        </p>
        <p style="display: inline-block;"><strong>截止时间：</strong></p>
        <input type="datetime-local" id="eventDdl" style="display: inline-block; vertical-align: middle;">
        <input type="hidden" id="eventId"> <!-- 隐藏的输入框用于存储事件 ID -->
        <input type="hidden" id="eventImportance">
        <input type="hidden" id="eventUrgency">
        <button onclick="updateEventFromModal()">确定</button>
        <button onclick="deleteEvent()">删除日程</button>
    </div>
</div>


<!-- 创建日程的对话框 -->
<div id="createEventModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeCreateEventModal()">&times;</span>
        <h2>新建日程</h2>
        <form id="createEventForm">
            <p><strong>日程名称：</strong> <input type="text" id="newEventTitle" required></p>
            <p><strong>日程详情：</strong> <textarea id="newEventDescription"></textarea></p>
            <p><strong>从</strong> <input type="datetime-local" id="newEventStart" required></p>
            <p><strong>到</strong> <input type="datetime-local" id="newEventEnd" required></p>
            <div class="importance-urgency-matrix">
                <button type="button" onclick="setImportanceUrgency('important', 'urgent', this)" class="matrix-button">重要且紧急</button>
                <button type="button" onclick="setImportanceUrgency('important', 'not-urgent', this)" class="matrix-button">重要但不紧急</button>
                <button type="button" onclick="setImportanceUrgency('not-important', 'urgent', this)" class="matrix-button">不重要但紧急</button>
                <button type="button" onclick="setImportanceUrgency('not-important', 'not-urgent', this)" class="matrix-button">不重要且不紧急</button>
            </div>
            <p><strong>置入日程组：</strong>
                <select id="newEventGroupId">
                    <option value="">无</option>
                    <!-- 选项将通过 JavaScript 动态生成 -->
                </select>
            </p>
            <p style="display: inline-block;"><strong>截止时间：</strong></p>
            <input type="datetime-local" id="creatEventDdl" style="display: inline-block; vertical-align: middle;">
            <input type="hidden" id="newEventImportance">
            <input type="hidden" id="newEventUrgency">
            <button type="submit">创建</button>
        </form>
    </div>
</div>

<!-- 创建日程组的对话框 -->
<div id="createEventGroupModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeCreateEventGroupModal()">&times;</span>
        <h2>创建日程组</h2>
        <form id="createEventGroupForm">
            <p><strong>日程组名称：</strong> <input type="text" id="newGroupName" required></p>
            <p><strong>日程组描述：</strong> <textarea id="newGroupDescription"></textarea></p>
            <p><strong>日程组颜色：</strong> <input type="color" id="newGroupColor" required></p>
            <button type="submit">创建</button>
        </form>
    </div>
</div>

<!--编辑日程组弹出框-->
<div id="editEventGroupsModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditEventGroupsModal()">&times;</span>
        <h2>编辑日程组</h2>
        <div id="eventGroupsList"></div>
        <button id="deleteSelectedGroups" style="display: none;">删除</button>
    </div>
</div>

<!--编辑日程组对话框-->
<div id="editEventGroupModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditEventGroupModal()">&times;</span>
        <h2>编辑日程组</h2>
        <p><strong>名称：</strong> <input type="text" id="groupTitle"></p>
        <p><strong>描述：</strong> <textarea id="groupDescription"></textarea></p>
        <p><strong>颜色：</strong> <input type="color" id="groupColor"></p>
        <input type="hidden" id="groupId">
        <button onclick="updateEventGroup()">保存</button>
    </div>
</div>

<!--删除选项对话框-->
<div id="deleteOptionsModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeDeleteOptionsModal()">&times;</span>
        <h2>删除选项</h2>
        <p>请选择删除方式：</p>
        <button id="deleteOptionsButton1">只删除日程组</button>
        <button id="deleteOptionsButton2">删除日程组及所有日程</button>
    </div>
</div>

<!--<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/main.min.js"></script>-->
<!--<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.15/main.min.js"></script>-->
<!--<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.15/main.min.js"></script>-->
<!--<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.15/main.min.js"></script>-->

<!--<script src='https://cdn.jsdelivr.net/npm/fullcalendar/index.global.min.js'></script>-->
<!--上面是让浏览器自行下载fullcalendar的意思-->
{#<script src='https://unpkg.com/popper.js/dist/umd/popper.min.js'></script>#}
{#<script src='https://unpkg.com/tooltip.js/dist/umd/tooltip.min.js'></script>#}
<script src='../static/fullcalendar_index.global.js'></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            height: 'auto',
            locale: 'zh-cn', // 指定中文简体
            allDayText: '全天', // 更改all-day 显示文本
            initialView: 'timeGridWeek', // 初始视图
            editable: true, // enable draggable events
            nowIndicator: true,
            businessHours: {
                  // days of week. an array of zero-based day of week integers (0=Sunday)
                  daysOfWeek: [1, 2, 3, 4, 5, 6, 0], // Monday - Thursday

                  startTime: '10:00', // a start time (10am in this example)
                  endTime: '23:00', // an end time (6pm in this example)
            },
            eventDrop: function (info) {

                const event = info.event;
                const ddl = new Date(event.extendedProps.ddl);
                const newEnd = new Date(info.event.end);

                if (ddl){
                    // TODO 这个检查方式是为应对原有数据库中用户events字段的每项都缺少ddl键的问题，这里的逻辑是，若为空（正确实现）
                    // 或者根本没有ddl键（不正确实现）都会直接跳过这个检查，后期等后端用户初始化函数写好之后就不搞这个了
                    if (newEnd > ddl) {
                        // 如果新结束时间超过了 ddl，恢复到原来的位置
                        info.revert();
                        // alert('事件不能拖动到截止日期之后！');
                        return;
                    }
                }
                updateEvent(info.event.id, info.event.start.toISOString(), info.event.end.toISOString(), info.event.title, info.event.extendedProps.description, info.event.extendedProps.importance, info.event.extendedProps.urgency, info.event.extendedProps.groupID, info.event.extendedProps.ddl);
            },

            eventResize: function (info) {
                const event = info.event;
                const ddl = new Date(event.extendedProps.ddl);
                const newEnd = new Date(info.event.end);

                if (ddl){
                    // TODO 这个检查方式是为应对原有数据库中用户events字段的每项都缺少ddl键的问题，这里的逻辑是，若为空（正确实现）
                    // 或者根本没有ddl键（不正确实现）都会直接跳过这个检查，后期等后端用户初始化函数写好之后就不搞这个了
                    if (newEnd > ddl) {
                        // 如果新结束时间超过了 ddl，恢复到原来的位置
                        info.revert();
                        // alert('事件不能拖动到截止日期之后！');
                        return;
                    }
                }
                updateEvent(info.event.id, info.event.start.toISOString(), info.event.end.toISOString(), info.event.title, info.event.extendedProps.description, info.event.extendedProps.importance, info.event.extendedProps.urgency, info.event.extendedProps.groupID, info.event.extendedProps.ddl);
            },

            datesSet: function(viewInfo) {
                // 调用后端接口保存当前视图类型和日期范围

                //！！！！！这里有个BUG，你点击刷新，这里会自动跳到初始视图，把页面数据发送。因此后台做了一个处理，过滤这种
                saveCurrentView(viewInfo.view.type, viewInfo.start, viewInfo.end);
            },


            eventClick: function (info) {
                var modal = document.getElementById('myModal');
                var closeBtn = document.getElementsByClassName('close')[0];

                // 获取事件的开始时间和结束时间，并减去8小时
                var eventStart = new Date(info.event.start);
                eventStart.setHours(eventStart.getHours() + 8); // 减去8小时时差
                var eventEnd = new Date(info.event.end);
                eventEnd.setHours(eventEnd.getHours() + 8); // 减去8小时时差

                // 转换为 YYYY-MM-DDTHH:MM 格式
                var formattedStart = eventStart.toISOString().substring(0, 16);
                var formattedEnd = eventEnd.toISOString().substring(0, 16);

                // 设置事件信息到对话框
                document.getElementById('eventTitle').value = info.event.title;
                document.getElementById('eventStart').value = formattedStart;
                document.getElementById('eventEnd').value = formattedEnd;
                document.getElementById('eventDescription').value = info.event.extendedProps.description;


                try {
                    const ddl = new Date(info.event.extendedProps.ddl);
                    if (ddl) {
                        ddl.setHours(ddl.getHours() + 8); // 减去8小时时差
                        document.getElementById('eventDdl').value = ddl.toISOString().substring(0, 16) || '';
                    }
                }
                catch(err) {

                }



                // 获取重要性和紧急性属性
                const importance = info.event.extendedProps.importance || '';
                const urgency = info.event.extendedProps.urgency || '';

                // 设置重要性和紧急性按钮的选中状态
                const buttons = document.querySelectorAll('.matrix-button');
                buttons.forEach(btn => btn.classList.remove('selected'));
                if (importance && urgency) {
                    document.querySelector(`[onclick="setImportanceUrgency('${importance}', '${urgency}', this)"]`).classList.add('selected');
                }

                // 动态生成日程组的下拉菜单选项
                const eventGroupIdSelect = document.getElementById('eventGroupId');
                eventGroupIdSelect.innerHTML = '<option value="">无</option>'; // 默认选项
                window.events_groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.text = group.name;
                    eventGroupIdSelect.appendChild(option);
                });

                // 设置日程组选择框的默认值
                const eventGroupId = info.event.extendedProps.groupID || '';
                document.getElementById('eventGroupId').value = eventGroupId;


                // 保存当前事件的 ID 和属性
                document.getElementById('eventId').value = info.event.id;
                document.getElementById('eventImportance').value = importance;
                document.getElementById('eventUrgency').value = urgency;

                modal.style.display = 'block';

                closeBtn.onclick = function () {
                    modal.style.display = 'none';
                };

                window.onclick = function (event) {
                    if (event.target == modal) {
                        modal.style.display = 'none';
                    }
                };
            },

            selectable: true,
            select: function (info) {
                openCreateEventModal(info.startStr, info.endStr);
            },

            aspectRatio: 1.8,
            headerToolbar: {
                left: 'today prev, next, createEventButton, createEventGroupButton',
                center: 'title',
                right: 'timeGridDay,dayGridMonth,timeGridWeek,listWeek'
            },

            buttonText: {
                today: '今天',
                month: '月',
                week: '周',
                day: '日',
                list: '列表视图',

            },
            customButtons: {
                createEventButton: {
                    text: '新建日程',
                    click: function () {
                        openCreateEventModal(0, 0);
                    }
                },
                createEventGroupButton: {
                    text: '新建日程组',
                    click: function () {
                        openCreateEventGroupModal();
                    }
                }
            },


            events: function (info, successCallback, failureCallback) {
                fetch('/get_calendar/events/')
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.events && data.events_groups) {
                            // 将日程组数据存储到全局变量中
                            window.events_groups = data.events_groups;

                            // 为每个事件添加颜色信息
                            const eventsWithColor = data.events.map(event => {
                                const groupID = String(event.groupID); // 确保 groupID 是字符串
                                const group = window.events_groups.find(group => String(group.id) === groupID); // 确保 group.id 也是字符串

                                const groupColor = group ? group.color : '#999'; // 默认颜色
                                return {
                                    ...event,
                                    backgroundColor: groupColor,
                                    borderColor: groupColor
                                };
                            });

                            successCallback(eventsWithColor);
                        } else {
                            failureCallback(new Error('Invalid data format'));
                        }
                    })
                    .catch(error => {
                        failureCallback(error);
                    });
            },
            {#eventDidMount: function(info) {#}
            {#    var tooltip = new Tooltip(info.el, {#}
            {#      title: info.event.extendedProps.description,#}
            {#      placement: 'top',#}
            {#      trigger: 'hover',#}
            {#      container: 'body'#}
            {#    });#}
            // TODO 在 timeGridWeek 视图下会出现 description 显示不消除的问题。根本不会改
            //  },
        });




        // 页面加载时恢复视图
        initCalendar(calendar);
        calendar.render();



    })

    function initCalendar(calendar) {
        fetch("/get_calendar/user_settings")
            .then(response => response.json())
            .then(data => {
                const nowView = data.message.now_view;

                if (nowView.viewType) {
                    calendar.changeView(nowView.viewType, new Date(nowView.start));
                }

                if (nowView.start) {
                    calendar.gotoDate(new Date(nowView.start));
                }
            });
    }


    // 调用后端接口保存当前视图类型和日期范围
    function saveCurrentView(viewType, start, end) {
        fetch('/get_calendar/change_view/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                viewType: viewType,
                start: start.toISOString(),
                end: end.toISOString()
            })
        });
    }

    document.getElementById('createEventForm').addEventListener('submit', function (event) {
        event.preventDefault();
        createEvent();
    });





    // 处理创建日程组的表单提交
    document.getElementById('createEventGroupForm').addEventListener('submit', function(event) {
        event.preventDefault();
        createEventGroup();
    });

    // 监听编辑日程组按钮
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('editEventGroupsButton').addEventListener('click', function() {
            fetch('/get_calendar/events/')
                .then(response => response.json())
                .then(data => {
                    if (data && data.events_groups) {
                        showEditEventGroupsModal(data.events_groups);
                    }
                })
                .catch(error => console.error('Error fetching event groups:', error));
        });
    });


    function updateEvent(eventId, newStart, newEnd, title, description, importance, urgency, groupID, ddl) {
        fetch('/get_calendar/update_events/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({eventId, newStart, newEnd, title, description, importance, urgency, groupID, ddl})
        })
            .then(response => response.json())
            .then(data => {
                console.log('Event updated successfully');
            })
            .catch(error => console.error('Error updating event:', error));
    }

    function updateEventFromModal() {
        var eventId = document.getElementById('eventId').value; // 获取事件 ID
        var title = document.getElementById('eventTitle').value; // 获取日程名称
        var newStart = document.getElementById('eventStart').value; // 获取用户输入的新开始时间
        var newEnd = document.getElementById('eventEnd').value; // 获取用户输入的新结束时间
        var description = document.getElementById('eventDescription').value; // 获取日程详情
        var importance = document.getElementById('eventImportance').value; // 获取重要性
        var urgency = document.getElementById('eventUrgency').value; // 获取紧急性
        var groupID = document.getElementById('eventGroupId').value; // 获取日程组 ID
        var ddl = document.getElementById('eventDdl').value; // 获取截止时间

        // 将本地时间转换为 UTC 时间
        function toUTC(time) {
            const date = new Date(time);
            return date.toISOString();
        }

        // 调用 updateEvent 函数
        updateEvent(eventId, toUTC(newStart), toUTC(newEnd), title, description, importance, urgency, groupID, ddl);
        location.reload()

        // 关闭对话框
        document.getElementById('myModal').style.display = 'none';
    }

    // 关闭
    function closeUpdateEventFromModal() {
        document.getElementById('myModal').style.display = 'none';
    }


    function deleteEvent() {
        // 从隐藏的输入框中获取 eventId
        var eventId = document.getElementById('eventId').value;

        fetch('/get_calendar/delete_event/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({eventId}) // 确保传递正确的 eventId
        })
            .then(response => response.json())
            .then(data => {
                console.log('Event deleted successfully');
                location.reload(); // 刷新页面
                document.getElementById('myModal').style.display = 'none';

                // 从日历中移除该事件
                if (window.currentEvent) {
                    window.currentEvent.remove(); // 删除事件

                }
            })
            .catch(error => console.error('Error deleting event:', error));
    }

    // 打开创建栏
    function openCreateEventModal(start, end) {
        // 将 ISO 格式的时间字符串转换为本地时间格式，并加上8小时
        function toLocalTime(time) {
            const date = new Date(time);
            date.setHours(date.getHours() + 8); // 加上8小时
            return date.toISOString().substring(0, 16); // 格式化为 YYYY-MM-DDTHH:MM
        }

        // 设置输入框的值
        document.getElementById('newEventStart').value = toLocalTime(start);
        document.getElementById('newEventEnd').value = toLocalTime(end);
        document.getElementById('creatEventDdl').value = toLocalTime(end);

        // 清除重要性和紧急性按钮的选中状态
        const buttons = document.querySelectorAll('.matrix-button');
        buttons.forEach(btn => btn.classList.remove('selected'));

        // 清空隐藏输入框的值
        document.getElementById('newEventImportance').value = '';
        document.getElementById('newEventUrgency').value = '';

        // 动态生成日程组的下拉菜单选项
        const eventGroupIdSelect = document.getElementById('newEventGroupId');
        eventGroupIdSelect.innerHTML = '<option value="">无</option>'; // 默认选项
        window.events_groups.forEach(group => {
            const option = document.createElement('option');
            option.value = group.id;
            option.text = group.name;
            eventGroupIdSelect.appendChild(option);
        });

        // 显示创建日程的对话框
        document.getElementById('createEventModal').style.display = 'block';
    }

    // 关闭
    function closeCreateEventModal() {
        document.getElementById('createEventModal').style.display = 'none';
    }

    // 重要性-紧急性维度视图
    function setImportanceUrgency(importance, urgency, button) {
        // 获取当前按钮的状态
        const isAlreadySelected = button.classList.contains('selected');

        // 如果按钮已经被选中，再次点击则取消选中
        if (isAlreadySelected) {
            document.getElementById('eventImportance').value = '';
            document.getElementById('eventUrgency').value = '';
            button.classList.remove('selected');
        } else {
            // 如果按钮未被选中，设置为选中状态
            document.getElementById('eventImportance').value = importance;
            document.getElementById('eventUrgency').value = urgency;

            // 清除所有按钮的选中状态
            const buttons = document.querySelectorAll('.matrix-button');
            buttons.forEach(btn => btn.classList.remove('selected'));

            // 设置当前按钮为选中状态
            button.classList.add('selected');
        }
    }

    // 发送新建的日程
    function createEvent() {
        var title = document.getElementById('newEventTitle').value;
        var start = document.getElementById('newEventStart').value;
        var end = document.getElementById('newEventEnd').value;
        var description = document.getElementById('newEventDescription').value;
        var importance = document.getElementById('newEventImportance').value;
        var urgency = document.getElementById('newEventUrgency').value;
        var groupId = document.getElementById('newEventGroupId').value; // 获取选中的日程组 ID
        var ddl = document.getElementById('creatEventDdl').value;

        fetch('/get_calendar/create_event/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ title, start, end, description, importance, urgency, groupId, ddl })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    closeCreateEventModal();
                    location.reload(); // 刷新页面以显示新事件
                }
            })
            .catch(error => console.error('Error creating event:', error));
    }


    // 下面都是日程组编辑功能


    function openCreateEventGroupModal() {
        document.getElementById('createEventGroupModal').style.display = 'block';
    }

    function closeCreateEventGroupModal() {
        document.getElementById('createEventGroupModal').style.display = 'none';
    }

    function createEventGroup() {
        const groupName = document.getElementById('newGroupName').value;
        const groupDescription = document.getElementById('newGroupDescription').value;
        const groupColor = document.getElementById('newGroupColor').value;

        fetch('/get_calendar/create_events_group/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: groupName,
                description: groupDescription,
                color: groupColor
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('日程组创建成功');
                    closeCreateEventGroupModal();
                    location.reload(); // 刷新页面以获取最新的日程组数据
                }
            })
            .catch(error => console.error('创建日程组失败:', error));
    }



    function showEditEventGroupsModal(groups) {
        const modal = document.getElementById('editEventGroupsModal');
        const groupsList = document.getElementById('eventGroupsList');
        const deleteButton = document.getElementById('deleteSelectedGroups');

        // 清空之前的列表
        groupsList.innerHTML = '';

        // 为每个日程组创建一个列表项
        groups.forEach(group => {
            const groupItem = document.createElement('div');
            groupItem.className = 'group-item';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `group-${group.id}`;
            checkbox.value = group.id;

            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.textContent = group.name;

            const editButton = document.createElement('button');
            editButton.textContent = '编辑';
            editButton.onclick = function() {
                editEventGroup(group.id);
            };

            groupItem.appendChild(checkbox);
            groupItem.appendChild(label);
            groupItem.appendChild(editButton);
            groupsList.appendChild(groupItem);
        });

        // 显示删除按钮
        deleteButton.style.display = 'block';
        deleteButton.onclick = function() {
            const selectedGroups = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(checkbox => checkbox.value);
            if (selectedGroups.length > 0) {
                showDeleteOptions(selectedGroups);
            }
        };

        modal.style.display = 'block';
    }

    function closeEditEventGroupsModal() {
        const modal = document.getElementById('editEventGroupsModal');
        modal.style.display = 'none';
    }

    function editEventGroup(groupId) {
        // 弹出编辑日程组的对话框
        const group = window.events_groups.find(group => group.id === groupId);
        if (group) {
            const modal = document.getElementById('editEventGroupModal');
            const closeBtn = document.getElementsByClassName('close')[1];

            document.getElementById('groupTitle').value = group.name;
            document.getElementById('groupDescription').value = group.description;
            document.getElementById('groupColor').value = group.color;
            document.getElementById('groupId').value = groupId;

            modal.style.display = 'block';

            closeBtn.onclick = function() {
                modal.style.display = 'none';
            };

            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            };
        }
    }

    function updateEventGroup() {
        var groupID = document.getElementById('groupId').value;
        var title = document.getElementById('groupTitle').value;
        var description = document.getElementById('groupDescription').value;
        var color = document.getElementById('groupColor').value;

        fetch('/get_calendar/update_events_group/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ groupID, title, description, color })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('日程组更新成功');
                    location.reload(); // 刷新页面以获取最新的日程组数据
                } else {
                    alert('更新失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error updating event group:', error);
                alert('更新失败: ' + error.message);
            });

        // 关闭编辑日程组的对话框
        closeEditEventGroupModal();
    }

    function closeEditEventGroupModal() {
        const modal = document.getElementById('editEventGroupModal');
        modal.style.display = 'none';
    }

    function showDeleteOptions(selectedGroups) {
        const modal = document.getElementById('deleteOptionsModal');
        const closeBtn = document.getElementsByClassName('close')[2];

        modal.style.display = 'block';

        document.getElementById('deleteOptionsButton1').onclick = function() {
            deleteEventGroups(selectedGroups, false); // 只删除日程组，保留日程
            modal.style.display = 'none';
        };

        document.getElementById('deleteOptionsButton2').onclick = function() {
            deleteEventGroups(selectedGroups, true); // 删除日程组及所有日程
            modal.style.display = 'none';
        };

        closeBtn.onclick = function() {
            modal.style.display = 'none';
        };

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        };
    }

    function deleteEventGroups(groupIds, deleteEvents) {
        fetch('/get_calendar/delete_event_groups/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ groupIds, deleteEvents })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('日程组删除成功');
                    location.reload(); // 刷新页面
                }
            })
            .catch(error => console.error('Error deleting event groups:', error));
    }

    function closeDeleteOptionsModal() {
        const modal = document.getElementById('deleteOptionsModal');
        modal.style.display = 'none';
    }


    // 下面是导入日程的代码

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('importEventsButton').addEventListener('click', function() {
            fetch('/get_calendar/events/')
                .then(response => response.json())
                .then(data => {
                    if (data && data.events_groups) {
                        showImportEventsModal(data.events_groups);
                    }
                })
                .catch(error => console.error('Error fetching event groups:', error));
        });
    });

    function showImportEventsModal(groups) {
        const modal = document.getElementById('importEventsModal');
        const groupIdSelect = document.getElementById('importGroupId');

        // 清空之前的列表
        groupIdSelect.innerHTML = '<option value="">选择日程组</option>';

        // 为每个日程组创建一个选项
        groups.forEach(group => {
            const option = document.createElement('option');
            option.value = group.id;
            option.text = group.name;
            groupIdSelect.appendChild(option);
        });

        modal.style.display = 'block';
    }

    function closeImportEventsModal() {
        const modal = document.getElementById('importEventsModal');
        modal.style.display = 'none';
    }

    function importEvents() {
        const cookie = document.getElementById('importCookie').value;
        const groupId = document.getElementById('importGroupId').value;

        if (!cookie || !groupId) {
            alert('请输入Cookie并选择日程组');
            return;
        }

        fetch('/get_calendar/import_events/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ cookie, groupId })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('日程导入成功');
                    location.reload(); // 刷新页面以获取最新的日程数据
                } else {
                    alert('导入失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error importing events:', error);
                alert('导入失败: ' + error.message);
            });

        closeImportEventsModal();
    }




</script>
</body>
</html>