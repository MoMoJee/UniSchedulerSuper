{% load static %}
<!-- v20251101-009: å®ç°å®Œæ•´çš„å¤šç»´åº¦ç­›é€‰ï¼ˆçŠ¶æ€+ä¼˜å…ˆçº§+ç±»å‹ï¼‰ï¼›ä¿®å¤ä¼˜å…ˆçº§ç­›é€‰å™¨é€‰é¡¹å€¼ -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniSchedulerSuper - æ™ºèƒ½æ—¥ç¨‹ç®¡ç†ç³»ç»Ÿ</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/home-styles.css' %}?v=20251107-011">
    <!-- Share Groups CSS -->
    <link rel="stylesheet" href="{% static 'css/share-groups.css' %}?v=20251111-001">
    <!-- Agent Chat CSS -->
    <link rel="stylesheet" href="{% static 'css/agent-chat.css' %}?v=20251201-001">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">    <!-- å¼ºåˆ¶éšè—editEventRecurringInfoå…ƒç´ çš„æ ·å¼ -->
    <style>
        #editEventRecurringInfo {
            display: none !important;
            visibility: hidden !important;
        }
        /* é˜²æ­¢JavaScripté‡æ–°æ˜¾ç¤º */
        #editEventRecurringInfo[data-force-hidden="true"] {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            overflow: hidden !important;
        }
        
        /* TODOè¯¦æƒ…æ¨¡æ€æ¡†æ ·å¼ */
        .todo-detail-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .detail-row {
            display: flex;
            gap: 15px;
            padding: 10px;
            background-color: var(--bg-secondary, #f8f9fa);
            border-radius: 6px;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--text-secondary, #6c757d);
            min-width: 100px;
            flex-shrink: 0;
        }
        
        .detail-value {
            flex: 1;
            color: var(--text-primary, #212529);
            word-break: break-word;
        }
        
        #todoDetailTitle {
            font-weight: 600;
            color: var(--text-primary, #212529);
        }
        
        #todoDetailPriority {
            font-weight: 500;
        }
        
        /* ä¸ªäººèµ„æ–™é¡µå¡ç‰‡æ‚¬åœæ•ˆæœ - é€‚é…æ‰€æœ‰ä¸»é¢˜ */
        .hover-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .hover-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15) !important;
        }
        
        /* æ·±è‰²ä¸»é¢˜å¡ç‰‡é€‚é… */
        [data-theme="dark"] .hover-card:hover,
        [data-theme="cyberpunk"] .hover-card:hover {
            box-shadow: 0 8px 16px rgba(255, 255, 255, 0.1) !important;
        }
        
        /* ä¸ªæ€§åŒ–ä¸»é¢˜å¡ç‰‡é€‚é… */
        [data-theme="china-red"] .hover-card:hover {
            box-shadow: 0 8px 16px rgba(220, 38, 38, 0.2) !important;
        }
        
        [data-theme="ocean"] .hover-card:hover,
        [data-theme="cool-pastel"] .hover-card:hover {
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.2) !important;
        }
        
        [data-theme="forest"] .hover-card:hover {
            box-shadow: 0 8px 16px rgba(34, 197, 94, 0.2) !important;
        }
        
        [data-theme="sunset"] .hover-card:hover,
        [data-theme="warm-pastel"] .hover-card:hover {
            box-shadow: 0 8px 16px rgba(251, 146, 60, 0.2) !important;
        }
        
        [data-theme="sakura"] .hover-card:hover,
        [data-theme="macaron"] .hover-card:hover {
            box-shadow: 0 8px 16px rgba(236, 72, 153, 0.2) !important;
        }
        
        [data-theme="dopamine"] .hover-card:hover {
            box-shadow: 0 8px 16px rgba(168, 85, 247, 0.2) !important;
        }
        
        /* å¤´åƒåœ†åœˆæ ·å¼ - é€‚é…ä¸»é¢˜ */
        .avatar-circle {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* ç¡®ä¿ç´«è‰²åœ¨æ‰€æœ‰ä¸»é¢˜ä¸‹å¯è§ */
        .text-purple {
            color: #8b5cf6 !important;
        }
        
        [data-theme="dark"] .text-purple,
        [data-theme="cyberpunk"] .text-purple {
            color: #a78bfa !important;
        }
        
        /* é‡å¤é€‰é¡¹å¡ç‰‡ - æ·±è‰²æ¨¡å¼é€‚é… */
        [data-theme="dark"] .card.bg-light,
        [data-theme="cyberpunk"] .card.bg-light,
        [data-theme="platinum-dark"] .card.bg-light {
            background-color: #2d3748 !important;
            border-color: #4a5568 !important;
        }
        
        [data-theme="dark"] .card.bg-light .form-label,
        [data-theme="dark"] .card.bg-light .form-control,
        [data-theme="dark"] .card.bg-light .form-select,
        [data-theme="dark"] .card.bg-light .input-group-text,
        [data-theme="cyberpunk"] .card.bg-light .form-label,
        [data-theme="cyberpunk"] .card.bg-light .form-control,
        [data-theme="cyberpunk"] .card.bg-light .form-select,
        [data-theme="cyberpunk"] .card.bg-light .input-group-text {
            color: #e2e8f0 !important;
            background-color: #1a202c !important;
            border-color: #4a5568 !important;
        }
        
        [data-theme="dark"] .card.bg-light .input-group-text,
        [data-theme="cyberpunk"] .card.bg-light .input-group-text {
            background-color: #374151 !important;
        }
        
        /* é»‘é‡‘æ¨¡å¼ç‰¹æ®Šé€‚é… (platinum-dark) */
        [data-theme="platinum-dark"] .card.bg-light {
            background-color: #1a1a1a !important;
            border: 1px solid #d4af37 !important;
        }
        
        [data-theme="platinum-dark"] .card.bg-light .form-label,
        [data-theme="platinum-dark"] .card.bg-light .form-control,
        [data-theme="platinum-dark"] .card.bg-light .form-select,
        [data-theme="platinum-dark"] .card.bg-light .input-group-text {
            color: #d4af37 !important;
            background-color: #0d0d0d !important;
            border-color: #8b7355 !important;
        }
        
        [data-theme="platinum-dark"] .card.bg-light .input-group-text {
            background-color: #1a1a1a !important;
        }
        
        /* æ·±è‰²æ¨¡å¼ä¸‹æ‰€æœ‰æ¨¡æ€æ¡†å†…çš„è¡¨å•å…ƒç´ é€‚é… */
        [data-theme="dark"] .modal-content .card-header,
        [data-theme="cyberpunk"] .modal-content .card-header,
        [data-theme="platinum-dark"] .modal-content .card-header {
            background-color: #374151 !important;
            border-bottom-color: #4a5568 !important;
            color: #e2e8f0 !important;
        }
        
        [data-theme="platinum-dark"] .modal-content .card-header {
            background-color: #1a1a1a !important;
            border-bottom: 1px solid #d4af37 !important;
            color: #d4af37 !important;
        }
        
        [data-theme="dark"] .modal-content .card,
        [data-theme="cyberpunk"] .modal-content .card,
        [data-theme="platinum-dark"] .modal-content .card {
            background-color: #2d3748 !important;
            border-color: #4a5568 !important;
        }
        
        [data-theme="platinum-dark"] .modal-content .card {
            background-color: #0d0d0d !important;
            border: 1px solid #8b7355 !important;
        }
        
        [data-theme="dark"] .modal-content .card .form-label,
        [data-theme="dark"] .modal-content .card .form-control,
        [data-theme="dark"] .modal-content .card .form-select,
        [data-theme="dark"] .modal-content .card .input-group-text,
        [data-theme="cyberpunk"] .modal-content .card .form-label,
        [data-theme="cyberpunk"] .modal-content .card .form-control,
        [data-theme="cyberpunk"] .modal-content .card .form-select,
        [data-theme="cyberpunk"] .modal-content .card .input-group-text {
            color: #e2e8f0 !important;
            background-color: #1a202c !important;
            border-color: #4a5568 !important;
        }
        
        [data-theme="platinum-dark"] .modal-content .card .form-label,
        [data-theme="platinum-dark"] .modal-content .card .form-control,
        [data-theme="platinum-dark"] .modal-content .card .form-select,
        [data-theme="platinum-dark"] .modal-content .card .input-group-text {
            color: #d4af37 !important;
            background-color: #1a1a1a !important;
            border-color: #8b7355 !important;
        }
        
        [data-theme="dark"] .modal-content .card .input-group-text,
        [data-theme="cyberpunk"] .modal-content .card .input-group-text {
            background-color: #374151 !important;
        }
        
        [data-theme="platinum-dark"] .modal-content .card .input-group-text {
            background-color: #0d0d0d !important;
        }
        
        /* æ·±è‰²æ¨¡å¼ä¸‹é€‰é¡¹ï¼ˆoptionï¼‰æ–‡æœ¬é¢œè‰²ä¿®å¤ */
        [data-theme="dark"] .form-select option,
        [data-theme="cyberpunk"] .form-select option {
            background-color: #1a202c !important;
            color: #e2e8f0 !important;
        }
        
        [data-theme="platinum-dark"] .form-select option {
            background-color: #0d0d0d !important;
            color: #d4af37 !important;
        }
        
        /* æ·±è‰²æ¨¡å¼å’Œé»‘é‡‘æ¨¡å¼ä¸‹çš„æ—¥æœŸæ—¶é—´è¾“å…¥æ¡†ä¿®å¤ */
        [data-theme="dark"] input[type="date"],
        [data-theme="dark"] input[type="time"],
        [data-theme="dark"] input[type="datetime-local"],
        [data-theme="cyberpunk"] input[type="date"],
        [data-theme="cyberpunk"] input[type="time"],
        [data-theme="cyberpunk"] input[type="datetime-local"] {
            color: #e2e8f0 !important;
            background-color: #1a202c !important;
            border-color: #4a5568 !important;
            color-scheme: dark;
        }
        
        [data-theme="platinum-dark"] input[type="date"],
        [data-theme="platinum-dark"] input[type="time"],
        [data-theme="platinum-dark"] input[type="datetime-local"] {
            color: #d4af37 !important;
            background-color: #0d0d0d !important;
            border-color: #8b7355 !important;
            color-scheme: dark;
        }
        
        /* ç¦ç”¨çŠ¶æ€çš„è¾“å…¥æ¡†æ ·å¼ä¿®å¤ */
        [data-theme="dark"] input[type="date"]:disabled,
        [data-theme="dark"] input[type="time"]:disabled,
        [data-theme="dark"] input[type="datetime-local"]:disabled,
        [data-theme="dark"] input[type="text"]:disabled,
        [data-theme="dark"] .form-control:disabled,
        [data-theme="cyberpunk"] input[type="date"]:disabled,
        [data-theme="cyberpunk"] input[type="time"]:disabled,
        [data-theme="cyberpunk"] input[type="datetime-local"]:disabled,
        [data-theme="cyberpunk"] input[type="text"]:disabled,
        [data-theme="cyberpunk"] .form-control:disabled {
            color: #a0aec0 !important;
            background-color: #2d3748 !important;
            border-color: #4a5568 !important;
            opacity: 0.8;
        }
        
        [data-theme="platinum-dark"] input[type="date"]:disabled,
        [data-theme="platinum-dark"] input[type="time"]:disabled,
        [data-theme="platinum-dark"] input[type="datetime-local"]:disabled,
        [data-theme="platinum-dark"] input[type="text"]:disabled,
        [data-theme="platinum-dark"] .form-control:disabled {
            color: #b8935f !important;
            background-color: #1a1a1a !important;
            border-color: #8b7355 !important;
            opacity: 0.8;
        }
        
        /* æ—¥æœŸæ—¶é—´é€‰æ‹©å™¨æ—¥å†å¼¹å‡ºæ¡†æ ·å¼ï¼ˆWebkitæµè§ˆå™¨ï¼‰ */
        [data-theme="dark"] input[type="date"]::-webkit-calendar-picker-indicator,
        [data-theme="dark"] input[type="time"]::-webkit-calendar-picker-indicator,
        [data-theme="dark"] input[type="datetime-local"]::-webkit-calendar-picker-indicator,
        [data-theme="cyberpunk"] input[type="date"]::-webkit-calendar-picker-indicator,
        [data-theme="cyberpunk"] input[type="time"]::-webkit-calendar-picker-indicator,
        [data-theme="cyberpunk"] input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
        
        [data-theme="platinum-dark"] input[type="date"]::-webkit-calendar-picker-indicator,
        [data-theme="platinum-dark"] input[type="time"]::-webkit-calendar-picker-indicator,
        [data-theme="platinum-dark"] input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            filter: invert(0.7) sepia(1) saturate(5) hue-rotate(5deg);
            cursor: pointer;
        }
        
        /* å¼ºåˆ¶ä¿®å¤æ‰€æœ‰æ¨¡æ€æ¡†å†…çš„ bg-light å¡ç‰‡ï¼ˆæé«˜ä¼˜å…ˆçº§ï¼‰*/
        body [data-theme="dark"] .modal .card.bg-light,
        body [data-theme="cyberpunk"] .modal .card.bg-light {
            background-color: #2d3748 !important;
            border-color: #4a5568 !important;
            color: #e2e8f0 !important;
        }
        
        body [data-theme="platinum-dark"] .modal .card.bg-light {
            background-color: #1a1a1a !important;
            border: 1px solid #d4af37 !important;
            color: #d4af37 !important;
        }
        
        /* å¼ºåˆ¶ä¿®å¤ bg-light å¡ç‰‡å†…çš„æ‰€æœ‰è¡¨å•å…ƒç´  */
        body [data-theme="dark"] .card.bg-light *,
        body [data-theme="cyberpunk"] .card.bg-light * {
            color: inherit !important;
        }
        
        body [data-theme="platinum-dark"] .card.bg-light * {
            color: inherit !important;
        }
        
        /* ç‰¹åˆ«é’ˆå¯¹ bg-light å†…éƒ¨çš„è¾“å…¥æ¡† */
        body [data-theme="dark"] .card.bg-light input.form-control,
        body [data-theme="dark"] .card.bg-light select.form-select,
        body [data-theme="dark"] .card.bg-light textarea.form-control,
        body [data-theme="cyberpunk"] .card.bg-light input.form-control,
        body [data-theme="cyberpunk"] .card.bg-light select.form-select,
        body [data-theme="cyberpunk"] .card.bg-light textarea.form-control {
            color: #e2e8f0 !important;
            background-color: #1a202c !important;
            border-color: #4a5568 !important;
        }
        
        body [data-theme="platinum-dark"] .card.bg-light input.form-control,
        body [data-theme="platinum-dark"] .card.bg-light select.form-select,
        body [data-theme="platinum-dark"] .card.bg-light textarea.form-control {
            color: #d4af37 !important;
            background-color: #0d0d0d !important;
            border-color: #8b7355 !important;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  - æ–°ç‰ˆå…¨å±€æœç´¢ -->
    <nav class="navbar navbar-expand-lg navbar-island" id="topNavbar">
        <div class="container-fluid d-flex align-items-center justify-content-center">
            <!-- çµåŠ¨å²›å®¹å™¨ -->
            <div class="dynamic-island">
                <!-- å…¨å±€æœç´¢ç»„ä»¶ -->
                <div id="globalSearchContainer" class="global-search-container">
                    <!-- æœç´¢æŒ‰é’® (æœªæ¿€æ´»çŠ¶æ€) -->
                    <button id="searchToggleBtn" class="search-toggle-btn" onclick="globalSearch.toggle()">
                        <i class="fas fa-search"></i>
                    </button>
                    
                    <!-- æœç´¢æ  (æ¿€æ´»çŠ¶æ€) -->
                    <div id="searchBarExpanded" class="search-bar-expanded" style="display: none;">
                        <div class="search-input-wrapper">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="globalSearchInput" class="global-search-input" placeholder="æœç´¢æ—¥ç¨‹ã€æé†’ã€å¾…åŠ..." oninput="globalSearch.handleInput(event)">
                            <button class="search-clear-btn" onclick="globalSearch.clear()" style="display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <!-- ç­›é€‰ä¸‹æ‹‰æ¡† -->
                        <div class="search-filters">
                            <!-- ç±»å‹ç­›é€‰ -->
                            <select id="searchTypeFilter" class="search-filter-select" onchange="globalSearch.applyFilters()">
                                <option value="all">å…¨éƒ¨ç±»å‹</option>
                                <option value="event">æ—¥ç¨‹</option>
                                <option value="reminder">æé†’</option>
                                <option value="todo">å¾…åŠ</option>
                            </select>
                            
                            <!-- æ—¥ç¨‹ç»„ç­›é€‰ -->
                            <select id="searchGroupFilter" class="search-filter-select" onchange="globalSearch.applyFilters()">
                                <option value="all">å…¨éƒ¨æ—¥ç¨‹ç»„</option>
                                <!-- åŠ¨æ€åŠ è½½ -->
                            </select>
                            
                            <!-- æ—¶é—´èŒƒå›´ç­›é€‰ -->
                            <select id="searchTimeFilter" class="search-filter-select" onchange="globalSearch.applyFilters()">
                                <option value="all">å…¨éƒ¨æ—¶é—´</option>
                                <option value="past">è¿‡å»</option>
                                <option value="today">ä»Šå¤©</option>
                                <option value="week">æœ¬å‘¨</option>
                                <option value="month">æœ¬æœˆ</option>
                                <option value="future">æœªæ¥</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- æœç´¢ç»“æœä¸‹æ‹‰åˆ—è¡¨ -->
                    <div id="searchResultsDropdown" class="search-results-dropdown" style="display: none;">
                        <div class="search-results-list">
                            <!-- åŠ¨æ€åŠ è½½æœç´¢ç»“æœ -->
                        </div>
                    </div>
                </div>
                
                <!-- è®¾ç½®æŒ‰é’® -->
                <div id="settingsContainer" class="settings-container">
                    <!-- è®¾ç½®æŒ‰é’® (æœªæ¿€æ´»çŠ¶æ€) -->
                    <button id="settingsToggleBtn" class="settings-toggle-btn" onclick="settingsMenu.toggle()">
                        <i class="fas fa-cog"></i>
                    </button>
                    
                    <!-- è®¾ç½®èœå• (æ¿€æ´»çŠ¶æ€) - çµåŠ¨å²›å½¢å¼ -->
                    <div id="settingsMenuExpanded" class="settings-menu-expanded" style="display: none;">
                        <div class="settings-input-wrapper">
                            <button class="settings-menu-item" onclick="settingsMenu.openSettings()">
                                <i class="fas fa-cog me-2"></i>
                                <span>è®¾ç½®</span>
                            </button>
                            <button class="settings-menu-item" onclick="settingsMenu.openHelp()">
                                <i class="fas fa-question-circle me-2"></i>
                                <span>å¸®åŠ©</span>
                            </button>
                            <button class="settings-menu-item logout-item" onclick="settingsMenu.logout()">
                                <i class="fas fa-sign-out-alt me-2"></i>
                                <span>é€€å‡º</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="main-container">
        <!-- å·¦ä¾§é¢æ¿ - å¾…åŠäº‹é¡¹å’Œæé†’ -->
        <div class="left-panel resizable-panel" data-min-width="15" data-max-width="35">
            <!-- å¾…åŠäº‹é¡¹åŒºåŸŸ -->
            <div class="todo-section section-half">
                <div class="section-header">
                    <h6><i class="fas fa-tasks me-2"></i>å¾…åŠäº‹é¡¹</h6>
                    <div class="header-buttons">
                        <button class="btn btn-outline-secondary btn-sm me-1" id="todoViewToggle" onclick="todoManager.switchViewMode()" title="åˆ‡æ¢è§†å›¾">
                            <i class="fas fa-list"></i>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm me-1" onclick="todoManager.toggleFilterDropdown()" title="ç­›é€‰">
                            <i class="fas fa-filter"></i>
                        </button>
                        <button class="btn btn-primary btn-sm create-btn" onclick="modalManager.openCreateTodoModal()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                
                <!-- å¾…åŠäº‹é¡¹ç­›é€‰ä¸‹æ‹‰èœå• -->
                <div id="todoFilterDropdown" class="todo-filter-dropdown" style="display: none;">
                    <div class="filter-section">
                        <h6 class="filter-title"><i class="fas fa-th me-2"></i>é‡è¦ç´§æ€¥æ€§</h6>
                        <div id="todoPriorityFilterList">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="important-urgent" id="todo-filter-important-urgent" checked>
                                <label class="form-check-label" for="todo-filter-important-urgent">
                                    ğŸ”´ é‡è¦ä¸”ç´§æ€¥
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="important-not-urgent" id="todo-filter-important-not-urgent" checked>
                                <label class="form-check-label" for="todo-filter-important-not-urgent">
                                    ğŸŸ¡ é‡è¦ä¸ç´§æ€¥
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="not-important-urgent" id="todo-filter-not-important-urgent" checked>
                                <label class="form-check-label" for="todo-filter-not-important-urgent">
                                    ğŸŸ  ä¸é‡è¦ä½†ç´§æ€¥
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="not-important-not-urgent" id="todo-filter-not-important-not-urgent" checked>
                                <label class="form-check-label" for="todo-filter-not-important-not-urgent">
                                    ğŸŸ¢ ä¸é‡è¦ä¸ç´§æ€¥
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="unspecified" id="todo-filter-unspecified" checked>
                                <label class="form-check-label" for="todo-filter-unspecified">
                                    âšª å…¶ä»–
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <h6 class="filter-title"><i class="fas fa-folder me-2"></i>æ—¥ç¨‹ç»„</h6>
                        <div id="todoGroupFilterList">
                            <!-- å°†é€šè¿‡JSåŠ¨æ€å¡«å…… -->
                        </div>
                    </div>
                </div>
                
                <div class="section-content scrollable-content">
                    <!-- åˆ—è¡¨è§†å›¾ (åŸæœ‰) -->
                    <div id="todoListView" class="todo-view active">
                        <div id="todoList" class="todo-list">
                            <div class="loading-placeholder">
                                <i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...
                            </div>
                        </div>
                    </div>
                    
                    <!-- å››è±¡é™è§†å›¾ (æ–°å¢) -->
                    <div id="todoQuadrantView" class="todo-view" style="display: none;">
                        <div class="quadrant-container">
                            <!-- é¡¶éƒ¨æ ‡ç­¾ï¼šé‡è¦ -->
                            <div class="axis-label axis-top">é‡è¦</div>
                            <!-- åº•éƒ¨æ ‡ç­¾ï¼šä¸é‡è¦ -->
                            <div class="axis-label axis-bottom">ä¸é‡è¦</div>
                            <!-- å·¦ä¾§æ ‡ç­¾ï¼šç´§æ€¥ -->
                            <div class="axis-label axis-left">ç´§æ€¥</div>
                            <!-- å³ä¾§æ ‡ç­¾ï¼šä¸ç´§æ€¥ -->
                            <div class="axis-label axis-right">ä¸ç´§æ€¥</div>
                            
                            <!-- å››è±¡é™ç½‘æ ¼ -->
                            <div class="quadrant-grid" id="todoQuadrantGrid">
                                <div class="quadrant quadrant-important-urgent" data-quadrant="important-urgent">
                                    <div class="quadrant-todos"></div>
                                </div>
                                <div class="quadrant quadrant-important-not-urgent" data-quadrant="important-not-urgent">
                                    <div class="quadrant-todos"></div>
                                </div>
                                <div class="quadrant quadrant-not-important-urgent" data-quadrant="not-important-urgent">
                                    <div class="quadrant-todos"></div>
                                </div>
                                <div class="quadrant quadrant-not-important-not-urgent" data-quadrant="not-important-not-urgent">
                                    <div class="quadrant-todos"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æº¢å‡ºåŒºåŸŸ -->
                        <div class="overflow-container" id="todoOverflowContainer">
                            <div class="overflow-header">å…¶ä»–</div>
                            <div class="overflow-list" id="todoOverflowList"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åˆ†éš”çº¿ -->
            <div class="section-divider"></div>

            <!-- æé†’åŒºåŸŸ -->
            <div class="reminder-section section-half">
                <div class="section-header">
                    <h6><i class="fas fa-bell me-2"></i>æé†’</h6>
                    <button class="btn btn-primary btn-sm create-btn" onclick="modalManager.openCreateReminderModal()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <!-- æé†’ç­›é€‰æ§ä»¶ - å›ºå®šåœ¨é¡¶éƒ¨ -->
                <div class="reminder-filters mb-2">
                    <div class="row g-1">
                        <div class="col-6">
                            <select id="reminderTimeRange" class="form-select form-select-sm">
                                <option value="today">ä»Šå¤©</option>
                                <option value="week">æœ¬å‘¨</option>
                                <option value="month">æœ¬æœˆ</option>
                                <option value="quarter">æœ¬å­£åº¦</option>
                                <option value="year">ä¸€å¹´å†…</option>
                                <option value="all">å…¨éƒ¨æ—¶é—´</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <select id="reminderStatusFilter" class="form-select form-select-sm">
                                <option value="active">æ´»è·ƒ</option>
                                <option value="completed">å·²å®Œæˆ</option>
                                <option value="dismissed">å·²å¿½ç•¥</option>
                                <option value="snoozed">å·²å»¶å</option>
                                <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-1 mt-1">
                        <div class="col-6">
                            <select id="reminderPriorityFilter" class="form-select form-select-sm">
                                <option value="all">å…¨éƒ¨ä¼˜å…ˆçº§</option>
                                <option value="urgent">ç´§æ€¥</option>
                                <option value="high">é«˜</option>
                                <option value="normal">æ™®é€š</option>
                                <option value="low">ä½</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <select id="reminderTypeFilter" class="form-select form-select-sm">
                                <option value="all">å…¨éƒ¨ç±»å‹</option>
                                <option value="single">å•æ¬¡æé†’</option>
                                <option value="recurring">é‡å¤æé†’</option>
                                <option value="detached">å·²åˆ†ç¦»</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="section-content scrollable-content">
                    <div id="reminderList" class="reminder-list">
                        <div class="loading-placeholder">
                            <i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è°ƒèŠ‚å™¨ -->
        <div class="resize-handle left-resize" data-target="left-panel"></div>

        <!-- ä¸­å¤®é¢æ¿ - æ—¥å† -->
        <div class="center-panel resizable-panel" data-min-width="30" data-max-width="70">
            <div class="panel-header">
                <h5><i class="fas fa-calendar-alt me-2"></i>æ—¥ç¨‹æ—¥å†</h5>
                <div class="calendar-controls">
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="modalManager.openCreateEventModal()">
                        <i class="fas fa-plus me-1"></i>æ–°å»ºäº‹ä»¶
                    </button>
                    <button class="btn btn-outline-success btn-sm me-2" onclick="groupManager.showManageGroupsModal()">
                        <i class="fas fa-layer-group me-1"></i>ç®¡ç†æ—¥ç¨‹ç»„
                    </button>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="eventManager.calendar.today()">ä»Šå¤©</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="eventManager.calendar.prev()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="eventManager.calendar.next()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="panel-content calendar-content">
                <!-- é€‰é¡¹å¡åˆ‡æ¢å®¹å™¨ -->
                <div class="calendar-tabs-container" id="calendarTabsContainer">
                    <!-- æˆ‘çš„æ—¥ç¨‹é€‰é¡¹å¡ -->
                    <div class="calendar-tab active" data-type="my" data-id="my-calendar">
                        <i class="fas fa-user"></i>
                        <span>æˆ‘çš„æ—¥ç¨‹</span>
                    </div>
                    
                    <!-- ç¾¤ç»„é€‰é¡¹å¡å°†åŠ¨æ€æ’å…¥åˆ°è¿™é‡Œ -->
                    
                    <!-- æ·»åŠ ç¾¤ç»„æŒ‰é’® -->
                    <div class="calendar-tab-add" id="addGroupTab" title="ç®¡ç†åˆ†äº«ç¾¤ç»„">
                        <i class="fas fa-users-cog"></i>
                    </div>
                </div>
                
                <div id="calendar" class="calendar-container"></div>
                
                <!-- æ—¥å†ç­›é€‰ä¸‹æ‹‰èœå• -->
                <div id="calendarFilterDropdown" class="calendar-filter-dropdown" style="display: none;">
                    <div class="filter-section">
                        <h6 class="filter-title"><i class="fas fa-th me-2"></i>å››è±¡é™ç­›é€‰</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filter-important-urgent" checked>
                            <label class="form-check-label" for="filter-important-urgent">
                                é‡è¦ä¸”ç´§æ€¥
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filter-important-not-urgent" checked>
                            <label class="form-check-label" for="filter-important-not-urgent">
                                é‡è¦ä¸ç´§æ€¥
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filter-not-important-urgent" checked>
                            <label class="form-check-label" for="filter-not-important-urgent">
                                ä¸é‡è¦ä½†ç´§æ€¥
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filter-not-important-not-urgent" checked>
                            <label class="form-check-label" for="filter-not-important-not-urgent">
                                ä¸é‡è¦ä¸ç´§æ€¥
                            </label>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <h6 class="filter-title"><i class="fas fa-flag me-2"></i>æˆªæ­¢æ—¶é—´</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filter-has-ddl" checked>
                            <label class="form-check-label" for="filter-has-ddl">
                                æœ‰æˆªæ­¢æ—¶é—´
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filter-no-ddl" checked>
                            <label class="form-check-label" for="filter-no-ddl">
                                æ— æˆªæ­¢æ—¶é—´
                            </label>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <h6 class="filter-title"><i class="fas fa-repeat me-2"></i>é‡å¤äº‹ä»¶</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filter-recurring" checked>
                            <label class="form-check-label" for="filter-recurring">
                                é‡å¤äº‹ä»¶
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filter-not-recurring" checked>
                            <label class="form-check-label" for="filter-not-recurring">
                                å•æ¬¡äº‹ä»¶
                            </label>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <h6 class="filter-title"><i class="fas fa-bell me-2"></i>æé†’</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="filter-show-reminders" checked>
                            <label class="form-check-label" for="filter-show-reminders">
                                æ˜¾ç¤ºæé†’
                            </label>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <h6 class="filter-title"><i class="fas fa-folder me-2"></i>æ—¥ç¨‹ç»„</h6>
                        <div id="groupFilterList">
                            <!-- å°†é€šè¿‡JSåŠ¨æ€å¡«å…… -->
                        </div>
                        <small class="text-muted">æœªé€‰æ‹©æ—¶æ˜¾ç¤ºæ‰€æœ‰åˆ†ç»„</small>
                    </div>
                    
                    <!-- ç¾¤ç»„æˆå‘˜ç­›é€‰ï¼ˆä»…åœ¨ç¾¤ç»„è§†å›¾ä¸­æ˜¾ç¤ºï¼‰ -->
                    <div class="filter-section" id="memberFilterSection" style="display: none;">
                        <h6 class="filter-title"><i class="fas fa-users me-2"></i>ç¾¤ç»„æˆå‘˜</h6>
                        <div id="memberFilterList">
                            <!-- å°†é€šè¿‡JSåŠ¨æ€å¡«å…… -->
                        </div>
                        <small class="text-muted">æœªé€‰æ‹©æ—¶æ˜¾ç¤ºæ‰€æœ‰æˆå‘˜</small>
                    </div>
                    
                    <div class="filter-actions">
                        <button class="btn btn-sm btn-primary" onclick="window.eventManager.applyFiltersFromUI()">
                            <i class="fas fa-check me-1"></i>åº”ç”¨
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="window.eventManager.resetFilters()">
                            <i class="fas fa-undo me-1"></i>é‡ç½®
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è°ƒèŠ‚å™¨ -->
        <div class="resize-handle right-resize" data-target="center-panel"></div>

        <!-- å³ä¾§é¢æ¿ - AI Agent åŠ©æ‰‹ -->
        <div class="right-panel resizable-panel" data-min-width="20" data-max-width="50">
            <div class="panel-header">
                <h5><i class="fas fa-robot me-2"></i>AI Agent</h5>
                <div class="d-flex align-items-center gap-2">
                    <span class="agent-status-badge" id="agentStatusBadge">
                        <span class="status-dot disconnected"></span>
                        <span class="status-text">æœªè¿æ¥</span>
                    </span>
                    <!-- ä¼šè¯å†å²è®°å½•æŒ‰é’® -->
                    <button class="btn btn-outline-secondary btn-sm" id="sessionHistoryBtn" title="ä¼šè¯å†å²">
                        <i class="fas fa-history"></i>
                    </button>
                    <!-- æ–°å»ºä¼šè¯æŒ‰é’® -->
                    <button class="btn btn-outline-primary btn-sm" id="newSessionBtn" title="æ–°å»ºä¼šè¯">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn btn-outline-primary btn-sm" id="agentExpandBtn" title="å±•å¼€èŠå¤©">
                        <i class="fas fa-expand-alt"></i>
                    </button>
                </div>
            </div>
            
            <div class="panel-content scrollable-content agent-panel-content">
                <!-- ä¼šè¯å†å²é¢æ¿ï¼ˆä¸Šæ–¹ï¼Œé»˜è®¤éšè—ï¼‰ -->
                <div class="session-history-panel" id="sessionHistoryPanel" style="display: none;">
                    <div class="session-history-header">
                        <span class="fw-bold"><i class="fas fa-history me-2"></i>ä¼šè¯å†å²</span>
                        <button class="btn btn-sm btn-link text-muted" id="closeSessionHistoryBtn" title="å…³é—­">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="session-list-container" id="sessionList">
                        <div class="text-muted text-center py-3">åŠ è½½ä¸­...</div>
                    </div>
                </div>
                
                <!-- Agent èŠå¤©åŒºåŸŸ -->
                <div class="agent-chat-container" id="agentChatContainer">
                    <div class="agent-messages" id="agentMessages">
                        <!-- æ¬¢è¿æ¶ˆæ¯åªåœ¨æ²¡æœ‰å†å²æ¶ˆæ¯æ—¶æ˜¾ç¤ºï¼Œç”± JS æ§åˆ¶ -->
                    </div>
                    
                    <!-- æ‰“å­—æŒ‡ç¤ºå™¨ -->
                    <div class="typing-indicator" id="agentTyping" style="display: none;">
                        <span></span><span></span><span></span>
                        <span class="typing-text">Agent æ­£åœ¨æ€è€ƒ...</span>
                    </div>
                </div>
                
                <!-- å·¥å…·é€‰æ‹©é¢æ¿ï¼ˆåˆ†æ æ˜¾ç¤ºï¼‰ -->
                <div class="tool-select-panel" id="toolSelectPanel" style="display: none;">
                    <!-- ç”± JS åŠ¨æ€æ¸²æŸ“ -->
                </div>
                
                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="agent-input-area" id="agentInputArea">
                    <div class="input-wrapper">
                        <textarea class="form-control" id="agentInput" 
                            placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒæŒ‰ Enter å‘é€..." 
                            rows="1"></textarea>
                        <!-- å·¥å…·é€‰æ‹©æŒ‰é’® -->
                        <button class="btn btn-outline-secondary tool-select-btn" id="toolSelectBtn" title="å·¥å…·é€‰æ‹©">
                            <i class="fas fa-tools"></i>
                        </button>
                        <button class="btn btn-primary send-btn" id="agentSendBtn" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="input-hint">
                        <small class="text-muted">
                            <kbd>Enter</kbd> å‘é€ | <kbd>Shift + Enter</kbd> æ¢è¡Œ
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºäº‹ä»¶æ¨¡æ€æ¡† -->
    <div class="modal" id="createEventModal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-plus me-2"></i>åˆ›å»ºæ–°äº‹ä»¶
                </h5>
                <span class="close">&times;</span>
            </div>
            
            <form id="createEventForm" class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="newEventTitle" class="form-label">æ ‡é¢˜ *</label>
                        <input type="text" class="form-control form-input" id="newEventTitle" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="newEventGroupId" class="form-label">æ—¥ç¨‹ç»„</label>
                        <select class="form-select" id="newEventGroupId">
                            <option value="">æ— </option>
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="newEventStart" class="form-label">å¼€å§‹æ—¶é—´ *</label>
                        <input type="datetime-local" class="form-control form-input" id="newEventStart" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="newEventEnd" class="form-label">ç»“æŸæ—¶é—´ *</label>
                        <input type="datetime-local" class="form-control form-input" id="newEventEnd" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="creatEventDdl" class="form-label">æˆªæ­¢æ—¶é—´</label>
                        <input type="datetime-local" class="form-control" id="creatEventDdl">
                    </div>
                    
                    <!-- RRuleé‡å¤è®¾ç½® -->
                    <div class="col-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="newEventIsRecurring">
                            <label class="form-check-label" for="newEventIsRecurring">
                                <i class="fas fa-repeat me-1"></i>é‡å¤äº‹ä»¶
                            </label>
                        </div>
                    </div>
                    
                    <!-- é‡å¤äº‹ä»¶è®¾ç½®åŒºåŸŸ -->
                    <div class="col-12" id="newEventRecurringOptions" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-cog me-2"></i>é‡å¤è®¾ç½®</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <!-- é‡å¤é¢‘ç‡ -->
                                    <div class="col-md-4">
                                        <label for="newEventFreq" class="form-label">é‡å¤é¢‘ç‡</label>
                                        <select class="form-select" id="newEventFreq">
                                            <option value="DAILY">æ¯æ—¥</option>
                                            <option value="WEEKLY">æ¯å‘¨</option>
                                            <option value="MONTHLY">æ¯æœˆ</option>
                                            <option value="YEARLY">æ¯å¹´</option>
                                        </select>
                                    </div>
                                    
                                    <!-- é‡å¤é—´éš” -->
                                    <div class="col-md-4">
                                        <label for="newEventInterval" class="form-label">é—´éš”</label>
                                        <input type="number" class="form-control" id="newEventInterval" value="1" min="1" max="365">
                                    </div>
                                    
                                    <!-- ç»“æŸæ¡ä»¶ -->
                                    <div class="col-md-4">
                                        <label for="newEventEndType" class="form-label">ç»“æŸæ¡ä»¶</label>
                                        <select class="form-select" id="newEventEndType">
                                            <option value="never">æ°¸ä¸ç»“æŸ</option>
                                            <option value="count">é‡å¤æ¬¡æ•°</option>
                                            <option value="until">ç»“æŸæ—¥æœŸ</option>
                                        </select>
                                    </div>
                                    
                                    <!-- é‡å¤æ¬¡æ•° -->
                                    <div class="col-md-6" id="newEventCountContainer" style="display: none;">
                                        <label for="newEventCount" class="form-label">é‡å¤æ¬¡æ•°</label>
                                        <input type="number" class="form-control" id="newEventCount" value="10" min="1" max="999">
                                    </div>
                                    
                                    <!-- ç»“æŸæ—¥æœŸ -->
                                    <div class="col-md-6" id="newEventUntilContainer" style="display: none;">
                                        <label for="newEventUntil" class="form-label">ç»“æŸæ—¥æœŸ</label>
                                        <input type="date" class="form-control" id="newEventUntil">
                                    </div>
                                    
                                    <!-- æ¯å‘¨é‡å¤çš„æ˜ŸæœŸé€‰æ‹© -->
                                    <div class="col-12" id="newEventWeekdaysContainer" style="display: none;">
                                        <label class="form-label">é‡å¤æ˜ŸæœŸ</label>
                                        <div class="weekday-buttons">
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="MO">å‘¨ä¸€</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="TU">å‘¨äºŒ</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="WE">å‘¨ä¸‰</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="TH">å‘¨å››</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="FR">å‘¨äº”</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="SA">å‘¨å…­</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="SU">å‘¨æ—¥</button>
                                        </div>
                                    </div>
                                    
                                    <!-- æ¯æœˆé‡å¤è®¾ç½® -->
                                    <div class="col-md-6" id="newEventMonthlyOptions" style="display: none;">
                                        <label for="newEventMonthlyType" class="form-label">æœˆé‡å¤æ–¹å¼</label>
                                        <select class="form-select" id="newEventMonthlyType">
                                            <option value="simple">æ¯éš”æŒ‡å®šæœˆæ•°</option>
                                            <option value="bymonthday">æŒ‰æ—¥æœŸï¼ˆä¾‹å¦‚ï¼šæ¯æœˆ15æ—¥ï¼‰</option>
                                            <option value="byweekday">æŒ‰æ˜ŸæœŸï¼ˆä¾‹å¦‚ï¼šæ¯æœˆç¬¬äºŒä¸ªå‘¨ä¸€ï¼‰</option>
                                        </select>
                                    </div>
                                    
                                    <!-- æŒ‰æ—¥æœŸé‡å¤çš„é€‰æ‹© -->
                                    <div class="col-md-6" id="newEventMonthlyDateOptions" style="display: none;">
                                        <label for="newEventMonthlyDate" class="form-label">é€‰æ‹©æ—¥æœŸ</label>
                                        <select class="form-select" id="newEventMonthlyDate">
                                            <option value="1">1æ—¥</option>
                                            <option value="2">2æ—¥</option>
                                            <option value="3">3æ—¥</option>
                                            <option value="4">4æ—¥</option>
                                            <option value="5">5æ—¥</option>
                                            <option value="6">6æ—¥</option>
                                            <option value="7">7æ—¥</option>
                                            <option value="8">8æ—¥</option>
                                            <option value="9">9æ—¥</option>
                                            <option value="10">10æ—¥</option>
                                            <option value="11">11æ—¥</option>
                                            <option value="12">12æ—¥</option>
                                            <option value="13">13æ—¥</option>
                                            <option value="14">14æ—¥</option>
                                            <option value="15">15æ—¥</option>
                                            <option value="16">16æ—¥</option>
                                            <option value="17">17æ—¥</option>
                                            <option value="18">18æ—¥</option>
                                            <option value="19">19æ—¥</option>
                                            <option value="20">20æ—¥</option>
                                            <option value="21">21æ—¥</option>
                                            <option value="22">22æ—¥</option>
                                            <option value="23">23æ—¥</option>
                                            <option value="24">24æ—¥</option>
                                            <option value="25">25æ—¥</option>
                                            <option value="26">26æ—¥</option>
                                            <option value="27">27æ—¥</option>
                                            <option value="28">28æ—¥</option>
                                            <option value="29">29æ—¥</option>
                                            <option value="30">30æ—¥</option>
                                            <option value="31">31æ—¥</option>
                                            <option value="-1">æœˆæœ«</option>
                                        </select>
                                    </div>
                                    
                                    <!-- æŒ‰æ˜ŸæœŸé‡å¤çš„é€‰æ‹© -->
                                    <div class="col-md-3" id="newEventMonthlyWeekOptions" style="display: none;">
                                        <label for="newEventMonthlyWeek" class="form-label">ç¬¬å‡ å‘¨</label>
                                        <select class="form-select" id="newEventMonthlyWeek">
                                            <option value="1">ç¬¬ä¸€å‘¨</option>
                                            <option value="2">ç¬¬äºŒå‘¨</option>
                                            <option value="3">ç¬¬ä¸‰å‘¨</option>
                                            <option value="4">ç¬¬å››å‘¨</option>
                                            <option value="-1">æœ€åä¸€å‘¨</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-3" id="newEventMonthlyWeekdayOptions" style="display: none;">
                                        <label for="newEventMonthlyWeekday" class="form-label">æ˜ŸæœŸå‡ </label>
                                        <select class="form-select" id="newEventMonthlyWeekday">
                                            <option value="MO">å‘¨ä¸€</option>
                                            <option value="TU">å‘¨äºŒ</option>
                                            <option value="WE">å‘¨ä¸‰</option>
                                            <option value="TH">å‘¨å››</option>
                                            <option value="FR">å‘¨äº”</option>
                                            <option value="SA">å‘¨å…­</option>
                                            <option value="SU">å‘¨æ—¥</option>
                                        </select>
                                    </div>
                                    
                                    <!-- RRuleé¢„è§ˆ -->
                                    <div class="col-12">
                                        <label class="form-label">é‡å¤è§„åˆ™é¢„è§ˆ</label>
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <span id="newEventRulePreview">è¯·é€‰æ‹©é‡å¤è®¾ç½®</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <label for="newEventDescription" class="form-label">æè¿°</label>
                        <textarea class="form-control" id="newEventDescription" rows="3"></textarea>
                    </div>
                    
                    <!-- é‡è¦æ€§ç´§æ€¥æ€§çŸ©é˜µ -->
                    <div class="col-12">
                        <label class="form-label">é‡è¦æ€§ / ç´§æ€¥æ€§</label>
                        <div class="importance-urgency-matrix">
                            <div class="matrix-row">
                                <button type="button" class="matrix-button important-urgent" 
                                        data-importance="important" data-urgency="urgent"
                                        onclick="setImportanceUrgency('important', 'urgent', this)">
                                    é‡è¦ç´§æ€¥
                                </button>
                                <button type="button" class="matrix-button important-not-urgent" 
                                        data-importance="important" data-urgency="not-urgent"
                                        onclick="setImportanceUrgency('important', 'not-urgent', this)">
                                    é‡è¦ä¸ç´§æ€¥
                                </button>
                            </div>
                            <div class="matrix-row">
                                <button type="button" class="matrix-button not-important-urgent" 
                                        data-importance="not-important" data-urgency="urgent"
                                        onclick="setImportanceUrgency('not-important', 'urgent', this)">
                                    ä¸é‡è¦ç´§æ€¥
                                </button>
                                <button type="button" class="matrix-button not-important-not-urgent" 
                                        data-importance="not-important" data-urgency="not-urgent"
                                        onclick="setImportanceUrgency('not-important', 'not-urgent', this)">
                                    ä¸é‡è¦ä¸ç´§æ€¥
                                </button>
                            </div>
                        </div>
                        <input type="hidden" id="newEventImportance">
                        <input type="hidden" id="newEventUrgency">
                    </div>
                    
                    <!-- åˆ†äº«åˆ°ç¾¤ç»„ -->
                    <div class="col-12">
                        <label class="form-label">
                            <i class="fas fa-share-alt me-2"></i>åˆ†äº«åˆ°ç¾¤ç»„
                        </label>
                        <div class="share-groups-selector" id="newEventShareGroupsSelector">
                            <!-- åŠ¨æ€æ¸²æŸ“ç¾¤ç»„åˆ—è¡¨ -->
                            <small class="text-muted">åŠ è½½ä¸­...</small>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="modalManager.closeAllModals()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">åˆ›å»ºäº‹ä»¶</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç¼–è¾‘äº‹ä»¶æ¨¡æ€æ¡† -->
    <div class="modal" id="editEventModal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-edit me-2"></i>ç¼–è¾‘äº‹ä»¶
                </h5>
                <span class="close">&times;</span>
            </div>
            
            <form id="editEventForm" class="modal-body">
                <input type="hidden" id="eventId">
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="eventTitle" class="form-label">æ ‡é¢˜ *</label>
                        <input type="text" class="form-control form-input" id="eventTitle" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="eventGroupId" class="form-label">æ—¥ç¨‹ç»„</label>
                        <select class="form-select" id="eventGroupId">
                            <option value="">æ— </option>
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="eventStart" class="form-label">å¼€å§‹æ—¶é—´ *</label>
                        <input type="datetime-local" class="form-control form-input" id="eventStart" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="eventEnd" class="form-label">ç»“æŸæ—¶é—´ *</label>
                        <input type="datetime-local" class="form-control form-input" id="eventEnd" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="eventDdl" class="form-label">æˆªæ­¢æ—¶é—´</label>
                        <input type="datetime-local" class="form-control" id="eventDdl">
                    </div>
                    
                    <div class="col-12">
                        <label for="eventDescription" class="form-label">æè¿°</label>
                        <textarea class="form-control" id="eventDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="col-12">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="eventRepeat" onchange="if(!this.disabled) toggleRepeatOptions('editEvent'); else this.checked = false;">
                            <label class="form-check-label" for="eventRepeat">
                                <i class="fas fa-repeat me-2"></i>é‡å¤æ—¥ç¨‹
                            </label>
                        </div>
                    </div>
                    
                    <!-- é‡å¤äº‹ä»¶ä¿¡æ¯æ˜¾ç¤º -->
                    <div class="col-12" id="editEventRecurringInfo" style="display: none;">
                        <div class="alert alert-warning">
                            <i class="fas fa-repeat me-2"></i>
                            <strong>è¿™æ˜¯ä¸€ä¸ªé‡å¤äº‹ä»¶</strong>
                            <p class="mb-2">ä¿®æ”¹èŒƒå›´ï¼š</p>
                            <div class="btn-group-vertical w-100" role="group">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="editEventScope" id="editScopeThis" value="single" checked>
                                    <label class="form-check-label" for="editScopeThis">
                                        <strong>ä»…æ­¤æ¬¡</strong>
                                        <small class="text-muted d-block">åªä¿®æ”¹å½“å‰é€‰ä¸­çš„äº‹ä»¶å®ä¾‹</small>
                                    </label>
                                </div>
                                
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="editEventScope" id="editScopeAll" value="all">
                                    <label class="form-check-label" for="editScopeAll">
                                        <strong>å…¨éƒ¨</strong>
                                        <small class="text-muted d-block">ä¿®æ”¹æ•´ä¸ªé‡å¤äº‹ä»¶ç³»åˆ—</small>
                                    </label>
                                </div>
                                
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="editEventScope" id="editScopeFuture" value="future">
                                    <label class="form-check-label" for="editScopeFuture">
                                        <strong>æ­¤åŠä¹‹å</strong>
                                        <small class="text-muted d-block">ä¿®æ”¹å½“å‰åŠä¹‹åçš„æ‰€æœ‰äº‹ä»¶å®ä¾‹</small>
                                    </label>
                                </div>
                                
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="editEventScope" id="editScopeFromTime" value="from_time">
                                    <label class="form-check-label" for="editScopeFromTime">
                                        <strong>ä»æŒ‡å®šæ—¶é—´å¼€å§‹</strong>
                                        <small class="text-muted d-block">ä»é€‰æ‹©çš„æ—¶é—´ç‚¹å¼€å§‹ä¿®æ”¹</small>
                                    </label>
                                    <select class="form-select form-select-sm mt-2" id="editEventTimeSelect" style="display: none;">
                                        <!-- åŠ¨æ€å¡«å……æ—¶é—´é€‰é¡¹ -->
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- RRuleç¼–è¾‘è®¾ç½® -->
                    <div class="col-12" id="editEventRecurringOptions" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-cog me-2"></i>é‡å¤è®¾ç½®ä¿®æ”¹</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <!-- é‡å¤é¢‘ç‡ -->
                                    <div class="col-md-4">
                                        <label for="editEventFreq" class="form-label">é‡å¤é¢‘ç‡</label>
                                        <select class="form-select" id="editEventFreq" onchange="if(window.rruleManager) window.rruleManager.updateFrequencyOptions('edit');">
                                            <option value="DAILY">æ¯æ—¥</option>
                                            <option value="WEEKLY">æ¯å‘¨</option>
                                            <option value="MONTHLY">æ¯æœˆ</option>
                                            <option value="YEARLY">æ¯å¹´</option>
                                        </select>
                                    </div>
                                    
                                    <!-- é‡å¤é—´éš” -->
                                    <div class="col-md-4">
                                        <label for="editEventInterval" class="form-label">é—´éš”</label>
                                        <input type="number" class="form-control" id="editEventInterval" value="1" min="1" max="365">
                                    </div>
                                    
                                    <!-- ç»“æŸæ¡ä»¶ -->
                                    <div class="col-md-4">
                                        <label for="editEventEndType" class="form-label">ç»“æŸæ¡ä»¶</label>
                                        <select class="form-select" id="editEventEndType">
                                            <option value="never">æ°¸ä¸ç»“æŸ</option>
                                            <option value="count">é‡å¤æ¬¡æ•°</option>
                                            <option value="until">ç»“æŸæ—¥æœŸ</option>
                                        </select>
                                    </div>
                                    
                                    <!-- é‡å¤æ¬¡æ•° -->
                                    <div class="col-md-6" id="editEventCountContainer" style="display: none;">
                                        <label for="editEventCount" class="form-label">é‡å¤æ¬¡æ•°</label>
                                        <input type="number" class="form-control" id="editEventCount" value="10" min="1" max="999">
                                    </div>
                                    
                                    <!-- ç»“æŸæ—¥æœŸ -->
                                    <div class="col-md-6" id="editEventUntilContainer" style="display: none;">
                                        <label for="editEventUntil" class="form-label">ç»“æŸæ—¥æœŸ</label>
                                        <input type="date" class="form-control" id="editEventUntil">
                                    </div>
                                    
                                    <!-- æ¯å‘¨é‡å¤çš„æ˜ŸæœŸé€‰æ‹© -->
                                    <div class="col-12" id="editEventWeekdaysContainer" style="display: none;">
                                        <label class="form-label">é‡å¤æ˜ŸæœŸ</label>
                                        <div class="weekday-buttons">
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="MO">å‘¨ä¸€</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="TU">å‘¨äºŒ</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="WE">å‘¨ä¸‰</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="TH">å‘¨å››</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="FR">å‘¨äº”</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="SA">å‘¨å…­</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="SU">å‘¨æ—¥</button>
                                        </div>
                                    </div>
                                    
                                    <!-- æ¯æœˆé‡å¤è®¾ç½® -->
                                    <div class="col-md-6" id="editEventMonthlyOptions" style="display: none;">
                                        <label for="editEventMonthlyType" class="form-label">æœˆé‡å¤æ–¹å¼</label>
                                        <select class="form-select" id="editEventMonthlyType" onchange="if(window.rruleManager) window.rruleManager.updateEventMonthlyOptions('edit');">
                                            <option value="simple">æ¯éš”æŒ‡å®šæœˆæ•°</option>
                                            <option value="bymonthday">æŒ‰æ—¥æœŸï¼ˆä¾‹å¦‚ï¼šæ¯æœˆ15æ—¥ï¼‰</option>
                                            <option value="byweekday">æŒ‰æ˜ŸæœŸï¼ˆä¾‹å¦‚ï¼šæ¯æœˆç¬¬äºŒä¸ªå‘¨ä¸€ï¼‰</option>
                                        </select>
                                    </div>
                                    
                                    <!-- æŒ‰æ—¥æœŸé‡å¤çš„é€‰æ‹© -->
                                    <div class="col-md-6" id="editEventMonthlyDateOptions" style="display: none;">
                                        <label for="editEventMonthlyDate" class="form-label">é€‰æ‹©æ—¥æœŸ</label>
                                        <select class="form-select" id="editEventMonthlyDate">
                                            <option value="1">1æ—¥</option>
                                            <option value="2">2æ—¥</option>
                                            <option value="3">3æ—¥</option>
                                            <option value="4">4æ—¥</option>
                                            <option value="5">5æ—¥</option>
                                            <option value="6">6æ—¥</option>
                                            <option value="7">7æ—¥</option>
                                            <option value="8">8æ—¥</option>
                                            <option value="9">9æ—¥</option>
                                            <option value="10">10æ—¥</option>
                                            <option value="11">11æ—¥</option>
                                            <option value="12">12æ—¥</option>
                                            <option value="13">13æ—¥</option>
                                            <option value="14">14æ—¥</option>
                                            <option value="15">15æ—¥</option>
                                            <option value="16">16æ—¥</option>
                                            <option value="17">17æ—¥</option>
                                            <option value="18">18æ—¥</option>
                                            <option value="19">19æ—¥</option>
                                            <option value="20">20æ—¥</option>
                                            <option value="21">21æ—¥</option>
                                            <option value="22">22æ—¥</option>
                                            <option value="23">23æ—¥</option>
                                            <option value="24">24æ—¥</option>
                                            <option value="25">25æ—¥</option>
                                            <option value="26">26æ—¥</option>
                                            <option value="27">27æ—¥</option>
                                            <option value="28">28æ—¥</option>
                                            <option value="29">29æ—¥</option>
                                            <option value="30">30æ—¥</option>
                                            <option value="31">31æ—¥</option>
                                            <option value="-1">æœˆæœ«</option>
                                        </select>
                                    </div>
                                    
                                    <!-- æŒ‰æ˜ŸæœŸé‡å¤çš„é€‰æ‹© -->
                                    <div class="col-md-3" id="editEventMonthlyWeekOptions" style="display: none;">
                                        <label for="editEventMonthlyWeek" class="form-label">ç¬¬å‡ å‘¨</label>
                                        <select class="form-select" id="editEventMonthlyWeek">
                                            <option value="1">ç¬¬ä¸€å‘¨</option>
                                            <option value="2">ç¬¬äºŒå‘¨</option>
                                            <option value="3">ç¬¬ä¸‰å‘¨</option>
                                            <option value="4">ç¬¬å››å‘¨</option>
                                            <option value="-1">æœ€åä¸€å‘¨</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-3" id="editEventMonthlyWeekdayOptions" style="display: none;">
                                        <label for="editEventMonthlyWeekday" class="form-label">æ˜ŸæœŸå‡ </label>
                                        <select class="form-select" id="editEventMonthlyWeekday">
                                            <option value="MO">å‘¨ä¸€</option>
                                            <option value="TU">å‘¨äºŒ</option>
                                            <option value="WE">å‘¨ä¸‰</option>
                                            <option value="TH">å‘¨å››</option>
                                            <option value="FR">å‘¨äº”</option>
                                            <option value="SA">å‘¨å…­</option>
                                            <option value="SU">å‘¨æ—¥</option>
                                        </select>
                                    </div>
                                    
                                    <!-- RRuleé¢„è§ˆ -->
                                    <div class="col-12">
                                        <label class="form-label">é‡å¤è§„åˆ™é¢„è§ˆ</label>
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <span id="editEventRulePreview">å½“å‰é‡å¤è§„åˆ™</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- é‡è¦æ€§ç´§æ€¥æ€§çŸ©é˜µ -->
                    <div class="col-12">
                        <label class="form-label">é‡è¦æ€§ / ç´§æ€¥æ€§</label>
                        <div class="importance-urgency-matrix">
                            <div class="matrix-row">
                                <button type="button" class="matrix-button important-urgent" 
                                        data-importance="important" data-urgency="urgent"
                                        onclick="setImportanceUrgency('important', 'urgent', this)">
                                    é‡è¦ç´§æ€¥
                                </button>
                                <button type="button" class="matrix-button important-not-urgent" 
                                        data-importance="important" data-urgency="not-urgent"
                                        onclick="setImportanceUrgency('important', 'not-urgent', this)">
                                    é‡è¦ä¸ç´§æ€¥
                                </button>
                            </div>
                            <div class="matrix-row">
                                <button type="button" class="matrix-button not-important-urgent" 
                                        data-importance="not-important" data-urgency="urgent"
                                        onclick="setImportanceUrgency('not-important', 'urgent', this)">
                                    ä¸é‡è¦ç´§æ€¥
                                </button>
                                <button type="button" class="matrix-button not-important-not-urgent" 
                                        data-importance="not-important" data-urgency="not-urgent"
                                        onclick="setImportanceUrgency('not-important', 'not-urgent', this)">
                                    ä¸é‡è¦ä¸ç´§æ€¥
                                </button>
                            </div>
                        </div>
                        <input type="hidden" id="eventImportance">
                        <input type="hidden" id="eventUrgency">
                    </div>
                    
                    <!-- åˆ†äº«åˆ°ç¾¤ç»„ -->
                    <div class="col-12">
                        <label class="form-label">
                            <i class="fas fa-share-alt me-2"></i>åˆ†äº«åˆ°ç¾¤ç»„
                        </label>
                        <div class="share-groups-selector" id="eventShareGroupsSelector">
                            <!-- åŠ¨æ€æ¸²æŸ“ç¾¤ç»„åˆ—è¡¨ -->
                            <small class="text-muted">åŠ è½½ä¸­...</small>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="modalManager.handleDeleteEvent()">åˆ é™¤</button>
                    <button type="button" class="btn btn-secondary" onclick="modalManager.closeAllModals()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary" onclick="modalManager.handleUpdateEvent()">æ›´æ–°äº‹ä»¶</button>
                </div>
            </form>
        </div>
    </div>

    <!-- é‡å¤äº‹ä»¶åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal" id="deleteRecurringEventModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i>åˆ é™¤é‡å¤äº‹ä»¶
                </h5>
                <span class="close">&times;</span>
            </div>
            
            <div class="modal-body">
                <p>è¿™æ˜¯ä¸€ä¸ªé‡å¤äº‹ä»¶ï¼Œè¯·é€‰æ‹©åˆ é™¤èŒƒå›´ï¼š</p>
                
                <div class="delete-scope-options">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deleteEventScope" id="deleteScopeThis" value="single" checked>
                        <label class="form-check-label" for="deleteScopeThis">
                            <strong>ä»…æ­¤æ¬¡</strong>
                            <small class="text-muted d-block">åªåˆ é™¤å½“å‰é€‰ä¸­çš„äº‹ä»¶å®ä¾‹</small>
                        </label>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deleteEventScope" id="deleteScopeAll" value="all">
                        <label class="form-check-label" for="deleteScopeAll">
                            <strong>å…¨éƒ¨</strong>
                            <small class="text-muted d-block">åˆ é™¤æ•´ä¸ªé‡å¤äº‹ä»¶ç³»åˆ—</small>
                        </label>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deleteEventScope" id="deleteScopeFuture" value="future">
                        <label class="form-check-label" for="deleteScopeFuture">
                            <strong>æ­¤åŠä¹‹å</strong>
                            <small class="text-muted d-block">åˆ é™¤å½“å‰åŠä¹‹åçš„æ‰€æœ‰äº‹ä»¶å®ä¾‹</small>
                        </label>
                    </div>
                </div>
                
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>æ³¨æ„ï¼š</strong>åˆ é™¤æ“ä½œæ— æ³•æ’¤é”€ï¼
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="modalManager.closeAllModals()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" onclick="modalManager.confirmDeleteRecurringEvent()">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºå¾…åŠäº‹é¡¹æ¨¡æ€æ¡† -->
    <div class="modal" id="createTodoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle me-2"></i>åˆ›å»ºå¾…åŠäº‹é¡¹
                </h5>
                <span class="close">&times;</span>
            </div>
            
            <form id="createTodoForm" class="modal-body">
                <div class="row g-3">
                    <div class="col-12">
                        <label for="newTodoTitle" class="form-label">æ ‡é¢˜ *</label>
                        <input type="text" class="form-control form-input" id="newTodoTitle" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="newTodoDueDate" class="form-label">åˆ°æœŸæ—¶é—´</label>
                        <input type="datetime-local" class="form-control" id="newTodoDueDate">
                    </div>
                    
                    <div class="col-md-6">
                        <label for="newTodoEstimatedDuration" class="form-label">é¢„è®¡è€—æ—¶ï¼ˆåˆ†é’Ÿï¼‰</label>
                        <input type="number" class="form-control" id="newTodoEstimatedDuration" min="1">
                    </div>
                    
                    <!-- é‡è¦æ€§ç´§æ€¥æ€§çŸ©é˜µ -->
                    <div class="col-12">
                        <label class="form-label">é‡è¦æ€§ / ç´§æ€¥æ€§</label>
                        <div class="importance-urgency-matrix">
                            <div class="matrix-row">
                                <button type="button" class="matrix-button important-urgent" 
                                        data-importance="important" data-urgency="urgent"
                                        onclick="setImportanceUrgency('important', 'urgent', this)">
                                    é‡è¦ç´§æ€¥
                                </button>
                                <button type="button" class="matrix-button important-not-urgent" 
                                        data-importance="important" data-urgency="not-urgent"
                                        onclick="setImportanceUrgency('important', 'not-urgent', this)">
                                    é‡è¦ä¸ç´§æ€¥
                                </button>
                            </div>
                            <div class="matrix-row">
                                <button type="button" class="matrix-button not-important-urgent" 
                                        data-importance="not-important" data-urgency="urgent"
                                        onclick="setImportanceUrgency('not-important', 'urgent', this)">
                                    ä¸é‡è¦ç´§æ€¥
                                </button>
                                <button type="button" class="matrix-button not-important-not-urgent" 
                                        data-importance="not-important" data-urgency="not-urgent"
                                        onclick="setImportanceUrgency('not-important', 'not-urgent', this)">
                                    ä¸é‡è¦ä¸ç´§æ€¥
                                </button>
                            </div>
                        </div>
                        <input type="hidden" id="newTodoImportance">
                        <input type="hidden" id="newTodoUrgency">
                    </div>
                    
                    <div class="col-12">
                        <label for="newTodoGroupId" class="form-label">æ—¥ç¨‹ç»„</label>
                        <select class="form-select" id="newTodoGroupId">
                            <option value="">æ— </option>
                        </select>
                    </div>
                    
                    <div class="col-12">
                        <label for="newTodoDescription" class="form-label">æè¿°</label>
                        <textarea class="form-control" id="newTodoDescription" rows="3"></textarea>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="modalManager.closeAllModals()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">åˆ›å»ºå¾…åŠ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç¼–è¾‘å¾…åŠäº‹é¡¹æ¨¡æ€æ¡† -->
    <div class="modal" id="editTodoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>ç¼–è¾‘å¾…åŠäº‹é¡¹
                </h5>
                <span class="close">&times;</span>
            </div>
            
            <form id="editTodoForm" class="modal-body">
                <input type="hidden" id="todoId">
                
                <div class="row g-3">
                    <div class="col-12">
                        <label for="todoTitle" class="form-label">æ ‡é¢˜ *</label>
                        <input type="text" class="form-control form-input" id="todoTitle" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="todoDueDate" class="form-label">åˆ°æœŸæ—¶é—´</label>
                        <input type="datetime-local" class="form-control" id="todoDueDate">
                    </div>
                    
                    <div class="col-md-6">
                        <label for="todoEstimatedDuration" class="form-label">é¢„è®¡è€—æ—¶ï¼ˆåˆ†é’Ÿï¼‰</label>
                        <input type="number" class="form-control" id="todoEstimatedDuration" min="1">
                    </div>
                    
                    <!-- é‡è¦æ€§ç´§æ€¥æ€§çŸ©é˜µ -->
                    <div class="col-12">
                        <label class="form-label">é‡è¦æ€§ / ç´§æ€¥æ€§</label>
                        <div class="importance-urgency-matrix">
                            <div class="matrix-row">
                                <button type="button" class="matrix-button important-urgent" 
                                        data-importance="important" data-urgency="urgent"
                                        onclick="setImportanceUrgency('important', 'urgent', this)">
                                    é‡è¦ç´§æ€¥
                                </button>
                                <button type="button" class="matrix-button important-not-urgent" 
                                        data-importance="important" data-urgency="not-urgent"
                                        onclick="setImportanceUrgency('important', 'not-urgent', this)">
                                    é‡è¦ä¸ç´§æ€¥
                                </button>
                            </div>
                            <div class="matrix-row">
                                <button type="button" class="matrix-button not-important-urgent" 
                                        data-importance="not-important" data-urgency="urgent"
                                        onclick="setImportanceUrgency('not-important', 'urgent', this)">
                                    ä¸é‡è¦ç´§æ€¥
                                </button>
                                <button type="button" class="matrix-button not-important-not-urgent" 
                                        data-importance="not-important" data-urgency="not-urgent"
                                        onclick="setImportanceUrgency('not-important', 'not-urgent', this)">
                                    ä¸é‡è¦ä¸ç´§æ€¥
                                </button>
                            </div>
                        </div>
                        <input type="hidden" id="todoImportance">
                        <input type="hidden" id="todoUrgency">
                    </div>
                    
                    <div class="col-12">
                        <label for="todoGroupId" class="form-label">æ—¥ç¨‹ç»„</label>
                        <select class="form-select" id="todoGroupId">
                            <option value="">æ— </option>
                        </select>
                    </div>
                    
                    <div class="col-12">
                        <label for="todoDescription" class="form-label">æè¿°</label>
                        <textarea class="form-control" id="todoDescription" rows="3"></textarea>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="todoManager.deleteTodo(modalManager.currentTodoId)">åˆ é™¤</button>
                    <button type="button" class="btn btn-secondary" onclick="modalManager.closeAllModals()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary" onclick="modalManager.handleUpdateTodo()">æ›´æ–°å¾…åŠ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å¾…åŠäº‹é¡¹è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal" id="todoDetailModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i><span id="todoDetailTitle"></span>
                </h5>
                <span class="close" onclick="todoManager.closeTodoDetailModal()">&times;</span>
            </div>
            
            <div class="modal-body">
                <div class="todo-detail-info">
                    <div class="detail-row">
                        <div class="detail-label">
                            <i class="fas fa-flag me-2"></i>ä¼˜å…ˆçº§
                        </div>
                        <div class="detail-value" id="todoDetailPriority"></div>
                    </div>
                    
                    <div class="detail-row" id="todoDetailGroupRow" style="display: none;">
                        <div class="detail-label">
                            <i class="fas fa-folder me-2"></i>æ—¥ç¨‹ç»„
                        </div>
                        <div class="detail-value" id="todoDetailGroup"></div>
                    </div>
                    
                    <div class="detail-row" id="todoDetailDescriptionRow" style="display: none;">
                        <div class="detail-label">
                            <i class="fas fa-align-left me-2"></i>æè¿°
                        </div>
                        <div class="detail-value" id="todoDetailDescription" style="white-space: pre-wrap;"></div>
                    </div>
                    
                    <div class="detail-row" id="todoDetailDurationRow" style="display: none;">
                        <div class="detail-label">
                            <i class="fas fa-clock me-2"></i>é¢„è®¡è€—æ—¶
                        </div>
                        <div class="detail-value" id="todoDetailDuration"></div>
                    </div>
                    
                    <div class="detail-row" id="todoDetailDueDateRow" style="display: none;">
                        <div class="detail-label">
                            <i class="fas fa-calendar-times me-2"></i>æˆªæ­¢æ—¶é—´
                        </div>
                        <div class="detail-value" id="todoDetailDueDate"></div>
                    </div>
                </div>
                
                <div class="modal-footer" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                    <button type="button" class="btn btn-secondary" onclick="todoManager.closeTodoDetailModal()">å…³é—­</button>
                    <button type="button" class="btn btn-primary" id="todoDetailEditBtn">
                        <i class="fas fa-edit me-1"></i>ç¼–è¾‘
                    </button>
                    <button type="button" class="btn btn-danger" id="todoDetailDeleteBtn">
                        <i class="fas fa-trash me-1"></i>åˆ é™¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºæé†’æ¨¡æ€æ¡† -->
    <div class="modal" id="createReminderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-bell-plus me-2"></i>åˆ›å»ºæé†’
                </h5>
                <span class="close">&times;</span>
            </div>
            
            <form id="createReminderForm" class="modal-body">
                <div class="row g-3">
                    <div class="col-12">
                        <label for="newReminderTitle" class="form-label">æ ‡é¢˜ *</label>
                        <input type="text" class="form-control form-input" id="newReminderTitle" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="newReminderTriggerTime" class="form-label">æé†’æ—¶é—´ *</label>
                        <input type="datetime-local" class="form-control form-input" id="newReminderTriggerTime" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="newReminderPriority" class="form-label">ä¼˜å…ˆçº§</label>
                        <select class="form-select" id="newReminderPriority">
                            <option value="low">ä½</option>
                            <option value="normal" selected>æ™®é€š</option>
                            <option value="high">é«˜</option>
                            <option value="urgent">ç´§æ€¥</option>
                        </select>
                    </div>
                    
                    <div class="col-12">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="newReminderRepeat" onchange="toggleRepeatOptions('new')">
                            <label class="form-check-label" for="newReminderRepeat">
                                <i class="fas fa-repeat me-2"></i>é‡å¤æé†’
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-12" id="newRepeatOptions" style="display: none;">
                        <div class="card bg-light">
                            <div class="card-body p-3">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="newRepeatFreq" class="form-label">é‡å¤é¢‘ç‡</label>
                                        <select class="form-select" id="newRepeatFreq" onchange="updateRepeatOptions('new')">
                                            <option value="DAILY">æ¯å¤©</option>
                                            <option value="WEEKLY">æ¯å‘¨</option>
                                            <option value="MONTHLY">æ¯æœˆ</option>
                                            <option value="YEARLY">æ¯å¹´</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="newRepeatInterval" class="form-label">é—´éš”</label>
                                        <div class="input-group">
                                            <span class="input-group-text">æ¯</span>
                                            <input type="number" class="form-control" id="newRepeatInterval" value="1" min="1" max="365">
                                            <span class="input-group-text" id="newIntervalUnit">å¤©</span>
                                        </div>
                                    </div>
                                    
                                    <div class="col-12" id="newWeekdaysOptions" style="display: none;">
                                        <label class="form-label">é‡å¤æ—¥æœŸ</label>
                                        <div class="btn-group weekdays-toggle" role="group">
                                            <input type="checkbox" class="btn-check" id="newMO" value="MO">
                                            <label class="btn btn-outline-primary btn-sm" for="newMO">ä¸€</label>
                                            
                                            <input type="checkbox" class="btn-check" id="newTU" value="TU">
                                            <label class="btn btn-outline-primary btn-sm" for="newTU">äºŒ</label>
                                            
                                            <input type="checkbox" class="btn-check" id="newWE" value="WE">
                                            <label class="btn btn-outline-primary btn-sm" for="newWE">ä¸‰</label>
                                            
                                            <input type="checkbox" class="btn-check" id="newTH" value="TH">
                                            <label class="btn btn-outline-primary btn-sm" for="newTH">å››</label>
                                            
                                            <input type="checkbox" class="btn-check" id="newFR" value="FR">
                                            <label class="btn btn-outline-primary btn-sm" for="newFR">äº”</label>
                                            
                                            <input type="checkbox" class="btn-check" id="newSA" value="SA">
                                            <label class="btn btn-outline-primary btn-sm" for="newSA">å…­</label>
                                            
                                            <input type="checkbox" class="btn-check" id="newSU" value="SU">
                                            <label class="btn btn-outline-primary btn-sm" for="newSU">æ—¥</label>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6" id="newMonthlyOptions" style="display: none;">
                                        <label for="newMonthlyType" class="form-label">æœˆé‡å¤æ–¹å¼</label>
                                        <select class="form-select" id="newMonthlyType" onchange="updateMonthlyOptions('new')">
                                            <option value="simple">æ¯éš”æŒ‡å®šæœˆæ•°</option>
                                            <option value="bymonthday">æŒ‰æ—¥æœŸï¼ˆä¾‹å¦‚ï¼šæ¯æœˆ15æ—¥ï¼‰</option>
                                            <option value="byweekday">æŒ‰æ˜ŸæœŸï¼ˆä¾‹å¦‚ï¼šæ¯æœˆç¬¬äºŒä¸ªå‘¨ä¸€ï¼‰</option>
                                        </select>
                                    </div>                    <!-- æŒ‰æ—¥æœŸé‡å¤çš„é€‰æ‹© -->
                    <div class="col-md-6" id="newMonthlyDateOptions" style="display: none;">
                        <label for="newMonthlyDate" class="form-label">é€‰æ‹©æ—¥æœŸ</label>
                        <select class="form-select" id="newMonthlyDate">
                            <option value="1">1æ—¥</option>
                            <option value="2">2æ—¥</option>
                            <option value="3">3æ—¥</option>
                            <option value="4">4æ—¥</option>
                            <option value="5">5æ—¥</option>
                            <option value="6">6æ—¥</option>
                            <option value="7">7æ—¥</option>
                            <option value="8">8æ—¥</option>
                            <option value="9">9æ—¥</option>
                            <option value="10">10æ—¥</option>
                            <option value="11">11æ—¥</option>
                            <option value="12">12æ—¥</option>
                            <option value="13">13æ—¥</option>
                            <option value="14">14æ—¥</option>
                            <option value="15">15æ—¥</option>
                            <option value="16">16æ—¥</option>
                            <option value="17">17æ—¥</option>
                            <option value="18">18æ—¥</option>
                            <option value="19">19æ—¥</option>
                            <option value="20">20æ—¥</option>
                            <option value="21">21æ—¥</option>
                            <option value="22">22æ—¥</option>
                            <option value="23">23æ—¥</option>
                            <option value="24">24æ—¥</option>
                            <option value="25">25æ—¥</option>
                            <option value="26">26æ—¥</option>
                            <option value="27">27æ—¥</option>
                            <option value="28">28æ—¥</option>
                            <option value="29">29æ—¥</option>
                            <option value="30">30æ—¥</option>
                            <option value="31">31æ—¥</option>
                            <option value="-1">æœˆæœ«</option>
                        </select>
                    </div>
                    
                    <!-- æŒ‰æ˜ŸæœŸé‡å¤çš„é€‰æ‹© -->
                    <div class="col-md-3" id="newMonthlyWeekOptions" style="display: none;">
                        <label for="newMonthlyWeek" class="form-label">ç¬¬å‡ å‘¨</label>
                        <select class="form-select" id="newMonthlyWeek">
                            <option value="1">ç¬¬ä¸€å‘¨</option>
                            <option value="2">ç¬¬äºŒå‘¨</option>
                            <option value="3">ç¬¬ä¸‰å‘¨</option>
                            <option value="4">ç¬¬å››å‘¨</option>
                            <option value="-1">æœ€åä¸€å‘¨</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3" id="newMonthlyWeekdayOptions" style="display: none;">
                        <label for="newMonthlyWeekday" class="form-label">æ˜ŸæœŸå‡ </label>
                        <select class="form-select" id="newMonthlyWeekday">
                            <option value="MO">å‘¨ä¸€</option>
                            <option value="TU">å‘¨äºŒ</option>
                            <option value="WE">å‘¨ä¸‰</option>
                            <option value="TH">å‘¨å››</option>
                            <option value="FR">å‘¨äº”</option>
                            <option value="SA">å‘¨å…­</option>
                            <option value="SU">å‘¨æ—¥</option>
                        </select>
                    </div>                                    <div class="col-md-6">
                                        <label for="newRepeatUntil" class="form-label">ç»“æŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰</label>
                                        <input type="date" class="form-control" id="newRepeatUntil">
                                    </div>
                                </div>
                                
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <span id="newRepeatPreview">é¢„è§ˆï¼šä¸é‡å¤</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <label for="newReminderContent" class="form-label">æé†’å†…å®¹</label>
                        <textarea class="form-control" id="newReminderContent" rows="3"></textarea>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="modalManager.closeAllModals()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">åˆ›å»ºæé†’</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç¼–è¾‘æé†’æ¨¡æ€æ¡† -->
    <div class="modal" id="editReminderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-bell-edit me-2"></i>ç¼–è¾‘æé†’
                </h5>
                <span class="close">&times;</span>
            </div>
            
            <form id="editReminderForm" class="modal-body">
                <input type="hidden" id="reminderId">
                
                <div class="row g-3">
                    <div class="col-12">
                        <label for="reminderTitle" class="form-label">æ ‡é¢˜ *</label>
                        <input type="text" class="form-control form-input" id="reminderTitle" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="reminderTriggerTime" class="form-label">æé†’æ—¶é—´ *</label>
                        <input type="datetime-local" class="form-control form-input" id="reminderTriggerTime" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="reminderPriority" class="form-label">ä¼˜å…ˆçº§</label>
                        <select class="form-select" id="reminderPriority">
                            <option value="low">ä½</option>
                            <option value="normal">æ™®é€š</option>
                            <option value="high">é«˜</option>
                            <option value="urgent">ç´§æ€¥</option>
                        </select>
                    </div>
                    
                    <div class="col-12">
                        <label for="reminderContent" class="form-label">æé†’å†…å®¹</label>
                        <textarea class="form-control" id="reminderContent" rows="3"></textarea>
                    </div>
                    
                    <div class="col-12">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="reminderRepeat" onchange="if(!this.disabled) toggleRepeatOptions('edit'); else this.checked = false;">
                            <label class="form-check-label" for="reminderRepeat">
                                <i class="fas fa-repeat me-2"></i>é‡å¤æé†’
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-12" id="editRepeatOptions" style="display: none;">
                        <div class="card bg-light">
                            <div class="card-body p-3">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="reminderRepeatFreq" class="form-label">é‡å¤é¢‘ç‡</label>
                                        <select class="form-select" id="reminderRepeatFreq" onchange="updateRepeatOptions('edit')">
                                            <option value="DAILY">æ¯å¤©</option>
                                            <option value="WEEKLY">æ¯å‘¨</option>
                                            <option value="MONTHLY">æ¯æœˆ</option>
                                            <option value="YEARLY">æ¯å¹´</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="reminderRepeatInterval" class="form-label">é—´éš”</label>
                                        <div class="input-group">
                                            <span class="input-group-text">æ¯</span>
                                            <input type="number" class="form-control" id="reminderRepeatInterval" value="1" min="1" max="365">
                                            <span class="input-group-text" id="reminderIntervalUnit">å¤©</span>
                                        </div>
                                    </div>
                                    
                                    <div class="col-12" id="reminderWeekdaysOptions" style="display: none;">
                                        <label class="form-label">é‡å¤æ—¥æœŸ</label>
                                        <div class="btn-group weekdays-toggle" role="group">
                                            <input type="checkbox" class="btn-check" id="reminderMO" value="MO">
                                            <label class="btn btn-outline-primary btn-sm" for="reminderMO">ä¸€</label>
                                            
                                            <input type="checkbox" class="btn-check" id="reminderTU" value="TU">
                                            <label class="btn btn-outline-primary btn-sm" for="reminderTU">äºŒ</label>
                                            
                                            <input type="checkbox" class="btn-check" id="reminderWE" value="WE">
                                            <label class="btn btn-outline-primary btn-sm" for="reminderWE">ä¸‰</label>
                                            
                                            <input type="checkbox" class="btn-check" id="reminderTH" value="TH">
                                            <label class="btn btn-outline-primary btn-sm" for="reminderTH">å››</label>
                                            
                                            <input type="checkbox" class="btn-check" id="reminderFR" value="FR">
                                            <label class="btn btn-outline-primary btn-sm" for="reminderFR">äº”</label>
                                            
                                            <input type="checkbox" class="btn-check" id="reminderSA" value="SA">
                                            <label class="btn btn-outline-primary btn-sm" for="reminderSA">å…­</label>
                                            
                                            <input type="checkbox" class="btn-check" id="reminderSU" value="SU">
                                            <label class="btn btn-outline-primary btn-sm" for="reminderSU">æ—¥</label>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6" id="reminderMonthlyOptions" style="display: none;">
                                        <label for="reminderRepeatBy" class="form-label">æœˆé‡å¤æ–¹å¼</label>
                                        <select class="form-select" id="reminderRepeatBy" onchange="updateMonthlyOptions('edit')">
                                            <option value="simple">æ¯éš”Xä¸ªæœˆ</option>
                                            <option value="bymonthday">æŒ‰æ—¥æœŸï¼ˆä¾‹å¦‚ï¼šæ¯æœˆ15æ—¥ï¼‰</option>
                                            <option value="byweekday">æŒ‰æ˜ŸæœŸï¼ˆä¾‹å¦‚ï¼šæ¯æœˆç¬¬äºŒä¸ªå‘¨ä¸€ï¼‰</option>
                                        </select>
                                    </div>
                                    
                                    <!-- æŒ‰æ—¥æœŸé‡å¤çš„é€‰æ‹© -->
                                    <div class="col-md-6" id="editMonthlyDateOptions" style="display: none;">
                                        <label for="editMonthlyDate" class="form-label">é€‰æ‹©æ—¥æœŸ</label>
                                        <select class="form-select" id="editMonthlyDate">
                                            <option value="1">1æ—¥</option>
                                            <option value="2">2æ—¥</option>
                                            <option value="3">3æ—¥</option>
                                            <option value="4">4æ—¥</option>
                                            <option value="5">5æ—¥</option>
                                            <option value="6">6æ—¥</option>
                                            <option value="7">7æ—¥</option>
                                            <option value="8">8æ—¥</option>
                                            <option value="9">9æ—¥</option>
                                            <option value="10">10æ—¥</option>
                                            <option value="11">11æ—¥</option>
                                            <option value="12">12æ—¥</option>
                                            <option value="13">13æ—¥</option>
                                            <option value="14">14æ—¥</option>
                                            <option value="15">15æ—¥</option>
                                            <option value="16">16æ—¥</option>
                                            <option value="17">17æ—¥</option>
                                            <option value="18">18æ—¥</option>
                                            <option value="19">19æ—¥</option>
                                            <option value="20">20æ—¥</option>
                                            <option value="21">21æ—¥</option>
                                            <option value="22">22æ—¥</option>
                                            <option value="23">23æ—¥</option>
                                            <option value="24">24æ—¥</option>
                                            <option value="25">25æ—¥</option>
                                            <option value="26">26æ—¥</option>
                                            <option value="27">27æ—¥</option>
                                            <option value="28">28æ—¥</option>
                                            <option value="29">29æ—¥</option>
                                            <option value="30">30æ—¥</option>
                                            <option value="31">31æ—¥</option>
                                            <option value="-1">æœˆæœ«</option>
                                        </select>
                                    </div>
                                    
                                    <!-- æŒ‰æ˜ŸæœŸé‡å¤çš„é€‰æ‹© -->
                                    <div class="col-md-3" id="editMonthlyWeekOptions" style="display: none;">
                                        <label for="editMonthlyWeek" class="form-label">ç¬¬å‡ å‘¨</label>
                                        <select class="form-select" id="editMonthlyWeek">
                                            <option value="1">ç¬¬ä¸€å‘¨</option>
                                            <option value="2">ç¬¬äºŒå‘¨</option>
                                            <option value="3">ç¬¬ä¸‰å‘¨</option>
                                            <option value="4">ç¬¬å››å‘¨</option>
                                            <option value="-1">æœ€åä¸€å‘¨</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-3" id="editMonthlyWeekdayOptions" style="display: none;">
                                        <label for="editMonthlyWeekday" class="form-label">æ˜ŸæœŸå‡ </label>
                                        <select class="form-select" id="editMonthlyWeekday">
                                            <option value="MO">å‘¨ä¸€</option>
                                            <option value="TU">å‘¨äºŒ</option>
                                            <option value="WE">å‘¨ä¸‰</option>
                                            <option value="TH">å‘¨å››</option>
                                            <option value="FR">å‘¨äº”</option>
                                            <option value="SA">å‘¨å…­</option>
                                            <option value="SU">å‘¨æ—¥</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="reminderRepeatUntil" class="form-label">ç»“æŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰</label>
                                        <input type="date" class="form-control" id="reminderRepeatUntil">
                                    </div>
                                </div>
                                
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <span id="reminderRepeatPreview">é¢„è§ˆï¼šä¸é‡å¤</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            
            <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="modalManager.closeAllModals()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary" onclick="modalManager.handleUpdateReminder()">æ›´æ–°æé†’</button>
                </div>
        </div>
    </div>

    <!-- æé†’è¯¦æƒ…æ¨¡æ€æ¡†ï¼ˆä»æ—¥å†ç‚¹å‡»æ—¶æ‰“å¼€ï¼‰-->
    <!-- æé†’è¯¦æƒ…æ¨¡æ€æ¡†ï¼ˆä»æ—¥å†æˆ–åˆ—è¡¨ç‚¹å‡»æ—¶æ‰“å¼€ï¼‰-->
    <div class="modal" id="reminderDetailModal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-bell me-2"></i><span id="reminderDetailTitle"></span>
                </h5>
                <span class="close" onclick="eventManager.closeReminderDetailModal()">&times;</span>
            </div>
            
            <div class="modal-body">
                <div class="reminder-detail-info">
                    <!-- ä¼˜å…ˆçº§ -->
                    <div class="detail-row">
                        <div class="detail-label">
                            <i class="fas fa-flag me-2"></i>ä¼˜å…ˆçº§
                        </div>
                        <div class="detail-value" id="reminderDetailPriority"></div>
                    </div>
                    
                    <!-- æé†’æ—¶é—´ -->
                    <div class="detail-row">
                        <div class="detail-label">
                            <i class="far fa-clock me-2"></i>æé†’æ—¶é—´
                        </div>
                        <div class="detail-value" id="reminderDetailTime"></div>
                    </div>
                    
                    <!-- æè¿°ï¼ˆä»…åœ¨æœ‰å†…å®¹æ—¶æ˜¾ç¤ºï¼‰-->
                    <div class="detail-row" id="reminderDetailDescriptionRow" style="display: none;">
                        <div class="detail-label">
                            <i class="far fa-file-alt me-2"></i>æè¿°
                        </div>
                        <div class="detail-value" id="reminderDetailDescription" style="white-space: pre-wrap;"></div>
                    </div>
                    
                    <!-- é‡å¤è§„åˆ™ï¼ˆä»…åœ¨æœ‰æ—¶æ˜¾ç¤ºï¼‰-->
                    <div class="detail-row" id="reminderDetailRRuleRow" style="display: none;">
                        <div class="detail-label">
                            <i class="fas fa-repeat me-2"></i>é‡å¤è§„åˆ™
                        </div>
                        <div class="detail-value" id="reminderDetailRRule" style="font-family: monospace; font-size: 0.9em;"></div>
                    </div>
                    
                    <!-- æå‰æé†’ï¼ˆä»…åœ¨æœ‰æ—¶æ˜¾ç¤ºï¼‰-->
                    <div class="detail-row" id="reminderDetailAdvanceRow" style="display: none;">
                        <div class="detail-label">
                            <i class="fas fa-bell-plus me-2"></i>æå‰æé†’
                        </div>
                        <div class="detail-value" id="reminderDetailAdvance"></div>
                    </div>
                </div>
                
                <!-- çŠ¶æ€å’Œå»¶åæŒ‰é’® -->
                <div class="d-flex flex-wrap gap-2 mt-3 mb-3" id="reminderDetailStatusButtons">
                    <!-- åŠ¨æ€å¡«å…… -->
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="modal-footer" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                    <button type="button" class="btn btn-secondary" onclick="eventManager.closeReminderDetailModal()">å…³é—­</button>
                    <button type="button" class="btn btn-primary" id="reminderDetailEditBtn">
                        <i class="fas fa-edit me-1"></i>ç¼–è¾‘
                    </button>
                    <button type="button" class="btn btn-danger" id="reminderDetailDeleteBtn">
                        <i class="fas fa-trash me-1"></i>åˆ é™¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ—¥ç¨‹è¯¦æƒ…æ¨¡æ€æ¡†ï¼ˆé¢„è§ˆæ¨¡å¼ï¼‰-->
    <div class="modal" id="eventDetailModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-day me-2"></i><span id="eventDetailTitle"></span>
                </h5>
                <span class="close" onclick="eventManager.closeEventDetailModal()">&times;</span>
            </div>
            
            <div class="modal-body">
                <div class="event-detail-info">
                    <!-- æ—¶é—´ -->
                    <div class="detail-row">
                        <div class="detail-label">
                            <i class="far fa-clock me-2"></i>æ—¶é—´
                        </div>
                        <div class="detail-value" id="eventDetailTime"></div>
                    </div>
                    
                    <!-- å½’å±ç”¨æˆ·ï¼ˆä»…å¯¹ä¸æ˜¯è‡ªå·±çš„äº‹ä»¶æ˜¾ç¤ºï¼‰-->
                    <div class="detail-row" id="eventDetailOwnerRow" style="display: none;">
                        <div class="detail-label">
                            <i class="fas fa-user me-2"></i>å½’å±
                        </div>
                        <div class="detail-value" id="eventDetailOwner"></div>
                    </div>
                    
                    <!-- æ—¥ç¨‹ç»„ï¼ˆä»…åœ¨æœ‰æ—¶æ˜¾ç¤ºï¼‰-->
                    <div class="detail-row" id="eventDetailGroupRow" style="display: none;">
                        <div class="detail-label">
                            <i class="fas fa-folder me-2"></i>æ—¥ç¨‹ç»„
                        </div>
                        <div class="detail-value" id="eventDetailGroup"></div>
                    </div>
                    
                    <!-- é‡è¦æ€§/ç´§æ€¥æ€§ -->
                    <div class="detail-row" id="eventDetailPriorityRow" style="display: none;">
                        <div class="detail-label">
                            <i class="fas fa-flag me-2"></i>ä¼˜å…ˆçº§
                        </div>
                        <div class="detail-value" id="eventDetailPriority"></div>
                    </div>
                    
                    <!-- æè¿°ï¼ˆä»…åœ¨æœ‰å†…å®¹æ—¶æ˜¾ç¤ºï¼‰-->
                    <div class="detail-row" id="eventDetailDescriptionRow" style="display: none;">
                        <div class="detail-label">
                            <i class="far fa-file-alt me-2"></i>æè¿°
                        </div>
                        <div class="detail-value" id="eventDetailDescription" style="white-space: pre-wrap;"></div>
                    </div>
                    
                    <!-- DDLï¼ˆä»…åœ¨æœ‰æ—¶æ˜¾ç¤ºï¼‰-->
                    <div class="detail-row" id="eventDetailDdlRow" style="display: none;">
                        <div class="detail-label">
                            <i class="fas fa-flag-checkered me-2"></i>æˆªæ­¢æ—¶é—´
                        </div>
                        <div class="detail-value" id="eventDetailDdl"></div>
                    </div>
                    
                    <!-- é‡å¤è§„åˆ™ï¼ˆä»…åœ¨æœ‰æ—¶æ˜¾ç¤ºï¼‰-->
                    <div class="detail-row" id="eventDetailRRuleRow" style="display: none;">
                        <div class="detail-label">
                            <i class="fas fa-repeat me-2"></i>é‡å¤è§„åˆ™
                        </div>
                        <div class="detail-value" id="eventDetailRRule" style="font-family: monospace; font-size: 0.9em;"></div>
                    </div>
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="modal-footer" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                    <button type="button" class="btn btn-secondary" onclick="eventManager.closeEventDetailModal()">å…³é—­</button>
                    <button type="button" class="btn btn-primary" id="eventDetailEditBtn">
                        <i class="fas fa-edit me-1"></i>ç¼–è¾‘
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent èŠå¤©æ¨¡æ€æ¡†ï¼ˆå±•å¼€ç‰ˆï¼‰ -->
    <div class="modal" id="agentChatModal">
        <div class="modal-content modal-xl agent-modal">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-robot me-2"></i>AI Agent åŠ©æ‰‹
                </h5>
                <div class="modal-header-actions">
                    <button class="btn btn-sm btn-outline-secondary" onclick="agentChat.newSession()" title="æ–°å»ºä¼šè¯">
                        <i class="fas fa-plus"></i>
                    </button>
                    <span class="close">&times;</span>
                </div>
            </div>
            
            <div class="modal-body agent-modal-body">
                <div class="agent-chat-fullscreen">
                    <div id="modalAgentMessages" class="agent-messages-full">
                        <!-- æ¶ˆæ¯å°†ä»ä¾§è¾¹æ åŒæ­¥ -->
                    </div>
                    
                    <div class="typing-indicator" id="modalAgentTyping" style="display: none;">
                        <span></span><span></span><span></span>
                        <span class="typing-text">Agent æ­£åœ¨æ€è€ƒ...</span>
                    </div>
                    
                    <div class="agent-input-area-full">
                        <div class="input-wrapper-full">
                            <textarea class="form-control" id="modalAgentInput" 
                                placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒæŒ‰ Enter å‘é€..." 
                                rows="2"></textarea>
                            <button class="btn btn-primary send-btn-full" id="modalAgentSendBtn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ—¥ç¨‹ç»„ç®¡ç†æ¨¡æ€æ¡† -->
    <!-- æ—¥ç¨‹ç»„ç®¡ç†æ¨¡æ€æ¡†ï¼ˆå•æ¨¡æ€æ¡†ï¼Œå¤šé¢æ¿è®¾è®¡ï¼‰ -->
    <div class="modal fade" id="manageGroupsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="groupModalTitle">
                        <i class="fas fa-layer-group me-2"></i>ç®¡ç†æ—¥ç¨‹ç»„
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- æ—¥ç¨‹ç»„åˆ—è¡¨é¢æ¿ -->
                    <div id="groupListPanel">
                        <div class="mb-3">
                            <button class="btn btn-success btn-sm" onclick="groupManager.showCreatePanel()">
                                <i class="fas fa-plus me-1"></i>åˆ›å»ºæ–°æ—¥ç¨‹ç»„
                            </button>
                        </div>
                        <div id="groupsList" class="list-group">
                            <!-- åŠ¨æ€ç”Ÿæˆçš„æ—¥ç¨‹ç»„åˆ—è¡¨ -->
                        </div>
                    </div>

                    <!-- åˆ›å»ºæ—¥ç¨‹ç»„é¢æ¿ -->
                    <div id="groupCreatePanel" style="display: none;">
                        <div class="mb-3">
                            <button class="btn btn-outline-secondary btn-sm" onclick="groupManager.showListPanel()">
                                <i class="fas fa-arrow-left me-1"></i>è¿”å›åˆ—è¡¨
                            </button>
                        </div>
                        <div class="mb-3">
                            <label for="newGroupName" class="form-label">ç»„å <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="newGroupName" placeholder="è¾“å…¥æ—¥ç¨‹ç»„åç§°">
                        </div>
                        <div class="mb-3">
                            <label for="newGroupDescription" class="form-label">æè¿°</label>
                            <textarea class="form-control" id="newGroupDescription" rows="3" placeholder="è¾“å…¥æ—¥ç¨‹ç»„æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="newGroupColor" class="form-label">é¢œè‰²</label>
                            <input type="color" class="form-control form-control-color" id="newGroupColor" value="#3788d8">
                        </div>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-success" onclick="groupManager.createGroup()">
                                <i class="fas fa-save me-1"></i>åˆ›å»ºæ—¥ç¨‹ç»„
                            </button>
                        </div>
                    </div>

                    <!-- ç¼–è¾‘æ—¥ç¨‹ç»„é¢æ¿ -->
                    <div id="groupEditPanel" style="display: none;">
                        <div class="mb-3">
                            <button class="btn btn-outline-secondary btn-sm" onclick="groupManager.showListPanel()">
                                <i class="fas fa-arrow-left me-1"></i>è¿”å›åˆ—è¡¨
                            </button>
                        </div>
                        <input type="hidden" id="editGroupId">
                        <div class="mb-3">
                            <label for="editGroupName" class="form-label">ç»„å <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editGroupName" placeholder="è¾“å…¥æ—¥ç¨‹ç»„åç§°">
                        </div>
                        <div class="mb-3">
                            <label for="editGroupDescription" class="form-label">æè¿°</label>
                            <textarea class="form-control" id="editGroupDescription" rows="3" placeholder="è¾“å…¥æ—¥ç¨‹ç»„æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editGroupColor" class="form-label">é¢œè‰²</label>
                            <input type="color" class="form-control form-control-color" id="editGroupColor">
                        </div>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary" onclick="groupManager.updateGroup()">
                                <i class="fas fa-save me-1"></i>ä¿å­˜ä¿®æ”¹
                            </button>
                        </div>
                    </div>

                    <!-- åˆ é™¤æ—¥ç¨‹ç»„é¢æ¿ -->
                    <div id="groupDeletePanel" style="display: none;">
                        <div class="mb-3">
                            <button class="btn btn-outline-secondary btn-sm" onclick="groupManager.showListPanel()">
                                <i class="fas fa-arrow-left me-1"></i>è¿”å›åˆ—è¡¨
                            </button>
                        </div>
                        <input type="hidden" id="deleteGroupId">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>è­¦å‘Šï¼š</strong>æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼
                        </div>
                        <p class="mb-3">è¯·é€‰æ‹©åˆ é™¤æ–¹å¼ï¼š</p>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="deleteOption" id="deleteGroupOnly" value="group" checked>
                            <label class="form-check-label" for="deleteGroupOnly">
                                <i class="fas fa-folder-minus me-1"></i>åªåˆ é™¤æ—¥ç¨‹ç»„ï¼ˆä¿ç•™æ—¥ç¨‹ï¼‰
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="deleteOption" id="deleteGroupAndEvents" value="all">
                            <label class="form-check-label" for="deleteGroupAndEvents">
                                <i class="fas fa-trash-alt me-1"></i>åˆ é™¤æ—¥ç¨‹ç»„åŠå…¶æ‰€æœ‰æ—¥ç¨‹
                            </label>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-danger" onclick="groupManager.confirmDeleteGroup()">
                                <i class="fas fa-trash me-1"></i>ç¡®è®¤åˆ é™¤
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-cog me-2"></i>ç”¨æˆ·è®¾ç½®
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Tabs å¯¼èˆª -->
                    <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" 
                                    data-bs-target="#basic-settings" type="button" role="tab">
                                <i class="fas fa-user-cog me-2"></i>åŸºæœ¬è®¾ç½®
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="schedule-tab" data-bs-toggle="tab" 
                                    data-bs-target="#schedule-settings" type="button" role="tab">
                                <i class="fas fa-calendar-alt me-2"></i>æ—¥ç¨‹åå¥½
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="display-tab" data-bs-toggle="tab" 
                                    data-bs-target="#display-settings" type="button" role="tab">
                                <i class="fas fa-palette me-2"></i>æ˜¾ç¤ºåå¥½
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="reminder-tab" data-bs-toggle="tab" 
                                    data-bs-target="#reminder-settings" type="button" role="tab">
                                <i class="fas fa-bell me-2"></i>æé†’è®¾ç½®
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="ai-tab" data-bs-toggle="tab" 
                                    data-bs-target="#ai-settings" type="button" role="tab">
                                <i class="fas fa-robot me-2"></i>AI è®¾ç½®
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="profile-tab" data-bs-toggle="tab" 
                                    data-bs-target="#profile-settings" type="button" role="tab">
                                <i class="fas fa-user-circle me-2"></i>æˆ‘çš„
                            </button>
                        </li>
                    </ul>

                    <!-- Tabs å†…å®¹ -->
                    <div class="tab-content" id="settingsTabContent">
                        <!-- åŸºæœ¬è®¾ç½® -->
                        <div class="tab-pane fade show active" id="basic-settings" role="tabpanel">
                            <h6 class="mb-3 text-primary"><i class="fas fa-cog me-2"></i>å‘¨æ•°æ˜¾ç¤ºè®¾ç½®</h6>
                            
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showWeekNumber" checked>
                                        <label class="form-check-label" for="showWeekNumber">
                                            <strong>æ˜¾ç¤ºå‘¨æ•°</strong>
                                        </label>
                                    </div>
                                    <small class="text-muted">åœ¨æ—¥å†æ ‡é¢˜æ—æ˜¾ç¤º"ç¬¬Nå‘¨"å¾½ç« </small>
                                </div>
                                
                                <div class="col-12">
                                    <hr>
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <label class="form-label mb-0">
                                            <strong>å­¦æœŸ/å‘¨æœŸè®¾ç½®</strong>
                                        </label>
                                        <button type="button" class="btn btn-sm btn-primary" onclick="addWeekPeriod()">
                                            <i class="fas fa-plus me-1"></i>æ·»åŠ å­¦æœŸ
                                        </button>
                                    </div>
                                    <small class="text-muted d-block mb-3">
                                        è®¾ç½®å¤šä¸ªå­¦æœŸçš„èµ·å§‹æ—¥æœŸ,ç³»ç»Ÿä¼šè‡ªåŠ¨é€‰æ‹©æœ€è¿‘çš„å­¦æœŸè®¡ç®—å‘¨æ•°ã€‚
                                        ä¾‹å¦‚: æ˜¥å­£å­¦æœŸ(2æœˆ24æ—¥)ã€ç§‹å­£å­¦æœŸ(9æœˆ1æ—¥)
                                    </small>
                                    
                                    <!-- å‘¨æœŸåˆ—è¡¨å®¹å™¨ -->
                                    <div id="weekPeriodsList" class="mb-3">
                                        <!-- å‘¨æœŸé¡¹ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                                    </div>
                                    
                                    <div class="alert alert-warning mb-0">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>æ³¨æ„ï¼š</strong>
                                        <ul class="mb-0 mt-2">
                                            <li>å¦‚æœå½“å‰æ—¥æœŸæ‰¾ä¸åˆ°ä»»ä½•å­¦æœŸèµ·å§‹æ—¥æœŸ,å°†ä¸æ˜¾ç¤ºå‘¨æ•°</li>
                                            <li>ç³»ç»Ÿä¼šå‘å‰æŸ¥æ‰¾è·ç¦»æœ€è¿‘çš„èµ·å§‹æ—¥æœŸ</li>
                                            <li>è‡³å°‘éœ€è¦æ·»åŠ ä¸€ä¸ªå­¦æœŸæ‰èƒ½æ˜¾ç¤ºå‘¨æ•°</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æ—¥ç¨‹åå¥½ -->
                        <div class="tab-pane fade" id="schedule-settings" role="tabpanel">
                            <h6 class="mb-3 text-primary"><i class="fas fa-sliders-h me-2"></i>æ—¥ç¨‹é»˜è®¤è®¾ç½®</h6>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="defaultEventDuration" class="form-label">
                                        é»˜è®¤æ—¥ç¨‹æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
                                        <span class="badge bg-secondary">å³å°†æ¨å‡º</span>
                                    </label>
                                    <input type="number" class="form-control" id="defaultEventDuration" 
                                           min="5" max="480" step="5" value="60" disabled>
                                    <small class="text-muted">æ–°å»ºæ—¥ç¨‹çš„é»˜è®¤æŒç»­æ—¶é—´</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="weekStartsOn" class="form-label">
                                        æ¯å‘¨èµ·å§‹æ—¥
                                    </label>
                                    <select class="form-select" id="weekStartsOn">
                                        <option value="0">å‘¨æ—¥</option>
                                        <option value="1" selected>å‘¨ä¸€</option>
                                        <option value="2">å‘¨äºŒ</option>
                                        <option value="3">å‘¨ä¸‰</option>
                                        <option value="4">å‘¨å››</option>
                                        <option value="5">å‘¨äº”</option>
                                        <option value="6">å‘¨å…­</option>
                                    </select>
                                    <small class="text-muted">æ—¥å†å’Œå‘¨æ•°è®¡ç®—çš„èµ·å§‹æ—¥</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="workHoursStart" class="form-label">
                                        å·¥ä½œæ—¶é—´ - å¼€å§‹
                                        <span class="badge bg-secondary">å³å°†æ¨å‡º</span>
                                    </label>
                                    <input type="time" class="form-control" id="workHoursStart" value="09:00" disabled>
                                </div>
                                <div class="col-md-6">
                                    <label for="workHoursEnd" class="form-label">
                                        å·¥ä½œæ—¶é—´ - ç»“æŸ
                                        <span class="badge bg-secondary">å³å°†æ¨å‡º</span>
                                    </label>
                                    <input type="time" class="form-control" id="workHoursEnd" value="18:00" disabled>
                                </div>
                                <div class="col-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="autoDdl" checked>
                                        <label class="form-check-label" for="autoDdl">
                                            è‡ªåŠ¨å°†æ—¥ç¨‹ç»“æŸæ—¶é—´è®¾ç½®ä¸ºæˆªæ­¢æ—¶é—´
                                        </label>
                                    </div>
                                    <small class="text-muted">æ–°å»ºæ—¥ç¨‹æ—¶ï¼Œè‡ªåŠ¨å°†ç»“æŸæ—¶é—´å¡«å…¥DDLå­—æ®µ</small>
                                </div>
                                <div class="col-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showWeekends" checked>
                                        <label class="form-check-label" for="showWeekends">
                                            æ—¥å†æ˜¾ç¤ºå‘¨æœ«
                                        </label>
                                    </div>
                                    <small class="text-muted">åœ¨æ—¥å†è§†å›¾ä¸­æ˜¾ç¤ºæˆ–éšè—å‘¨å…­å’Œå‘¨æ—¥</small>
                                </div>
                            </div>
                        </div>

                        <!-- æ˜¾ç¤ºåå¥½ -->
                        <div class="tab-pane fade" id="display-settings" role="tabpanel">
                            <h6 class="mb-3 text-primary"><i class="fas fa-eye me-2"></i>ç•Œé¢æ˜¾ç¤º</h6>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="calendarViewDefault" class="form-label">
                                        é»˜è®¤æ—¥å†è§†å›¾
                                    </label>
                                    <select class="form-select" id="calendarViewDefault">
                                        <option value="dayGridMonth" selected>æœˆè§†å›¾</option>
                                        <option value="timeGridWeek">å‘¨è§†å›¾</option>
                                        <option value="timeGridDay">æ—¥è§†å›¾</option>
                                        <option value="listWeek">åˆ—è¡¨è§†å›¾</option>
                                    </select>
                                    <small class="text-muted">é‡æ–°ç™»å½•æ—¶ä½¿ç”¨çš„è§†å›¾,åˆ·æ–°é¡µé¢ä¼šä¿ç•™å½“å‰è§†å›¾</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="theme" class="form-label">
                                        ä¸»é¢˜æ¨¡å¼
                                    </label>
                                    <select class="form-select" id="theme">
                                        <optgroup label="åŸºç¡€ä¸»é¢˜">
                                            <option value="light">æµ…è‰²æ¨¡å¼</option>
                                            <option value="dark">æ·±è‰²æ¨¡å¼</option>
                                            <option value="auto" selected>è·Ÿéšç³»ç»Ÿ</option>
                                        </optgroup>
                                        <optgroup label="åˆ›æ„ä¸»é¢˜ I">
                                            <option value="china-red">ğŸ‡¨ğŸ‡³ ä¸­å›½çº¢</option>
                                            <option value="warm-pastel">ğŸŒ¸ æ·¡æš–è‰²</option>
                                            <option value="cool-pastel">â„ï¸ æ·¡å†·è‰²</option>
                                            <option value="macaron">ğŸ° é©¬å¡é¾™</option>
                                            <option value="dopamine">âš¡ å¤šå·´èƒº</option>
                                        </optgroup>
                                        <optgroup label="åˆ›æ„ä¸»é¢˜ II">
                                            <option value="forest">ğŸŒ² æ£®æ—</option>
                                            <option value="sunset">ğŸŒ… æ—¥è½</option>
                                            <option value="ocean">ğŸŒŠ æµ·æ´‹</option>
                                            <option value="sakura">ğŸŒ¸ æ¨±èŠ±</option>
                                            <option value="cyberpunk">ğŸ¤– èµ›åšæœ‹å…‹</option>
                                        </optgroup>
                                    </select>
                                    <small class="text-muted">åˆ‡æ¢åº”ç”¨çš„å¤–è§‚ä¸»é¢˜ (å…±13ç§ä¸»é¢˜å¯é€‰)</small>
                                </div>
                                <div class="col-md-6">
                                    <div class="pt-4">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="useGoldTheme">
                                            <label class="form-check-label" for="useGoldTheme">
                                                <i class="fas fa-crown text-warning me-1"></i>ä½¿ç”¨é‡‘è‰²ä¸»é¢˜
                                            </label>
                                        </div>
                                        <small class="text-muted d-block mt-1">
                                            ä¸ºæµ…è‰²/æ·±è‰²ä¸»é¢˜æ·»åŠ é‡‘è‰²å¼ºè°ƒè‰²ï¼ˆç™½é‡‘/é»‘é‡‘ï¼‰
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="eventColorBy" class="form-label">
                                        æ—¥ç¨‹é¢œè‰²æ–¹æ¡ˆ
                                        <span class="badge bg-secondary">å³å°†æ¨å‡º</span>
                                    </label>
                                    <select class="form-select" id="eventColorBy" disabled>
                                        <option value="default" selected>é»˜è®¤</option>
                                        <option value="priority">æŒ‰ä¼˜å…ˆçº§</option>
                                        <option value="type">æŒ‰ç±»å‹</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showCompletedEvents" checked disabled>
                                        <label class="form-check-label" for="showCompletedEvents">
                                            æ˜¾ç¤ºå·²å®Œæˆçš„æ—¥ç¨‹
                                            <span class="badge bg-secondary">å³å°†æ¨å‡º</span>
                                        </label>
                                    </div>
                                    <small class="text-muted">åœ¨æ—¥å†ä¸­æ˜¾ç¤ºæˆ–éšè—å·²æ ‡è®°ä¸ºå®Œæˆçš„æ—¥ç¨‹</small>
                                </div>
                            </div>
                        </div>

                        <!-- æé†’è®¾ç½® -->
                        <div class="tab-pane fade" id="reminder-settings" role="tabpanel">
                            <h6 class="mb-3 text-primary"><i class="fas fa-clock me-2"></i>æé†’é€‰é¡¹</h6>
                            
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="reminderEnabled" checked disabled>
                                        <label class="form-check-label" for="reminderEnabled">
                                            å¯ç”¨æé†’å¼¹çª—é€šçŸ¥
                                            <span class="badge bg-secondary">å³å°†æ¨å‡º</span>
                                        </label>
                                    </div>
                                    <small class="text-muted">æé†’åˆ°æœŸæ—¶æ˜¯å¦å¼¹å‡ºæµè§ˆå™¨é€šçŸ¥</small>
                                </div>
                                <div class="col-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="reminderSound" checked disabled>
                                        <label class="form-check-label" for="reminderSound">
                                            æé†’å£°éŸ³
                                            <span class="badge bg-secondary">å³å°†æ¨å‡º</span>
                                        </label>
                                    </div>
                                    <small class="text-muted">æé†’æ—¶æ’­æ”¾æç¤ºéŸ³</small>
                                </div>
                            </div>
                        </div>

                        <!-- AI è®¾ç½® -->
                        <div class="tab-pane fade" id="ai-settings" role="tabpanel">
                            <h6 class="mb-3 text-primary"><i class="fas fa-brain me-2"></i>AI åŠ©æ‰‹é€‰é¡¹</h6>
                            
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="aiEnabled" checked disabled>
                                        <label class="form-check-label" for="aiEnabled">
                                            å¯ç”¨ AI åŠŸèƒ½
                                            <span class="badge bg-secondary">å³å°†æ¨å‡º</span>
                                        </label>
                                    </div>
                                    <small class="text-muted">å¯ç”¨æˆ–å…³é—­æ‰€æœ‰ AI ç›¸å…³åŠŸèƒ½</small>
                                </div>
                                <div class="col-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="aiAutoSuggest" disabled>
                                        <label class="form-check-label" for="aiAutoSuggest">
                                            AI è‡ªåŠ¨å»ºè®®
                                            <span class="badge bg-secondary">å³å°†æ¨å‡º</span>
                                        </label>
                                    </div>
                                    <small class="text-muted">AI ä¼šè‡ªåŠ¨åˆ†æä½ çš„æ—¥ç¨‹å¹¶æä¾›ä¼˜åŒ–å»ºè®®</small>
                                </div>
                            </div>
                        </div>

                        <!-- æˆ‘çš„ -->
                        <div class="tab-pane fade" id="profile-settings" role="tabpanel">
                            <h6 class="mb-4 text-primary"><i class="fas fa-user-circle me-2"></i>è´¦æˆ·ç®¡ç†</h6>
                            
                            <div class="row g-4">
                                <!-- å½“å‰ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
                                <div class="col-12">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-circle bg-primary text-white me-3" style="width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold;">
                                                    {{ request.user.username|first|upper }}
                                                </div>
                                                <div>
                                                    <h5 class="mb-1">{{ request.user.username }}</h5>
                                                    <small class="text-muted">
                                                        <i class="fas fa-envelope me-1"></i>{{ request.user.email|default:"æœªè®¾ç½®é‚®ç®±" }}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Token ç®¡ç† -->
                                <div class="col-12">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center mb-3">
                                                <i class="fas fa-key fa-2x text-primary me-3"></i>
                                                <div>
                                                    <h6 class="mb-0">API Token ç®¡ç†</h6>
                                                    <small class="text-muted">ç”¨äºç¬¬ä¸‰æ–¹åº”ç”¨å’Œ API è®¿é—®è®¤è¯</small>
                                                </div>
                                            </div>
                                            
                                            <!-- Token æ˜¾ç¤ºåŒºåŸŸ -->
                                            <div id="tokenDisplayArea" class="mb-3">
                                                <div class="alert alert-info mb-0">
                                                    <i class="fas fa-spinner fa-spin me-2"></i>æ­£åœ¨åŠ è½½ Token...
                                                </div>
                                            </div>
                                            
                                            <!-- Token æ“ä½œæŒ‰é’® -->
                                            <div class="d-flex gap-2 flex-wrap" id="tokenActions">
                                                <button class="btn btn-sm btn-outline-primary" onclick="copyToken()" id="copyTokenBtn" style="display:none;">
                                                    <i class="fas fa-copy me-1"></i>å¤åˆ¶ Token
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning" onclick="refreshToken()" id="refreshTokenBtn" style="display:none;">
                                                    <i class="fas fa-sync-alt me-1"></i>åˆ·æ–° Token
                                                </button>
                                                <button class="btn btn-sm btn-outline-success" onclick="createToken()" id="createTokenBtn" style="display:none;">
                                                    <i class="fas fa-plus me-1"></i>åˆ›å»º Token
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteToken()" id="deleteTokenBtn" style="display:none;">
                                                    <i class="fas fa-trash me-1"></i>åˆ é™¤ Token
                                                </button>
                                                <button class="btn btn-sm btn-outline-info" onclick="toggleUsageExample()">
                                                    <i class="fas fa-book me-1"></i>ä½¿ç”¨ç¤ºä¾‹
                                                </button>
                                            </div>
                                            
                                            <!-- ä½¿ç”¨ç¤ºä¾‹ï¼ˆå¯æŠ˜å ï¼‰ -->
                                            <div id="usageExample" style="display:none;" class="mt-3">
                                                <hr>
                                                <h6 class="text-muted mb-2"><i class="fas fa-code me-2"></i>API è°ƒç”¨ç¤ºä¾‹</h6>
                                                <div class="bg-dark text-light p-3 rounded" style="font-family: monospace; font-size: 12px; overflow-x: auto;">
<pre class="mb-0 text-light">// JavaScript Fetch
fetch('/api/reminders/', {
    headers: {
        'Authorization': 'Token YOUR_TOKEN_HERE'
    }
})

# Python Requests
import requests
headers = {'Authorization': 'Token YOUR_TOKEN_HERE'}
requests.get('http://your-domain.com/api/reminders/', headers=headers)

# cURL
curl -H "Authorization: Token YOUR_TOKEN_HERE" \\
     http://your-domain.com/api/reminders/</pre>
                                                </div>
                                            </div>
                                            
                                            <!-- Token éªŒè¯åŒºåŸŸ -->
                                            <div class="mt-3">
                                                <hr>
                                                <h6 class="text-muted mb-2"><i class="fas fa-shield-alt me-2"></i>éªŒè¯ Token</h6>
                                                <div class="input-group input-group-sm">
                                                    <input type="text" class="form-control" id="testTokenInput" placeholder="è¾“å…¥è¦éªŒè¯çš„ Token..." style="font-family: monospace;">
                                                    <button class="btn btn-outline-secondary" onclick="testToken()">
                                                        <i class="fas fa-check me-1"></i>éªŒè¯
                                                    </button>
                                                </div>
                                                <div id="testTokenResult" class="mt-2"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ç”¨æˆ·æ•°æ®ç®¡ç† -->
                                <div class="col-md-6">
                                    <div class="card h-100 border-0 shadow-sm hover-card">
                                        <div class="card-body d-flex flex-column">
                                            <div class="mb-3">
                                                <i class="fas fa-database fa-2x text-success mb-2"></i>
                                                <h6 class="card-title">ç”¨æˆ·æ•°æ®ç®¡ç†</h6>
                                            </div>
                                            <p class="card-text text-muted flex-grow-1">
                                                æŸ¥çœ‹å’Œç®¡ç†æ‚¨çš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬æ—¥ç¨‹ã€æé†’ç­‰
                                            </p>
                                            <a href="{% url 'user_data' %}" class="btn btn-outline-success btn-sm mt-auto">
                                                <i class="fas fa-database me-1"></i>æŸ¥çœ‹æ•°æ®
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <!-- ä¿®æ”¹ç”¨æˆ·å/å¯†ç  -->
                                <div class="col-md-6">
                                    <div class="card h-100 border-0 shadow-sm hover-card">
                                        <div class="card-body d-flex flex-column">
                                            <div class="mb-3">
                                                <i class="fas fa-user-lock fa-2x text-warning mb-2"></i>
                                                <h6 class="card-title">ä¿®æ”¹ç”¨æˆ·å/å¯†ç </h6>
                                            </div>
                                            <p class="card-text text-muted flex-grow-1">
                                                æ›´æ”¹æ‚¨çš„ç™»å½•å‡­æ®ä»¥ä¿æŠ¤è´¦æˆ·å®‰å…¨
                                            </p>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-outline-warning btn-sm flex-fill" onclick="showChangeUsernameModal()">
                                                    <i class="fas fa-user me-1"></i>ä¿®æ”¹ç”¨æˆ·å
                                                </button>
                                                <button class="btn btn-outline-warning btn-sm flex-fill" onclick="showChangePasswordModal()">
                                                    <i class="fas fa-lock me-1"></i>ä¿®æ”¹å¯†ç 
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ä¿®æ”¹æ˜µç§° -->
                                <div class="col-md-6">
                                    <div class="card h-100 border-0 shadow-sm hover-card">
                                        <div class="card-body d-flex flex-column">
                                            <div class="mb-3">
                                                <i class="fas fa-id-badge fa-2x text-info mb-2"></i>
                                                <h6 class="card-title">ä¿®æ”¹æ˜µç§°</h6>
                                            </div>
                                            <p class="card-text text-muted flex-grow-1">
                                                è®¾ç½®ä¸€ä¸ªå‹å¥½çš„æ˜¾ç¤ºåç§°
                                            </p>
                                            <button class="btn btn-outline-info btn-sm mt-auto" disabled>
                                                <i class="fas fa-edit me-1"></i>è®¾ç½®æ˜µç§°
                                                <span class="badge bg-secondary ms-2">å³å°†æ¨å‡º</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- å¯¼å‡ºæ•°æ® -->
                                <div class="col-md-6">
                                    <div class="card h-100 border-0 shadow-sm hover-card">
                                        <div class="card-body d-flex flex-column">
                                            <div class="mb-3">
                                                <i class="fas fa-download fa-2x text-dark mb-2"></i>
                                                <h6 class="card-title">å¯¼å‡ºæ•°æ®</h6>
                                            </div>
                                            <p class="card-text text-muted flex-grow-1">
                                                å¯¼å‡ºæ‚¨çš„æ—¥ç¨‹æ•°æ®ä¸º iCalendar æ ¼å¼
                                            </p>
                                            <a href="{% url 'outport_calendar' %}" class="btn btn-outline-dark btn-sm mt-auto">
                                                <i class="fas fa-file-export me-1"></i>å¯¼å‡ºæ—¥å†
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <!-- æ•°æ®åŒæ­¥ -->
                                <div class="col-md-6">
                                    <div class="card h-100 border-0 shadow-sm hover-card">
                                        <div class="card-body d-flex flex-column">
                                            <div class="mb-3">
                                                <i class="fas fa-sync-alt fa-2x text-primary mb-2"></i>
                                                <h6 class="card-title">æ•°æ®åŒæ­¥</h6>
                                            </div>
                                            <p class="card-text text-muted flex-grow-1">
                                                ä¸å…¶ä»–è®¾å¤‡æˆ–æœåŠ¡åŒæ­¥æ‚¨çš„æ•°æ®
                                            </p>
                                            <button class="btn btn-outline-primary btn-sm mt-auto" disabled>
                                                <i class="fas fa-cloud me-1"></i>åŒæ­¥è®¾ç½®
                                                <span class="badge bg-secondary ms-2">å³å°†æ¨å‡º</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- è´¦æˆ·å®‰å…¨ -->
                                <div class="col-md-6">
                                    <div class="card h-100 border-0 shadow-sm hover-card">
                                        <div class="card-body d-flex flex-column">
                                            <div class="mb-3">
                                                <i class="fas fa-shield-alt fa-2x text-danger mb-2"></i>
                                                <h6 class="card-title">è´¦æˆ·å®‰å…¨</h6>
                                            </div>
                                            <p class="card-text text-muted flex-grow-1">
                                                ä¸¤æ­¥éªŒè¯ã€ç™»å½•å†å²ç­‰å®‰å…¨è®¾ç½®
                                            </p>
                                            <button class="btn btn-outline-danger btn-sm mt-auto" disabled>
                                                <i class="fas fa-user-shield me-1"></i>å®‰å…¨è®¾ç½®
                                                <span class="badge bg-secondary ms-2">å³å°†æ¨å‡º</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- æ³¨é”€è´¦æˆ· -->
                                <div class="col-12">
                                    <div class="card border-danger">
                                        <div class="card-body">
                                            <h6 class="card-title text-danger">
                                                <i class="fas fa-exclamation-triangle me-2"></i>å±é™©æ“ä½œ
                                            </h6>
                                            <p class="card-text text-muted mb-3">
                                                æ³¨é”€è´¦æˆ·å°†æ°¸ä¹…åˆ é™¤æ‚¨çš„æ‰€æœ‰æ•°æ®ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤
                                            </p>
                                            <button class="btn btn-outline-danger btn-sm" disabled>
                                                <i class="fas fa-user-times me-1"></i>æ³¨é”€è´¦æˆ·
                                                <span class="badge bg-secondary ms-2">å³å°†æ¨å‡º</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>å–æ¶ˆ
                    </button>
                    <button type="button" class="btn btn-primary" id="saveSettings">
                        <i class="fas fa-save me-1"></i>ä¿å­˜è®¾ç½®
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹ç”¨æˆ·åæ¨¡æ€æ¡† -->
    <div class="modal fade" id="changeUsernameModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-edit me-2"></i>ä¿®æ”¹ç”¨æˆ·å
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <small>ä¿®æ”¹ç”¨æˆ·ååï¼Œè¯·ä½¿ç”¨æ–°ç”¨æˆ·åç™»å½•</small>
                    </div>
                    <form id="changeUsernameForm">
                        <div class="mb-3">
                            <label for="currentUsername" class="form-label">å½“å‰ç”¨æˆ·å</label>
                            <input type="text" class="form-control" id="currentUsername" value="{{ request.user.username }}" disabled>
                        </div>
                        <div class="mb-3">
                            <label for="newUsername" class="form-label">æ–°ç”¨æˆ·å *</label>
                            <input type="text" class="form-control" id="newUsername" required placeholder="è¯·è¾“å…¥æ–°ç”¨æˆ·å">
                        </div>
                        <div class="mb-3">
                            <label for="usernamePassword" class="form-label">å½“å‰å¯†ç  *</label>
                            <input type="password" class="form-control" id="usernamePassword" required placeholder="è¯·è¾“å…¥å½“å‰å¯†ç ä»¥éªŒè¯èº«ä»½">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-warning" onclick="submitChangeUsername()">
                        <i class="fas fa-check me-1"></i>ç¡®è®¤ä¿®æ”¹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹å¯†ç æ¨¡æ€æ¡† -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-lock me-2"></i>ä¿®æ”¹å¯†ç 
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>å¯†ç è‡³å°‘éœ€è¦ 6 ä¸ªå­—ç¬¦</small>
                    </div>
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label for="oldPassword" class="form-label">å½“å‰å¯†ç  *</label>
                            <input type="password" class="form-control" id="oldPassword" required placeholder="è¯·è¾“å…¥å½“å‰å¯†ç ">
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">æ–°å¯†ç  *</label>
                            <input type="password" class="form-control" id="newPassword" required placeholder="è¯·è¾“å…¥æ–°å¯†ç ">
                            <small class="form-text text-muted">
                                å¯†ç è¦æ±‚ï¼šè‡³å°‘8ä¸ªå­—ç¬¦ï¼Œä¸èƒ½ä¸ç”¨æˆ·åå¤ªç›¸ä¼¼ï¼Œä¸èƒ½æ˜¯å¸¸è§å¯†ç ï¼Œä¸èƒ½å…¨æ˜¯æ•°å­—
                            </small>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">ç¡®è®¤æ–°å¯†ç  *</label>
                            <input type="password" class="form-control" id="confirmPassword" required placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-warning" onclick="submitChangePassword()">
                        <i class="fas fa-check me-1"></i>ç¡®è®¤ä¿®æ”¹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¾¤ç»„ç®¡ç†å¼¹çª—åŒºåŸŸ -->
    <!-- åˆ›å»ºç¾¤ç»„æ¨¡æ€æ¡† -->
    <div class="modal fade share-group-modal" id="createShareGroupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-users-cog me-2"></i>åˆ›å»ºåä½œç¾¤ç»„
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createShareGroupForm">
                        <div class="form-group mb-3">
                            <label for="shareGroupName">
                                <i class="fas fa-tag"></i>
                                ç¾¤ç»„åç§° *
                            </label>
                            <input type="text" class="form-control" id="shareGroupName" required placeholder="ä¾‹å¦‚ï¼šå·¥ä½œåä½œç»„">
                        </div>
                        <div class="form-group mb-3">
                            <label for="shareGroupDescription">
                                <i class="fas fa-align-left"></i>
                                ç¾¤ç»„æè¿°
                            </label>
                            <textarea class="form-control" id="shareGroupDescription" rows="3" placeholder="æè¿°ç¾¤ç»„ç”¨é€”ï¼ˆå¯é€‰ï¼‰"></textarea>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <small>åˆ›å»ºåå°†ç”Ÿæˆå”¯ä¸€çš„ç¾¤ç»„IDï¼Œæ‚¨å¯ä»¥åˆ†äº«ç»™å…¶ä»–æˆå‘˜åŠ å…¥</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="shareGroupManager.createGroup()">
                        <i class="fas fa-check me-1"></i>åˆ›å»ºç¾¤ç»„
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ å…¥ç¾¤ç»„æ¨¡æ€æ¡† -->
    <div class="modal fade share-group-modal" id="joinShareGroupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus me-2"></i>åŠ å…¥åä½œç¾¤ç»„
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="joinShareGroupForm">
                        <div class="form-group mb-3">
                            <label for="joinGroupId">
                                <i class="fas fa-key"></i>
                                ç¾¤ç»„ID *
                            </label>
                            <input type="text" class="form-control" id="joinGroupId" required placeholder="è¯·è¾“å…¥ç¾¤ç»„ID">
                            <small class="form-text text-muted">
                                ç¾¤ç»„IDç”±ç¾¤ç»„åˆ›å»ºè€…æä¾›ï¼Œæ ¼å¼ç±»ä¼¼ï¼šshare_group_abc123
                            </small>
                        </div>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <small>åŠ å…¥åå¯æŸ¥çœ‹ç¾¤ç»„æˆå‘˜åˆ†äº«çš„æ—¥ç¨‹</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-success" onclick="shareGroupManager.joinGroup()">
                        <i class="fas fa-check me-1"></i>åŠ å…¥ç¾¤ç»„
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¾¤ç»„æˆå‘˜ç®¡ç†æ¨¡æ€æ¡† -->
    <div class="modal fade share-group-modal" id="manageGroupMembersModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-users me-2"></i>ç¾¤ç»„æˆå‘˜ç®¡ç†
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>ç¾¤ç»„ä¿¡æ¯
                            </h6>
                            <button class="copy-button" onclick="shareGroupManager.copyGroupId()">
                                <i class="fas fa-copy me-1"></i>å¤åˆ¶ç¾¤ç»„ID
                            </button>
                        </div>
                        <div class="share-group-id-display" id="currentGroupIdDisplay">
                            <span id="currentGroupId">-</span>
                        </div>
                        <div class="mt-2">
                            <strong id="currentGroupName">-</strong>
                            <p class="text-muted mb-0" id="currentGroupDescription">-</p>
                        </div>
                    </div>

                    <h6><i class="fas fa-users me-2"></i>æˆå‘˜åˆ—è¡¨</h6>
                    <div class="group-members-list" id="groupMembersList">
                        <!-- åŠ¨æ€æ¸²æŸ“æˆå‘˜åˆ—è¡¨ -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-danger" id="leaveGroupBtn" onclick="shareGroupManager.leaveGroup()" style="display:none;">
                        <i class="fas fa-sign-out-alt me-1"></i>é€€å‡ºç¾¤ç»„
                    </button>
                    <button type="button" class="btn btn-danger" id="deleteGroupBtn" onclick="shareGroupManager.deleteGroup()" style="display:none;">
                        <i class="fas fa-trash me-1"></i>åˆ é™¤ç¾¤ç»„
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¾¤ç»„é€‰æ‹©èœå•æ¨¡æ€æ¡†ï¼ˆç‚¹å‡»+æŒ‰é’®æ˜¾ç¤ºï¼‰ -->
    <!-- ç®¡ç†ç¾¤ç»„å¼¹çª—ï¼ˆå¤šçº§èœå•å½¢å¼ï¼‰ -->
    <div class="modal fade" id="manageShareGroupsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-users-cog me-2"></i>ç¾¤ç»„ç®¡ç†ä¸­å¿ƒ
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Tabs å¯¼èˆª -->
                    <ul class="nav nav-tabs mb-4" id="groupManageTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="my-groups-tab" data-bs-toggle="tab" 
                                    data-bs-target="#my-groups-panel" type="button" role="tab">
                                <i class="fas fa-list me-2"></i>æˆ‘çš„ç¾¤ç»„
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="create-group-tab" data-bs-toggle="tab" 
                                    data-bs-target="#create-group-panel" type="button" role="tab">
                                <i class="fas fa-plus-circle me-2"></i>åˆ›å»ºç¾¤ç»„
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="join-group-tab" data-bs-toggle="tab" 
                                    data-bs-target="#join-group-panel" type="button" role="tab">
                                <i class="fas fa-user-plus me-2"></i>åŠ å…¥ç¾¤ç»„
                            </button>
                        </li>
                        <li class="nav-item" role="presentation" id="edit-group-tab-item" style="display: none;">
                            <button class="nav-link" id="edit-group-tab" data-bs-toggle="tab" 
                                    data-bs-target="#edit-group-panel" type="button" role="tab">
                                <i class="fas fa-edit me-2"></i>ç¼–è¾‘ç¾¤ç»„
                                <button type="button" class="btn-close btn-close-sm ms-2" onclick="shareGroupManager.closeEditTab(event)" 
                                        style="font-size: 10px; padding: 0; width: 12px; height: 12px;"></button>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation" id="group-detail-tab-item" style="display: none;">
                            <button class="nav-link" id="group-detail-tab" data-bs-toggle="tab" 
                                    data-bs-target="#group-detail-panel" type="button" role="tab">
                                <i class="fas fa-info-circle me-2"></i>ç¾¤ç»„è¯¦æƒ…
                                <button type="button" class="btn-close btn-close-sm ms-2" onclick="shareGroupManager.closeDetailTab(event)" 
                                        style="font-size: 10px; padding: 0; width: 12px; height: 12px;"></button>
                            </button>
                        </li>
                    </ul>

                    <!-- Tabs å†…å®¹ -->
                    <div class="tab-content" id="groupManageTabContent">
                        <!-- æˆ‘çš„ç¾¤ç»„åˆ—è¡¨ -->
                        <div class="tab-pane fade show active" id="my-groups-panel" role="tabpanel">
                            <div id="shareGroupsList" class="share-groups-list">
                                <!-- åŠ¨æ€æ¸²æŸ“ç¾¤ç»„åˆ—è¡¨ -->
                            </div>
                        </div>

                        <!-- åˆ›å»ºç¾¤ç»„é¢æ¿ -->
                        <div class="tab-pane fade" id="create-group-panel" role="tabpanel">
                            <div class="create-group-form-container">
                                <h6 class="mb-3 text-primary">
                                    <i class="fas fa-info-circle me-2"></i>åˆ›å»ºæ–°çš„åä½œç¾¤ç»„
                                </h6>
                                <form id="createGroupForm" onsubmit="return false;">
                                    <div class="mb-3">
                                        <label for="createGroupName" class="form-label">
                                            <i class="fas fa-tag me-2"></i>ç¾¤ç»„åç§° <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="createGroupName" 
                                               placeholder="ä¾‹å¦‚ï¼šå·¥ä½œåä½œç»„" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="createGroupColor" class="form-label">
                                            <i class="fas fa-palette me-2"></i>ç¾¤ç»„é¢œè‰²
                                        </label>
                                        <input type="color" class="form-control form-control-color" 
                                               id="createGroupColor" value="#3498db">
                                    </div>
                                    <div class="mb-3">
                                        <label for="createMemberColor" class="form-label">
                                            <i class="fas fa-user-tag me-2"></i>æˆ‘çš„æˆå‘˜é¢œè‰²
                                        </label>
                                        <input type="color" class="form-control form-control-color" 
                                               id="createMemberColor" value="#3498db">
                                        <small class="text-muted">ç”¨äºåœ¨ç¾¤ç»„æ—¥å†ä¸­åŒºåˆ†ä¸åŒæˆå‘˜çš„æ—¥ç¨‹</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="createGroupDescription" class="form-label">
                                            <i class="fas fa-align-left me-2"></i>ç¾¤ç»„æè¿°
                                        </label>
                                        <textarea class="form-control" id="createGroupDescription" 
                                                  rows="3" placeholder="ç®€å•æè¿°è¿™ä¸ªç¾¤ç»„çš„ç”¨é€”..."></textarea>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-primary" onclick="shareGroupManager.createGroupInPanel()">
                                            <i class="fas fa-check me-2"></i>åˆ›å»ºç¾¤ç»„
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="shareGroupManager.resetCreateForm()">
                                            <i class="fas fa-redo me-2"></i>é‡ç½®
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- åŠ å…¥ç¾¤ç»„é¢æ¿ -->
                        <div class="tab-pane fade" id="join-group-panel" role="tabpanel">
                            <div class="join-group-form-container">
                                <h6 class="mb-3 text-primary">
                                    <i class="fas fa-info-circle me-2"></i>é€šè¿‡ç¾¤ç»„IDåŠ å…¥å·²æœ‰ç¾¤ç»„
                                </h6>
                                <form id="joinGroupForm" onsubmit="return false;">
                                    <div class="mb-3">
                                        <label for="joinGroupIdInput" class="form-label">
                                            <i class="fas fa-key me-2"></i>ç¾¤ç»„ID <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="joinGroupIdInput" 
                                               placeholder="share_group_xxxxxxxxxxxx" required>
                                        <small class="text-muted">è¯·å‘ç¾¤ä¸»ç´¢å–ç¾¤ç»„ID</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="joinMemberColor" class="form-label">
                                            <i class="fas fa-user-tag me-2"></i>æˆ‘çš„æˆå‘˜é¢œè‰²
                                        </label>
                                        <input type="color" class="form-control form-control-color" 
                                               id="joinMemberColor" value="#3498db">
                                        <small class="text-muted">ç”¨äºåœ¨ç¾¤ç»„æ—¥å†ä¸­åŒºåˆ†ä¸åŒæˆå‘˜çš„æ—¥ç¨‹</small>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-success" onclick="shareGroupManager.joinGroupInPanel()">
                                            <i class="fas fa-sign-in-alt me-2"></i>åŠ å…¥ç¾¤ç»„
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="shareGroupManager.resetJoinForm()">
                                            <i class="fas fa-redo me-2"></i>æ¸…ç©º
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- ç¼–è¾‘ç¾¤ç»„é¢æ¿ -->
                        <div class="tab-pane fade" id="edit-group-panel" role="tabpanel">
                            <div class="edit-group-form-container">
                                <h6 class="mb-3 text-primary">
                                    <i class="fas fa-edit me-2"></i>ç¼–è¾‘ç¾¤ç»„ä¿¡æ¯
                                </h6>
                                <form id="editGroupFormPanel" onsubmit="return false;">
                                    <input type="hidden" id="editShareGroupId">
                                    
                                    <div class="mb-3">
                                        <label for="editShareGroupName" class="form-label">
                                            <i class="fas fa-tag me-2"></i>ç¾¤ç»„åç§° <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="editShareGroupName" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="editShareGroupColor" class="form-label">
                                            <i class="fas fa-palette me-2"></i>ç¾¤ç»„é¢œè‰²
                                        </label>
                                        <input type="color" class="form-control form-control-color" id="editShareGroupColor">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="editShareGroupDescription" class="form-label">
                                            <i class="fas fa-align-left me-2"></i>ç¾¤ç»„æè¿°
                                        </label>
                                        <textarea class="form-control" id="editShareGroupDescription" rows="3"></textarea>
                                    </div>
                                    
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-primary" onclick="shareGroupManager.updateGroupInfoInPanel()">
                                            <i class="fas fa-save me-2"></i>ä¿å­˜ä¿®æ”¹
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="shareGroupManager.closeEditTab()">
                                            <i class="fas fa-arrow-left me-2"></i>è¿”å›åˆ—è¡¨
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- ç¾¤ç»„è¯¦æƒ…é¢æ¿ -->
                        <div class="tab-pane fade" id="group-detail-panel" role="tabpanel">
                            <div class="group-detail-container">
                                <h6 class="mb-3 text-primary">
                                    <i class="fas fa-info-circle me-2"></i>ç¾¤ç»„è¯¦ç»†ä¿¡æ¯
                                </h6>
                                
                                <div class="group-detail-item">
                                    <label>ç¾¤ç»„åç§°ï¼š</label>
                                    <span>
                                        <span class="share-group-color-dot" id="detailGroupColorDot" style="background-color: #007bff;"></span>
                                        <span id="detailGroupName">-</span>
                                    </span>
                                </div>
                                
                                <div class="group-detail-item">
                                    <label>ç¾¤ç»„IDï¼š</label>
                                    <span class="share-group-id">
                                        <span id="detailGroupId">-</span>
                                        <i class="fas fa-copy ms-2" onclick="shareGroupManager.copyGroupIdFromDetail()" title="å¤åˆ¶ID" style="cursor: pointer;"></i>
                                    </span>
                                </div>
                                
                                <div class="group-detail-item" id="detailGroupDescContainer" style="display: none;">
                                    <label>æè¿°ï¼š</label>
                                    <span id="detailGroupDesc">-</span>
                                </div>
                                
                                <div class="group-detail-item">
                                    <label>æˆå‘˜åˆ—è¡¨ï¼š</label>
                                    <div class="members-list" id="detailMembersList">
                                        <!-- åŠ¨æ€æ¸²æŸ“æˆå‘˜åˆ—è¡¨ -->
                                    </div>
                                </div>
                                
                                <div class="group-detail-item mt-4">
                                    <label>
                                        <i class="fas fa-user-tag me-2"></i>æˆ‘çš„æˆå‘˜é¢œè‰²ï¼š
                                    </label>
                                    <div class="d-flex align-items-center gap-2">
                                        <input type="color" class="form-control form-control-color" 
                                               id="detailMyMemberColor" value="#3498db">
                                        <button type="button" class="btn btn-sm btn-primary" 
                                                onclick="shareGroupManager.updateMyMemberColor()">
                                            <i class="fas fa-save me-1"></i>ä¿å­˜
                                        </button>
                                    </div>
                                    <small class="text-muted">æ­¤é¢œè‰²ç”¨äºåœ¨ç¾¤ç»„æ—¥å†ä¸­æ ‡è¯†æ‚¨çš„æ—¥ç¨‹</small>
                                </div>
                                
                                <div class="mt-4">
                                    <button type="button" class="btn btn-secondary" onclick="shareGroupManager.closeDetailTab()">
                                        <i class="fas fa-arrow-left me-2"></i>è¿”å›åˆ—è¡¨
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'fullcalendar_index.global.js' %}"></script>
    
    <!-- ç¾¤ç»„åä½œåŠŸèƒ½ JavaScript -->
    <script src="{% static 'js/share-groups.js' %}?v=20251111-001"></script>
    
    <!-- å…¨å±€å˜é‡ -->
    <script>
        // Djangoä¼ é€’çš„æ•°æ®
        window.events_groups = {{ events_groups|safe }};
        window.CSRF_TOKEN = '{{ csrf_token }}';
    </script>
    
    <!-- å…¨å±€æœç´¢å’Œè®¾ç½®èœå• -->
    <script>
        // å…¨å±€æœç´¢ç®¡ç†å™¨
        const globalSearch = {
            isExpanded: false,
            searchData: {
                events: [],
                reminders: [],
                todos: []
            },
            
            // åˆ‡æ¢æœç´¢æ 
            toggle() {
                // â­æ£€æŸ¥è®¾ç½®èœå•æ˜¯å¦å±•å¼€ï¼Œå¦‚æœæ˜¯ï¼Œå…ˆå…³é—­å®ƒ
                if (!this.isExpanded && settingsMenu.isExpanded) {
                    settingsMenu.toggle();
                    // â­ç«‹å³å¼ºåˆ¶æ¸…ç†è®¾ç½®èœå•UIï¼Œä¸ç­‰å¾…åŠ¨ç”»
                    const expandedMenu = document.getElementById('settingsMenuExpanded');
                    const settingsToggleBtn = document.getElementById('settingsToggleBtn');
                    const island = document.querySelector('.dynamic-island');
                    expandedMenu.style.display = 'none';
                    expandedMenu.classList.remove('closing');
                    settingsToggleBtn.style.display = 'flex';  // ç«‹å³æ˜¾ç¤ºè®¾ç½®æŒ‰é’®
                    const searchContainer = document.getElementById('globalSearchContainer');
                    searchContainer.style.order = '0';  // æ¢å¤order
                    island.classList.remove('settings-expanded');  // ç§»é™¤settings-expandedç±»
                }
                
                this.isExpanded = !this.isExpanded;
                const toggleBtn = document.getElementById('searchToggleBtn');
                const expandedBar = document.getElementById('searchBarExpanded');
                const resultsDropdown = document.getElementById('searchResultsDropdown');
                const settingsToggleBtn = document.getElementById('settingsToggleBtn');  // è·å–è®¾ç½®æŒ‰é’®
                const island = document.querySelector('.dynamic-island');
                
                if (this.isExpanded) {
                    // å±•å¼€åŠ¨ç”»
                    toggleBtn.style.display = 'none';
                    expandedBar.style.display = 'flex';
                    expandedBar.classList.remove('closing');
                    island.classList.add('search-expanded');
                    document.getElementById('globalSearchInput').focus();
                    this.loadAllData();
                    this.populateGroupFilter();
                    this.restoreFilterSettings(); // æ¢å¤ç­›é€‰è®¾ç½®
                } else {
                    // æ”¶èµ·åŠ¨ç”»
                    // â­ç«‹å³éšè—è®¾ç½®æŒ‰é’®
                    settingsToggleBtn.style.display = 'none';
                    
                    expandedBar.classList.add('closing');
                    resultsDropdown.style.display = 'none';
                    island.classList.remove('search-expanded');
                    
                    // åœ¨åŠ¨ç”»å¿«ç»“æŸæ—¶(250ms)è®©ä¸¤ä¸ªæŒ‰é’®ä¸€èµ·æ˜¾ç°
                    setTimeout(() => {
                        toggleBtn.style.display = 'flex';
                        settingsToggleBtn.style.display = 'flex';
                        toggleBtn.classList.add('appearing');
                        settingsToggleBtn.classList.add('appearing');
                        setTimeout(() => {
                            toggleBtn.classList.remove('appearing');
                            settingsToggleBtn.classList.remove('appearing');
                        }, 350);
                    }, 250);
                    
                    // ç­‰å¾…å®Œæ•´åŠ¨ç”»å®Œæˆåæ¸…ç†å±•å¼€æ 
                    setTimeout(() => {
                        expandedBar.style.display = 'none';
                        expandedBar.classList.remove('closing');
                    }, 350);
                    
                    this.clear();
                }
            },
            
            // æ¸…ç©ºæœç´¢
            clear() {
                document.getElementById('globalSearchInput').value = '';
                document.getElementById('searchResultsDropdown').style.display = 'none';
                document.querySelector('.search-clear-btn').style.display = 'none';
            },
            
            // å¤„ç†è¾“å…¥
            handleInput(event) {
                const query = event.target.value.trim();
                const clearBtn = document.querySelector('.search-clear-btn');
                
                clearBtn.style.display = query ? 'flex' : 'none';
                
                if (query.length > 0) {
                    this.performSearch(query);
                } else {
                    document.getElementById('searchResultsDropdown').style.display = 'none';
                }
            },
            
            // åŠ è½½æ‰€æœ‰æ•°æ®
            async loadAllData() {
                try {
                    // åŠ è½½æ—¥ç¨‹
                    const eventsResponse = await fetch('/get_calendar/events/');
                    const eventsData = await eventsResponse.json();
                    this.searchData.events = eventsData.events || [];
                    
                    // åŠ è½½æé†’
                    const remindersResponse = await fetch('/api/reminders/');
                    const remindersData = await remindersResponse.json();
                    this.searchData.reminders = remindersData.reminders || [];
                    
                    // åŠ è½½å¾…åŠ
                    const todosResponse = await fetch('/api/todos/');
                    const todosData = await todosResponse.json();
                    this.searchData.todos = todosData.todos || [];
                } catch (error) {
                    console.error('åŠ è½½æœç´¢æ•°æ®å¤±è´¥:', error);
                }
            },
            
            // å¡«å……æ—¥ç¨‹ç»„ç­›é€‰å™¨
            populateGroupFilter() {
                const groupFilter = document.getElementById('searchGroupFilter');
                groupFilter.innerHTML = '<option value="all">å…¨éƒ¨æ—¥ç¨‹ç»„</option>';
                
                if (window.events_groups && Array.isArray(window.events_groups)) {
                    window.events_groups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group.id;
                        option.textContent = group.name;
                        groupFilter.appendChild(option);
                    });
                }
            },
            
            // æ‰§è¡Œæœç´¢
            performSearch(query) {
                const typeFilter = document.getElementById('searchTypeFilter').value;
                const groupFilter = document.getElementById('searchGroupFilter').value;
                const timeFilter = document.getElementById('searchTimeFilter').value;
                
                let results = [];
                
                // æœç´¢æ—¥ç¨‹
                if (typeFilter === 'all' || typeFilter === 'event') {
                    const eventResults = this.searchData.events.filter(event => 
                        this.matchesQuery(event.title, query) || 
                        this.matchesQuery(event.description, query)
                    ).filter(event => 
                        this.matchesGroupFilter(event.groupID, groupFilter)
                    ).filter(event =>
                        this.matchesTimeFilter(event.start, timeFilter)
                    ).map(event => ({
                        ...event,
                        type: 'event',
                        displayType: 'æ—¥ç¨‹'
                    }));
                    results.push(...eventResults);
                }
                
                // æœç´¢æé†’
                if (typeFilter === 'all' || typeFilter === 'reminder') {
                    const reminderResults = this.searchData.reminders.filter(reminder =>
                        this.matchesQuery(reminder.title, query) ||
                        this.matchesQuery(reminder.content, query)
                    ).filter(reminder =>
                        this.matchesTimeFilter(reminder.trigger_time, timeFilter)
                    ).map(reminder => ({
                        ...reminder,
                        type: 'reminder',
                        displayType: 'æé†’'
                    }));
                    results.push(...reminderResults);
                }
                
                // æœç´¢å¾…åŠ
                if (typeFilter === 'all' || typeFilter === 'todo') {
                    const todoResults = this.searchData.todos.filter(todo =>
                        this.matchesQuery(todo.title, query) ||
                        this.matchesQuery(todo.description, query)
                    ).filter(todo =>
                        this.matchesGroupFilter(todo.groupID, groupFilter)
                    ).filter(todo =>
                        this.matchesTimeFilter(todo.due_date, timeFilter)
                    ).map(todo => ({
                        ...todo,
                        type: 'todo',
                        displayType: 'å¾…åŠ'
                    }));
                    results.push(...todoResults);
                }
                
                this.displayResults(results);
            },
            
            // åŒ¹é…æŸ¥è¯¢
            matchesQuery(text, query) {
                if (!text) return false;
                return text.toLowerCase().includes(query.toLowerCase());
            },
            
            // åŒ¹é…æ—¥ç¨‹ç»„ç­›é€‰
            matchesGroupFilter(groupID, filter) {
                if (filter === 'all') return true;
                return groupID === filter;
            },
            
            // åŒ¹é…æ—¶é—´ç­›é€‰
            matchesTimeFilter(timeStr, filter) {
                if (filter === 'all' || !timeStr) return true;
                
                const itemTime = new Date(timeStr);
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay());
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                
                switch (filter) {
                    case 'past':
                        return itemTime < now;
                    case 'today':
                        return itemTime >= today && itemTime < new Date(today.getTime() + 86400000);
                    case 'week':
                        return itemTime >= weekStart && itemTime < new Date(weekStart.getTime() + 7 * 86400000);
                    case 'month':
                        return itemTime >= monthStart && itemTime < new Date(now.getFullYear(), now.getMonth() + 1, 1);
                    case 'future':
                        return itemTime > now;
                    default:
                        return true;
                }
            },
            
            // æ˜¾ç¤ºæœç´¢ç»“æœ
            displayResults(results) {
                const resultsDropdown = document.getElementById('searchResultsDropdown');
                const resultsList = resultsDropdown.querySelector('.search-results-list');
                
                if (results.length === 0) {
                    resultsList.innerHTML = '<div class="search-no-results">æœªæ‰¾åˆ°åŒ¹é…çš„ç»“æœ</div>';
                } else {
                    resultsList.innerHTML = results.map(item => this.createResultItem(item)).join('');
                }
                
                resultsDropdown.style.display = 'block';
            },
            
            // åˆ›å»ºç»“æœé¡¹
            createResultItem(item) {
                const time = item.start || item.trigger_time || item.due_date || '';
                const timeDisplay = time ? new Date(time).toLocaleString('zh-CN') : 'æ— æ—¶é—´';
                
                return `
                    <div class="search-result-item" onclick="globalSearch.openItem('${item.type}', '${item.id}')">
                        <div class="search-result-title">${this.escapeHtml(item.title)}</div>
                        <div class="search-result-meta">
                            <span class="search-result-type ${item.type}">${item.displayType}</span>
                            <span>${timeDisplay}</span>
                        </div>
                    </div>
                `;
            },
            
            // æ‰“å¼€é¡¹ç›®è¯¦æƒ…
            openItem(type, id) {
                this.toggle(); // å…³é—­æœç´¢
                
                if (type === 'event') {
                    // æ‰¾åˆ°åŸå§‹äº‹ä»¶æ•°æ®
                    const eventData = this.searchData.events.find(e => e.id === id);
                    if (eventData && window.modalManager) {
                        // å°†åŸå§‹æ•°æ®è½¬æ¢ä¸º FullCalendar event æ ¼å¼
                        const fcEvent = {
                            id: eventData.id,
                            title: eventData.title,
                            start: eventData.start,
                            end: eventData.end,
                            extendedProps: {
                                description: eventData.description || '',
                                importance: eventData.importance || '',
                                urgency: eventData.urgency || '',
                                groupID: eventData.groupID || '',
                                ddl: eventData.ddl || '',
                                rrule: eventData.rrule || '',
                                series_id: eventData.series_id || '',
                                is_recurring: eventData.is_recurring || false,
                                is_main_event: eventData.is_main_event || false,
                                is_detached: eventData.is_detached || false,
                                recurrence_id: eventData.recurrence_id || '',
                                parent_event_id: eventData.parent_event_id || ''
                            }
                        };
                        window.modalManager.openEditEventModal(fcEvent);
                    }
                } else if (type === 'reminder') {
                    // æ‰¾åˆ°å¹¶è§¦å‘æé†’ç‚¹å‡» - ä½¿ç”¨æ­£ç¡®çš„å‡½æ•°
                    const reminder = this.searchData.reminders.find(r => r.id === id);
                    if (reminder && window.reminderManager) {
                        // reminderManager.editReminder éœ€è¦ reminderId å’Œ seriesId
                        window.reminderManager.editReminder(reminder.id, reminder.series_id || '');
                    }
                } else if (type === 'todo') {
                    // æ‰¾åˆ°å¹¶è§¦å‘å¾…åŠç‚¹å‡» - ä½¿ç”¨æ­£ç¡®çš„å‡½æ•°
                    const todo = this.searchData.todos.find(t => t.id === id);
                    if (todo && window.todoManager) {
                        // todoManager.openTodoDetailModal æ˜¯æ­£ç¡®çš„å‡½æ•°
                        window.todoManager.openTodoDetailModal(todo);
                    }
                }
            },
            
            // åº”ç”¨ç­›é€‰å™¨
            applyFilters() {
                this.saveFilterSettings(); // ä¿å­˜ç­›é€‰è®¾ç½®
                const query = document.getElementById('globalSearchInput').value.trim();
                if (query) {
                    this.performSearch(query);
                }
            },
            
            // ä¿å­˜ç­›é€‰è®¾ç½®åˆ°sessionStorage
            saveFilterSettings() {
                const typeFilter = document.getElementById('searchTypeFilter').value;
                const groupFilter = document.getElementById('searchGroupFilter').value;
                const timeFilter = document.getElementById('searchTimeFilter').value;
                
                sessionStorage.setItem('globalSearch_typeFilter', typeFilter);
                sessionStorage.setItem('globalSearch_groupFilter', groupFilter);
                sessionStorage.setItem('globalSearch_timeFilter', timeFilter);
            },
            
            // ä»sessionStorageæ¢å¤ç­›é€‰è®¾ç½®
            restoreFilterSettings() {
                const typeFilter = sessionStorage.getItem('globalSearch_typeFilter');
                const groupFilter = sessionStorage.getItem('globalSearch_groupFilter');
                const timeFilter = sessionStorage.getItem('globalSearch_timeFilter');
                
                if (typeFilter) {
                    document.getElementById('searchTypeFilter').value = typeFilter;
                }
                if (groupFilter) {
                    document.getElementById('searchGroupFilter').value = groupFilter;
                }
                if (timeFilter) {
                    document.getElementById('searchTimeFilter').value = timeFilter;
                }
            },
            
            // HTMLè½¬ä¹‰
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        };
        
        // è®¾ç½®èœå•ç®¡ç†å™¨
        const settingsMenu = {
            isExpanded: false,
            
            // åˆ‡æ¢è®¾ç½®èœå•
            toggle() {
                // â­æ£€æŸ¥æœç´¢æ˜¯å¦å±•å¼€ï¼Œå¦‚æœæ˜¯ï¼Œå…ˆå…³é—­å®ƒ
                if (!this.isExpanded && globalSearch.isExpanded) {
                    globalSearch.toggle();
                    // â­ç«‹å³å¼ºåˆ¶æ¸…ç†æœç´¢UIï¼Œä¸ç­‰å¾…åŠ¨ç”»
                    const expandedBar = document.getElementById('searchBarExpanded');
                    const searchToggleBtn = document.getElementById('searchToggleBtn');
                    const resultsDropdown = document.getElementById('searchResultsDropdown');
                    const island = document.querySelector('.dynamic-island');
                    expandedBar.style.display = 'none';
                    expandedBar.classList.remove('closing');
                    resultsDropdown.style.display = 'none';
                    searchToggleBtn.style.display = 'flex';  // ç«‹å³æ˜¾ç¤ºæœç´¢æŒ‰é’®
                    island.classList.remove('search-expanded');  // ç§»é™¤search-expandedç±»
                }
                
                this.isExpanded = !this.isExpanded;
                const toggleBtn = document.getElementById('settingsToggleBtn');
                const expandedMenu = document.getElementById('settingsMenuExpanded');
                const searchContainer = document.getElementById('globalSearchContainer');
                const searchToggleBtn = document.getElementById('searchToggleBtn');  // è·å–æœç´¢æŒ‰é’®
                const island = document.querySelector('.dynamic-island');
                
                if (this.isExpanded) {
                    // å±•å¼€åŠ¨ç”»
                    toggleBtn.style.display = 'none';
                    expandedMenu.style.display = 'flex';
                    expandedMenu.classList.remove('closing');
                    // æœç´¢æŒ‰é’®ç§»åˆ°æœ€å·¦ä¾§,è®¾ç½®èœå•åœ¨å³ä¾§,æ•´ä½“å±…ä¸­
                    searchContainer.style.order = '-1';
                    island.classList.add('settings-expanded');
                } else {
                    // æ”¶èµ·åŠ¨ç”»
                    // â­ç«‹å³éšè—æœç´¢æŒ‰é’®å¹¶æ¢å¤order
                    searchToggleBtn.style.display = 'none';
                    searchContainer.style.order = '0';
                    
                    expandedMenu.classList.add('closing');
                    island.classList.remove('settings-expanded');
                    
                    // åœ¨åŠ¨ç”»å¿«ç»“æŸæ—¶(250ms)è®©ä¸¤ä¸ªæŒ‰é’®ä¸€èµ·æ˜¾ç°
                    setTimeout(() => {
                        toggleBtn.style.display = 'flex';
                        searchToggleBtn.style.display = 'flex';
                        toggleBtn.classList.add('appearing');
                        searchToggleBtn.classList.add('appearing');
                        setTimeout(() => {
                            toggleBtn.classList.remove('appearing');
                            searchToggleBtn.classList.remove('appearing');
                        }, 350);
                    }, 250);
                    
                    // ç­‰å¾…å®Œæ•´åŠ¨ç”»å®Œæˆåæ¸…ç†å±•å¼€èœå•
                    setTimeout(() => {
                        expandedMenu.style.display = 'none';
                        expandedMenu.classList.remove('closing');
                    }, 350);
                }
            },
            
            // æ‰“å¼€è®¾ç½®
            openSettings() {
                const settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
                settingsModal.show();
                this.toggle(); // å…³é—­èœå•
            },
            
            // æ‰“å¼€å¸®åŠ©
            openHelp() {
                window.location.href = "{% url 'help_page' %}";
            },
            
            // é€€å‡ºç™»å½•
            logout() {
                if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                    window.location.href = "{% url 'user_logout' %}";
                }
            }
        };
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­æœç´¢å’Œè®¾ç½®èœå•
        document.addEventListener('click', function(event) {
            const searchContainer = document.getElementById('globalSearchContainer');
            const settingsContainer = document.getElementById('settingsContainer');
            
            // å…³é—­æœç´¢
            if (globalSearch.isExpanded && !searchContainer.contains(event.target)) {
                globalSearch.toggle();
            }
            
            // å…³é—­è®¾ç½®èœå•
            if (settingsMenu.isExpanded && !settingsContainer.contains(event.target)) {
                settingsMenu.toggle();
            }
        });
    </script>
    
    <!-- è‡ªå®šä¹‰JavaScriptæ¨¡å— -->
    <script src="{% static 'js/theme-manager.js' %}?v=20251107-002"></script>
    <script src="{% static 'js/settings-manager.js' %}?v=20251107-001"></script>
    <script src="{% static 'js/panel-resizer.js' %}?v=20251107-001"></script>
    <script src="{% static 'js/reminder-manager.js' %}?v=20251104-002"></script>
    <script src="{% static 'js/rrule-manager.js' %}?v=20251104-002"></script>
    <script src="{% static 'js/modal-manager.js' %}?v=20251104-002"></script>
    <script src="{% static 'js/group-manager.js' %}?v=20251106-001"></script>
    <script src="{% static 'js/event-manager.js' %}?v=20251106-002"></script>
    <script src="{% static 'js/todo-manager.js' %}?v=20251107-007"></script>
    <script src="{% static 'js/calendar-touch-swipe.js' %}?v=20251104-003"></script>
    <script src="{% static 'js/container-query-polyfill.js' %}?v=20251107-001"></script>
    
    <!-- AI Agent æ¨¡å— -->
    <script src="{% static 'js/agent-chat.js' %}?v=20251222-001"></script>
    <script>
        // åˆå§‹åŒ– Agent Chat
        agentChat = new AgentChat({{ user.id }}, window.CSRF_TOKEN);
        
        // ä¿ç•™æ—§çš„ aiAssistant å˜é‡ä»¥å…¼å®¹å…¶ä»–å¯èƒ½çš„å¼•ç”¨
        const aiAssistant = agentChat;
        
        // åˆ›å»ºç®¡ç†å™¨å®ä¾‹ï¼ˆå…¨å±€å˜é‡ï¼‰
        window.modalManager = new ModalManager();
        window.eventManager = new EventManager();
        window.todoManager = new TodoManager();
        window.reminderManager = new ReminderManager();
        window.rruleManager = new RRuleManager();
        window.panelResizer = new PanelResizer(); // æ·»åŠ é¢æ¿è°ƒèŠ‚å™¨
    </script>

    <!-- é¡µé¢åˆå§‹åŒ– -->
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // é¦–å…ˆåˆå§‹åŒ–è®¾ç½®ç®¡ç†å™¨å¹¶ç­‰å¾…åŠ è½½å®Œæˆ
            await settingsManager.init();
            console.log('âœ… è®¾ç½®ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');
            
            // ç«‹å³åŠ è½½ç”¨æˆ·è®¾ç½®åˆ°å…¨å±€å˜é‡ï¼ˆä¸æ˜¾ç¤ºåœ¨UIä¸Šï¼‰
            await loadUserSettingsToGlobal();
            console.log('âœ… ç”¨æˆ·è®¾ç½®å·²åŠ è½½åˆ°å…¨å±€å˜é‡');
            
            // åˆå§‹åŒ–ä¸»é¢˜ç®¡ç†å™¨(éœ€è¦åœ¨userSettingsåŠ è½½å)
            window.themeManager.init();
            
            // åˆå§‹åŒ–å„ä¸ªç®¡ç†å™¨
            window.modalManager.init();
            window.groupManager.init();  // å…ˆåˆå§‹åŒ–æ—¥ç¨‹ç»„ç®¡ç†å™¨
            window.eventManager.init(); // æ­¤æ—¶settingsManagerå·²æœ‰æ•°æ®,å¯ä»¥æ­£ç¡®è®¾ç½®initialViewå’ŒinitialDate
            window.todoManager.init();
            window.reminderManager.init();
            
            // åˆå§‹åŒ–æ—¥å†è§¦å±æ»‘åŠ¨åŠŸèƒ½
            // ç­‰å¾…æ—¥å†æ¸²æŸ“å®Œæˆåå†å¯ç”¨è§¦å±æ»‘åŠ¨
            setTimeout(() => {
                if (window.eventManager && window.eventManager.calendar && window.CalendarTouchSwipe) {
                    window.calendarSwipe = new CalendarTouchSwipe(window.eventManager.calendar);
                    console.log('âœ… æ—¥å†è§¦å±æ»‘åŠ¨åŠŸèƒ½å·²å¯ç”¨');
                }
            }, 800);
            
            // åˆå§‹åŒ–é‡å¤æé†’UIäº‹ä»¶ç›‘å¬å™¨
            initRepeatReminderListeners();
            
            // ç¨å¾®å»¶è¿ŸåŠ è½½æ•°æ®ï¼Œç¡®ä¿DOMå®Œå…¨å‡†å¤‡å¥½
            setTimeout(() => {
                window.eventManager.loadEvents();
                window.todoManager.loadTodos();
                window.reminderManager.loadReminders();
                
                // å†å»¶è¿Ÿä¸€ç‚¹åº”ç”¨ä¿å­˜çš„è®¾ç½®ï¼Œç¡®ä¿æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆ
                setTimeout(() => {
                    settingsManager.applySettings();
                    console.log('å·²åº”ç”¨ä¿å­˜çš„ç”¨æˆ·è®¾ç½®');
                }, 500);
            }, 100);
            
            // åˆå§‹åŒ–ç”¨æˆ·è®¾ç½®åŠŸèƒ½
            initUserSettings();
            
            // åˆå§‹åŒ–å‘¨æ•°æ˜¾ç¤ºåŠŸèƒ½
            initWeekNumberDisplay();
            
            console.log('UniSchedulerSuper ç³»ç»Ÿå·²åˆå§‹åŒ–å®Œæˆ');
        });
        
        // ==================== ç”¨æˆ·è®¾ç½®ç®¡ç† ====================
        
        // åŠ è½½ç”¨æˆ·è®¾ç½®åˆ°å…¨å±€å˜é‡ï¼ˆé¡µé¢åˆå§‹åŒ–æ—¶è°ƒç”¨ï¼‰
        async function loadUserSettingsToGlobal() {
            try {
                const response = await fetch('/get_calendar/user_settings/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const settings = await response.json();
                // å°†è®¾ç½®ä¿å­˜åˆ°å…¨å±€å˜é‡
                window.userSettings = settings;
                console.log('âœ… ç”¨æˆ·è®¾ç½®å·²åŠ è½½åˆ°å…¨å±€å˜é‡:', window.userSettings);
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·è®¾ç½®å¤±è´¥:', error);
                // è®¾ç½®é»˜è®¤å€¼
                window.userSettings = {
                    auto_ddl: true,  // é»˜è®¤å¯ç”¨è‡ªåŠ¨DDL
                    show_weekends: true,
                    calendar_view_default: 'dayGridMonth'
                };
                console.log('ä½¿ç”¨é»˜è®¤è®¾ç½®:', window.userSettings);
            }
        }
        
        function initUserSettings() {
            // å½“è®¾ç½®æ¨¡æ€æ¡†æ‰“å¼€æ—¶ï¼ŒåŠ è½½å½“å‰è®¾ç½®
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal) {
                settingsModal.addEventListener('show.bs.modal', loadUserSettings);
            }
            
            // ä¿å­˜è®¾ç½®æŒ‰é’®
            const saveBtn = document.getElementById('saveSettings');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveUserSettings);
            }
            
            // é‡‘è‰²ä¸»é¢˜å¼€å…³
            const goldThemeToggle = document.getElementById('useGoldTheme');
            if (goldThemeToggle) {
                goldThemeToggle.addEventListener('change', function() {
                    if (window.themeManager) {
                        window.themeManager.toggleGoldTheme(this.checked);
                    }
                });
            }
            
            // ä¸»é¢˜é€‰æ‹©å™¨å˜åŒ–æ—¶ï¼Œå¦‚æœå¯ç”¨äº†é‡‘è‰²ä¸»é¢˜ï¼Œä¹Ÿè¦é‡æ–°åº”ç”¨
            const themeSelect = document.getElementById('theme');
            if (themeSelect) {
                themeSelect.addEventListener('change', function() {
                    const useGold = document.getElementById('useGoldTheme')?.checked || false;
                    if (window.themeManager) {
                        window.themeManager.applyTheme(this.value);
                    }
                });
            }
            
            // åˆå§‹åŒ– tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
        
        // åŠ è½½ç”¨æˆ·è®¾ç½®
        function loadUserSettings() {
            fetch('/get_calendar/user_settings/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(settings => {
                console.log('åŠ è½½çš„è®¾ç½®:', settings);
                
                // è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨è®¾ç½®å…ƒç´ å€¼ï¼ˆè·³è¿‡ä¸å­˜åœ¨æˆ–è¢«ç¦ç”¨çš„å…ƒç´ ï¼‰
                function safeSetValue(id, value) {
                    const element = document.getElementById(id);
                    if (element && !element.disabled) {
                        element.value = value;
                    }
                }
                
                function safeSetChecked(id, value) {
                    const element = document.getElementById(id);
                    if (element && !element.disabled) {
                        element.checked = value;
                    }
                }
                
                // åŸºæœ¬è®¾ç½® - å‘¨æ•°æ˜¾ç¤º
                safeSetChecked('showWeekNumber', settings.show_week_number !== false);
                
                // åŠ è½½å‘¨æœŸåˆ—è¡¨
                loadWeekPeriods(settings.week_number_periods || []);
                
                // æ—¥ç¨‹åå¥½ï¼ˆå¤§éƒ¨åˆ†å·²ç¦ç”¨ï¼‰
                safeSetValue('defaultEventDuration', settings.default_event_duration || 60);
                safeSetValue('weekStartsOn', settings.week_starts_on || 1);
                safeSetValue('workHoursStart', settings.work_hours_start || '09:00');
                safeSetValue('workHoursEnd', settings.work_hours_end || '18:00');
                safeSetChecked('autoDdl', settings.auto_ddl !== false);
                safeSetChecked('showWeekends', settings.show_weekends !== false);
                
                // æ˜¾ç¤ºåå¥½
                safeSetValue('calendarViewDefault', settings.calendar_view_default || 'dayGridMonth');
                safeSetValue('theme', settings.theme || 'light');
                safeSetChecked('useGoldTheme', settings.use_gold_theme === true);
                safeSetValue('eventColorBy', settings.event_color_by || 'default');
                safeSetChecked('showCompletedEvents', settings.show_completed_events !== false);
                
                // æé†’è®¾ç½®
                safeSetChecked('reminderEnabled', settings.reminder_enabled !== false);
                safeSetChecked('reminderSound', settings.reminder_sound !== false);
                
                // AI è®¾ç½®
                safeSetChecked('aiEnabled', settings.ai_enabled !== false);
                safeSetChecked('aiAutoSuggest', settings.ai_auto_suggest === true);
                
                // å°†è®¾ç½®ä¿å­˜åˆ°å…¨å±€å˜é‡,ä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
                window.userSettings = settings;
                console.log('ç”¨æˆ·è®¾ç½®å·²ä¿å­˜åˆ° window.userSettings:', window.userSettings);
            })
            .catch(error => {
                console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
                showToast('åŠ è½½è®¾ç½®å¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼', 'warning');
                // å³ä½¿åŠ è½½å¤±è´¥,ä¹Ÿè®¾ç½®é»˜è®¤å€¼
                window.userSettings = {
                    auto_ddl: true,  // é»˜è®¤å¯ç”¨è‡ªåŠ¨DDL
                    show_weekends: true,
                    calendar_view_default: 'dayGridMonth'
                };
            });
        }
        
        // ==================== å‘¨æœŸç®¡ç†åŠŸèƒ½ ====================
        
        /**
         * åŠ è½½å‘¨æœŸåˆ—è¡¨åˆ°UI
         */
        function loadWeekPeriods(periods) {
            const container = document.getElementById('weekPeriodsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!periods || periods.length === 0) {
                // æ˜¾ç¤ºç©ºçŠ¶æ€
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•å­¦æœŸ,ç‚¹å‡»"æ·»åŠ å­¦æœŸ"æŒ‰é’®å¼€å§‹è®¾ç½®
                    </div>
                `;
                return;
            }
            
            // æ¸²æŸ“æ¯ä¸ªå‘¨æœŸ
            periods.forEach((period, index) => {
                const periodCard = document.createElement('div');
                periodCard.className = 'card mb-2';
                periodCard.innerHTML = `
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <label class="form-label small">å­¦æœŸåç§°</label>
                                <input type="text" class="form-control form-control-sm" 
                                       value="${period.name || ''}" 
                                       onchange="updatePeriodName(${index}, this.value)"
                                       placeholder="ä¾‹å¦‚: 2024ç§‹å­£">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">å¹´ä»½</label>
                                <input type="number" class="form-control form-control-sm" 
                                       value="${period.year || new Date().getFullYear()}" 
                                       min="2000" max="2100"
                                       onchange="updatePeriodYear(${index}, this.value)">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">æœˆä»½</label>
                                <select class="form-select form-select-sm" 
                                        onchange="updatePeriodMonth(${index}, this.value)">
                                    ${generateMonthOptions(period.month)}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">æ—¥æœŸ</label>
                                <input type="number" class="form-control form-control-sm" 
                                       value="${period.day || 1}" 
                                       min="1" max="31"
                                       onchange="updatePeriodDay(${index}, this.value)">
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="button" class="btn btn-sm btn-danger w-100" 
                                        onclick="removeWeekPeriod(${index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(periodCard);
            });
        }
        
        /**
         * ç”Ÿæˆæœˆä»½é€‰é¡¹
         */
        function generateMonthOptions(selectedMonth) {
            const months = [
                '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ',
                '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'
            ];
            return months.map((name, index) => {
                const value = index + 1;
                const selected = value === selectedMonth ? 'selected' : '';
                return `<option value="${value}" ${selected}>${name}</option>`;
            }).join('');
        }
        
        /**
         * æ·»åŠ æ–°å‘¨æœŸ
         */
        function addWeekPeriod() {
            const settings = window.userSettings || {};
            const periods = settings.week_number_periods || [];
            
            // æ·»åŠ æ–°å‘¨æœŸ,é»˜è®¤ä½¿ç”¨å½“å‰å¹´ä»½
            periods.push({
                name: 'æ–°å­¦æœŸ',
                year: new Date().getFullYear(),
                month: 2,
                day: 24
            });
            
            // æ›´æ–°è®¾ç½®
            settings.week_number_periods = periods;
            window.userSettings = settings;
            
            // é‡æ–°åŠ è½½UI
            loadWeekPeriods(periods);
        }
        
        /**
         * åˆ é™¤å‘¨æœŸ
         */
        function removeWeekPeriod(index) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå­¦æœŸå—?')) {
                return;
            }
            
            const settings = window.userSettings || {};
            const periods = settings.week_number_periods || [];
            
            periods.splice(index, 1);
            settings.week_number_periods = periods;
            window.userSettings = settings;
            
            loadWeekPeriods(periods);
        }
        
        /**
         * æ›´æ–°å‘¨æœŸåç§°
         */
        function updatePeriodName(index, value) {
            const settings = window.userSettings || {};
            const periods = settings.week_number_periods || [];
            
            if (periods[index]) {
                periods[index].name = value;
                settings.week_number_periods = periods;
                window.userSettings = settings;
            }
        }
        
        /**
         * æ›´æ–°å‘¨æœŸå¹´ä»½
         */
        function updatePeriodYear(index, value) {
            const settings = window.userSettings || {};
            const periods = settings.week_number_periods || [];
            
            if (periods[index]) {
                periods[index].year = parseInt(value);
                settings.week_number_periods = periods;
                window.userSettings = settings;
            }
        }
        
        /**
         * æ›´æ–°å‘¨æœŸæœˆä»½
         */
        function updatePeriodMonth(index, value) {
            const settings = window.userSettings || {};
            const periods = settings.week_number_periods || [];
            
            if (periods[index]) {
                periods[index].month = parseInt(value);
                settings.week_number_periods = periods;
                window.userSettings = settings;
            }
        }
        
        /**
         * æ›´æ–°å‘¨æœŸæ—¥æœŸ
         */
        function updatePeriodDay(index, value) {
            const settings = window.userSettings || {};
            const periods = settings.week_number_periods || [];
            
            if (periods[index]) {
                periods[index].day = parseInt(value);
                settings.week_number_periods = periods;
                window.userSettings = settings;
            }
        }
        
        /**
         * è·å–å½“å‰å‘¨æœŸé…ç½®
         */
        function getWeekPeriods() {
            const settings = window.userSettings || {};
            return settings.week_number_periods || [];
        }
        
        // ä¿å­˜ç”¨æˆ·è®¾ç½®
        function saveUserSettings() {
            // è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨è·å–å…ƒç´ å€¼ï¼ˆè·³è¿‡ä¸å­˜åœ¨æˆ–è¢«ç¦ç”¨çš„å…ƒç´ ï¼‰
            function safeGetValue(id, defaultValue) {
                const element = document.getElementById(id);
                if (element && !element.disabled) {
                    return element.value;
                }
                return defaultValue;
            }
            
            function safeGetChecked(id, defaultValue) {
                const element = document.getElementById(id);
                if (element && !element.disabled) {
                    return element.checked;
                }
                return defaultValue;
            }
            
            function safeGetIntValue(id, defaultValue) {
                const element = document.getElementById(id);
                if (element && !element.disabled) {
                    return parseInt(element.value);
                }
                return defaultValue;
            }
            
            const settings = {
                // æ–°çš„å¤šå‘¨æœŸç³»ç»Ÿ
                week_number_periods: getWeekPeriods(),
                show_week_number: safeGetChecked('showWeekNumber', true),
                // ä¿ç•™æ—§å­—æ®µä»¥å…¼å®¹å†å²æ•°æ®
                week_number_start: {
                    month: safeGetIntValue('weekNumberStartMonth', 2),
                    day: safeGetIntValue('weekNumberStartDay', 24)
                },
                auto_ddl: safeGetChecked('autoDdl', true),
                default_event_duration: safeGetIntValue('defaultEventDuration', 60),
                work_hours_start: safeGetValue('workHoursStart', '09:00'),
                work_hours_end: safeGetValue('workHoursEnd', '18:00'),
                show_weekends: safeGetChecked('showWeekends', true),
                week_starts_on: safeGetIntValue('weekStartsOn', 1),
                calendar_view_default: safeGetValue('calendarViewDefault', 'dayGridMonth'),
                theme: safeGetValue('theme', 'light'),
                use_gold_theme: safeGetChecked('useGoldTheme', false),
                show_completed_events: safeGetChecked('showCompletedEvents', true),
                event_color_by: safeGetValue('eventColorBy', 'default'),
                reminder_enabled: safeGetChecked('reminderEnabled', true),
                default_reminder_time: 15,  // å›ºå®šé»˜è®¤å€¼ï¼Œå› ä¸ºUIä¸­å·²åˆ é™¤è¯¥å­—æ®µ
                reminder_sound: safeGetChecked('reminderSound', true),
                ai_enabled: safeGetChecked('aiEnabled', true),
                ai_auto_suggest: safeGetChecked('aiAutoSuggest', false),
                prompt_scene_presets: []  // æš‚æ—¶ä¿ç•™ç©ºæ•°ç»„ï¼Œæœªæ¥å¯æ‰©å±•
            };
            
            console.log('ä¿å­˜çš„è®¾ç½®:', settings);
            
            fetch('/get_calendar/user_settings/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': window.CSRF_TOKEN
                },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                console.log('è®¾ç½®ä¿å­˜æˆåŠŸ:', data);
                showToast('è®¾ç½®å·²ä¿å­˜', 'success');
                
                // æ›´æ–°å…¨å±€è®¾ç½®å˜é‡
                window.userSettings = settings;
                console.log('âœ… å…¨å±€è®¾ç½®å·²æ›´æ–°:', window.userSettings);
                
                // å…³é—­æ¨¡æ€æ¡†
                const modalElement = document.getElementById('settingsModal');
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
                
                // åº”ç”¨æŸäº›ç«‹å³ç”Ÿæ•ˆçš„è®¾ç½®
                applyImmediateSettings(settings);
            })
            .catch(error => {
                console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
                showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'danger');
            });
        }
        
        // åº”ç”¨ç«‹å³ç”Ÿæ•ˆçš„è®¾ç½®
        function applyImmediateSettings(settings) {
            // æ£€æŸ¥æ—¥å†å®ä¾‹æ˜¯å¦å­˜åœ¨
            const calendarInstance = window.eventManager?.calendar;
            
            if (!calendarInstance) {
                console.log('æ—¥å†å®ä¾‹å°šæœªåˆå§‹åŒ–ï¼Œè®¾ç½®å°†åœ¨ä¸‹æ¬¡é¡µé¢åŠ è½½æ—¶ç”Ÿæ•ˆ');
                return;
            }
            
            // âš ï¸ æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œåº”ç”¨ calendar_view_default
            // å› ä¸º settings-manager.js ä¼šåœ¨é¡µé¢åˆ·æ–°æ—¶æ¢å¤ç”¨æˆ·ä¸Šæ¬¡çš„è§†å›¾å’Œæ—¥æœŸ
            // calendar_view_default åªåœ¨é‡æ–°ç™»å½•(æ²¡æœ‰ä¿å­˜çš„è§†å›¾çŠ¶æ€)æ—¶ä½¿ç”¨
            
            // åº”ç”¨ä¸»é¢˜è®¾ç½®
            if (settings.theme && window.themeManager) {
                window.themeManager.applyTheme(settings.theme, false); // falseå› ä¸ºå·²ç»ä¿å­˜åˆ°æ•°æ®åº“
                console.log('ä¸»é¢˜å·²æ›´æ–°ä¸º:', settings.theme);
            }
            
            // åº”ç”¨å‘¨èµ·å§‹æ—¥è®¾ç½®
            if (settings.week_starts_on !== undefined) {
                try {
                    calendarInstance.setOption('firstDay', settings.week_starts_on);
                    console.log('å‘¨èµ·å§‹æ—¥å·²æ›´æ–°ä¸º:', settings.week_starts_on);
                    
                    // æ›´æ–°å‘¨æ•°æ˜¾ç¤º(å› ä¸ºå‘¨æ•°è®¡ç®—ä¾èµ–äºå‘¨èµ·å§‹æ—¥)
                    updateWeekNumberDisplay();
                } catch (error) {
                    console.error('æ›´æ–°å‘¨èµ·å§‹æ—¥å¤±è´¥:', error);
                }
            }
            
            // åº”ç”¨å‘¨æœ«æ˜¾ç¤ºè®¾ç½®
            if (settings.show_weekends !== undefined) {
                try {
                    calendarInstance.setOption('weekends', settings.show_weekends);
                    console.log('å‘¨æœ«æ˜¾ç¤ºå·²æ›´æ–°ä¸º:', settings.show_weekends);
                } catch (error) {
                    console.error('æ›´æ–°å‘¨æœ«æ˜¾ç¤ºå¤±è´¥:', error);
                }
            }
        }
        
        // ==================== å‘¨æ•°æ˜¾ç¤ºç®¡ç† ====================
        
        /**
         * è·å–æŸä¸ªæ—¥æœŸæ‰€åœ¨å‘¨çš„å¼€å§‹æ—¥æœŸ
         * @param {Date} date - è¾“å…¥æ—¥æœŸ
         * @param {number} weekStartsOn - æ¯å‘¨èµ·å§‹æ—¥(0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­)
         * @returns {Date} è¯¥å‘¨çš„å¼€å§‹æ—¥æœŸ
         */
        function getWeekStart(date, weekStartsOn = 1) {
            const d = new Date(date);
            const day = d.getDay(); // 0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­
            const diff = (day - weekStartsOn + 7) % 7; // è®¡ç®—è·ç¦»å‘¨èµ·å§‹æ—¥çš„å¤©æ•°
            d.setDate(d.getDate() - diff);
            d.setHours(0, 0, 0, 0); // é‡ç½®åˆ°å½“å¤©00:00:00
            return d;
        }
        
        /**
         * æŸ¥æ‰¾æœ€è¿‘çš„å‘¨æ•°èµ·å§‹æ—¥æœŸ
         * @param {Date} date - è¦æŸ¥æ‰¾çš„åŸºå‡†æ—¥æœŸ
         * @param {Array} periods - å‘¨æ•°èµ·å§‹æ—¶é—´æ•°ç»„ [{name, year, month, day}]
         * @param {number} weekStartsOn - æ¯å‘¨èµ·å§‹æ—¥(0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­)
         * @returns {Object|null} {period, startDate, weekNumber} æˆ– null(æ‰¾ä¸åˆ°)
         */
        function findNearestPeriod(date, periods, weekStartsOn = 1) {
            if (!periods || periods.length === 0) {
                return null;
            }
            
            let nearestPeriod = null;
            let nearestStartDate = null;
            let minDistance = Infinity;
            
            // éå†æ‰€æœ‰èµ·å§‹æ—¶é—´,ä½¿ç”¨é…ç½®çš„å¹´ä»½
            for (const period of periods) {
                // ä½¿ç”¨é…ç½®çš„å¹´æœˆæ—¥åˆ›å»ºèµ·å§‹æ—¥æœŸ
                const startDate = new Date(period.year, period.month - 1, period.day);
                
                // åªè€ƒè™‘åœ¨å½“å‰æ—¥æœŸä¹‹å‰æˆ–ç­‰äºçš„èµ·å§‹æ—¥æœŸ
                if (startDate <= date) {
                    const distance = date - startDate;
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestPeriod = period;
                        nearestStartDate = startDate;
                    }
                }
            }
            
            // å¦‚æœæ‰¾åˆ°äº†æœ€è¿‘çš„èµ·å§‹æ—¥æœŸ,è®¡ç®—å‘¨æ•°
            if (nearestPeriod && nearestStartDate) {
                // æ‰¾åˆ°èµ·å§‹æ—¥æœŸæ‰€åœ¨å‘¨çš„å¼€å§‹
                const periodWeekStart = getWeekStart(nearestStartDate, weekStartsOn);
                
                // æ‰¾åˆ°ç›®æ ‡æ—¥æœŸæ‰€åœ¨å‘¨çš„å¼€å§‹
                const targetWeekStart = getWeekStart(date, weekStartsOn);
                
                // è®¡ç®—ä¸¤ä¸ªå‘¨å¼€å§‹æ—¥æœŸä¹‹é—´çš„å¤©æ•°å·®
                const diffTime = targetWeekStart - periodWeekStart;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                // è®¡ç®—ç»è¿‡äº†å¤šå°‘å®Œæ•´çš„å‘¨,åŠ 1å¾—åˆ°å½“å‰æ˜¯ç¬¬å‡ å‘¨
                const weekNumber = Math.floor(diffDays / 7) + 1;
                
                return {
                    period: nearestPeriod,
                    startDate: nearestStartDate,
                    weekNumber: weekNumber
                };
            }
            
            return null;
        }
        
        /**
         * è®¡ç®—å½“å‰æ—¥æœŸæ˜¯ç¬¬å‡ å‘¨(æ–°ç‰ˆæœ¬ - æ”¯æŒå¤šèµ·å§‹æ—¶é—´å’Œæ¯å‘¨èµ·å§‹æ—¥)
         * @param {Date} date - è¦è®¡ç®—çš„æ—¥æœŸ
         * @returns {Object|null} {period, weekNumber} æˆ– null(æ‰¾ä¸åˆ°èµ·å§‹æ—¶é—´)
         */
        function calculateWeekNumber(date = new Date()) {
            // æ£€æŸ¥ç”¨æˆ·è®¾ç½®
            const settings = window.userSettings || {};
            
            // æ£€æŸ¥æ˜¯å¦ç¦ç”¨å‘¨æ•°æ˜¾ç¤º
            if (settings.show_week_number === false) {
                return null;
            }
            
            // è·å–æ¯å‘¨èµ·å§‹æ—¥é…ç½®,é»˜è®¤ä¸ºå‘¨ä¸€(1)
            const weekStartsOn = settings.week_starts_on !== undefined ? settings.week_starts_on : 1;
            
            // ä¼˜å…ˆä½¿ç”¨æ–°çš„week_number_periods
            let periods = settings.week_number_periods;
            
            // å¦‚æœæ²¡æœ‰periodsä½†æœ‰æ—§çš„week_number_start,è¿›è¡Œå…¼å®¹å¤„ç†
            if ((!periods || periods.length === 0) && settings.week_number_start) {
                periods = [{
                    name: 'é»˜è®¤å­¦æœŸ',
                    year: new Date().getFullYear(), // ä½¿ç”¨å½“å‰å¹´ä»½
                    month: settings.week_number_start.month || 2,
                    day: settings.week_number_start.day || 24
                }];
            }
            
            // æŸ¥æ‰¾æœ€è¿‘çš„èµ·å§‹æ—¶é—´,ä¼ å…¥weekStartsOnå‚æ•°
            const result = findNearestPeriod(date, periods, weekStartsOn);
            
            if (result) {
                return {
                    period: result.period,
                    weekNumber: result.weekNumber
                };
            }
            
            return null;
        }
        
        /**
         * æ›´æ–°æ—¥å†æ ‡é¢˜æ—è¾¹çš„å‘¨æ•°æ˜¾ç¤º
         */
        function updateWeekNumberDisplay() {
            // è·å–æ—¥å†å®ä¾‹
            const calendarInstance = window.eventManager?.calendar;
            if (!calendarInstance) {
                console.warn('æ—¥å†å®ä¾‹ä¸å­˜åœ¨ï¼Œæ— æ³•æ›´æ–°å‘¨æ•°æ˜¾ç¤º');
                return;
            }
            
            // è·å–å½“å‰è§†å›¾
            const currentView = calendarInstance.view;
            const viewType = currentView.type;
            
            // æŸ¥æ‰¾æˆ–åˆ›å»ºå‘¨æ•°æ˜¾ç¤ºå…ƒç´ 
            let weekBadge = document.getElementById('weekNumberBadge');
            const toolbarTitle = document.querySelector('.fc-toolbar-title');
            
            if (!toolbarTitle) {
                console.warn('æœªæ‰¾åˆ°æ—¥å†æ ‡é¢˜å…ƒç´ ');
                return;
            }
            
            // è®¡ç®—å‘¨æ•°æ˜¾ç¤ºå†…å®¹
            let badgeText = '';
            
            if (viewType === 'dayGridMonth') {
                // æœˆè§†å›¾: æ˜¾ç¤ºç¬¬Xå‘¨-ç¬¬Yå‘¨
                const startDate = currentView.activeStart;
                const endDate = new Date(currentView.activeEnd.getTime() - 1); // å‡1å¤©,å› ä¸ºactiveEndæ˜¯ä¸‹ä¸ªæœˆç¬¬ä¸€å¤©
                
                const startResult = calculateWeekNumber(startDate);
                const endResult = calculateWeekNumber(endDate);
                
                if (startResult && endResult) {
                    if (startResult.weekNumber === endResult.weekNumber) {
                        badgeText = `ç¬¬ ${startResult.weekNumber} å‘¨`;
                    } else {
                        badgeText = `ç¬¬ ${startResult.weekNumber}-${endResult.weekNumber} å‘¨`;
                    }
                    // å¦‚æœå­¦æœŸåç§°ç›¸åŒ,æ˜¾ç¤ºå­¦æœŸå
                    if (startResult.period.name === endResult.period.name && startResult.period.name !== 'é»˜è®¤å­¦æœŸ') {
                        badgeText += ` (${startResult.period.name})`;
                    }
                }
            } else {
                // å‘¨è§†å›¾/æ—¥è§†å›¾: æ˜¾ç¤ºå•ä¸ªå‘¨æ•°
                const currentDate = calendarInstance.getDate();
                const result = calculateWeekNumber(currentDate);
                
                if (result) {
                    badgeText = `ç¬¬ ${result.weekNumber} å‘¨`;
                    // æ˜¾ç¤ºå­¦æœŸåç§°(å¦‚æœä¸æ˜¯é»˜è®¤å­¦æœŸ)
                    if (result.period.name && result.period.name !== 'é»˜è®¤å­¦æœŸ') {
                        badgeText += ` (${result.period.name})`;
                    }
                }
            }
            
            // å¦‚æœæ²¡æœ‰å‘¨æ•°ä¿¡æ¯,éšè—å¾½ç« 
            if (!badgeText) {
                if (weekBadge) {
                    weekBadge.style.display = 'none';
                }
                console.log('å½“å‰æ—¥æœŸä¸åœ¨ä»»ä½•å­¦æœŸèŒƒå›´å†…,ä¸æ˜¾ç¤ºå‘¨æ•°');
                return;
            }
            
            if (!weekBadge) {
                // åˆ›å»ºå‘¨æ•°å¾½ç« å…ƒç´ 
                weekBadge = document.createElement('span');
                weekBadge.id = 'weekNumberBadge';
                weekBadge.className = 'badge ms-3';  // ç§»é™¤bg-primaryï¼Œæ”¹ç”¨CSSä¸»é¢˜é€‚é…
                weekBadge.style.fontSize = '0.9rem';
                weekBadge.style.verticalAlign = 'middle';
                
                // æ’å…¥åˆ°æ ‡é¢˜åé¢
                toolbarTitle.appendChild(weekBadge);
            }
            
            // æ˜¾ç¤ºå¾½ç« å¹¶æ›´æ–°æ–‡æœ¬
            weekBadge.style.display = '';
            weekBadge.textContent = badgeText;
            console.log(`âœ… å‘¨æ•°å·²æ›´æ–°: ${badgeText}`);
        }
        
        /**
         * åˆå§‹åŒ–å‘¨æ•°æ˜¾ç¤ºåŠŸèƒ½
         */
        function initWeekNumberDisplay() {
            // ç­‰å¾…æ—¥å†åˆå§‹åŒ–å®Œæˆ
            const checkCalendar = setInterval(() => {
                if (window.eventManager?.calendar) {
                    clearInterval(checkCalendar);
                    
                    // é¦–æ¬¡æ˜¾ç¤ºå‘¨æ•°
                    setTimeout(() => {
                        updateWeekNumberDisplay();
                    }, 500);
                    
                    // ç›‘å¬æ—¥å†è§†å›¾å˜åŒ–
                    const calendarInstance = window.eventManager.calendar;
                    
                    // ä½¿ç”¨FullCalendarçš„datesSetäº‹ä»¶ç›‘å¬æ—¥æœŸå˜åŒ–
                    calendarInstance.on('datesSet', function(info) {
                        console.log('æ—¥å†è§†å›¾å·²å˜åŒ–ï¼Œæ›´æ–°å‘¨æ•°');
                        updateWeekNumberDisplay();
                    });
                    
                    console.log('âœ… å‘¨æ•°æ˜¾ç¤ºåŠŸèƒ½å·²åˆå§‹åŒ–');
                }
            }, 100);
            
            // 30ç§’ååœæ­¢æ£€æŸ¥ï¼ˆé˜²æ­¢æ— é™å¾ªç¯ï¼‰
            setTimeout(() => {
                clearInterval(checkCalendar);
            }, 30000);
        }
        
        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯ï¼ˆToastï¼‰
        function showToast(message, type = 'info') {
            // åˆ›å»º Toast å…ƒç´ 
            const toastHTML = `
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.insertAdjacentHTML('beforeend', toastHTML);
            
            // è·å–åˆšæ·»åŠ çš„æœ€åä¸€ä¸ª toast å…ƒç´ 
            const toastElements = document.querySelectorAll('.toast');
            const toastElement = toastElements[toastElements.length - 1];
            
            // åˆå§‹åŒ–å¹¶æ˜¾ç¤º Toast
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();
            
            // è‡ªåŠ¨ç§»é™¤ DOM å…ƒç´ 
            setTimeout(() => {
                toastElement.remove();
            }, 4000);
        }
        
        // åˆå§‹åŒ–é‡å¤æé†’ç›¸å…³çš„äº‹ä»¶ç›‘å¬å™¨
        function initRepeatReminderListeners() {
            // ç›‘å¬æ‰€æœ‰å¯èƒ½å½±å“é‡å¤é¢„è§ˆçš„æ§ä»¶
            const fieldsToWatch = [
                'newRepeatFreq', 'newRepeatInterval', 'newRepeatUntil', 'newMonthlyType', 'newMonthlyDate', 'newMonthlyWeek', 'newMonthlyWeekday',
                'editRepeatFreq', 'editRepeatInterval', 'editRepeatUntil', 'editMonthlyType', 'editMonthlyDate', 'editMonthlyWeek', 'editMonthlyWeekday',
                'newMO', 'newTU', 'newWE', 'newTH', 'newFR', 'newSA', 'newSU',
                'editMO', 'editTU', 'editWE', 'editTH', 'editFR', 'editSA', 'editSU'
            ];
            
            fieldsToWatch.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    const mode = fieldId.startsWith('new') ? 'new' : 'edit';
                    element.addEventListener('change', () => {
                        updateRepeatPreview(mode);
                    });
                }
            });
        }
        
        // ===== Token ç®¡ç†åŠŸèƒ½ =====
        let currentToken = null;
        
        // é¡µé¢åŠ è½½æ—¶è·å– Token
        document.addEventListener('DOMContentLoaded', function() {
            loadUserToken();
        });
        
        // åŠ è½½ç”¨æˆ·çš„ Token
        async function loadUserToken() {
            const displayArea = document.getElementById('tokenDisplayArea');
            try {
                const response = await fetch('/api/auth/token/', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentToken = data.token;
                    displayToken(currentToken, data.created);
                } else {
                    // ç”¨æˆ·æ²¡æœ‰ Token
                    displayNoToken();
                }
            } catch (error) {
                console.error('åŠ è½½ Token å¤±è´¥:', error);
                displayArea.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-exclamation-circle me-2"></i>åŠ è½½å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        }
        
        // æ˜¾ç¤º Token
        function displayToken(token, isNew = false) {
            const displayArea = document.getElementById('tokenDisplayArea');
            const statusText = isNew ? '<span class="badge bg-success">æ–°åˆ›å»º</span>' : '<span class="badge bg-info">å·²å­˜åœ¨</span>';
            
            displayArea.innerHTML = `
                <div class="alert alert-warning mb-0">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-key me-2"></i>
                        <strong>æ‚¨çš„ API Token</strong>
                        ${statusText}
                    </div>
                    <div class="bg-white p-2 rounded border" style="font-family: monospace; font-size: 13px; word-break: break-all; user-select: all;">
                        ${token}
                    </div>
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle me-1"></i>è¯·å¦¥å–„ä¿ç®¡ï¼Œä¸è¦æ³„éœ²ç»™ä»–äºº
                    </small>
                </div>
            `;
            
            // æ˜¾ç¤ºç›¸å…³æŒ‰é’®
            document.getElementById('copyTokenBtn').style.display = 'inline-block';
            document.getElementById('refreshTokenBtn').style.display = 'inline-block';
            document.getElementById('deleteTokenBtn').style.display = 'inline-block';
            document.getElementById('createTokenBtn').style.display = 'none';
        }
        
        // æ˜¾ç¤ºæ—  Token çŠ¶æ€
        function displayNoToken() {
            const displayArea = document.getElementById('tokenDisplayArea');
            displayArea.innerHTML = `
                <div class="alert alert-secondary mb-0">
                    <i class="fas fa-info-circle me-2"></i>æ‚¨è¿˜æ²¡æœ‰ API Tokenï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åˆ›å»ºä¸€ä¸ª
                </div>
            `;
            
            // æ˜¾ç¤ºåˆ›å»ºæŒ‰é’®ï¼Œéšè—å…¶ä»–æŒ‰é’®
            document.getElementById('createTokenBtn').style.display = 'inline-block';
            document.getElementById('copyTokenBtn').style.display = 'none';
            document.getElementById('refreshTokenBtn').style.display = 'none';
            document.getElementById('deleteTokenBtn').style.display = 'none';
            currentToken = null;
        }
        
        // å¤åˆ¶ Token
        function copyToken() {
            if (!currentToken) {
                showToast('æ²¡æœ‰å¯å¤åˆ¶çš„ Token', 'warning');
                return;
            }
            
            navigator.clipboard.writeText(currentToken).then(() => {
                showToast('Token å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(err => {
                showToast('å¤åˆ¶å¤±è´¥: ' + err.message, 'danger');
            });
        }
        
        // åˆ·æ–° Token
        async function refreshToken() {
            if (!confirm('ç¡®å®šè¦åˆ·æ–° Token å—ï¼Ÿæ—§çš„ Token å°†ç«‹å³å¤±æ•ˆã€‚')) {
                return;
            }
            
            try {
                const response = await fetch('/api/auth/token/refresh/', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Token ' + currentToken,
                        'X-CSRFToken': window.CSRF_TOKEN
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentToken = data.token;
                    displayToken(currentToken, true);
                    showToast('Token å·²åˆ·æ–°', 'success');
                } else {
                    const error = await response.json();
                    showToast('åˆ·æ–°å¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'), 'danger');
                }
            } catch (error) {
                showToast('åˆ·æ–°å¤±è´¥: ' + error.message, 'danger');
            }
        }
        
        // åˆ›å»º Token
        async function createToken() {
            try {
                const response = await fetch('/api/auth/token/', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentToken = data.token;
                    displayToken(currentToken, data.created);
                    showToast('Token å·²åˆ›å»º', 'success');
                } else {
                    const error = await response.json();
                    showToast('åˆ›å»ºå¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'), 'danger');
                }
            } catch (error) {
                showToast('åˆ›å»ºå¤±è´¥: ' + error.message, 'danger');
            }
        }
        
        // åˆ é™¤ Token
        async function deleteToken() {
            if (!confirm('ç¡®å®šè¦åˆ é™¤ Token å—ï¼Ÿåˆ é™¤åéœ€è¦é‡æ–°åˆ›å»ºã€‚')) {
                return;
            }
            
            try {
                const response = await fetch('/api/auth/token/delete/', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Token ' + currentToken,
                        'X-CSRFToken': window.CSRF_TOKEN
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    displayNoToken();
                    showToast('Token å·²åˆ é™¤', 'info');
                } else {
                    const error = await response.json();
                    showToast('åˆ é™¤å¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'), 'danger');
                }
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'danger');
            }
        }
        
        // æµ‹è¯• Tokenï¼ˆéªŒè¯ä»»æ„è¾“å…¥çš„ Tokenï¼‰
        async function testToken() {
            const tokenInput = document.getElementById('testTokenInput');
            const resultDiv = document.getElementById('testTokenResult');
            const token = tokenInput.value.trim();
            
            if (!token) {
                resultDiv.innerHTML = '<div class="alert alert-warning alert-sm mb-0 mt-2"><small>è¯·è¾“å…¥è¦éªŒè¯çš„ Token</small></div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="alert alert-info alert-sm mb-0 mt-2"><small><i class="fas fa-spinner fa-spin me-1"></i>éªŒè¯ä¸­...</small></div>';
            
            try {
                const response = await fetch('/api/auth/token/verify/', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Token ' + token
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `
                        <div class="alert alert-success alert-sm mb-0 mt-2">
                            <small>
                                <i class="fas fa-check-circle me-1"></i><strong>Token æœ‰æ•ˆ</strong><br>
                                ç”¨æˆ·: ${data.username} (ID: ${data.user_id})<br>
                                é‚®ç®±: ${data.email || 'æœªè®¾ç½®'}
                            </small>
                        </div>
                    `;
                } else {
                    const error = await response.json();
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger alert-sm mb-0 mt-2">
                            <small><i class="fas fa-times-circle me-1"></i>Token æ— æ•ˆæˆ–å·²è¿‡æœŸ</small>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger alert-sm mb-0 mt-2">
                        <small><i class="fas fa-exclamation-circle me-1"></i>éªŒè¯å¤±è´¥: ${error.message}</small>
                    </div>
                `;
            }
        }
        
        // åˆ‡æ¢ä½¿ç”¨ç¤ºä¾‹æ˜¾ç¤º
        function toggleUsageExample() {
            const exampleDiv = document.getElementById('usageExample');
            if (exampleDiv.style.display === 'none') {
                exampleDiv.style.display = 'block';
            } else {
                exampleDiv.style.display = 'none';
            }
        }
        
        // ===== ä¿®æ”¹ç”¨æˆ·åå’Œå¯†ç åŠŸèƒ½ =====
        
        // æ˜¾ç¤ºä¿®æ”¹ç”¨æˆ·åæ¨¡æ€æ¡†
        function showChangeUsernameModal() {
            const modal = new bootstrap.Modal(document.getElementById('changeUsernameModal'));
            // æ¸…ç©ºè¡¨å•
            document.getElementById('newUsername').value = '';
            document.getElementById('usernamePassword').value = '';
            modal.show();
        }
        
        // æ˜¾ç¤ºä¿®æ”¹å¯†ç æ¨¡æ€æ¡†
        function showChangePasswordModal() {
            const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
            // æ¸…ç©ºè¡¨å•
            document.getElementById('oldPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            modal.show();
        }
        
        // æäº¤ä¿®æ”¹ç”¨æˆ·å
        async function submitChangeUsername() {
            const newUsername = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('usernamePassword').value;
            
            if (!newUsername) {
                showToast('è¯·è¾“å…¥æ–°ç”¨æˆ·å', 'warning');
                return;
            }
            
            if (!password) {
                showToast('è¯·è¾“å…¥å½“å‰å¯†ç ', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/user/change-username/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.CSRF_TOKEN
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        new_username: newUsername,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast('ç”¨æˆ·åä¿®æ”¹æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°...', 'success');
                    // å…³é—­æ¨¡æ€æ¡†
                    const modal = bootstrap.Modal.getInstance(document.getElementById('changeUsernameModal'));
                    modal.hide();
                    // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ–°ç”¨æˆ·å
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showToast(data.error || 'ä¿®æ”¹å¤±è´¥', 'danger');
                }
            } catch (error) {
                showToast('ä¿®æ”¹å¤±è´¥: ' + error.message, 'danger');
            }
        }
        
        // æäº¤ä¿®æ”¹å¯†ç 
        async function submitChangePassword() {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!oldPassword) {
                showToast('è¯·è¾“å…¥å½“å‰å¯†ç ', 'warning');
                return;
            }
            
            if (!newPassword) {
                showToast('è¯·è¾“å…¥æ–°å¯†ç ', 'warning');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'warning');
                return;
            }
            
            // å¯†ç å¼ºåº¦éªŒè¯ç”±åç«¯çš„ Django å¯†ç éªŒè¯å™¨å¤„ç†
            // åŒ…æ‹¬ï¼šæœ€å°é•¿åº¦ã€ä¸èƒ½ä¸ç”¨æˆ·ä¿¡æ¯ç›¸ä¼¼ã€ä¸èƒ½æ˜¯å¸¸è§å¯†ç ã€ä¸èƒ½å…¨æ˜¯æ•°å­—
            
            try {
                const response = await fetch('/api/user/change-password/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.CSRF_TOKEN
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        old_password: oldPassword,
                        new_password: newPassword,
                        confirm_password: confirmPassword
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast('å¯†ç ä¿®æ”¹æˆåŠŸï¼', 'success');
                    // å…³é—­æ¨¡æ€æ¡†
                    const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
                    modal.hide();
                } else {
                    showToast(data.error || 'ä¿®æ”¹å¤±è´¥', 'danger');
                }
            } catch (error) {
                showToast('ä¿®æ”¹å¤±è´¥: ' + error.message, 'danger');
            }
        }
        
    </script>
</body>
</html>
