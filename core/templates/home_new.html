{% load static %}
<!-- v20251101-009: 实现完整的多维度筛选（状态+优先级+类型）；修复优先级筛选器选项值 -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniSchedulerSuper - 智能日程管理系统</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/home-styles.css' %}?v=20251031-002">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- 强制隐藏editEventRecurringInfo元素的样式 -->
    <style>
        #editEventRecurringInfo {
            display: none !important;
            visibility: hidden !important;
        }
        /* 防止JavaScript重新显示 */
        #editEventRecurringInfo[data-force-hidden="true"] {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            overflow: hidden !important;
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav class="navbar navbar-expand-lg bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand text-white" href="#">
                <i class="fas fa-calendar-check me-2"></i>
                UniSchedulerSuper
            </a>
            
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle text-white" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle me-1"></i>
                        用户
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#settingsModal"><i class="fas fa-cog me-2"></i>设置</a></li>
                        <li><a class="dropdown-item" href="{% url 'help_page' %}"><i class="fas fa-question-circle me-2"></i>帮助</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{% url 'user_logout' %}"><i class="fas fa-sign-out-alt me-2"></i>退出</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容区域 -->
    <div class="main-container">
        <!-- 左侧面板 - 待办事项和提醒 -->
        <div class="left-panel resizable-panel" data-min-width="15" data-max-width="35">
            <!-- 待办事项区域 -->
            <div class="todo-section section-half">
                <div class="section-header">
                    <h6><i class="fas fa-tasks me-2"></i>待办事项</h6>
                    <button class="btn btn-primary btn-sm create-btn" onclick="modalManager.openCreateTodoModal()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <!-- 待办事项筛选和排序 - 固定在顶部 -->
                <div class="filter-controls mb-2">
                    <div class="row g-1">
                        <div class="col-6">
                            <select class="form-select form-select-sm" id="todoStatusFilter">
                                <option value="">全部状态</option>
                                <option value="pending">待完成</option>
                                <option value="in_progress">进行中</option>
                                <option value="completed">已完成</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <select class="form-select form-select-sm" id="todoSortBy">
                                <option value="priority">按优先级</option>
                                <option value="due_date">按到期时间</option>
                                <option value="created_at">按创建时间</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="section-content scrollable-content">
                    <!-- 待办事项列表 -->
                    <div id="todoList" class="todo-list">
                        <div class="loading-placeholder">
                            <i class="fas fa-spinner fa-spin"></i> 加载中...
                        </div>
                    </div>
                </div>
            </div>

            <!-- 分隔线 -->
            <div class="section-divider"></div>

            <!-- 提醒区域 -->
            <div class="reminder-section section-half">
                <div class="section-header">
                    <h6><i class="fas fa-bell me-2"></i>提醒</h6>
                    <button class="btn btn-primary btn-sm create-btn" onclick="modalManager.openCreateReminderModal()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <!-- 提醒筛选控件 - 固定在顶部 -->
                <div class="reminder-filters mb-2">
                    <div class="row g-1">
                        <div class="col-6">
                            <select id="reminderTimeRange" class="form-select form-select-sm">
                                <option value="today">今天</option>
                                <option value="week">本周</option>
                                <option value="month">本月</option>
                                <option value="quarter">本季度</option>
                                <option value="year">一年内</option>
                                <option value="all">全部时间</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <select id="reminderStatusFilter" class="form-select form-select-sm">
                                <option value="active">活跃</option>
                                <option value="completed">已完成</option>
                                <option value="dismissed">已忽略</option>
                                <option value="snoozed">已延后</option>
                                <option value="all">全部状态</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-1 mt-1">
                        <div class="col-6">
                            <select id="reminderPriorityFilter" class="form-select form-select-sm">
                                <option value="all">全部优先级</option>
                                <option value="urgent">紧急</option>
                                <option value="high">高</option>
                                <option value="normal">普通</option>
                                <option value="low">低</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <select id="reminderTypeFilter" class="form-select form-select-sm">
                                <option value="all">全部类型</option>
                                <option value="single">单次提醒</option>
                                <option value="recurring">重复提醒</option>
                                <option value="detached">已分离</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="section-content scrollable-content">
                    <div id="reminderList" class="reminder-list">
                        <div class="loading-placeholder">
                            <i class="fas fa-spinner fa-spin"></i> 加载中...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 调节器 -->
        <div class="resize-handle left-resize" data-target="left-panel"></div>

        <!-- 中央面板 - 日历 -->
        <div class="center-panel resizable-panel" data-min-width="30" data-max-width="70">
            <div class="panel-header">
                <h5><i class="fas fa-calendar-alt me-2"></i>日程日历</h5>
                <div class="calendar-controls">
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="modalManager.openCreateEventModal()">
                        <i class="fas fa-plus me-1"></i>新建事件
                    </button>
                    <button class="btn btn-outline-success btn-sm me-2" onclick="groupManager.showManageGroupsModal()">
                        <i class="fas fa-layer-group me-1"></i>管理日程组
                    </button>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="eventManager.calendar.today()">今天</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="eventManager.calendar.prev()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="eventManager.calendar.next()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="panel-content calendar-content">
                <div id="calendar" class="calendar-container"></div>
            </div>
        </div>

        <!-- 调节器 -->
        <div class="resize-handle right-resize" data-target="center-panel"></div>

        <!-- 右侧面板 - AI助手 -->
        <div class="right-panel resizable-panel" data-min-width="20" data-max-width="50">
            <div class="panel-header">
                <h5><i class="fas fa-robot me-2"></i>AI助手</h5>
                <button class="btn btn-outline-primary btn-sm" id="aiChatToggle">
                    <i class="fas fa-comment"></i>
                </button>
            </div>
            
            <div class="panel-content scrollable-content">
                <div class="ai-quick-actions mb-3">
                    <button class="btn btn-outline-info btn-sm w-100 mb-2" onclick="aiAssistant.smartSchedule()">
                        <i class="fas fa-magic me-1"></i>智能安排
                    </button>
                    <button class="btn btn-outline-success btn-sm w-100 mb-2" onclick="aiAssistant.analyzePriority()">
                        <i class="fas fa-chart-line me-1"></i>优先级分析
                    </button>
                    <button class="btn btn-outline-warning btn-sm w-100 mb-2" onclick="aiAssistant.timeBlocking()">
                        <i class="fas fa-clock me-1"></i>时间块分配
                    </button>
                </div>
                
                <div class="ai-chat-area">
                    <div class="chat-messages" id="aiChatMessages">
                        <div class="welcome-message">
                            <i class="fas fa-robot"></i>
                            <p>你好！我是你的AI助手，可以帮你：</p>
                            <ul>
                                <li>智能安排日程</li>
                                <li>分析任务优先级</li>
                                <li>优化时间分配</li>
                                <li>提供效率建议</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="chat-input-area">
                        <div class="input-group">
                            <input type="text" class="form-control" id="aiChatInput" placeholder="输入你的问题...">
                            <button class="btn btn-primary" id="aiSendButton">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 创建事件模态框 -->
    <div class="modal" id="createEventModal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-plus me-2"></i>创建新事件
                </h5>
                <span class="close">&times;</span>
            </div>
            
            <form id="createEventForm" class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="newEventTitle" class="form-label">标题 *</label>
                        <input type="text" class="form-control form-input" id="newEventTitle" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="newEventGroupId" class="form-label">日程组</label>
                        <select class="form-select" id="newEventGroupId">
                            <option value="">无</option>
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="newEventStart" class="form-label">开始时间 *</label>
                        <input type="datetime-local" class="form-control form-input" id="newEventStart" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="newEventEnd" class="form-label">结束时间 *</label>
                        <input type="datetime-local" class="form-control form-input" id="newEventEnd" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="creatEventDdl" class="form-label">截止时间</label>
                        <input type="datetime-local" class="form-control" id="creatEventDdl">
                    </div>
                    
                    <!-- RRule重复设置 -->
                    <div class="col-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="newEventIsRecurring">
                            <label class="form-check-label" for="newEventIsRecurring">
                                <i class="fas fa-repeat me-1"></i>重复事件
                            </label>
                        </div>
                    </div>
                    
                    <!-- 重复事件设置区域 -->
                    <div class="col-12" id="newEventRecurringOptions" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-cog me-2"></i>重复设置</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <!-- 重复频率 -->
                                    <div class="col-md-4">
                                        <label for="newEventFreq" class="form-label">重复频率</label>
                                        <select class="form-select" id="newEventFreq">
                                            <option value="DAILY">每日</option>
                                            <option value="WEEKLY">每周</option>
                                            <option value="MONTHLY">每月</option>
                                            <option value="YEARLY">每年</option>
                                        </select>
                                    </div>
                                    
                                    <!-- 重复间隔 -->
                                    <div class="col-md-4">
                                        <label for="newEventInterval" class="form-label">间隔</label>
                                        <input type="number" class="form-control" id="newEventInterval" value="1" min="1" max="365">
                                    </div>
                                    
                                    <!-- 结束条件 -->
                                    <div class="col-md-4">
                                        <label for="newEventEndType" class="form-label">结束条件</label>
                                        <select class="form-select" id="newEventEndType">
                                            <option value="never">永不结束</option>
                                            <option value="count">重复次数</option>
                                            <option value="until">结束日期</option>
                                        </select>
                                    </div>
                                    
                                    <!-- 重复次数 -->
                                    <div class="col-md-6" id="newEventCountContainer" style="display: none;">
                                        <label for="newEventCount" class="form-label">重复次数</label>
                                        <input type="number" class="form-control" id="newEventCount" value="10" min="1" max="999">
                                    </div>
                                    
                                    <!-- 结束日期 -->
                                    <div class="col-md-6" id="newEventUntilContainer" style="display: none;">
                                        <label for="newEventUntil" class="form-label">结束日期</label>
                                        <input type="date" class="form-control" id="newEventUntil">
                                    </div>
                                    
                                    <!-- 每周重复的星期选择 -->
                                    <div class="col-12" id="newEventWeekdaysContainer" style="display: none;">
                                        <label class="form-label">重复星期</label>
                                        <div class="weekday-buttons">
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="MO">周一</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="TU">周二</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="WE">周三</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="TH">周四</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="FR">周五</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="SA">周六</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="SU">周日</button>
                                        </div>
                                    </div>
                                    
                                    <!-- 每月重复设置 -->
                                    <div class="col-md-6" id="newEventMonthlyOptions" style="display: none;">
                                        <label for="newEventMonthlyType" class="form-label">月重复方式</label>
                                        <select class="form-select" id="newEventMonthlyType">
                                            <option value="simple">每隔指定月数</option>
                                            <option value="bymonthday">按日期（例如：每月15日）</option>
                                            <option value="byweekday">按星期（例如：每月第二个周一）</option>
                                        </select>
                                    </div>
                                    
                                    <!-- 按日期重复的选择 -->
                                    <div class="col-md-6" id="newEventMonthlyDateOptions" style="display: none;">
                                        <label for="newEventMonthlyDate" class="form-label">选择日期</label>
                                        <select class="form-select" id="newEventMonthlyDate">
                                            <option value="1">1日</option>
                                            <option value="2">2日</option>
                                            <option value="3">3日</option>
                                            <option value="4">4日</option>
                                            <option value="5">5日</option>
                                            <option value="6">6日</option>
                                            <option value="7">7日</option>
                                            <option value="8">8日</option>
                                            <option value="9">9日</option>
                                            <option value="10">10日</option>
                                            <option value="11">11日</option>
                                            <option value="12">12日</option>
                                            <option value="13">13日</option>
                                            <option value="14">14日</option>
                                            <option value="15">15日</option>
                                            <option value="16">16日</option>
                                            <option value="17">17日</option>
                                            <option value="18">18日</option>
                                            <option value="19">19日</option>
                                            <option value="20">20日</option>
                                            <option value="21">21日</option>
                                            <option value="22">22日</option>
                                            <option value="23">23日</option>
                                            <option value="24">24日</option>
                                            <option value="25">25日</option>
                                            <option value="26">26日</option>
                                            <option value="27">27日</option>
                                            <option value="28">28日</option>
                                            <option value="29">29日</option>
                                            <option value="30">30日</option>
                                            <option value="31">31日</option>
                                            <option value="-1">月末</option>
                                        </select>
                                    </div>
                                    
                                    <!-- 按星期重复的选择 -->
                                    <div class="col-md-3" id="newEventMonthlyWeekOptions" style="display: none;">
                                        <label for="newEventMonthlyWeek" class="form-label">第几周</label>
                                        <select class="form-select" id="newEventMonthlyWeek">
                                            <option value="1">第一周</option>
                                            <option value="2">第二周</option>
                                            <option value="3">第三周</option>
                                            <option value="4">第四周</option>
                                            <option value="-1">最后一周</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-3" id="newEventMonthlyWeekdayOptions" style="display: none;">
                                        <label for="newEventMonthlyWeekday" class="form-label">星期几</label>
                                        <select class="form-select" id="newEventMonthlyWeekday">
                                            <option value="MO">周一</option>
                                            <option value="TU">周二</option>
                                            <option value="WE">周三</option>
                                            <option value="TH">周四</option>
                                            <option value="FR">周五</option>
                                            <option value="SA">周六</option>
                                            <option value="SU">周日</option>
                                        </select>
                                    </div>
                                    
                                    <!-- RRule预览 -->
                                    <div class="col-12">
                                        <label class="form-label">重复规则预览</label>
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <span id="newEventRulePreview">请选择重复设置</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <label for="newEventDescription" class="form-label">描述</label>
                        <textarea class="form-control" id="newEventDescription" rows="3"></textarea>
                    </div>
                    
                    <!-- 重要性紧急性矩阵 -->
                    <div class="col-12">
                        <label class="form-label">重要性 / 紧急性</label>
                        <div class="importance-urgency-matrix">
                            <div class="matrix-row">
                                <button type="button" class="matrix-button important-urgent" 
                                        data-importance="important" data-urgency="urgent"
                                        onclick="setImportanceUrgency('important', 'urgent', this)">
                                    重要紧急
                                </button>
                                <button type="button" class="matrix-button important-not-urgent" 
                                        data-importance="important" data-urgency="not-urgent"
                                        onclick="setImportanceUrgency('important', 'not-urgent', this)">
                                    重要不紧急
                                </button>
                            </div>
                            <div class="matrix-row">
                                <button type="button" class="matrix-button not-important-urgent" 
                                        data-importance="not-important" data-urgency="urgent"
                                        onclick="setImportanceUrgency('not-important', 'urgent', this)">
                                    不重要紧急
                                </button>
                                <button type="button" class="matrix-button not-important-not-urgent" 
                                        data-importance="not-important" data-urgency="not-urgent"
                                        onclick="setImportanceUrgency('not-important', 'not-urgent', this)">
                                    不重要不紧急
                                </button>
                            </div>
                        </div>
                        <input type="hidden" id="newEventImportance">
                        <input type="hidden" id="newEventUrgency">
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="modalManager.closeAllModals()">取消</button>
                    <button type="submit" class="btn btn-primary">创建事件</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 编辑事件模态框 -->
    <div class="modal" id="editEventModal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-edit me-2"></i>编辑事件
                </h5>
                <span class="close">&times;</span>
            </div>
            
            <form id="editEventForm" class="modal-body">
                <input type="hidden" id="eventId">
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="eventTitle" class="form-label">标题 *</label>
                        <input type="text" class="form-control form-input" id="eventTitle" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="eventGroupId" class="form-label">日程组</label>
                        <select class="form-select" id="eventGroupId">
                            <option value="">无</option>
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="eventStart" class="form-label">开始时间 *</label>
                        <input type="datetime-local" class="form-control form-input" id="eventStart" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="eventEnd" class="form-label">结束时间 *</label>
                        <input type="datetime-local" class="form-control form-input" id="eventEnd" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="eventDdl" class="form-label">截止时间</label>
                        <input type="datetime-local" class="form-control" id="eventDdl">
                    </div>
                    
                    <div class="col-12">
                        <label for="eventDescription" class="form-label">描述</label>
                        <textarea class="form-control" id="eventDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="col-12">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="eventRepeat" onchange="if(!this.disabled) toggleRepeatOptions('editEvent'); else this.checked = false;">
                            <label class="form-check-label" for="eventRepeat">
                                <i class="fas fa-repeat me-2"></i>重复日程
                            </label>
                        </div>
                    </div>
                    
                    <!-- 重复事件信息显示 -->
                    <div class="col-12" id="editEventRecurringInfo" style="display: none;">
                        <div class="alert alert-warning">
                            <i class="fas fa-repeat me-2"></i>
                            <strong>这是一个重复事件</strong>
                            <p class="mb-2">修改范围：</p>
                            <div class="btn-group-vertical w-100" role="group">
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="editEventScope" id="editScopeThis" value="single" checked>
                                    <label class="form-check-label" for="editScopeThis">
                                        <strong>仅此次</strong>
                                        <small class="text-muted d-block">只修改当前选中的事件实例</small>
                                    </label>
                                </div>
                                
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="editEventScope" id="editScopeAll" value="all">
                                    <label class="form-check-label" for="editScopeAll">
                                        <strong>全部</strong>
                                        <small class="text-muted d-block">修改整个重复事件系列</small>
                                    </label>
                                </div>
                                
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="editEventScope" id="editScopeFuture" value="future">
                                    <label class="form-check-label" for="editScopeFuture">
                                        <strong>此及之后</strong>
                                        <small class="text-muted d-block">修改当前及之后的所有事件实例</small>
                                    </label>
                                </div>
                                
                                <div class="form-check">
                                    <input type="radio" class="form-check-input" name="editEventScope" id="editScopeFromTime" value="from_time">
                                    <label class="form-check-label" for="editScopeFromTime">
                                        <strong>从指定时间开始</strong>
                                        <small class="text-muted d-block">从选择的时间点开始修改</small>
                                    </label>
                                    <select class="form-select form-select-sm mt-2" id="editEventTimeSelect" style="display: none;">
                                        <!-- 动态填充时间选项 -->
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- RRule编辑设置 -->
                    <div class="col-12" id="editEventRecurringOptions" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-cog me-2"></i>重复设置修改</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <!-- 重复频率 -->
                                    <div class="col-md-4">
                                        <label for="editEventFreq" class="form-label">重复频率</label>
                                        <select class="form-select" id="editEventFreq" onchange="if(window.rruleManager) window.rruleManager.updateFrequencyOptions('edit');">
                                            <option value="DAILY">每日</option>
                                            <option value="WEEKLY">每周</option>
                                            <option value="MONTHLY">每月</option>
                                            <option value="YEARLY">每年</option>
                                        </select>
                                    </div>
                                    
                                    <!-- 重复间隔 -->
                                    <div class="col-md-4">
                                        <label for="editEventInterval" class="form-label">间隔</label>
                                        <input type="number" class="form-control" id="editEventInterval" value="1" min="1" max="365">
                                    </div>
                                    
                                    <!-- 结束条件 -->
                                    <div class="col-md-4">
                                        <label for="editEventEndType" class="form-label">结束条件</label>
                                        <select class="form-select" id="editEventEndType">
                                            <option value="never">永不结束</option>
                                            <option value="count">重复次数</option>
                                            <option value="until">结束日期</option>
                                        </select>
                                    </div>
                                    
                                    <!-- 重复次数 -->
                                    <div class="col-md-6" id="editEventCountContainer" style="display: none;">
                                        <label for="editEventCount" class="form-label">重复次数</label>
                                        <input type="number" class="form-control" id="editEventCount" value="10" min="1" max="999">
                                    </div>
                                    
                                    <!-- 结束日期 -->
                                    <div class="col-md-6" id="editEventUntilContainer" style="display: none;">
                                        <label for="editEventUntil" class="form-label">结束日期</label>
                                        <input type="date" class="form-control" id="editEventUntil">
                                    </div>
                                    
                                    <!-- 每周重复的星期选择 -->
                                    <div class="col-12" id="editEventWeekdaysContainer" style="display: none;">
                                        <label class="form-label">重复星期</label>
                                        <div class="weekday-buttons">
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="MO">周一</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="TU">周二</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="WE">周三</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="TH">周四</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="FR">周五</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="SA">周六</button>
                                            <button type="button" class="btn btn-outline-primary btn-sm weekday-btn" data-day="SU">周日</button>
                                        </div>
                                    </div>
                                    
                                    <!-- 每月重复设置 -->
                                    <div class="col-md-6" id="editEventMonthlyOptions" style="display: none;">
                                        <label for="editEventMonthlyType" class="form-label">月重复方式</label>
                                        <select class="form-select" id="editEventMonthlyType" onchange="if(window.rruleManager) window.rruleManager.updateEventMonthlyOptions('edit');">
                                            <option value="simple">每隔指定月数</option>
                                            <option value="bymonthday">按日期（例如：每月15日）</option>
                                            <option value="byweekday">按星期（例如：每月第二个周一）</option>
                                        </select>
                                    </div>
                                    
                                    <!-- 按日期重复的选择 -->
                                    <div class="col-md-6" id="editEventMonthlyDateOptions" style="display: none;">
                                        <label for="editEventMonthlyDate" class="form-label">选择日期</label>
                                        <select class="form-select" id="editEventMonthlyDate">
                                            <option value="1">1日</option>
                                            <option value="2">2日</option>
                                            <option value="3">3日</option>
                                            <option value="4">4日</option>
                                            <option value="5">5日</option>
                                            <option value="6">6日</option>
                                            <option value="7">7日</option>
                                            <option value="8">8日</option>
                                            <option value="9">9日</option>
                                            <option value="10">10日</option>
                                            <option value="11">11日</option>
                                            <option value="12">12日</option>
                                            <option value="13">13日</option>
                                            <option value="14">14日</option>
                                            <option value="15">15日</option>
                                            <option value="16">16日</option>
                                            <option value="17">17日</option>
                                            <option value="18">18日</option>
                                            <option value="19">19日</option>
                                            <option value="20">20日</option>
                                            <option value="21">21日</option>
                                            <option value="22">22日</option>
                                            <option value="23">23日</option>
                                            <option value="24">24日</option>
                                            <option value="25">25日</option>
                                            <option value="26">26日</option>
                                            <option value="27">27日</option>
                                            <option value="28">28日</option>
                                            <option value="29">29日</option>
                                            <option value="30">30日</option>
                                            <option value="31">31日</option>
                                            <option value="-1">月末</option>
                                        </select>
                                    </div>
                                    
                                    <!-- 按星期重复的选择 -->
                                    <div class="col-md-3" id="editEventMonthlyWeekOptions" style="display: none;">
                                        <label for="editEventMonthlyWeek" class="form-label">第几周</label>
                                        <select class="form-select" id="editEventMonthlyWeek">
                                            <option value="1">第一周</option>
                                            <option value="2">第二周</option>
                                            <option value="3">第三周</option>
                                            <option value="4">第四周</option>
                                            <option value="-1">最后一周</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-3" id="editEventMonthlyWeekdayOptions" style="display: none;">
                                        <label for="editEventMonthlyWeekday" class="form-label">星期几</label>
                                        <select class="form-select" id="editEventMonthlyWeekday">
                                            <option value="MO">周一</option>
                                            <option value="TU">周二</option>
                                            <option value="WE">周三</option>
                                            <option value="TH">周四</option>
                                            <option value="FR">周五</option>
                                            <option value="SA">周六</option>
                                            <option value="SU">周日</option>
                                        </select>
                                    </div>
                                    
                                    <!-- RRule预览 -->
                                    <div class="col-12">
                                        <label class="form-label">重复规则预览</label>
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <span id="editEventRulePreview">当前重复规则</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 重要性紧急性矩阵 -->
                    <div class="col-12">
                        <label class="form-label">重要性 / 紧急性</label>
                        <div class="importance-urgency-matrix">
                            <div class="matrix-row">
                                <button type="button" class="matrix-button important-urgent" 
                                        data-importance="important" data-urgency="urgent"
                                        onclick="setImportanceUrgency('important', 'urgent', this)">
                                    重要紧急
                                </button>
                                <button type="button" class="matrix-button important-not-urgent" 
                                        data-importance="important" data-urgency="not-urgent"
                                        onclick="setImportanceUrgency('important', 'not-urgent', this)">
                                    重要不紧急
                                </button>
                            </div>
                            <div class="matrix-row">
                                <button type="button" class="matrix-button not-important-urgent" 
                                        data-importance="not-important" data-urgency="urgent"
                                        onclick="setImportanceUrgency('not-important', 'urgent', this)">
                                    不重要紧急
                                </button>
                                <button type="button" class="matrix-button not-important-not-urgent" 
                                        data-importance="not-important" data-urgency="not-urgent"
                                        onclick="setImportanceUrgency('not-important', 'not-urgent', this)">
                                    不重要不紧急
                                </button>
                            </div>
                        </div>
                        <input type="hidden" id="eventImportance">
                        <input type="hidden" id="eventUrgency">
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="modalManager.handleDeleteEvent()">删除</button>
                    <button type="button" class="btn btn-secondary" onclick="modalManager.closeAllModals()">取消</button>
                    <button type="submit" class="btn btn-primary" onclick="modalManager.handleUpdateEvent()">更新事件</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 重复事件删除确认模态框 -->
    <div class="modal" id="deleteRecurringEventModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i>删除重复事件
                </h5>
                <span class="close">&times;</span>
            </div>
            
            <div class="modal-body">
                <p>这是一个重复事件，请选择删除范围：</p>
                
                <div class="delete-scope-options">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deleteEventScope" id="deleteScopeThis" value="single" checked>
                        <label class="form-check-label" for="deleteScopeThis">
                            <strong>仅此次</strong>
                            <small class="text-muted d-block">只删除当前选中的事件实例</small>
                        </label>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deleteEventScope" id="deleteScopeAll" value="all">
                        <label class="form-check-label" for="deleteScopeAll">
                            <strong>全部</strong>
                            <small class="text-muted d-block">删除整个重复事件系列</small>
                        </label>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deleteEventScope" id="deleteScopeFuture" value="future">
                        <label class="form-check-label" for="deleteScopeFuture">
                            <strong>此及之后</strong>
                            <small class="text-muted d-block">删除当前及之后的所有事件实例</small>
                        </label>
                    </div>
                </div>
                
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>注意：</strong>删除操作无法撤销！
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="modalManager.closeAllModals()">取消</button>
                <button type="button" class="btn btn-danger" onclick="modalManager.confirmDeleteRecurringEvent()">确认删除</button>
            </div>
        </div>
    </div>

    <!-- 创建待办事项模态框 -->
    <div class="modal" id="createTodoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle me-2"></i>创建待办事项
                </h5>
                <span class="close">&times;</span>
            </div>
            
            <form id="createTodoForm" class="modal-body">
                <div class="row g-3">
                    <div class="col-12">
                        <label for="newTodoTitle" class="form-label">标题 *</label>
                        <input type="text" class="form-control form-input" id="newTodoTitle" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="newTodoDueDate" class="form-label">到期时间</label>
                        <input type="datetime-local" class="form-control" id="newTodoDueDate">
                    </div>
                    
                    <div class="col-md-6">
                        <label for="newTodoEstimatedDuration" class="form-label">预计耗时（分钟）</label>
                        <input type="number" class="form-control" id="newTodoEstimatedDuration" min="1">
                    </div>
                    
                    <div class="col-md-6">
                        <label for="newTodoImportance" class="form-label">重要性</label>
                        <select class="form-select" id="newTodoImportance">
                            <option value="low">低</option>
                            <option value="medium" selected>中</option>
                            <option value="high">高</option>
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="newTodoUrgency" class="form-label">紧急性</label>
                        <select class="form-select" id="newTodoUrgency">
                            <option value="low">低</option>
                            <option value="normal" selected>普通</option>
                            <option value="high">高</option>
                        </select>
                    </div>
                    
                    <div class="col-12">
                        <label for="newTodoGroupId" class="form-label">日程组</label>
                        <select class="form-select" id="newTodoGroupId">
                            <option value="">无</option>
                        </select>
                    </div>
                    
                    <div class="col-12">
                        <label for="newTodoDescription" class="form-label">描述</label>
                        <textarea class="form-control" id="newTodoDescription" rows="3"></textarea>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="modalManager.closeAllModals()">取消</button>
                    <button type="submit" class="btn btn-primary">创建待办</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 编辑待办事项模态框 -->
    <div class="modal" id="editTodoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>编辑待办事项
                </h5>
                <span class="close">&times;</span>
            </div>
            
            <form id="editTodoForm" class="modal-body">
                <input type="hidden" id="todoId">
                
                <div class="row g-3">
                    <div class="col-12">
                        <label for="todoTitle" class="form-label">标题 *</label>
                        <input type="text" class="form-control form-input" id="todoTitle" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="todoDueDate" class="form-label">到期时间</label>
                        <input type="datetime-local" class="form-control" id="todoDueDate">
                    </div>
                    
                    <div class="col-md-6">
                        <label for="todoEstimatedDuration" class="form-label">预计耗时（分钟）</label>
                        <input type="number" class="form-control" id="todoEstimatedDuration" min="1">
                    </div>
                    
                    <div class="col-md-6">
                        <label for="todoImportance" class="form-label">重要性</label>
                        <select class="form-select" id="todoImportance">
                            <option value="low">低</option>
                            <option value="medium">中</option>
                            <option value="high">高</option>
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="todoUrgency" class="form-label">紧急性</label>
                        <select class="form-select" id="todoUrgency">
                            <option value="low">低</option>
                            <option value="normal">普通</option>
                            <option value="high">高</option>
                        </select>
                    </div>
                    
                    <div class="col-12">
                        <label for="todoGroupId" class="form-label">日程组</label>
                        <select class="form-select" id="todoGroupId">
                            <option value="">无</option>
                        </select>
                    </div>
                    
                    <div class="col-12">
                        <label for="todoDescription" class="form-label">描述</label>
                        <textarea class="form-control" id="todoDescription" rows="3"></textarea>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="todoManager.deleteTodo(modalManager.currentTodoId)">删除</button>
                    <button type="button" class="btn btn-secondary" onclick="modalManager.closeAllModals()">取消</button>
                    <button type="submit" class="btn btn-primary" onclick="modalManager.handleUpdateTodo()">更新待办</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 创建提醒模态框 -->
    <div class="modal" id="createReminderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-bell-plus me-2"></i>创建提醒
                </h5>
                <span class="close">&times;</span>
            </div>
            
            <form id="createReminderForm" class="modal-body">
                <div class="row g-3">
                    <div class="col-12">
                        <label for="newReminderTitle" class="form-label">标题 *</label>
                        <input type="text" class="form-control form-input" id="newReminderTitle" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="newReminderTriggerTime" class="form-label">提醒时间 *</label>
                        <input type="datetime-local" class="form-control form-input" id="newReminderTriggerTime" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="newReminderPriority" class="form-label">优先级</label>
                        <select class="form-select" id="newReminderPriority">
                            <option value="low">低</option>
                            <option value="normal" selected>普通</option>
                            <option value="high">高</option>
                            <option value="urgent">紧急</option>
                        </select>
                    </div>
                    
                    <div class="col-12">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="newReminderRepeat" onchange="toggleRepeatOptions('new')">
                            <label class="form-check-label" for="newReminderRepeat">
                                <i class="fas fa-repeat me-2"></i>重复提醒
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-12" id="newRepeatOptions" style="display: none;">
                        <div class="card bg-light">
                            <div class="card-body p-3">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="newRepeatFreq" class="form-label">重复频率</label>
                                        <select class="form-select" id="newRepeatFreq" onchange="updateRepeatOptions('new')">
                                            <option value="DAILY">每天</option>
                                            <option value="WEEKLY">每周</option>
                                            <option value="MONTHLY">每月</option>
                                            <option value="YEARLY">每年</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="newRepeatInterval" class="form-label">间隔</label>
                                        <div class="input-group">
                                            <span class="input-group-text">每</span>
                                            <input type="number" class="form-control" id="newRepeatInterval" value="1" min="1" max="365">
                                            <span class="input-group-text" id="newIntervalUnit">天</span>
                                        </div>
                                    </div>
                                    
                                    <div class="col-12" id="newWeekdaysOptions" style="display: none;">
                                        <label class="form-label">重复日期</label>
                                        <div class="btn-group weekdays-toggle" role="group">
                                            <input type="checkbox" class="btn-check" id="newMO" value="MO">
                                            <label class="btn btn-outline-primary btn-sm" for="newMO">一</label>
                                            
                                            <input type="checkbox" class="btn-check" id="newTU" value="TU">
                                            <label class="btn btn-outline-primary btn-sm" for="newTU">二</label>
                                            
                                            <input type="checkbox" class="btn-check" id="newWE" value="WE">
                                            <label class="btn btn-outline-primary btn-sm" for="newWE">三</label>
                                            
                                            <input type="checkbox" class="btn-check" id="newTH" value="TH">
                                            <label class="btn btn-outline-primary btn-sm" for="newTH">四</label>
                                            
                                            <input type="checkbox" class="btn-check" id="newFR" value="FR">
                                            <label class="btn btn-outline-primary btn-sm" for="newFR">五</label>
                                            
                                            <input type="checkbox" class="btn-check" id="newSA" value="SA">
                                            <label class="btn btn-outline-primary btn-sm" for="newSA">六</label>
                                            
                                            <input type="checkbox" class="btn-check" id="newSU" value="SU">
                                            <label class="btn btn-outline-primary btn-sm" for="newSU">日</label>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6" id="newMonthlyOptions" style="display: none;">
                                        <label for="newMonthlyType" class="form-label">月重复方式</label>
                                        <select class="form-select" id="newMonthlyType" onchange="updateMonthlyOptions('new')">
                                            <option value="simple">每隔指定月数</option>
                                            <option value="bymonthday">按日期（例如：每月15日）</option>
                                            <option value="byweekday">按星期（例如：每月第二个周一）</option>
                                        </select>
                                    </div>                    <!-- 按日期重复的选择 -->
                    <div class="col-md-6" id="newMonthlyDateOptions" style="display: none;">
                        <label for="newMonthlyDate" class="form-label">选择日期</label>
                        <select class="form-select" id="newMonthlyDate">
                            <option value="1">1日</option>
                            <option value="2">2日</option>
                            <option value="3">3日</option>
                            <option value="4">4日</option>
                            <option value="5">5日</option>
                            <option value="6">6日</option>
                            <option value="7">7日</option>
                            <option value="8">8日</option>
                            <option value="9">9日</option>
                            <option value="10">10日</option>
                            <option value="11">11日</option>
                            <option value="12">12日</option>
                            <option value="13">13日</option>
                            <option value="14">14日</option>
                            <option value="15">15日</option>
                            <option value="16">16日</option>
                            <option value="17">17日</option>
                            <option value="18">18日</option>
                            <option value="19">19日</option>
                            <option value="20">20日</option>
                            <option value="21">21日</option>
                            <option value="22">22日</option>
                            <option value="23">23日</option>
                            <option value="24">24日</option>
                            <option value="25">25日</option>
                            <option value="26">26日</option>
                            <option value="27">27日</option>
                            <option value="28">28日</option>
                            <option value="29">29日</option>
                            <option value="30">30日</option>
                            <option value="31">31日</option>
                            <option value="-1">月末</option>
                        </select>
                    </div>
                    
                    <!-- 按星期重复的选择 -->
                    <div class="col-md-3" id="newMonthlyWeekOptions" style="display: none;">
                        <label for="newMonthlyWeek" class="form-label">第几周</label>
                        <select class="form-select" id="newMonthlyWeek">
                            <option value="1">第一周</option>
                            <option value="2">第二周</option>
                            <option value="3">第三周</option>
                            <option value="4">第四周</option>
                            <option value="-1">最后一周</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3" id="newMonthlyWeekdayOptions" style="display: none;">
                        <label for="newMonthlyWeekday" class="form-label">星期几</label>
                        <select class="form-select" id="newMonthlyWeekday">
                            <option value="MO">周一</option>
                            <option value="TU">周二</option>
                            <option value="WE">周三</option>
                            <option value="TH">周四</option>
                            <option value="FR">周五</option>
                            <option value="SA">周六</option>
                            <option value="SU">周日</option>
                        </select>
                    </div>                                    <div class="col-md-6">
                                        <label for="newRepeatUntil" class="form-label">结束时间（可选）</label>
                                        <input type="date" class="form-control" id="newRepeatUntil">
                                    </div>
                                </div>
                                
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <span id="newRepeatPreview">预览：不重复</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <label for="newReminderContent" class="form-label">提醒内容</label>
                        <textarea class="form-control" id="newReminderContent" rows="3"></textarea>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="modalManager.closeAllModals()">取消</button>
                    <button type="submit" class="btn btn-primary">创建提醒</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 编辑提醒模态框 -->
    <div class="modal" id="editReminderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-bell-edit me-2"></i>编辑提醒
                </h5>
                <span class="close">&times;</span>
            </div>
            
            <form id="editReminderForm" class="modal-body">
                <input type="hidden" id="reminderId">
                
                <div class="row g-3">
                    <div class="col-12">
                        <label for="reminderTitle" class="form-label">标题 *</label>
                        <input type="text" class="form-control form-input" id="reminderTitle" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="reminderTriggerTime" class="form-label">提醒时间 *</label>
                        <input type="datetime-local" class="form-control form-input" id="reminderTriggerTime" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="reminderPriority" class="form-label">优先级</label>
                        <select class="form-select" id="reminderPriority">
                            <option value="low">低</option>
                            <option value="normal">普通</option>
                            <option value="high">高</option>
                            <option value="urgent">紧急</option>
                        </select>
                    </div>
                    
                    <div class="col-12">
                        <label for="reminderContent" class="form-label">提醒内容</label>
                        <textarea class="form-control" id="reminderContent" rows="3"></textarea>
                    </div>
                    
                    <div class="col-12">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="reminderRepeat" onchange="if(!this.disabled) toggleRepeatOptions('edit'); else this.checked = false;">
                            <label class="form-check-label" for="reminderRepeat">
                                <i class="fas fa-repeat me-2"></i>重复提醒
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-12" id="editRepeatOptions" style="display: none;">
                        <div class="card bg-light">
                            <div class="card-body p-3">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="reminderRepeatFreq" class="form-label">重复频率</label>
                                        <select class="form-select" id="reminderRepeatFreq" onchange="updateRepeatOptions('edit')">
                                            <option value="DAILY">每天</option>
                                            <option value="WEEKLY">每周</option>
                                            <option value="MONTHLY">每月</option>
                                            <option value="YEARLY">每年</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="reminderRepeatInterval" class="form-label">间隔</label>
                                        <div class="input-group">
                                            <span class="input-group-text">每</span>
                                            <input type="number" class="form-control" id="reminderRepeatInterval" value="1" min="1" max="365">
                                            <span class="input-group-text" id="reminderIntervalUnit">天</span>
                                        </div>
                                    </div>
                                    
                                    <div class="col-12" id="reminderWeekdaysOptions" style="display: none;">
                                        <label class="form-label">重复日期</label>
                                        <div class="btn-group weekdays-toggle" role="group">
                                            <input type="checkbox" class="btn-check" id="reminderMO" value="MO">
                                            <label class="btn btn-outline-primary btn-sm" for="reminderMO">一</label>
                                            
                                            <input type="checkbox" class="btn-check" id="reminderTU" value="TU">
                                            <label class="btn btn-outline-primary btn-sm" for="reminderTU">二</label>
                                            
                                            <input type="checkbox" class="btn-check" id="reminderWE" value="WE">
                                            <label class="btn btn-outline-primary btn-sm" for="reminderWE">三</label>
                                            
                                            <input type="checkbox" class="btn-check" id="reminderTH" value="TH">
                                            <label class="btn btn-outline-primary btn-sm" for="reminderTH">四</label>
                                            
                                            <input type="checkbox" class="btn-check" id="reminderFR" value="FR">
                                            <label class="btn btn-outline-primary btn-sm" for="reminderFR">五</label>
                                            
                                            <input type="checkbox" class="btn-check" id="reminderSA" value="SA">
                                            <label class="btn btn-outline-primary btn-sm" for="reminderSA">六</label>
                                            
                                            <input type="checkbox" class="btn-check" id="reminderSU" value="SU">
                                            <label class="btn btn-outline-primary btn-sm" for="reminderSU">日</label>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6" id="reminderMonthlyOptions" style="display: none;">
                                        <label for="reminderRepeatBy" class="form-label">月重复方式</label>
                                        <select class="form-select" id="reminderRepeatBy" onchange="updateMonthlyOptions('edit')">
                                            <option value="simple">每隔X个月</option>
                                            <option value="bymonthday">按日期（例如：每月15日）</option>
                                            <option value="byweekday">按星期（例如：每月第二个周一）</option>
                                        </select>
                                    </div>
                                    
                                    <!-- 按日期重复的选择 -->
                                    <div class="col-md-6" id="editMonthlyDateOptions" style="display: none;">
                                        <label for="editMonthlyDate" class="form-label">选择日期</label>
                                        <select class="form-select" id="editMonthlyDate">
                                            <option value="1">1日</option>
                                            <option value="2">2日</option>
                                            <option value="3">3日</option>
                                            <option value="4">4日</option>
                                            <option value="5">5日</option>
                                            <option value="6">6日</option>
                                            <option value="7">7日</option>
                                            <option value="8">8日</option>
                                            <option value="9">9日</option>
                                            <option value="10">10日</option>
                                            <option value="11">11日</option>
                                            <option value="12">12日</option>
                                            <option value="13">13日</option>
                                            <option value="14">14日</option>
                                            <option value="15">15日</option>
                                            <option value="16">16日</option>
                                            <option value="17">17日</option>
                                            <option value="18">18日</option>
                                            <option value="19">19日</option>
                                            <option value="20">20日</option>
                                            <option value="21">21日</option>
                                            <option value="22">22日</option>
                                            <option value="23">23日</option>
                                            <option value="24">24日</option>
                                            <option value="25">25日</option>
                                            <option value="26">26日</option>
                                            <option value="27">27日</option>
                                            <option value="28">28日</option>
                                            <option value="29">29日</option>
                                            <option value="30">30日</option>
                                            <option value="31">31日</option>
                                            <option value="-1">月末</option>
                                        </select>
                                    </div>
                                    
                                    <!-- 按星期重复的选择 -->
                                    <div class="col-md-3" id="editMonthlyWeekOptions" style="display: none;">
                                        <label for="editMonthlyWeek" class="form-label">第几周</label>
                                        <select class="form-select" id="editMonthlyWeek">
                                            <option value="1">第一周</option>
                                            <option value="2">第二周</option>
                                            <option value="3">第三周</option>
                                            <option value="4">第四周</option>
                                            <option value="-1">最后一周</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-3" id="editMonthlyWeekdayOptions" style="display: none;">
                                        <label for="editMonthlyWeekday" class="form-label">星期几</label>
                                        <select class="form-select" id="editMonthlyWeekday">
                                            <option value="MO">周一</option>
                                            <option value="TU">周二</option>
                                            <option value="WE">周三</option>
                                            <option value="TH">周四</option>
                                            <option value="FR">周五</option>
                                            <option value="SA">周六</option>
                                            <option value="SU">周日</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="reminderRepeatUntil" class="form-label">结束时间（可选）</label>
                                        <input type="date" class="form-control" id="reminderRepeatUntil">
                                    </div>
                                </div>
                                
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <span id="reminderRepeatPreview">预览：不重复</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            
            <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="modalManager.closeAllModals()">取消</button>
                    <button type="submit" class="btn btn-primary" onclick="modalManager.handleUpdateReminder()">更新提醒</button>
                </div>
        </div>
    </div>

    <!-- 提醒详情模态框（从日历点击时打开）-->
    <div class="modal" id="reminderDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-bell me-2"></i>提醒详情
                </h5>
                <span class="close">&times;</span>
            </div>
            
            <div class="modal-body" id="reminderDetailContent">
                <!-- 动态内容将由JavaScript填充 -->
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="modalManager.closeAllModals()">关闭</button>
            </div>
        </div>
    </div>

    <!-- AI聊天模态框 -->
    <div class="modal" id="aiChatModal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-robot me-2"></i>AI智能助手
                </h5>
                <span class="close">&times;</span>
            </div>
            
            <div class="modal-body">
                <div class="chat-container">
                    <div id="chatMessages" class="chat-messages">
                        <div class="ai-message">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content">
                                您好！我是您的AI助手，可以帮助您：
                                <ul>
                                    <li>智能安排日程</li>
                                    <li>分析任务优先级</li>
                                    <li>优化时间分配</li>
                                    <li>提供日程建议</li>
                                </ul>
                                有什么可以帮助您的吗？
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-input">
                        <div class="input-group">
                            <input type="text" class="form-control" id="chatInput" placeholder="输入您的问题...">
                            <button class="btn btn-primary" type="button" onclick="aiAssistant.sendMessage()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 日程组管理模态框 -->
    <!-- 日程组管理模态框（单模态框，多面板设计） -->
    <div class="modal fade" id="manageGroupsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="groupModalTitle">
                        <i class="fas fa-layer-group me-2"></i>管理日程组
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- 日程组列表面板 -->
                    <div id="groupListPanel">
                        <div class="mb-3">
                            <button class="btn btn-success btn-sm" onclick="groupManager.showCreatePanel()">
                                <i class="fas fa-plus me-1"></i>创建新日程组
                            </button>
                        </div>
                        <div id="groupsList" class="list-group">
                            <!-- 动态生成的日程组列表 -->
                        </div>
                    </div>

                    <!-- 创建日程组面板 -->
                    <div id="groupCreatePanel" style="display: none;">
                        <div class="mb-3">
                            <button class="btn btn-outline-secondary btn-sm" onclick="groupManager.showListPanel()">
                                <i class="fas fa-arrow-left me-1"></i>返回列表
                            </button>
                        </div>
                        <div class="mb-3">
                            <label for="newGroupName" class="form-label">组名 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="newGroupName" placeholder="输入日程组名称">
                        </div>
                        <div class="mb-3">
                            <label for="newGroupDescription" class="form-label">描述</label>
                            <textarea class="form-control" id="newGroupDescription" rows="3" placeholder="输入日程组描述（可选）"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="newGroupColor" class="form-label">颜色</label>
                            <input type="color" class="form-control form-control-color" id="newGroupColor" value="#3788d8">
                        </div>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-success" onclick="groupManager.createGroup()">
                                <i class="fas fa-save me-1"></i>创建日程组
                            </button>
                        </div>
                    </div>

                    <!-- 编辑日程组面板 -->
                    <div id="groupEditPanel" style="display: none;">
                        <div class="mb-3">
                            <button class="btn btn-outline-secondary btn-sm" onclick="groupManager.showListPanel()">
                                <i class="fas fa-arrow-left me-1"></i>返回列表
                            </button>
                        </div>
                        <input type="hidden" id="editGroupId">
                        <div class="mb-3">
                            <label for="editGroupName" class="form-label">组名 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editGroupName" placeholder="输入日程组名称">
                        </div>
                        <div class="mb-3">
                            <label for="editGroupDescription" class="form-label">描述</label>
                            <textarea class="form-control" id="editGroupDescription" rows="3" placeholder="输入日程组描述（可选）"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editGroupColor" class="form-label">颜色</label>
                            <input type="color" class="form-control form-control-color" id="editGroupColor">
                        </div>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary" onclick="groupManager.updateGroup()">
                                <i class="fas fa-save me-1"></i>保存修改
                            </button>
                        </div>
                    </div>

                    <!-- 删除日程组面板 -->
                    <div id="groupDeletePanel" style="display: none;">
                        <div class="mb-3">
                            <button class="btn btn-outline-secondary btn-sm" onclick="groupManager.showListPanel()">
                                <i class="fas fa-arrow-left me-1"></i>返回列表
                            </button>
                        </div>
                        <input type="hidden" id="deleteGroupId">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>警告：</strong>此操作不可撤销！
                        </div>
                        <p class="mb-3">请选择删除方式：</p>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="deleteOption" id="deleteGroupOnly" value="group" checked>
                            <label class="form-check-label" for="deleteGroupOnly">
                                <i class="fas fa-folder-minus me-1"></i>只删除日程组（保留日程）
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="deleteOption" id="deleteGroupAndEvents" value="all">
                            <label class="form-check-label" for="deleteGroupAndEvents">
                                <i class="fas fa-trash-alt me-1"></i>删除日程组及其所有日程
                            </label>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-danger" onclick="groupManager.confirmDeleteGroup()">
                                <i class="fas fa-trash me-1"></i>确认删除
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 用户设置模态框 -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-cog me-2"></i>用户设置
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Tabs 导航 -->
                    <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" 
                                    data-bs-target="#basic-settings" type="button" role="tab">
                                <i class="fas fa-user-cog me-2"></i>基本设置
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="schedule-tab" data-bs-toggle="tab" 
                                    data-bs-target="#schedule-settings" type="button" role="tab">
                                <i class="fas fa-calendar-alt me-2"></i>日程偏好
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="display-tab" data-bs-toggle="tab" 
                                    data-bs-target="#display-settings" type="button" role="tab">
                                <i class="fas fa-palette me-2"></i>显示偏好
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="reminder-tab" data-bs-toggle="tab" 
                                    data-bs-target="#reminder-settings" type="button" role="tab">
                                <i class="fas fa-bell me-2"></i>提醒设置
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="ai-tab" data-bs-toggle="tab" 
                                    data-bs-target="#ai-settings" type="button" role="tab">
                                <i class="fas fa-robot me-2"></i>AI 设置
                            </button>
                        </li>
                    </ul>

                    <!-- Tabs 内容 -->
                    <div class="tab-content" id="settingsTabContent">
                        <!-- 基本设置 -->
                        <div class="tab-pane fade show active" id="basic-settings" role="tabpanel">
                            <h6 class="mb-3 text-primary"><i class="fas fa-cog me-2"></i>周数显示设置</h6>
                            
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showWeekNumber" checked>
                                        <label class="form-check-label" for="showWeekNumber">
                                            <strong>显示周数</strong>
                                        </label>
                                    </div>
                                    <small class="text-muted">在日历标题旁显示"第N周"徽章</small>
                                </div>
                                
                                <div class="col-12">
                                    <hr>
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <label class="form-label mb-0">
                                            <strong>学期/周期设置</strong>
                                        </label>
                                        <button type="button" class="btn btn-sm btn-primary" onclick="addWeekPeriod()">
                                            <i class="fas fa-plus me-1"></i>添加学期
                                        </button>
                                    </div>
                                    <small class="text-muted d-block mb-3">
                                        设置多个学期的起始日期,系统会自动选择最近的学期计算周数。
                                        例如: 春季学期(2月24日)、秋季学期(9月1日)
                                    </small>
                                    
                                    <!-- 周期列表容器 -->
                                    <div id="weekPeriodsList" class="mb-3">
                                        <!-- 周期项会动态添加到这里 -->
                                    </div>
                                    
                                    <div class="alert alert-warning mb-0">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>注意：</strong>
                                        <ul class="mb-0 mt-2">
                                            <li>如果当前日期找不到任何学期起始日期,将不显示周数</li>
                                            <li>系统会向前查找距离最近的起始日期</li>
                                            <li>至少需要添加一个学期才能显示周数</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 日程偏好 -->
                        <div class="tab-pane fade" id="schedule-settings" role="tabpanel">
                            <h6 class="mb-3 text-primary"><i class="fas fa-sliders-h me-2"></i>日程默认设置</h6>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="defaultEventDuration" class="form-label">
                                        默认日程时长（分钟）
                                        <span class="badge bg-secondary">即将推出</span>
                                    </label>
                                    <input type="number" class="form-control" id="defaultEventDuration" 
                                           min="5" max="480" step="5" value="60" disabled>
                                    <small class="text-muted">新建日程的默认持续时间</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="weekStartsOn" class="form-label">
                                        每周起始日
                                    </label>
                                    <select class="form-select" id="weekStartsOn">
                                        <option value="0">周日</option>
                                        <option value="1" selected>周一</option>
                                        <option value="2">周二</option>
                                        <option value="3">周三</option>
                                        <option value="4">周四</option>
                                        <option value="5">周五</option>
                                        <option value="6">周六</option>
                                    </select>
                                    <small class="text-muted">日历和周数计算的起始日</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="workHoursStart" class="form-label">
                                        工作时间 - 开始
                                        <span class="badge bg-secondary">即将推出</span>
                                    </label>
                                    <input type="time" class="form-control" id="workHoursStart" value="09:00" disabled>
                                </div>
                                <div class="col-md-6">
                                    <label for="workHoursEnd" class="form-label">
                                        工作时间 - 结束
                                        <span class="badge bg-secondary">即将推出</span>
                                    </label>
                                    <input type="time" class="form-control" id="workHoursEnd" value="18:00" disabled>
                                </div>
                                <div class="col-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="autoDdl" checked>
                                        <label class="form-check-label" for="autoDdl">
                                            自动将日程结束时间设置为截止时间
                                        </label>
                                    </div>
                                    <small class="text-muted">新建日程时，自动将结束时间填入DDL字段</small>
                                </div>
                                <div class="col-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showWeekends" checked>
                                        <label class="form-check-label" for="showWeekends">
                                            日历显示周末
                                        </label>
                                    </div>
                                    <small class="text-muted">在日历视图中显示或隐藏周六和周日</small>
                                </div>
                            </div>
                        </div>

                        <!-- 显示偏好 -->
                        <div class="tab-pane fade" id="display-settings" role="tabpanel">
                            <h6 class="mb-3 text-primary"><i class="fas fa-eye me-2"></i>界面显示</h6>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="calendarViewDefault" class="form-label">
                                        默认日历视图
                                    </label>
                                    <select class="form-select" id="calendarViewDefault">
                                        <option value="dayGridMonth" selected>月视图</option>
                                        <option value="timeGridWeek">周视图</option>
                                        <option value="timeGridDay">日视图</option>
                                        <option value="listWeek">列表视图</option>
                                    </select>
                                    <small class="text-muted">重新登录时使用的视图,刷新页面会保留当前视图</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="theme" class="form-label">
                                        主题模式
                                        <span class="badge bg-secondary">即将推出</span>
                                    </label>
                                    <select class="form-select" id="theme" disabled>
                                        <option value="light" selected>浅色模式</option>
                                        <option value="dark">深色模式</option>
                                        <option value="auto">跟随系统</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="eventColorBy" class="form-label">
                                        日程颜色方案
                                        <span class="badge bg-secondary">即将推出</span>
                                    </label>
                                    <select class="form-select" id="eventColorBy" disabled>
                                        <option value="default" selected>默认</option>
                                        <option value="priority">按优先级</option>
                                        <option value="type">按类型</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showCompletedEvents" checked disabled>
                                        <label class="form-check-label" for="showCompletedEvents">
                                            显示已完成的日程
                                            <span class="badge bg-secondary">即将推出</span>
                                        </label>
                                    </div>
                                    <small class="text-muted">在日历中显示或隐藏已标记为完成的日程</small>
                                </div>
                            </div>
                        </div>

                        <!-- 提醒设置 -->
                        <div class="tab-pane fade" id="reminder-settings" role="tabpanel">
                            <h6 class="mb-3 text-primary"><i class="fas fa-clock me-2"></i>提醒选项</h6>
                            
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="reminderEnabled" checked disabled>
                                        <label class="form-check-label" for="reminderEnabled">
                                            启用提醒弹窗通知
                                            <span class="badge bg-secondary">即将推出</span>
                                        </label>
                                    </div>
                                    <small class="text-muted">提醒到期时是否弹出浏览器通知</small>
                                </div>
                                <div class="col-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="reminderSound" checked disabled>
                                        <label class="form-check-label" for="reminderSound">
                                            提醒声音
                                            <span class="badge bg-secondary">即将推出</span>
                                        </label>
                                    </div>
                                    <small class="text-muted">提醒时播放提示音</small>
                                </div>
                            </div>
                        </div>

                        <!-- AI 设置 -->
                        <div class="tab-pane fade" id="ai-settings" role="tabpanel">
                            <h6 class="mb-3 text-primary"><i class="fas fa-brain me-2"></i>AI 助手选项</h6>
                            
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="aiEnabled" checked disabled>
                                        <label class="form-check-label" for="aiEnabled">
                                            启用 AI 功能
                                            <span class="badge bg-secondary">即将推出</span>
                                        </label>
                                    </div>
                                    <small class="text-muted">启用或关闭所有 AI 相关功能</small>
                                </div>
                                <div class="col-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="aiAutoSuggest" disabled>
                                        <label class="form-check-label" for="aiAutoSuggest">
                                            AI 自动建议
                                            <span class="badge bg-secondary">即将推出</span>
                                        </label>
                                    </div>
                                    <small class="text-muted">AI 会自动分析你的日程并提供优化建议</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>取消
                    </button>
                    <button type="button" class="btn btn-primary" id="saveSettings">
                        <i class="fas fa-save me-1"></i>保存设置
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'fullcalendar_index.global.js' %}"></script>
    
    <!-- 全局变量 -->
    <script>
        // Django传递的数据
        window.events_groups = {{ events_groups|safe }};
        window.CSRF_TOKEN = '{{ csrf_token }}';
    </script>
    
    <!-- 自定义JavaScript模块 -->
    <script src="{% static 'js/settings-manager.js' %}?v=20251031-004"></script>
    <script src="{% static 'js/panel-resizer.js' %}?v=20251031-004"></script>
    <script src="{% static 'js/reminder-manager.js' %}?v=20251031-004"></script>
    <script src="{% static 'js/rrule-manager.js' %}?v=20251031-004"></script>
    <script src="{% static 'js/modal-manager.js' %}?v=20251031-004"></script>
    <script src="{% static 'js/group-manager.js' %}?v=20251031-004"></script>
    <script src="{% static 'js/event-manager.js' %}?v=20251031-004"></script>
    <script src="{% static 'js/todo-manager.js' %}?v=20251031-004"></script>
    
    <!-- AI助手模块 -->
    <script>
        class AIAssistant {
            constructor() {
                this.chatModal = document.getElementById('aiChatModal');
                this.chatMessages = document.getElementById('chatMessages');
                this.chatInput = document.getElementById('chatInput');
                this.init();
            }

            init() {
                // AI聊天切换按钮
                document.getElementById('aiChatToggle').addEventListener('click', () => {
                    this.chatModal.style.display = 'block';
                });

                // 回车发送消息
                this.chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
            }

            async sendMessage() {
                const message = this.chatInput.value.trim();
                if (!message) return;

                // 添加用户消息
                this.addMessage(message, 'user');
                this.chatInput.value = '';

                try {
                    const response = await fetch('/ai_chatting/chat/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': window.CSRF_TOKEN
                        },
                        body: JSON.stringify({ message: message })
                    });

                    const data = await response.json();
                    if (data.success) {
                        this.addMessage(data.response, 'ai');
                    } else {
                        this.addMessage('抱歉，我现在无法回应。请稍后再试。', 'ai');
                    }
                } catch (error) {
                    console.error('AI聊天错误:', error);
                    this.addMessage('网络连接出现问题，请检查网络后重试。', 'ai');
                }
            }

            addMessage(content, type) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `${type}-message`;
                
                messageDiv.innerHTML = `
                    <div class="message-avatar">
                        <i class="fas fa-${type === 'user' ? 'user' : 'robot'}"></i>
                    </div>
                    <div class="message-content">${content}</div>
                `;
                
                this.chatMessages.appendChild(messageDiv);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            async smartSchedule() {
                try {
                    const response = await fetch('/planner/smart_schedule/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': window.CSRF_TOKEN
                        }
                    });

                    const data = await response.json();
                    if (data.success) {
                        modalManager.showNotification('智能安排已完成', 'success');
                        eventManager.loadEvents();
                    } else {
                        modalManager.showNotification('智能安排失败', 'error');
                    }
                } catch (error) {
                    console.error('智能安排错误:', error);
                    modalManager.showNotification('智能安排出现错误', 'error');
                }
            }

            async analyzePriority() {
                try {
                    const response = await fetch('/planner/analyze_priority/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': window.CSRF_TOKEN
                        }
                    });

                    const data = await response.json();
                    if (data.success) {
                        modalManager.showNotification('优先级分析已完成', 'success');
                        todoManager.loadTodos();
                    } else {
                        modalManager.showNotification('优先级分析失败', 'error');
                    }
                } catch (error) {
                    console.error('优先级分析错误:', error);
                    modalManager.showNotification('优先级分析出现错误', 'error');
                }
            }

            async timeBlocking() {
                try {
                    const response = await fetch('/planner/time_blocking/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': window.CSRF_TOKEN
                        }
                    });

                    const data = await response.json();
                    if (data.success) {
                        modalManager.showNotification('时间块分配已完成', 'success');
                        eventManager.loadEvents();
                    } else {
                        modalManager.showNotification('时间块分配失败', 'error');
                    }
                } catch (error) {
                    console.error('时间块分配错误:', error);
                    modalManager.showNotification('时间块分配出现错误', 'error');
                }
            }
        }

        // 创建AI助手实例
        const aiAssistant = new AIAssistant();
        
        // 创建管理器实例（全局变量）
        window.modalManager = new ModalManager();
        window.eventManager = new EventManager();
        window.todoManager = new TodoManager();
        window.reminderManager = new ReminderManager();
        window.rruleManager = new RRuleManager();
        window.panelResizer = new PanelResizer(); // 添加面板调节器
    </script>

    <!-- 页面初始化 -->
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // 首先初始化设置管理器并等待加载完成
            await settingsManager.init();
            console.log('✅ 设置管理器初始化完成');
            
            // 立即加载用户设置到全局变量（不显示在UI上）
            await loadUserSettingsToGlobal();
            console.log('✅ 用户设置已加载到全局变量');
            
            // 初始化各个管理器
            window.modalManager.init();
            window.eventManager.init(); // 此时settingsManager已有数据,可以正确设置initialView和initialDate
            window.todoManager.init();
            window.reminderManager.init();
            window.groupManager.init();
            
            // 初始化重复提醒UI事件监听器
            initRepeatReminderListeners();
            
            // 稍微延迟加载数据，确保DOM完全准备好
            setTimeout(() => {
                window.eventManager.loadEvents();
                window.todoManager.loadTodos();
                window.reminderManager.loadReminders();
                
                // 再延迟一点应用保存的设置，确保所有数据加载完成
                setTimeout(() => {
                    settingsManager.applySettings();
                    console.log('已应用保存的用户设置');
                }, 500);
            }, 100);
            
            // 初始化用户设置功能
            initUserSettings();
            
            // 初始化周数显示功能
            initWeekNumberDisplay();
            
            console.log('UniSchedulerSuper 系统已初始化完成');
        });
        
        // ==================== 用户设置管理 ====================
        
        // 加载用户设置到全局变量（页面初始化时调用）
        async function loadUserSettingsToGlobal() {
            try {
                const response = await fetch('/get_calendar/user_settings/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const settings = await response.json();
                // 将设置保存到全局变量
                window.userSettings = settings;
                console.log('✅ 用户设置已加载到全局变量:', window.userSettings);
            } catch (error) {
                console.error('加载用户设置失败:', error);
                // 设置默认值
                window.userSettings = {
                    auto_ddl: true,  // 默认启用自动DDL
                    show_weekends: true,
                    calendar_view_default: 'dayGridMonth'
                };
                console.log('使用默认设置:', window.userSettings);
            }
        }
        
        function initUserSettings() {
            // 当设置模态框打开时，加载当前设置
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal) {
                settingsModal.addEventListener('show.bs.modal', loadUserSettings);
            }
            
            // 保存设置按钮
            const saveBtn = document.getElementById('saveSettings');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveUserSettings);
            }
            
            // 初始化 tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
        
        // 加载用户设置
        function loadUserSettings() {
            fetch('/get_calendar/user_settings/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(settings => {
                console.log('加载的设置:', settings);
                
                // 辅助函数：安全设置元素值（跳过不存在或被禁用的元素）
                function safeSetValue(id, value) {
                    const element = document.getElementById(id);
                    if (element && !element.disabled) {
                        element.value = value;
                    }
                }
                
                function safeSetChecked(id, value) {
                    const element = document.getElementById(id);
                    if (element && !element.disabled) {
                        element.checked = value;
                    }
                }
                
                // 基本设置 - 周数显示
                safeSetChecked('showWeekNumber', settings.show_week_number !== false);
                
                // 加载周期列表
                loadWeekPeriods(settings.week_number_periods || []);
                
                // 日程偏好（大部分已禁用）
                safeSetValue('defaultEventDuration', settings.default_event_duration || 60);
                safeSetValue('weekStartsOn', settings.week_starts_on || 1);
                safeSetValue('workHoursStart', settings.work_hours_start || '09:00');
                safeSetValue('workHoursEnd', settings.work_hours_end || '18:00');
                safeSetChecked('autoDdl', settings.auto_ddl !== false);
                safeSetChecked('showWeekends', settings.show_weekends !== false);
                
                // 显示偏好
                safeSetValue('calendarViewDefault', settings.calendar_view_default || 'dayGridMonth');
                safeSetValue('theme', settings.theme || 'light');
                safeSetValue('eventColorBy', settings.event_color_by || 'default');
                safeSetChecked('showCompletedEvents', settings.show_completed_events !== false);
                
                // 提醒设置
                safeSetChecked('reminderEnabled', settings.reminder_enabled !== false);
                safeSetChecked('reminderSound', settings.reminder_sound !== false);
                
                // AI 设置
                safeSetChecked('aiEnabled', settings.ai_enabled !== false);
                safeSetChecked('aiAutoSuggest', settings.ai_auto_suggest === true);
                
                // 将设置保存到全局变量,供其他模块使用
                window.userSettings = settings;
                console.log('用户设置已保存到 window.userSettings:', window.userSettings);
            })
            .catch(error => {
                console.error('加载设置失败:', error);
                showToast('加载设置失败，将使用默认值', 'warning');
                // 即使加载失败,也设置默认值
                window.userSettings = {
                    auto_ddl: true,  // 默认启用自动DDL
                    show_weekends: true,
                    calendar_view_default: 'dayGridMonth'
                };
            });
        }
        
        // ==================== 周期管理功能 ====================
        
        /**
         * 加载周期列表到UI
         */
        function loadWeekPeriods(periods) {
            const container = document.getElementById('weekPeriodsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!periods || periods.length === 0) {
                // 显示空状态
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        还没有添加任何学期,点击"添加学期"按钮开始设置
                    </div>
                `;
                return;
            }
            
            // 渲染每个周期
            periods.forEach((period, index) => {
                const periodCard = document.createElement('div');
                periodCard.className = 'card mb-2';
                periodCard.innerHTML = `
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <label class="form-label small">学期名称</label>
                                <input type="text" class="form-control form-control-sm" 
                                       value="${period.name || ''}" 
                                       onchange="updatePeriodName(${index}, this.value)"
                                       placeholder="例如: 2024秋季">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">年份</label>
                                <input type="number" class="form-control form-control-sm" 
                                       value="${period.year || new Date().getFullYear()}" 
                                       min="2000" max="2100"
                                       onchange="updatePeriodYear(${index}, this.value)">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">月份</label>
                                <select class="form-select form-select-sm" 
                                        onchange="updatePeriodMonth(${index}, this.value)">
                                    ${generateMonthOptions(period.month)}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">日期</label>
                                <input type="number" class="form-control form-control-sm" 
                                       value="${period.day || 1}" 
                                       min="1" max="31"
                                       onchange="updatePeriodDay(${index}, this.value)">
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="button" class="btn btn-sm btn-danger w-100" 
                                        onclick="removeWeekPeriod(${index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(periodCard);
            });
        }
        
        /**
         * 生成月份选项
         */
        function generateMonthOptions(selectedMonth) {
            const months = [
                '1月', '2月', '3月', '4月', '5月', '6月',
                '7月', '8月', '9月', '10月', '11月', '12月'
            ];
            return months.map((name, index) => {
                const value = index + 1;
                const selected = value === selectedMonth ? 'selected' : '';
                return `<option value="${value}" ${selected}>${name}</option>`;
            }).join('');
        }
        
        /**
         * 添加新周期
         */
        function addWeekPeriod() {
            const settings = window.userSettings || {};
            const periods = settings.week_number_periods || [];
            
            // 添加新周期,默认使用当前年份
            periods.push({
                name: '新学期',
                year: new Date().getFullYear(),
                month: 2,
                day: 24
            });
            
            // 更新设置
            settings.week_number_periods = periods;
            window.userSettings = settings;
            
            // 重新加载UI
            loadWeekPeriods(periods);
        }
        
        /**
         * 删除周期
         */
        function removeWeekPeriod(index) {
            if (!confirm('确定要删除这个学期吗?')) {
                return;
            }
            
            const settings = window.userSettings || {};
            const periods = settings.week_number_periods || [];
            
            periods.splice(index, 1);
            settings.week_number_periods = periods;
            window.userSettings = settings;
            
            loadWeekPeriods(periods);
        }
        
        /**
         * 更新周期名称
         */
        function updatePeriodName(index, value) {
            const settings = window.userSettings || {};
            const periods = settings.week_number_periods || [];
            
            if (periods[index]) {
                periods[index].name = value;
                settings.week_number_periods = periods;
                window.userSettings = settings;
            }
        }
        
        /**
         * 更新周期年份
         */
        function updatePeriodYear(index, value) {
            const settings = window.userSettings || {};
            const periods = settings.week_number_periods || [];
            
            if (periods[index]) {
                periods[index].year = parseInt(value);
                settings.week_number_periods = periods;
                window.userSettings = settings;
            }
        }
        
        /**
         * 更新周期月份
         */
        function updatePeriodMonth(index, value) {
            const settings = window.userSettings || {};
            const periods = settings.week_number_periods || [];
            
            if (periods[index]) {
                periods[index].month = parseInt(value);
                settings.week_number_periods = periods;
                window.userSettings = settings;
            }
        }
        
        /**
         * 更新周期日期
         */
        function updatePeriodDay(index, value) {
            const settings = window.userSettings || {};
            const periods = settings.week_number_periods || [];
            
            if (periods[index]) {
                periods[index].day = parseInt(value);
                settings.week_number_periods = periods;
                window.userSettings = settings;
            }
        }
        
        /**
         * 获取当前周期配置
         */
        function getWeekPeriods() {
            const settings = window.userSettings || {};
            return settings.week_number_periods || [];
        }
        
        // 保存用户设置
        function saveUserSettings() {
            // 辅助函数：安全获取元素值（跳过不存在或被禁用的元素）
            function safeGetValue(id, defaultValue) {
                const element = document.getElementById(id);
                if (element && !element.disabled) {
                    return element.value;
                }
                return defaultValue;
            }
            
            function safeGetChecked(id, defaultValue) {
                const element = document.getElementById(id);
                if (element && !element.disabled) {
                    return element.checked;
                }
                return defaultValue;
            }
            
            function safeGetIntValue(id, defaultValue) {
                const element = document.getElementById(id);
                if (element && !element.disabled) {
                    return parseInt(element.value);
                }
                return defaultValue;
            }
            
            const settings = {
                // 新的多周期系统
                week_number_periods: getWeekPeriods(),
                show_week_number: safeGetChecked('showWeekNumber', true),
                // 保留旧字段以兼容历史数据
                week_number_start: {
                    month: safeGetIntValue('weekNumberStartMonth', 2),
                    day: safeGetIntValue('weekNumberStartDay', 24)
                },
                auto_ddl: safeGetChecked('autoDdl', true),
                default_event_duration: safeGetIntValue('defaultEventDuration', 60),
                work_hours_start: safeGetValue('workHoursStart', '09:00'),
                work_hours_end: safeGetValue('workHoursEnd', '18:00'),
                show_weekends: safeGetChecked('showWeekends', true),
                week_starts_on: safeGetIntValue('weekStartsOn', 1),
                calendar_view_default: safeGetValue('calendarViewDefault', 'dayGridMonth'),
                theme: safeGetValue('theme', 'light'),
                show_completed_events: safeGetChecked('showCompletedEvents', true),
                event_color_by: safeGetValue('eventColorBy', 'default'),
                reminder_enabled: safeGetChecked('reminderEnabled', true),
                default_reminder_time: 15,  // 固定默认值，因为UI中已删除该字段
                reminder_sound: safeGetChecked('reminderSound', true),
                ai_enabled: safeGetChecked('aiEnabled', true),
                ai_auto_suggest: safeGetChecked('aiAutoSuggest', false),
                prompt_scene_presets: []  // 暂时保留空数组，未来可扩展
            };
            
            console.log('保存的设置:', settings);
            
            fetch('/get_calendar/user_settings/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': window.CSRF_TOKEN
                },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                console.log('设置保存成功:', data);
                showToast('设置已保存', 'success');
                
                // 更新全局设置变量
                window.userSettings = settings;
                console.log('✅ 全局设置已更新:', window.userSettings);
                
                // 关闭模态框
                const modalElement = document.getElementById('settingsModal');
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
                
                // 应用某些立即生效的设置
                applyImmediateSettings(settings);
            })
            .catch(error => {
                console.error('保存设置失败:', error);
                showToast('保存失败，请重试', 'danger');
            });
        }
        
        // 应用立即生效的设置
        function applyImmediateSettings(settings) {
            // 检查日历实例是否存在
            const calendarInstance = window.eventManager?.calendar;
            
            if (!calendarInstance) {
                console.log('日历实例尚未初始化，设置将在下次页面加载时生效');
                return;
            }
            
            // ⚠️ 注意：不在这里应用 calendar_view_default
            // 因为 settings-manager.js 会在页面刷新时恢复用户上次的视图和日期
            // calendar_view_default 只在重新登录(没有保存的视图状态)时使用
            
            // 应用周起始日设置
            if (settings.week_starts_on !== undefined) {
                try {
                    calendarInstance.setOption('firstDay', settings.week_starts_on);
                    console.log('周起始日已更新为:', settings.week_starts_on);
                    
                    // 更新周数显示(因为周数计算依赖于周起始日)
                    updateWeekNumberDisplay();
                } catch (error) {
                    console.error('更新周起始日失败:', error);
                }
            }
            
            // 应用周末显示设置
            if (settings.show_weekends !== undefined) {
                try {
                    calendarInstance.setOption('weekends', settings.show_weekends);
                    console.log('周末显示已更新为:', settings.show_weekends);
                } catch (error) {
                    console.error('更新周末显示失败:', error);
                }
            }
        }
        
        // ==================== 周数显示管理 ====================
        
        /**
         * 获取某个日期所在周的开始日期
         * @param {Date} date - 输入日期
         * @param {number} weekStartsOn - 每周起始日(0=周日, 1=周一, ..., 6=周六)
         * @returns {Date} 该周的开始日期
         */
        function getWeekStart(date, weekStartsOn = 1) {
            const d = new Date(date);
            const day = d.getDay(); // 0=周日, 1=周一, ..., 6=周六
            const diff = (day - weekStartsOn + 7) % 7; // 计算距离周起始日的天数
            d.setDate(d.getDate() - diff);
            d.setHours(0, 0, 0, 0); // 重置到当天00:00:00
            return d;
        }
        
        /**
         * 查找最近的周数起始日期
         * @param {Date} date - 要查找的基准日期
         * @param {Array} periods - 周数起始时间数组 [{name, year, month, day}]
         * @param {number} weekStartsOn - 每周起始日(0=周日, 1=周一, ..., 6=周六)
         * @returns {Object|null} {period, startDate, weekNumber} 或 null(找不到)
         */
        function findNearestPeriod(date, periods, weekStartsOn = 1) {
            if (!periods || periods.length === 0) {
                return null;
            }
            
            let nearestPeriod = null;
            let nearestStartDate = null;
            let minDistance = Infinity;
            
            // 遍历所有起始时间,使用配置的年份
            for (const period of periods) {
                // 使用配置的年月日创建起始日期
                const startDate = new Date(period.year, period.month - 1, period.day);
                
                // 只考虑在当前日期之前或等于的起始日期
                if (startDate <= date) {
                    const distance = date - startDate;
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestPeriod = period;
                        nearestStartDate = startDate;
                    }
                }
            }
            
            // 如果找到了最近的起始日期,计算周数
            if (nearestPeriod && nearestStartDate) {
                // 找到起始日期所在周的开始
                const periodWeekStart = getWeekStart(nearestStartDate, weekStartsOn);
                
                // 找到目标日期所在周的开始
                const targetWeekStart = getWeekStart(date, weekStartsOn);
                
                // 计算两个周开始日期之间的天数差
                const diffTime = targetWeekStart - periodWeekStart;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                // 计算经过了多少完整的周,加1得到当前是第几周
                const weekNumber = Math.floor(diffDays / 7) + 1;
                
                return {
                    period: nearestPeriod,
                    startDate: nearestStartDate,
                    weekNumber: weekNumber
                };
            }
            
            return null;
        }
        
        /**
         * 计算当前日期是第几周(新版本 - 支持多起始时间和每周起始日)
         * @param {Date} date - 要计算的日期
         * @returns {Object|null} {period, weekNumber} 或 null(找不到起始时间)
         */
        function calculateWeekNumber(date = new Date()) {
            // 检查用户设置
            const settings = window.userSettings || {};
            
            // 检查是否禁用周数显示
            if (settings.show_week_number === false) {
                return null;
            }
            
            // 获取每周起始日配置,默认为周一(1)
            const weekStartsOn = settings.week_starts_on !== undefined ? settings.week_starts_on : 1;
            
            // 优先使用新的week_number_periods
            let periods = settings.week_number_periods;
            
            // 如果没有periods但有旧的week_number_start,进行兼容处理
            if ((!periods || periods.length === 0) && settings.week_number_start) {
                periods = [{
                    name: '默认学期',
                    year: new Date().getFullYear(), // 使用当前年份
                    month: settings.week_number_start.month || 2,
                    day: settings.week_number_start.day || 24
                }];
            }
            
            // 查找最近的起始时间,传入weekStartsOn参数
            const result = findNearestPeriod(date, periods, weekStartsOn);
            
            if (result) {
                return {
                    period: result.period,
                    weekNumber: result.weekNumber
                };
            }
            
            return null;
        }
        
        /**
         * 更新日历标题旁边的周数显示
         */
        function updateWeekNumberDisplay() {
            // 获取日历实例
            const calendarInstance = window.eventManager?.calendar;
            if (!calendarInstance) {
                console.warn('日历实例不存在，无法更新周数显示');
                return;
            }
            
            // 获取当前视图
            const currentView = calendarInstance.view;
            const viewType = currentView.type;
            
            // 查找或创建周数显示元素
            let weekBadge = document.getElementById('weekNumberBadge');
            const toolbarTitle = document.querySelector('.fc-toolbar-title');
            
            if (!toolbarTitle) {
                console.warn('未找到日历标题元素');
                return;
            }
            
            // 计算周数显示内容
            let badgeText = '';
            
            if (viewType === 'dayGridMonth') {
                // 月视图: 显示第X周-第Y周
                const startDate = currentView.activeStart;
                const endDate = new Date(currentView.activeEnd.getTime() - 1); // 减1天,因为activeEnd是下个月第一天
                
                const startResult = calculateWeekNumber(startDate);
                const endResult = calculateWeekNumber(endDate);
                
                if (startResult && endResult) {
                    if (startResult.weekNumber === endResult.weekNumber) {
                        badgeText = `第 ${startResult.weekNumber} 周`;
                    } else {
                        badgeText = `第 ${startResult.weekNumber}-${endResult.weekNumber} 周`;
                    }
                    // 如果学期名称相同,显示学期名
                    if (startResult.period.name === endResult.period.name && startResult.period.name !== '默认学期') {
                        badgeText += ` (${startResult.period.name})`;
                    }
                }
            } else {
                // 周视图/日视图: 显示单个周数
                const currentDate = calendarInstance.getDate();
                const result = calculateWeekNumber(currentDate);
                
                if (result) {
                    badgeText = `第 ${result.weekNumber} 周`;
                    // 显示学期名称(如果不是默认学期)
                    if (result.period.name && result.period.name !== '默认学期') {
                        badgeText += ` (${result.period.name})`;
                    }
                }
            }
            
            // 如果没有周数信息,隐藏徽章
            if (!badgeText) {
                if (weekBadge) {
                    weekBadge.style.display = 'none';
                }
                console.log('当前日期不在任何学期范围内,不显示周数');
                return;
            }
            
            if (!weekBadge) {
                // 创建周数徽章元素
                weekBadge = document.createElement('span');
                weekBadge.id = 'weekNumberBadge';
                weekBadge.className = 'badge bg-primary ms-3';
                weekBadge.style.fontSize = '0.9rem';
                weekBadge.style.verticalAlign = 'middle';
                
                // 插入到标题后面
                toolbarTitle.appendChild(weekBadge);
            }
            
            // 显示徽章并更新文本
            weekBadge.style.display = '';
            weekBadge.textContent = badgeText;
            console.log(`✅ 周数已更新: ${badgeText}`);
        }
        
        /**
         * 初始化周数显示功能
         */
        function initWeekNumberDisplay() {
            // 等待日历初始化完成
            const checkCalendar = setInterval(() => {
                if (window.eventManager?.calendar) {
                    clearInterval(checkCalendar);
                    
                    // 首次显示周数
                    setTimeout(() => {
                        updateWeekNumberDisplay();
                    }, 500);
                    
                    // 监听日历视图变化
                    const calendarInstance = window.eventManager.calendar;
                    
                    // 使用FullCalendar的datesSet事件监听日期变化
                    calendarInstance.on('datesSet', function(info) {
                        console.log('日历视图已变化，更新周数');
                        updateWeekNumberDisplay();
                    });
                    
                    console.log('✅ 周数显示功能已初始化');
                }
            }, 100);
            
            // 30秒后停止检查（防止无限循环）
            setTimeout(() => {
                clearInterval(checkCalendar);
            }, 30000);
        }
        
        // 显示提示消息（Toast）
        function showToast(message, type = 'info') {
            // 创建 Toast 元素
            const toastHTML = `
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.insertAdjacentHTML('beforeend', toastHTML);
            
            // 获取刚添加的最后一个 toast 元素
            const toastElements = document.querySelectorAll('.toast');
            const toastElement = toastElements[toastElements.length - 1];
            
            // 初始化并显示 Toast
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();
            
            // 自动移除 DOM 元素
            setTimeout(() => {
                toastElement.remove();
            }, 4000);
        }
        
        // 初始化重复提醒相关的事件监听器
        function initRepeatReminderListeners() {
            // 监听所有可能影响重复预览的控件
            const fieldsToWatch = [
                'newRepeatFreq', 'newRepeatInterval', 'newRepeatUntil', 'newMonthlyType', 'newMonthlyDate', 'newMonthlyWeek', 'newMonthlyWeekday',
                'editRepeatFreq', 'editRepeatInterval', 'editRepeatUntil', 'editMonthlyType', 'editMonthlyDate', 'editMonthlyWeek', 'editMonthlyWeekday',
                'newMO', 'newTU', 'newWE', 'newTH', 'newFR', 'newSA', 'newSU',
                'editMO', 'editTU', 'editWE', 'editTH', 'editFR', 'editSA', 'editSU'
            ];
            
            fieldsToWatch.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    const mode = fieldId.startsWith('new') ? 'new' : 'edit';
                    element.addEventListener('change', () => {
                        updateRepeatPreview(mode);
                    });
                }
            });
        }
        
    </script>
</body>
</html>
