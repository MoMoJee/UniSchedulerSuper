<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>找回密码</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .step {
      display: none;
    }
    .step.active {
      display: block;
    }
    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2rem;
    }
    .progress-step {
      flex: 1;
      text-align: center;
      padding: 1rem;
      border-bottom: 3px solid #dee2e6;
      color: #6c757d;
    }
    .progress-step.active {
      border-bottom-color: #0d6efd;
      color: #0d6efd;
      font-weight: bold;
    }
    .progress-step.completed {
      border-bottom-color: #198754;
      color: #198754;
    }
  </style>
</head>
<body class="bg-light">
{% csrf_token %}
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="card-title text-center mb-4">找回密码</h2>
          
          <!-- 选择重置方式 -->
          <div class="mb-4">
            <ul class="nav nav-tabs" id="resetMethodTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="email-tab" data-bs-toggle="tab" data-bs-target="#email-method" type="button" role="tab">
                  邮箱验证码
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="token-tab" data-bs-toggle="tab" data-bs-target="#token-method" type="button" role="tab">
                  API Token
                </button>
              </li>
            </ul>
          </div>

          <!-- 邮箱验证码方式 -->
          <div class="tab-content" id="resetMethodTabContent">
            <div class="tab-pane fade show active" id="email-method" role="tabpanel">
          
          <!-- 进度指示器 -->
          <div class="progress-steps" id="email-progress">
            <div class="progress-step active" id="progress-step1">
              <div>1. 输入邮箱</div>
            </div>
            <div class="progress-step" id="progress-step2">
              <div>2. 验证码</div>
            </div>
            <div class="progress-step" id="progress-step3">
              <div>3. 重置密码</div>
            </div>
          </div>

          <!-- 步骤 1: 输入邮箱 -->
          <div class="step active" id="step1">
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> 请输入您注册时使用的邮箱地址，我们将发送验证码到该邮箱。
            </div>
            <form id="emailForm">
              <div class="mb-3">
                <label for="email" class="form-label">邮箱地址 *</label>
                <input type="email" class="form-control" id="email" required placeholder="your@email.com">
              </div>
              <div class="d-flex justify-content-between">
                <a href="/user_login/" class="btn btn-secondary">返回登录</a>
                <button type="submit" class="btn btn-primary">获取验证码</button>
              </div>
            </form>
          </div>

          <!-- 步骤 2: 输入验证码 -->
          <div class="step" id="step2">
            <div class="alert alert-success" id="codeInfo">
              验证码已发送到您的邮箱，请查收。（有效期15分钟）
            </div>
            <form id="codeForm">
              <div class="mb-3">
                <label for="code" class="form-label">验证码 *</label>
                <input type="text" class="form-control" id="code" required placeholder="6位数字验证码" maxlength="6">
                <small class="form-text text-muted">请输入邮箱中收到的6位数字验证码</small>
              </div>
              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-secondary" onclick="goToStep(1)">上一步</button>
                <button type="submit" class="btn btn-primary">验证</button>
              </div>
            </form>
          </div>

          <!-- 步骤 3: 设置新密码 -->
          <div class="step" id="step3">
            <div class="alert alert-success">
              <i class="fas fa-check-circle"></i> 验证码正确！请设置新密码。
            </div>
            <form id="resetForm">
              <div class="mb-3">
                <label for="newPassword" class="form-label">新密码 *</label>
                <input type="password" class="form-control" id="newPassword" required placeholder="请输入新密码">
                <small class="form-text text-muted">
                  密码要求：至少8个字符，不能与用户名太相似，不能是常见密码，不能全是数字
                </small>
              </div>
              <div class="mb-3">
                <label for="confirmPassword" class="form-label">确认新密码 *</label>
                <input type="password" class="form-control" id="confirmPassword" required placeholder="再次输入新密码">
              </div>
              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-secondary" onclick="goToStep(2)">上一步</button>
                <button type="submit" class="btn btn-success">重置密码</button>
              </div>
            </form>
          </div>

          </div> <!-- 结束邮箱方式 tab-pane -->
          
          <!-- API Token 方式 -->
          <div class="tab-pane fade" id="token-method" role="tabpanel">
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> 如果您之前生成过 API Token，可以使用用户名和 Token 直接重置密码。
            </div>
            <form id="tokenResetForm">
              <div class="mb-3">
                <label for="tokenUsername" class="form-label">用户名 *</label>
                <input type="text" class="form-control" id="tokenUsername" required placeholder="请输入用户名">
              </div>
              <div class="mb-3">
                <label for="apiToken" class="form-label">API Token *</label>
                <input type="text" class="form-control" id="apiToken" required placeholder="请输入您的 API Token">
                <small class="form-text text-muted">
                  Token 可以在"我的" → "API Token 管理"中找到
                </small>
              </div>
              <div class="mb-3">
                <label for="tokenNewPassword" class="form-label">新密码 *</label>
                <input type="password" class="form-control" id="tokenNewPassword" required placeholder="请输入新密码">
                <small class="form-text text-muted">
                  密码要求：至少8个字符，不能与用户名太相似，不能是常见密码，不能全是数字
                </small>
              </div>
              <div class="mb-3">
                <label for="tokenConfirmPassword" class="form-label">确认新密码 *</label>
                <input type="password" class="form-control" id="tokenConfirmPassword" required placeholder="再次输入新密码">
              </div>
              <div class="d-flex justify-content-between">
                <a href="/user_login/" class="btn btn-secondary">返回登录</a>
                <button type="submit" class="btn btn-success">重置密码</button>
              </div>
            </form>
          </div>
          
          </div> <!-- 结束 tab-content -->

        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // 获取 CSRF Token
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
  // 存储邮箱地址
  let userEmail = '';
  let verificationCode = '';

  // Toast 提示函数
  function showToast(message, type = 'info') {
    const toastHtml = `
      <div class="toast align-items-center text-white bg-${type} border-0 position-fixed top-0 start-50 translate-middle-x mt-3" role="alert" style="z-index: 9999;">
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    `;
    const toastElement = document.createElement('div');
    toastElement.innerHTML = toastHtml;
    document.body.appendChild(toastElement);
    const toast = new bootstrap.Toast(toastElement.querySelector('.toast'));
    toast.show();
    setTimeout(() => toastElement.remove(), 5000);
  }

  // 切换步骤（仅用于邮箱验证码方式）
  function goToStep(stepNumber) {
    // 隐藏所有步骤
    document.querySelectorAll('#email-method .step').forEach(step => step.classList.remove('active'));
    document.querySelectorAll('.progress-step').forEach(step => {
      step.classList.remove('active');
      step.classList.remove('completed');
    });

    // 显示当前步骤
    document.getElementById('step' + stepNumber).classList.add('active');
    document.getElementById('progress-step' + stepNumber).classList.add('active');

    // 标记已完成的步骤
    for (let i = 1; i < stepNumber; i++) {
      document.getElementById('progress-step' + i).classList.add('completed');
    }
  }

  // 步骤 1: 提交邮箱
  document.getElementById('emailForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('email').value.trim();

    if (!email) {
      showToast('请输入邮箱地址', 'warning');
      return;
    }

    try {
      const response = await fetch('/api/password-reset/request/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ email })
      });

      const data = await response.json();

      if (response.ok) {
        userEmail = email;
        // 开发环境：显示验证码（生产环境应删除）
        if (data.code) {
          document.getElementById('codeInfo').innerHTML = `
            <i class="fas fa-check-circle"></i> 验证码已生成：<strong>${data.code}</strong><br>
            <small class="text-muted">（生产环境将发送到您的邮箱，有效期15分钟）</small>
          `;
        }
        showToast('验证码已发送', 'success');
        goToStep(2);
      } else {
        showToast(data.error || '请求失败', 'danger');
      }
    } catch (error) {
      showToast('请求失败: ' + error.message, 'danger');
    }
  });

  // 步骤 2: 验证验证码
  document.getElementById('codeForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const code = document.getElementById('code').value.trim();

    if (!code || code.length !== 6) {
      showToast('请输入6位数字验证码', 'warning');
      return;
    }

    try {
      const response = await fetch('/api/password-reset/verify/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ 
          email: userEmail,
          code: code
        })
      });

      const data = await response.json();

      if (response.ok) {
        verificationCode = code;
        showToast('验证码正确', 'success');
        goToStep(3);
      } else {
        showToast(data.error || '验证失败', 'danger');
      }
    } catch (error) {
      showToast('验证失败: ' + error.message, 'danger');
    }
  });

  // 步骤 3: 重置密码
  document.getElementById('resetForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    if (!newPassword) {
      showToast('请输入新密码', 'warning');
      return;
    }

    if (newPassword !== confirmPassword) {
      showToast('两次输入的密码不一致', 'warning');
      return;
    }

    try {
      const response = await fetch('/api/password-reset/reset/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          email: userEmail,
          code: verificationCode,
          new_password: newPassword,
          confirm_password: confirmPassword
        })
      });

      const data = await response.json();

      if (response.ok) {
        showToast('密码重置成功！正在跳转到登录页...', 'success');
        setTimeout(() => {
          window.location.href = '/user_login/';
        }, 2000);
      } else {
        showToast(data.error || '重置失败', 'danger');
      }
    } catch (error) {
      showToast('重置失败: ' + error.message, 'danger');
    }
  });

  // Token 方式重置密码
  document.getElementById('tokenResetForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('tokenUsername').value.trim();
    const token = document.getElementById('apiToken').value.trim();
    const newPassword = document.getElementById('tokenNewPassword').value;
    const confirmPassword = document.getElementById('tokenConfirmPassword').value;

    if (!username || !token) {
      showToast('请输入用户名和 Token', 'warning');
      return;
    }

    if (!newPassword) {
      showToast('请输入新密码', 'warning');
      return;
    }

    if (newPassword !== confirmPassword) {
      showToast('两次输入的密码不一致', 'warning');
      return;
    }

    try {
      const response = await fetch('/api/password-reset/token/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          username: username,
          token: token,
          new_password: newPassword,
          confirm_password: confirmPassword
        })
      });

      const data = await response.json();

      if (response.ok) {
        showToast('密码重置成功！正在跳转到登录页...', 'success');
        setTimeout(() => {
          window.location.href = '/user_login/';
        }, 2000);
      } else {
        showToast(data.error || '重置失败', 'danger');
      }
    } catch (error) {
      showToast('重置失败: ' + error.message, 'danger');
    }
  });
</script>
</body>
</html>
