<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日历导出</title>
    <!-- 引入 Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script>
        function downloadCalendar(mode) {
            // TODO 以后要加上选择某些日程组导出
            // 检查是否有修改过的日程
            fetch(`/get_calendar/check_modified_events?mode=${mode}`)
                .then(response => response.json())
                .then(data => {
                    if (data.modified_events.length > 0) {
                        // 显示用户选择的弹窗
                        const userChoice = prompt(
                            "警告：以下日程在上一次导出之后被修改过：\n" +
                            data.modified_events.map(event => `- ${event.title} (详情: ${event.description})`).join("\n") +
                            "\n请选择处理方式：\n1. 包含这些日程\n2. 忽略",
                            "1"
                        );

                        if (userChoice === null) {
                            alert("操作已取消。");
                            return;
                        }

                        // 构建下载链接，传递 mode 和 user_choice 参数
                        const url = `/get_calendar/get_outport_calendar?mode=${mode}&user_choice=${userChoice}`;
                        window.location.href = url;
                    } else {
                        // 如果没有修改过的日程，直接下载
                        const url = `/get_calendar/get_outport_calendar?mode=${mode}`;
                        window.location.href = url;
                    }
                })
                .catch(error => console.error("Error:", error));
        }
    </script>
</head>
<body class="bg-light">
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h2 class="card-title mb-4">导出日历</h2>

                    <!-- 按钮一：只导出新增日程 -->
                    <button onclick="downloadCalendar('new')" class="btn btn-success w-100 mb-3">导出新增日程</button>

                    <!-- 按钮二：导出所有日程 -->
                    <button onclick="downloadCalendar('all')" class="btn btn-primary w-100">导出所有日程</button>

                    <!-- 按钮三：返回首页 -->
                    <a href="/home/" class="btn btn-secondary w-100 mt-3">返回首页</a>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- 引入 Bootstrap JS 和依赖项 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>